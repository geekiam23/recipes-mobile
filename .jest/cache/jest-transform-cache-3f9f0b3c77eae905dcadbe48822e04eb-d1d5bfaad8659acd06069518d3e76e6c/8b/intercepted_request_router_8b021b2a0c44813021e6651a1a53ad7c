ba900021e9a2b1d2502d001ecaca04ea
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var debug = require('debug')('nock.request_overrider');

var _require = require('http'),
    IncomingMessage = _require.IncomingMessage,
    ClientRequest = _require.ClientRequest,
    originalHttpRequest = _require.request;

var _require2 = require('https'),
    originalHttpsRequest = _require2.request;

var propagate = require('propagate');

var common = require("./common");

var globalEmitter = require("./global_emitter");

var Socket = require("./socket");

var _require3 = require("./playback_interceptor"),
    playbackInterceptor = _require3.playbackInterceptor;

function socketOnClose(req) {
  debug('socket close');

  if (!req.res && !req.socket._hadError) {
    req.socket._hadError = true;
    var err = new Error('socket hang up');
    err.code = 'ECONNRESET';
    req.emit('error', err);
  }

  req.emit('close');
}

var InterceptedRequestRouter = function () {
  function InterceptedRequestRouter(_ref) {
    var _this = this;

    var req = _ref.req,
        options = _ref.options,
        interceptors = _ref.interceptors;
    (0, _classCallCheck2.default)(this, InterceptedRequestRouter);
    this.req = req;
    this.options = (0, _extends2.default)({}, options, {
      headers: common.headersFieldNamesToLowerCase(options.headers || {})
    });
    this.interceptors = interceptors;
    this.socket = new Socket(options);

    if (options.timeout) {
      this.socket.setTimeout(options.timeout);
    }

    this.response = new IncomingMessage(this.socket);
    this.requestBodyBuffers = [];
    this.playbackStarted = false;
    this.readyToStartPlaybackOnSocketEvent = false;
    this.attachToReq();
    process.nextTick(function () {
      return _this.connectSocket();
    });
  }

  (0, _createClass2.default)(InterceptedRequestRouter, [{
    key: "attachToReq",
    value: function attachToReq() {
      var _this2 = this;

      var req = this.req,
          options = this.options;

      for (var _i = 0, _Object$entries = Object.entries(options.headers); _i < _Object$entries.length; _i++) {
        var _ref2 = _Object$entries[_i];

        var _ref3 = (0, _slicedToArray2.default)(_ref2, 2);

        var name = _ref3[0];
        var val = _ref3[1];
        req.setHeader(name.toLowerCase(), val);
      }

      if (options.auth && !options.headers.authorization) {
        req.setHeader('authorization', "Basic " + Buffer.from(options.auth).toString('base64'));
      }

      req.path = options.path;
      req.method = options.method;

      req.write = function () {
        return _this2.handleWrite.apply(_this2, arguments);
      };

      req.end = function () {
        return _this2.handleEnd.apply(_this2, arguments);
      };

      req.flushHeaders = function () {
        return _this2.handleFlushHeaders.apply(_this2, arguments);
      };

      if (options.headers.expect === '100-continue') {
        common.setImmediate(function () {
          debug('continue');
          req.emit('continue');
        });
      }
    }
  }, {
    key: "connectSocket",
    value: function connectSocket() {
      var req = this.req,
          socket = this.socket;

      if (common.isRequestDestroyed(req)) {
        return;
      }

      req.socket = req.connection = socket;
      propagate(['error', 'timeout'], socket, req);
      socket.on('close', function () {
        return socketOnClose(req);
      });
      socket.connecting = false;
      req.emit('socket', socket);
      socket.emit('connect');

      if (socket.authorized) {
        socket.emit('secureConnect');
      }

      if (this.readyToStartPlaybackOnSocketEvent) {
        this.maybeStartPlayback();
      }
    }
  }, {
    key: "handleWrite",
    value: function handleWrite(buffer, encoding, callback) {
      debug('request write');
      var req = this.req;

      if (req.finished) {
        var err = new Error('write after end');
        err.code = 'ERR_STREAM_WRITE_AFTER_END';
        process.nextTick(function () {
          return req.emit('error', err);
        });
        return true;
      }

      if (req.socket && req.socket.destroyed) {
        return false;
      }

      if (!buffer || buffer.length === 0) {
        return true;
      }

      if (!Buffer.isBuffer(buffer)) {
        buffer = Buffer.from(buffer, encoding);
      }

      this.requestBodyBuffers.push(buffer);

      if (typeof callback === 'function') {
        callback();
      }

      common.setImmediate(function () {
        req.emit('drain');
      });
      return false;
    }
  }, {
    key: "handleEnd",
    value: function handleEnd(chunk, encoding, callback) {
      debug('request end');
      var req = this.req;

      if (typeof chunk === 'function') {
        callback = chunk;
        chunk = null;
      } else if (typeof encoding === 'function') {
        callback = encoding;
        encoding = null;
      }

      if (typeof callback === 'function') {
        req.once('finish', callback);
      }

      if (chunk) {
        req.write(chunk, encoding);
      }

      req.finished = true;
      this.maybeStartPlayback();
      return req;
    }
  }, {
    key: "handleFlushHeaders",
    value: function handleFlushHeaders() {
      debug('request flushHeaders');
      this.maybeStartPlayback();
    }
  }, {
    key: "setHostHeaderUsingInterceptor",
    value: function setHostHeaderUsingInterceptor(interceptor) {
      var req = this.req,
          options = this.options;
      var HOST_HEADER = 'host';

      if (interceptor.__nock_filteredScope && interceptor.__nock_scopeHost) {
        options.headers[HOST_HEADER] = interceptor.__nock_scopeHost;
        req.setHeader(HOST_HEADER, interceptor.__nock_scopeHost);
      } else {
        if (options.host && !req.getHeader(HOST_HEADER)) {
          var hostHeader = options.host;

          if (options.port === 80 || options.port === 443) {
            hostHeader = hostHeader.split(':')[0];
          }

          req.setHeader(HOST_HEADER, hostHeader);
        }
      }
    }
  }, {
    key: "maybeStartPlayback",
    value: function maybeStartPlayback() {
      var req = this.req,
          socket = this.socket,
          playbackStarted = this.playbackStarted;

      if (socket.connecting) {
        this.readyToStartPlaybackOnSocketEvent = true;
        return;
      }

      if (!common.isRequestDestroyed(req) && !playbackStarted) {
        this.startPlayback();
      }
    }
  }, {
    key: "startPlayback",
    value: function startPlayback() {
      var _this3 = this;

      debug('ending');
      this.playbackStarted = true;
      var req = this.req,
          response = this.response,
          socket = this.socket,
          options = this.options,
          interceptors = this.interceptors;
      (0, _extends2.default)(options, {
        path: req.path,
        headers: req.getHeaders(),
        protocol: options.proto + ":"
      });
      interceptors.forEach(function (interceptor) {
        _this3.setHostHeaderUsingInterceptor(interceptor);
      });
      var requestBodyBuffer = Buffer.concat(this.requestBodyBuffers);
      var requestBodyIsUtf8Representable = common.isUtf8Representable(requestBodyBuffer);
      var requestBodyString = requestBodyBuffer.toString(requestBodyIsUtf8Representable ? 'utf8' : 'hex');
      var matchedInterceptor = interceptors.find(function (i) {
        return i.match(req, options, requestBodyString);
      });

      if (matchedInterceptor) {
        matchedInterceptor.scope.logger('interceptor identified, starting mocking');
        matchedInterceptor.markConsumed();
        req.emit('finish');
        playbackInterceptor({
          req: req,
          socket: socket,
          options: options,
          requestBodyString: requestBodyString,
          requestBodyIsUtf8Representable: requestBodyIsUtf8Representable,
          response: response,
          interceptor: matchedInterceptor
        });
      } else {
        globalEmitter.emit('no match', req, options, requestBodyString);
        var allowUnmocked = interceptors.some(function (i) {
          return i.matchHostName(options) && i.options.allowUnmocked;
        });

        if (allowUnmocked && req instanceof ClientRequest) {
          var newReq = options.proto === 'https' ? originalHttpsRequest(options) : originalHttpRequest(options);
          propagate(newReq, req);
          newReq.end(requestBodyBuffer);
        } else {
          var reqStr = common.stringifyRequest(options, requestBodyString);
          var err = new Error("Nock: No match for request " + reqStr);
          err.code = 'ERR_NOCK_NO_MATCH';
          err.statusCode = err.status = 404;
          req.destroy(err);
        }
      }
    }
  }]);
  return InterceptedRequestRouter;
}();

module.exports = {
  InterceptedRequestRouter: InterceptedRequestRouter
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVyY2VwdGVkX3JlcXVlc3Rfcm91dGVyLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsIkluY29taW5nTWVzc2FnZSIsIkNsaWVudFJlcXVlc3QiLCJvcmlnaW5hbEh0dHBSZXF1ZXN0IiwicmVxdWVzdCIsIm9yaWdpbmFsSHR0cHNSZXF1ZXN0IiwicHJvcGFnYXRlIiwiY29tbW9uIiwiZ2xvYmFsRW1pdHRlciIsIlNvY2tldCIsInBsYXliYWNrSW50ZXJjZXB0b3IiLCJzb2NrZXRPbkNsb3NlIiwicmVxIiwicmVzIiwic29ja2V0IiwiX2hhZEVycm9yIiwiZXJyIiwiRXJyb3IiLCJjb2RlIiwiZW1pdCIsIkludGVyY2VwdGVkUmVxdWVzdFJvdXRlciIsIm9wdGlvbnMiLCJpbnRlcmNlcHRvcnMiLCJoZWFkZXJzIiwiaGVhZGVyc0ZpZWxkTmFtZXNUb0xvd2VyQ2FzZSIsInRpbWVvdXQiLCJzZXRUaW1lb3V0IiwicmVzcG9uc2UiLCJyZXF1ZXN0Qm9keUJ1ZmZlcnMiLCJwbGF5YmFja1N0YXJ0ZWQiLCJyZWFkeVRvU3RhcnRQbGF5YmFja09uU29ja2V0RXZlbnQiLCJhdHRhY2hUb1JlcSIsInByb2Nlc3MiLCJuZXh0VGljayIsImNvbm5lY3RTb2NrZXQiLCJPYmplY3QiLCJlbnRyaWVzIiwibmFtZSIsInZhbCIsInNldEhlYWRlciIsInRvTG93ZXJDYXNlIiwiYXV0aCIsImF1dGhvcml6YXRpb24iLCJCdWZmZXIiLCJmcm9tIiwidG9TdHJpbmciLCJwYXRoIiwibWV0aG9kIiwid3JpdGUiLCJoYW5kbGVXcml0ZSIsImVuZCIsImhhbmRsZUVuZCIsImZsdXNoSGVhZGVycyIsImhhbmRsZUZsdXNoSGVhZGVycyIsImV4cGVjdCIsInNldEltbWVkaWF0ZSIsImlzUmVxdWVzdERlc3Ryb3llZCIsImNvbm5lY3Rpb24iLCJvbiIsImNvbm5lY3RpbmciLCJhdXRob3JpemVkIiwibWF5YmVTdGFydFBsYXliYWNrIiwiYnVmZmVyIiwiZW5jb2RpbmciLCJjYWxsYmFjayIsImZpbmlzaGVkIiwiZGVzdHJveWVkIiwibGVuZ3RoIiwiaXNCdWZmZXIiLCJwdXNoIiwiY2h1bmsiLCJvbmNlIiwiaW50ZXJjZXB0b3IiLCJIT1NUX0hFQURFUiIsIl9fbm9ja19maWx0ZXJlZFNjb3BlIiwiX19ub2NrX3Njb3BlSG9zdCIsImhvc3QiLCJnZXRIZWFkZXIiLCJob3N0SGVhZGVyIiwicG9ydCIsInNwbGl0Iiwic3RhcnRQbGF5YmFjayIsImdldEhlYWRlcnMiLCJwcm90b2NvbCIsInByb3RvIiwiZm9yRWFjaCIsInNldEhvc3RIZWFkZXJVc2luZ0ludGVyY2VwdG9yIiwicmVxdWVzdEJvZHlCdWZmZXIiLCJjb25jYXQiLCJyZXF1ZXN0Qm9keUlzVXRmOFJlcHJlc2VudGFibGUiLCJpc1V0ZjhSZXByZXNlbnRhYmxlIiwicmVxdWVzdEJvZHlTdHJpbmciLCJtYXRjaGVkSW50ZXJjZXB0b3IiLCJmaW5kIiwiaSIsIm1hdGNoIiwic2NvcGUiLCJsb2dnZXIiLCJtYXJrQ29uc3VtZWQiLCJhbGxvd1VubW9ja2VkIiwic29tZSIsIm1hdGNoSG9zdE5hbWUiLCJuZXdSZXEiLCJyZXFTdHIiLCJzdHJpbmdpZnlSZXF1ZXN0Iiwic3RhdHVzQ29kZSIsInN0YXR1cyIsImRlc3Ryb3kiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsS0FBSyxHQUFHQyxPQUFPLENBQUMsT0FBRCxDQUFQLENBQWlCLHdCQUFqQixDQUFkOztBQUNBLGVBSUlBLE9BQU8sQ0FBQyxNQUFELENBSlg7QUFBQSxJQUNFQyxlQURGLFlBQ0VBLGVBREY7QUFBQSxJQUVFQyxhQUZGLFlBRUVBLGFBRkY7QUFBQSxJQUdXQyxtQkFIWCxZQUdFQyxPQUhGOztBQUtBLGdCQUEwQ0osT0FBTyxDQUFDLE9BQUQsQ0FBakQ7QUFBQSxJQUFpQkssb0JBQWpCLGFBQVFELE9BQVI7O0FBQ0EsSUFBTUUsU0FBUyxHQUFHTixPQUFPLENBQUMsV0FBRCxDQUF6Qjs7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a0IsT0FBbEIsR0FDSS9FLG9CQUFvQixDQUFDZ0IsT0FBRCxDQUR4QixHQUVJbEIsbUJBQW1CLENBQUNrQixPQUFELENBSHpCO0FBS0FmLFVBQUFBLFNBQVMsQ0FBQ2dHLE1BQUQsRUFBUzFGLEdBQVQsQ0FBVDtBQUVBMEYsVUFBQUEsTUFBTSxDQUFDcEQsR0FBUCxDQUFXcUMsaUJBQVg7QUFDRCxTQVRELE1BU087QUFDTCxjQUFNZ0IsTUFBTSxHQUFHaEcsTUFBTSxDQUFDaUcsZ0JBQVAsQ0FBd0JuRixPQUF4QixFQUFpQ3NFLGlCQUFqQyxDQUFmO0FBQ0EsY0FBTTNFLEdBQUcsR0FBRyxJQUFJQyxLQUFKLGlDQUF3Q3NGLE1BQXhDLENBQVo7QUFDQXZGLFVBQUFBLEdBQUcsQ0FBQ0UsSUFBSixHQUFXLG1CQUFYO0FBQ0FGLFVBQUFBLEdBQUcsQ0FBQ3lGLFVBQUosR0FBaUJ6RixHQUFHLENBQUMwRixNQUFKLEdBQWEsR0FBOUI7QUFDQTlGLFVBQUFBLEdBQUcsQ0FBQytGLE9BQUosQ0FBWTNGLEdBQVo7QUFDRDtBQUNGO0FBQ0Y7Ozs7O0FBR0g0RixNQUFNLENBQUNDLE9BQVAsR0FBaUI7QUFBRXpGLEVBQUFBLHdCQUF3QixFQUF4QkE7QUFBRixDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5jb25zdCBkZWJ1ZyA9IHJlcXVpcmUoJ2RlYnVnJykoJ25vY2sucmVxdWVzdF9vdmVycmlkZXInKVxuY29uc3Qge1xuICBJbmNvbWluZ01lc3NhZ2UsXG4gIENsaWVudFJlcXVlc3QsXG4gIHJlcXVlc3Q6IG9yaWdpbmFsSHR0cFJlcXVlc3QsXG59ID0gcmVxdWlyZSgnaHR0cCcpXG5jb25zdCB7IHJlcXVlc3Q6IG9yaWdpbmFsSHR0cHNSZXF1ZXN0IH0gPSByZXF1aXJlKCdodHRwcycpXG5jb25zdCBwcm9wYWdhdGUgPSByZXF1aXJlKCdwcm9wYWdhdGUnKVxuY29uc3QgY29tbW9uID0gcmVxdWlyZSgnLi9jb21tb24nKVxuY29uc3QgZ2xvYmFsRW1pdHRlciA9IHJlcXVpcmUoJy4vZ2xvYmFsX2VtaXR0ZXInKVxuY29uc3QgU29ja2V0ID0gcmVxdWlyZSgnLi9zb2NrZXQnKVxuY29uc3QgeyBwbGF5YmFja0ludGVyY2VwdG9yIH0gPSByZXF1aXJlKCcuL3BsYXliYWNrX2ludGVyY2VwdG9yJylcblxuZnVuY3Rpb24gc29ja2V0T25DbG9zZShyZXEpIHtcbiAgZGVidWcoJ3NvY2tldCBjbG9zZScpXG5cbiAgaWYgKCFyZXEucmVzICYmICFyZXEuc29ja2V0Ll9oYWRFcnJvcikge1xuICAgIC8vIElmIHdlIGRvbid0IGhhdmUgYSByZXNwb25zZSB0aGVuIHdlIGtub3cgdGhhdCB0aGUgc29ja2V0XG4gICAgLy8gZW5kZWQgcHJlbWF0dXJlbHkgYW5kIHdlIG5lZWQgdG8gZW1pdCBhbiBlcnJvciBvbiB0aGUgcmVxdWVzdC5cbiAgICByZXEuc29ja2V0Ll9oYWRFcnJvciA9IHRydWVcbiAgICBjb25zdCBlcnIgPSBuZXcgRXJyb3IoJ3NvY2tldCBoYW5nIHVwJylcbiAgICBlcnIuY29kZSA9ICdFQ09OTlJFU0VUJ1xuICAgIHJlcS5lbWl0KCdlcnJvcicsIGVycilcbiAgfVxuICByZXEuZW1pdCgnY2xvc2UnKVxufVxuXG4vKipcbiAqIEdpdmVuIGEgZ3JvdXAgb2YgaW50ZXJjZXB0b3JzLCBhcHByb3ByaWF0ZWx5IHJvdXRlIGFuIG91dGdvaW5nIHJlcXVlc3QuXG4gKiBJZGVudGlmeSB3aGljaCBpbnRlcmNlcHRvciBvdWdodCB0byByZXNwb25kLCBpZiBhbnksIHRoZW4gZGVsZWdhdGUgdG9cbiAqIGBwbGF5YmFja0ludGVyY2VwdG9yKClgIHRvIGNvbnN1bWUgdGhlIHJlcXVlc3QgaXRzZWxmLlxuICovXG5jbGFzcyBJbnRlcmNlcHRlZFJlcXVlc3RSb3V0ZXIge1xuICBjb25zdHJ1Y3Rvcih7IHJlcSwgb3B0aW9ucywgaW50ZXJjZXB0b3JzIH0pIHtcbiAgICB0aGlzLnJlcSA9IHJlcVxuICAgIHRoaXMub3B0aW9ucyA9IHtcbiAgICAgIC8vIFdlIG1heSBiZSBjaGFuZ2luZyB0aGUgb3B0aW9ucyBvYmplY3QgYW5kIHdlIGRvbid0IHdhbnQgdGhvc2UgY2hhbmdlc1xuICAgICAgLy8gYWZmZWN0aW5nIHRoZSB1c2VyIHNvIHdlIHVzZSBhIGNsb25lIG9mIHRoZSBvYmplY3QuXG4gICAgICAuLi5vcHRpb25zLFxuICAgICAgLy8gV2UgdXNlIGxvd2VyLWNhc2UgaGVhZGVyIGZpZWxkIG5hbWVzIHRocm91Z2hvdXQgTm9jay5cbiAgICAgIGhlYWRlcnM6IGNvbW1vbi5oZWFkZXJzRmllbGROYW1lc1RvTG93ZXJDYXNlKG9wdGlvbnMuaGVhZGVycyB8fCB7fSksXG4gICAgfVxuICAgIHRoaXMuaW50ZXJjZXB0b3JzID0gaW50ZXJjZXB0b3JzXG5cbiAgICB0aGlzLnNvY2tldCA9IG5ldyBTb2NrZXQob3B0aW9ucylcblxuICAgIC8vIHN1cHBvcnQgc2V0dGluZyBgdGltZW91dGAgdXNpbmcgcmVxdWVzdCBgb3B0aW9uc2BcbiAgICAvLyBodHRwczovL25vZGVqcy5vcmcvZG9jcy9sYXRlc3QtdjEyLngvYXBpL2h0dHAuaHRtbCNodHRwX2h0dHBfcmVxdWVzdF91cmxfb3B0aW9uc19jYWxsYmFja1xuICAgIGlmIChvcHRpb25zLnRpbWVvdXQpIHtcbiAgICAgIHRoaXMuc29ja2V0LnNldFRpbWVvdXQob3B0aW9ucy50aW1lb3V0KVxuICAgIH1cblxuICAgIHRoaXMucmVzcG9uc2UgPSBuZXcgSW5jb21pbmdNZXNzYWdlKHRoaXMuc29ja2V0KVxuICAgIHRoaXMucmVxdWVzdEJvZHlCdWZmZXJzID0gW11cbiAgICB0aGlzLnBsYXliYWNrU3RhcnRlZCA9IGZhbHNlXG5cbiAgICAvLyBGb3IgcGFyaXR5IHdpdGggTm9kZSwgaXQncyBpbXBvcnRhbnQgdGhlIHNvY2tldCBldmVudCBpcyBlbWl0dGVkIGJlZm9yZSB3ZSBiZWdpbiBwbGF5YmFjay5cbiAgICAvLyBUaGlzIGZsYWcgaXMgc2V0IHdoZW4gcGxheWJhY2sgaXMgdHJpZ2dlcmVkIGlmIHdlIGhhdmVuJ3QgeWV0IGdvdHRlbiB0aGVcbiAgICAvLyBzb2NrZXQgZXZlbnQgdG8gaW5kaWNhdGUgdGhhdCBwbGF5YmFjayBzaG91bGQgc3RhcnQgYXMgc29vbiBhcyBpdCBjb21lcyBpbi5cbiAgICB0aGlzLnJlYWR5VG9TdGFydFBsYXliYWNrT25Tb2NrZXRFdmVudCA9IGZhbHNlXG5cbiAgICB0aGlzLmF0dGFjaFRvUmVxKClcblxuICAgIC8vIEVtaXQgYSBmYWtlIHNvY2tldCBldmVudCBvbiB0aGUgbmV4dCB0aWNrIHRvIG1pbWljIHdoYXQgd291bGQgaGFwcGVuIG9uIGEgcmVhbCByZXF1ZXN0LlxuICAgIC8vIFNvbWUgY2xpZW50cyBsaXN0ZW4gZm9yIGEgJ3NvY2tldCcgZXZlbnQgdG8gYmUgZW1pdHRlZCBiZWZvcmUgY2FsbGluZyBlbmQoKSxcbiAgICAvLyB3aGljaCBjYXVzZXMgTm9jayB0byBoYW5nLlxuICAgIHByb2Nlc3MubmV4dFRpY2soKCkgPT4gdGhpcy5jb25uZWN0U29ja2V0KCkpXG4gIH1cblxuICBhdHRhY2hUb1JlcSgpIHtcbiAgICBjb25zdCB7IHJlcSwgb3B0aW9ucyB9ID0gdGhpc1xuXG4gICAgZm9yIChjb25zdCBbbmFtZSwgdmFsXSBvZiBPYmplY3QuZW50cmllcyhvcHRpb25zLmhlYWRlcnMpKSB7XG4gICAgICByZXEuc2V0SGVhZGVyKG5hbWUudG9Mb3dlckNhc2UoKSwgdmFsKVxuICAgIH1cblxuICAgIGlmIChvcHRpb25zLmF1dGggJiYgIW9wdGlvbnMuaGVhZGVycy5hdXRob3JpemF0aW9uKSB7XG4gICAgICByZXEuc2V0SGVhZGVyKFxuICAgICAgICAvLyBXZSB1c2UgbG93ZXItY2FzZSBoZWFkZXIgZmllbGQgbmFtZXMgdGhyb3VnaG91dCBOb2NrLlxuICAgICAgICAnYXV0aG9yaXphdGlvbicsXG4gICAgICAgIGBCYXNpYyAke0J1ZmZlci5mcm9tKG9wdGlvbnMuYXV0aCkudG9TdHJpbmcoJ2Jhc2U2NCcpfWBcbiAgICAgIClcbiAgICB9XG5cbiAgICByZXEucGF0aCA9IG9wdGlvbnMucGF0aFxuICAgIHJlcS5tZXRob2QgPSBvcHRpb25zLm1ldGhvZFxuXG4gICAgcmVxLndyaXRlID0gKC4uLmFyZ3MpID0+IHRoaXMuaGFuZGxlV3JpdGUoLi4uYXJncylcbiAgICByZXEuZW5kID0gKC4uLmFyZ3MpID0+IHRoaXMuaGFuZGxlRW5kKC4uLmFyZ3MpXG4gICAgcmVxLmZsdXNoSGVhZGVycyA9ICguLi5hcmdzKSA9PiB0aGlzLmhhbmRsZUZsdXNoSGVhZGVycyguLi5hcmdzKVxuXG4gICAgLy8gaHR0cHM6Ly9naXRodWIuY29tL25vY2svbm9jay9pc3N1ZXMvMjU2XG4gICAgaWYgKG9wdGlvbnMuaGVhZGVycy5leHBlY3QgPT09ICcxMDAtY29udGludWUnKSB7XG4gICAgICBjb21tb24uc2V0SW1tZWRpYXRlKCgpID0+IHtcbiAgICAgICAgZGVidWcoJ2NvbnRpbnVlJylcbiAgICAgICAgcmVxLmVtaXQoJ2NvbnRpbnVlJylcbiAgICAgIH0pXG4gICAgfVxuICB9XG5cbiAgY29ubmVjdFNvY2tldCgpIHtcbiAgICBjb25zdCB7IHJlcSwgc29ja2V0IH0gPSB0aGlzXG5cbiAgICBpZiAoY29tbW9uLmlzUmVxdWVzdERlc3Ryb3llZChyZXEpKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICAvLyBDbGllbnRSZXF1ZXN0LmNvbm5lY3Rpb24gaXMgYW4gYWxpYXMgZm9yIENsaWVudFJlcXVlc3Quc29ja2V0XG4gICAgLy8gaHR0cHM6Ly9ub2RlanMub3JnL2FwaS9odHRwLmh0bWwjaHR0cF9yZXF1ZXN0X3NvY2tldFxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2RlanMvbm9kZS9ibG9iL2IwZjc1ODE4ZjM5ZWQ0ZTZiZDgwZWI3YzQwMTBjMWRhZjU4MjNlZjcvbGliL19odHRwX2NsaWVudC5qcyNMNjQwLUw2NDFcbiAgICAvLyBUaGUgc2FtZSBTb2NrZXQgaXMgc2hhcmVkIGJldHdlZW4gdGhlIHJlcXVlc3QgYW5kIHJlc3BvbnNlIHRvIG1pbWljIG5hdGl2ZSBiZWhhdmlvci5cbiAgICByZXEuc29ja2V0ID0gcmVxLmNvbm5lY3Rpb24gPSBzb2NrZXRcblxuICAgIHByb3BhZ2F0ZShbJ2Vycm9yJywgJ3RpbWVvdXQnXSwgc29ja2V0LCByZXEpXG4gICAgc29ja2V0Lm9uKCdjbG9zZScsICgpID0+IHNvY2tldE9uQ2xvc2UocmVxKSlcblxuICAgIHNvY2tldC5jb25uZWN0aW5nID0gZmFsc2VcbiAgICByZXEuZW1pdCgnc29ja2V0Jywgc29ja2V0KVxuXG4gICAgLy8gaHR0cHM6Ly9ub2RlanMub3JnL2FwaS9uZXQuaHRtbCNuZXRfZXZlbnRfY29ubmVjdFxuICAgIHNvY2tldC5lbWl0KCdjb25uZWN0JylcblxuICAgIC8vIGh0dHBzOi8vbm9kZWpzLm9yZy9hcGkvdGxzLmh0bWwjdGxzX2V2ZW50X3NlY3VyZWNvbm5lY3RcbiAgICBpZiAoc29ja2V0LmF1dGhvcml6ZWQpIHtcbiAgICAgIHNvY2tldC5lbWl0KCdzZWN1cmVDb25uZWN0JylcbiAgICB9XG5cbiAgICBpZiAodGhpcy5yZWFkeVRvU3RhcnRQbGF5YmFja09uU29ja2V0RXZlbnQpIHtcbiAgICAgIHRoaXMubWF5YmVTdGFydFBsYXliYWNrKClcbiAgICB9XG4gIH1cblxuICAvLyBmcm9tIGRvY3M6IFdoZW4gd3JpdGUgZnVuY3Rpb24gaXMgY2FsbGVkIHdpdGggZW1wdHkgc3RyaW5nIG9yIGJ1ZmZlciwgaXQgZG9lcyBub3RoaW5nIGFuZCB3YWl0cyBmb3IgbW9yZSBpbnB1dC5cbiAgLy8gSG93ZXZlciwgYWN0dWFsbHkgaW1wbGVtZW50YXRpb24gY2hlY2tzIHRoZSBzdGF0ZSBvZiBmaW5pc2hlZCBhbmQgYWJvcnRlZCBiZWZvcmUgY2hlY2tpbmcgaWYgdGhlIGZpcnN0IGFyZyBpcyBlbXB0eS5cbiAgaGFuZGxlV3JpdGUoYnVmZmVyLCBlbmNvZGluZywgY2FsbGJhY2spIHtcbiAgICBkZWJ1ZygncmVxdWVzdCB3cml0ZScpXG4gICAgY29uc3QgeyByZXEgfSA9IHRoaXNcblxuICAgIGlmIChyZXEuZmluaXNoZWQpIHtcbiAgICAgIGNvbnN0IGVyciA9IG5ldyBFcnJvcignd3JpdGUgYWZ0ZXIgZW5kJylcbiAgICAgIGVyci5jb2RlID0gJ0VSUl9TVFJFQU1fV1JJVEVfQUZURVJfRU5EJ1xuICAgICAgcHJvY2Vzcy5uZXh0VGljaygoKSA9PiByZXEuZW1pdCgnZXJyb3InLCBlcnIpKVxuXG4gICAgICAvLyBJdCBzZWVtcyBvZGQgdG8gcmV0dXJuIGB0cnVlYCBoZXJlLCBub3Qgc3VyZSB3aHkgeW91J2Qgd2FudCB0byBoYXZlXG4gICAgICAvLyB0aGUgc3RyZWFtIHBvdGVudGlhbGx5IHdyaXR0ZW4gdG8gbW9yZSwgYnV0IGl0J3Mgd2hhdCBOb2RlIGRvZXMuXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUvYmxvYi9hOTI3MGRjYmViYTQzMTZiMWUxNzliNzdlY2I2YzQ2YWY1YWE4YzIwL2xpYi9faHR0cF9vdXRnb2luZy5qcyNMNjYyLUw2NjVcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgaWYgKHJlcS5zb2NrZXQgJiYgcmVxLnNvY2tldC5kZXN0cm95ZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGlmICghYnVmZmVyIHx8IGJ1ZmZlci5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoYnVmZmVyKSkge1xuICAgICAgYnVmZmVyID0gQnVmZmVyLmZyb20oYnVmZmVyLCBlbmNvZGluZylcbiAgICB9XG4gICAgdGhpcy5yZXF1ZXN0Qm9keUJ1ZmZlcnMucHVzaChidWZmZXIpXG5cbiAgICAvLyBjYW4ndCB1c2UgaW5zdGFuY2VvZiBGdW5jdGlvbiBiZWNhdXNlIHNvbWUgdGVzdCBydW5uZXJzXG4gICAgLy8gcnVuIHRlc3RzIGluIHZtLnJ1bkluTmV3Q29udGV4dCB3aGVyZSBGdW5jdGlvbiBpcyBub3Qgc2FtZVxuICAgIC8vIGFzIHRoYXQgaW4gdGhlIGN1cnJlbnQgY29udGV4dFxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2NrL25vY2svcHVsbC8xNzU0I2lzc3VlY29tbWVudC01NzE1MzE0MDdcbiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjYWxsYmFjaygpXG4gICAgfVxuXG4gICAgY29tbW9uLnNldEltbWVkaWF0ZShmdW5jdGlvbiAoKSB7XG4gICAgICByZXEuZW1pdCgnZHJhaW4nKVxuICAgIH0pXG5cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIGhhbmRsZUVuZChjaHVuaywgZW5jb2RpbmcsIGNhbGxiYWNrKSB7XG4gICAgZGVidWcoJ3JlcXVlc3QgZW5kJylcbiAgICBjb25zdCB7IHJlcSB9ID0gdGhpc1xuXG4gICAgLy8gaGFuZGxlIHRoZSBkaWZmZXJlbnQgb3ZlcmxvYWRlZCBhcmcgc2lnbmF0dXJlc1xuICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgIGNhbGxiYWNrID0gY2h1bmtcbiAgICAgIGNodW5rID0gbnVsbFxuICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBjYWxsYmFjayA9IGVuY29kaW5nXG4gICAgICBlbmNvZGluZyA9IG51bGxcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIGNhbGxiYWNrID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXEub25jZSgnZmluaXNoJywgY2FsbGJhY2spXG4gICAgfVxuXG4gICAgaWYgKGNodW5rKSB7XG4gICAgICByZXEud3JpdGUoY2h1bmssIGVuY29kaW5nKVxuICAgIH1cbiAgICByZXEuZmluaXNoZWQgPSB0cnVlXG4gICAgdGhpcy5tYXliZVN0YXJ0UGxheWJhY2soKVxuXG4gICAgcmV0dXJuIHJlcVxuICB9XG5cbiAgaGFuZGxlRmx1c2hIZWFkZXJzKCkge1xuICAgIGRlYnVnKCdyZXF1ZXN0IGZsdXNoSGVhZGVycycpXG4gICAgdGhpcy5tYXliZVN0YXJ0UGxheWJhY2soKVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCByZXF1ZXN0IGhlYWRlcnMgb2YgdGhlIGdpdmVuIHJlcXVlc3QuIFRoaXMgaXMgbmVlZGVkIGJvdGggZHVyaW5nIHRoZVxuICAgKiByb3V0aW5nIHBoYXNlLCBpbiBjYXNlIGhlYWRlciBmaWx0ZXJzIHdlcmUgc3BlY2lmaWVkLCBhbmQgZHVyaW5nIHRoZVxuICAgKiBpbnRlcmNlcHRvci1wbGF5YmFjayBwaGFzZSwgdG8gY29ycmVjdGx5IHBhc3MgbW9ja2VkIHJlcXVlc3QgaGVhZGVycy5cbiAgICogVE9ETyBUaGVyZSBhcmUgc29tZSBwcm9ibGVtcyB3aXRoIHRoaXM7IHNlZSBodHRwczovL2dpdGh1Yi5jb20vbm9jay9ub2NrL2lzc3Vlcy8xNzE4XG4gICAqL1xuICBzZXRIb3N0SGVhZGVyVXNpbmdJbnRlcmNlcHRvcihpbnRlcmNlcHRvcikge1xuICAgIGNvbnN0IHsgcmVxLCBvcHRpb25zIH0gPSB0aGlzXG5cbiAgICAvLyBJZiBhIGZpbHRlcmVkIHNjb3BlIGlzIGJlaW5nIHVzZWQgd2UgaGF2ZSB0byB1c2Ugc2NvcGUncyBob3N0IGluIHRoZVxuICAgIC8vIGhlYWRlciwgb3RoZXJ3aXNlICdob3N0JyBoZWFkZXIgd29uJ3QgbWF0Y2guXG4gICAgLy8gTk9URTogV2UgdXNlIGxvd2VyLWNhc2UgaGVhZGVyIGZpZWxkIG5hbWVzIHRocm91Z2hvdXQgTm9jay5cbiAgICBjb25zdCBIT1NUX0hFQURFUiA9ICdob3N0J1xuICAgIGlmIChpbnRlcmNlcHRvci5fX25vY2tfZmlsdGVyZWRTY29wZSAmJiBpbnRlcmNlcHRvci5fX25vY2tfc2NvcGVIb3N0KSB7XG4gICAgICBvcHRpb25zLmhlYWRlcnNbSE9TVF9IRUFERVJdID0gaW50ZXJjZXB0b3IuX19ub2NrX3Njb3BlSG9zdFxuICAgICAgcmVxLnNldEhlYWRlcihIT1NUX0hFQURFUiwgaW50ZXJjZXB0b3IuX19ub2NrX3Njb3BlSG9zdClcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gRm9yIGFsbCBvdGhlciBjYXNlcywgd2UgYWx3YXlzIGFkZCBob3N0IGhlYWRlciBlcXVhbCB0byB0aGUgcmVxdWVzdGVkXG4gICAgICAvLyBob3N0IHVubGVzcyBpdCB3YXMgYWxyZWFkeSBkZWZpbmVkLlxuICAgICAgaWYgKG9wdGlvbnMuaG9zdCAmJiAhcmVxLmdldEhlYWRlcihIT1NUX0hFQURFUikpIHtcbiAgICAgICAgbGV0IGhvc3RIZWFkZXIgPSBvcHRpb25zLmhvc3RcblxuICAgICAgICBpZiAob3B0aW9ucy5wb3J0ID09PSA4MCB8fCBvcHRpb25zLnBvcnQgPT09IDQ0Mykge1xuICAgICAgICAgIGhvc3RIZWFkZXIgPSBob3N0SGVhZGVyLnNwbGl0KCc6JylbMF1cbiAgICAgICAgfVxuXG4gICAgICAgIHJlcS5zZXRIZWFkZXIoSE9TVF9IRUFERVIsIGhvc3RIZWFkZXIpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgbWF5YmVTdGFydFBsYXliYWNrKCkge1xuICAgIGNvbnN0IHsgcmVxLCBzb2NrZXQsIHBsYXliYWNrU3RhcnRlZCB9ID0gdGhpc1xuXG4gICAgLy8gSW4gb3JkZXIgdG8gZ2V0IHRoZSBldmVudHMgaW4gdGhlIHJpZ2h0IG9yZGVyIHdlIG5lZWQgdG8gZGVsYXkgcGxheWJhY2tcbiAgICAvLyBpZiB3ZSBnZXQgaGVyZSBiZWZvcmUgdGhlIGBzb2NrZXRgIGV2ZW50IGlzIGVtaXR0ZWQuXG4gICAgaWYgKHNvY2tldC5jb25uZWN0aW5nKSB7XG4gICAgICB0aGlzLnJlYWR5VG9TdGFydFBsYXliYWNrT25Tb2NrZXRFdmVudCA9IHRydWVcbiAgICAgIHJldHVyblxuICAgIH1cblxuICAgIGlmICghY29tbW9uLmlzUmVxdWVzdERlc3Ryb3llZChyZXEpICYmICFwbGF5YmFja1N0YXJ0ZWQpIHtcbiAgICAgIHRoaXMuc3RhcnRQbGF5YmFjaygpXG4gICAgfVxuICB9XG5cbiAgc3RhcnRQbGF5YmFjaygpIHtcbiAgICBkZWJ1ZygnZW5kaW5nJylcbiAgICB0aGlzLnBsYXliYWNrU3RhcnRlZCA9IHRydWVcblxuICAgIGNvbnN0IHsgcmVxLCByZXNwb25zZSwgc29ja2V0LCBvcHRpb25zLCBpbnRlcmNlcHRvcnMgfSA9IHRoaXNcblxuICAgIE9iamVjdC5hc3NpZ24ob3B0aW9ucywge1xuICAgICAgLy8gUmUtdXBkYXRlIGBvcHRpb25zYCB3aXRoIHRoZSBjdXJyZW50IHZhbHVlIG9mIGByZXEucGF0aGAgYmVjYXVzZSBiYWRseVxuICAgICAgLy8gYmVoYXZpbmcgYWdlbnRzIGxpa2Ugc3VwZXJhZ2VudCBsaWtlIHRvIGNoYW5nZSBgcmVxLnBhdGhgIG1pZC1mbGlnaHQuXG4gICAgICBwYXRoOiByZXEucGF0aCxcbiAgICAgIC8vIFNpbWlsYXJseSwgbm9kZS1odHRwLXByb3h5IHdpbGwgbW9kaWZ5IGhlYWRlcnMgaW4gZmxpZ2h0LCBzbyB3ZSBoYXZlXG4gICAgICAvLyB0byBwdXQgdGhlIGhlYWRlcnMgYmFjayBpbnRvIG9wdGlvbnMuXG4gICAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9jay9ub2NrL3B1bGwvMTQ4NFxuICAgICAgaGVhZGVyczogcmVxLmdldEhlYWRlcnMoKSxcbiAgICAgIC8vIEZpeGVzIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2NrL25vY2svaXNzdWVzLzk3NlxuICAgICAgcHJvdG9jb2w6IGAke29wdGlvbnMucHJvdG99OmAsXG4gICAgfSlcblxuICAgIGludGVyY2VwdG9ycy5mb3JFYWNoKGludGVyY2VwdG9yID0+IHtcbiAgICAgIHRoaXMuc2V0SG9zdEhlYWRlclVzaW5nSW50ZXJjZXB0b3IoaW50ZXJjZXB0b3IpXG4gICAgfSlcblxuICAgIGNvbnN0IHJlcXVlc3RCb2R5QnVmZmVyID0gQnVmZmVyLmNvbmNhdCh0aGlzLnJlcXVlc3RCb2R5QnVmZmVycylcbiAgICAvLyBXaGVuIHJlcXVlc3QgYm9keSBpcyBhIGJpbmFyeSBidWZmZXIgd2UgaW50ZXJuYWxseSB1c2UgaW4gaXRzIGhleGFkZWNpbWFsXG4gICAgLy8gcmVwcmVzZW50YXRpb24uXG4gICAgY29uc3QgcmVxdWVzdEJvZHlJc1V0ZjhSZXByZXNlbnRhYmxlID0gY29tbW9uLmlzVXRmOFJlcHJlc2VudGFibGUoXG4gICAgICByZXF1ZXN0Qm9keUJ1ZmZlclxuICAgIClcbiAgICBjb25zdCByZXF1ZXN0Qm9keVN0cmluZyA9IHJlcXVlc3RCb2R5QnVmZmVyLnRvU3RyaW5nKFxuICAgICAgcmVxdWVzdEJvZHlJc1V0ZjhSZXByZXNlbnRhYmxlID8gJ3V0ZjgnIDogJ2hleCdcbiAgICApXG5cbiAgICBjb25zdCBtYXRjaGVkSW50ZXJjZXB0b3IgPSBpbnRlcmNlcHRvcnMuZmluZChpID0+XG4gICAgICBpLm1hdGNoKHJlcSwgb3B0aW9ucywgcmVxdWVzdEJvZHlTdHJpbmcpXG4gICAgKVxuXG4gICAgaWYgKG1hdGNoZWRJbnRlcmNlcHRvcikge1xuICAgICAgbWF0Y2hlZEludGVyY2VwdG9yLnNjb3BlLmxvZ2dlcihcbiAgICAgICAgJ2ludGVyY2VwdG9yIGlkZW50aWZpZWQsIHN0YXJ0aW5nIG1vY2tpbmcnXG4gICAgICApXG5cbiAgICAgIG1hdGNoZWRJbnRlcmNlcHRvci5tYXJrQ29uc3VtZWQoKVxuXG4gICAgICAvLyB3YWl0IHRvIGVtaXQgdGhlIGZpbmlzaCBldmVudCB1bnRpbCB3ZSBrbm93IGZvciBzdXJlIGFuIEludGVyY2VwdG9yIGlzIGdvaW5nIHRvIHBsYXliYWNrLlxuICAgICAgLy8gb3RoZXJ3aXNlIGFuIHVubW9ja2VkIHJlcXVlc3QgbWlnaHQgZW1pdCBmaW5pc2ggdHdpY2UuXG4gICAgICByZXEuZW1pdCgnZmluaXNoJylcblxuICAgICAgcGxheWJhY2tJbnRlcmNlcHRvcih7XG4gICAgICAgIHJlcSxcbiAgICAgICAgc29ja2V0LFxuICAgICAgICBvcHRpb25zLFxuICAgICAgICByZXF1ZXN0Qm9keVN0cmluZyxcbiAgICAgICAgcmVxdWVzdEJvZHlJc1V0ZjhSZXByZXNlbnRhYmxlLFxuICAgICAgICByZXNwb25zZSxcbiAgICAgICAgaW50ZXJjZXB0b3I6IG1hdGNoZWRJbnRlcmNlcHRvcixcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGdsb2JhbEVtaXR0ZXIuZW1pdCgnbm8gbWF0Y2gnLCByZXEsIG9wdGlvbnMsIHJlcXVlc3RCb2R5U3RyaW5nKVxuXG4gICAgICAvLyBUcnkgdG8gZmluZCBhIGhvc3RuYW1lIG1hdGNoIHRoYXQgYWxsb3dzIHVubW9ja2VkLlxuICAgICAgY29uc3QgYWxsb3dVbm1vY2tlZCA9IGludGVyY2VwdG9ycy5zb21lKFxuICAgICAgICBpID0+IGkubWF0Y2hIb3N0TmFtZShvcHRpb25zKSAmJiBpLm9wdGlvbnMuYWxsb3dVbm1vY2tlZFxuICAgICAgKVxuXG4gICAgICBpZiAoYWxsb3dVbm1vY2tlZCAmJiByZXEgaW5zdGFuY2VvZiBDbGllbnRSZXF1ZXN0KSB7XG4gICAgICAgIGNvbnN0IG5ld1JlcSA9XG4gICAgICAgICAgb3B0aW9ucy5wcm90byA9PT0gJ2h0dHBzJ1xuICAgICAgICAgICAgPyBvcmlnaW5hbEh0dHBzUmVxdWVzdChvcHRpb25zKVxuICAgICAgICAgICAgOiBvcmlnaW5hbEh0dHBSZXF1ZXN0KG9wdGlvbnMpXG5cbiAgICAgICAgcHJvcGFnYXRlKG5ld1JlcSwgcmVxKVxuICAgICAgICAvLyBXZSBzZW5kIHRoZSByYXcgYnVmZmVyIGFzIHdlIHJlY2VpdmVkIGl0LCBub3QgYXMgd2UgaW50ZXJwcmV0ZWQgaXQuXG4gICAgICAgIG5ld1JlcS5lbmQocmVxdWVzdEJvZHlCdWZmZXIpXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCByZXFTdHIgPSBjb21tb24uc3RyaW5naWZ5UmVxdWVzdChvcHRpb25zLCByZXF1ZXN0Qm9keVN0cmluZylcbiAgICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKGBOb2NrOiBObyBtYXRjaCBmb3IgcmVxdWVzdCAke3JlcVN0cn1gKVxuICAgICAgICBlcnIuY29kZSA9ICdFUlJfTk9DS19OT19NQVRDSCdcbiAgICAgICAgZXJyLnN0YXR1c0NvZGUgPSBlcnIuc3RhdHVzID0gNDA0XG4gICAgICAgIHJlcS5kZXN0cm95KGVycilcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9ydHMgPSB7IEludGVyY2VwdGVkUmVxdWVzdFJvdXRlciB9XG4iXX0=