543311fc3d7099f7debb19646b8bdcbc
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var assert = require('assert');

var recorder = require("./recorder");

var _require = require("./intercept"),
    activate = _require.activate,
    disableNetConnect = _require.disableNetConnect,
    enableNetConnect = _require.enableNetConnect,
    cleanAll = _require.removeAll;

var _require2 = require("./scope"),
    loadDefs = _require2.loadDefs,
    define = _require2.define;

var _require3 = require('util'),
    format = _require3.format;

var path = require('path');

var debug = require('debug')('nock.back');

var _mode = null;
var fs;

try {
  fs = require('fs');
} catch (err) {}

function Back(fixtureName, options, nockedFn) {
  if (!Back.fixtures) {
    throw new Error('Back requires nock.back.fixtures to be set\n' + 'Ex:\n' + "\trequire(nock).back.fixtures = '/path/to/fixtures/'");
  }

  if (typeof fixtureName !== 'string') {
    throw new Error('Parameter fixtureName must be a string');
  }

  if (arguments.length === 1) {
    options = {};
  } else if (arguments.length === 2) {
    if (typeof options === 'function') {
      nockedFn = options;
      options = {};
    }
  }

  _mode.setup();

  var fixture = path.join(Back.fixtures, fixtureName);

  var context = _mode.start(fixture, options);

  var nockDone = function nockDone() {
    _mode.finish(fixture, options, context);
  };

  debug('context:', context);

  if (typeof nockedFn === 'function') {
    nockedFn.call(context, nockDone);
  } else {
    return Promise.resolve({
      nockDone: nockDone,
      context: context
    });
  }
}

var wild = {
  setup: function setup() {
    cleanAll();
    recorder.restore();
    activate();
    enableNetConnect();
  },
  start: function start() {
    return load();
  },
  finish: function finish() {}
};
var dryrun = {
  setup: function setup() {
    recorder.restore();
    cleanAll();
    activate();
    enableNetConnect();
  },
  start: function start(fixture, options) {
    var contexts = load(fixture, options);
    enableNetConnect();
    return contexts;
  },
  finish: function finish() {}
};
var record = {
  setup: function setup() {
    recorder.restore();
    recorder.clear();
    cleanAll();
    activate();
    disableNetConnect();
  },
  start: function start(fixture, options) {
    if (!fs) {
      throw new Error('no fs');
    }

    var context = load(fixture, options);

    if (!context.isLoaded) {
      recorder.record((0, _extends2.default)({
        dont_print: true,
        output_objects: true
      }, options.recorder));
      context.isRecording = true;
    }

    return context;
  },
  finish: function finish(fixture, options, context) {
    if (context.isRecording) {
      var outputs = recorder.outputs();

      if (typeof options.afterRecord === 'function') {
        outputs = options.afterRecord(outputs);
      }

      outputs = typeof outputs === 'string' ? outputs : JSON.stringify(outputs, null, 4);
      debug('recorder outputs:', outputs);
      fs.mkdirSync(path.dirname(fixture), {
        recursive: true
      });
      fs.writeFileSync(fixture, outputs);
    }
  }
};
var lockdown = {
  setup: function setup() {
    recorder.restore();
    recorder.clear();
    cleanAll();
    activate();
    disableNetConnect();
  },
  start: function start(fixture, options) {
    return load(fixture, options);
  },
  finish: function finish() {}
};

function load(fixture, options) {
  var context = {
    scopes: [],
    assertScopesFinished: function assertScopesFinished() {
      assertScopes(this.scopes, fixture);
    }
  };

  if (fixture && fixtureExists(fixture)) {
    var scopes = loadDefs(fixture);
    applyHook(scopes, options.before);
    scopes = define(scopes);
    applyHook(scopes, options.after);
    context.scopes = scopes;
    context.isLoaded = true;
  }

  return context;
}

function applyHook(scopes, fn) {
  if (!fn) {
    return;
  }

  if (typeof fn !== 'function') {
    throw new Error('processing hooks must be a function');
  }

  scopes.forEach(fn);
}

function fixtureExists(fixture) {
  if (!fs) {
    throw new Error('no fs');
  }

  return fs.existsSync(fixture);
}

function assertScopes(scopes, fixture) {
  var pending = scopes.filter(function (scope) {
    return !scope.isDone();
  }).map(function (scope) {
    return scope.pendingMocks();
  });

  if (pending.length) {
    var _ref;

    assert.fail(format('%j was not used, consider removing %s to rerecord fixture', (_ref = []).concat.apply(_ref, (0, _toConsumableArray2.default)(pending)), fixture));
  }
}

var Modes = {
  wild: wild,
  dryrun: dryrun,
  record: record,
  lockdown: lockdown
};

Back.setMode = function (mode) {
  if (!(mode in Modes)) {
    throw new Error("Unknown mode: " + mode);
  }

  Back.currentMode = mode;
  debug('New nock back mode:', Back.currentMode);
  _mode = Modes[mode];

  _mode.setup();
};

Back.fixtures = null;
Back.currentMode = null;
module.exports = Back;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImJhY2suanMiXSwibmFtZXMiOlsiYXNzZXJ0IiwicmVxdWlyZSIsInJlY29yZGVyIiwiYWN0aXZhdGUiLCJkaXNhYmxlTmV0Q29ubmVjdCIsImVuYWJsZU5ldENvbm5lY3QiLCJjbGVhbkFsbCIsInJlbW92ZUFsbCIsImxvYWREZWZzIiwiZGVmaW5lIiwiZm9ybWF0IiwicGF0aCIsImRlYnVnIiwiX21vZGUiLCJmcyIsImVyciIsIkJhY2siLCJmaXh0dXJlTmFtZSIsIm9wdGlvbnMiLCJub2NrZWRGbiIsImZpeHR1cmVzIiwiRXJyb3IiLCJhcmd1bWVudHMiLCJsZW5ndGgiLCJzZXR1cCIsImZpeHR1cmUiLCJqb2luIiwiY29udGV4dCIsInN0YXJ0Iiwibm9ja0RvbmUiLCJmaW5pc2giLCJjYWxsIiwiUHJvbWlzZSIsInJlc29sdmUiLCJ3aWxkIiwicmVzdG9yZSIsImxvYWQiLCJkcnlydW4iLCJjb250ZXh0cyIsInJlY29yZCIsImNsZWFyIiwiaXNMb2FkZWQiLCJkb250X3ByaW50Iiwib3V0cHV0X29iamVjdHMiLCJpc1JlY29yZGluZyIsIm91dHB1dHMiLCJhZnRlclJlY29yZCIsIkpTT04iLCJzdHJpbmdpZnkiLCJta2RpclN5bmMiLCJkaXJuYW1lIiwicmVjdXJzaXZlIiwid3JpdGVGaWxlU3luYyIsImxvY2tkb3duIiwic2NvcGVzIiwiYXNzZXJ0U2NvcGVzRmluaXNoZWQiLCJhc3NlcnRTY29wZXMiLCJmaXh0dXJlRXhpc3RzIiwiYXBwbHlIb29rIiwiYmVmb3JlIiwiYWZ0ZXIiLCJmbiIsImZvckVhY2giLCJleGlzdHNTeW5jIiwicGVuZGluZyIsImZpbHRlciIsInNjb3BlIiwiaXNEb25lIiwibWFwIiwicGVuZGluZ01vY2tzIiwiZmFpbCIsImNvbmNhdCIsIk1vZGVzIiwic2V0TW9kZSIsIm1vZGUiLCJjdXJyZW50TW9kZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7OztBQUVBLElBQU1BLE1BQU0sR0FBR0Ms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QUFBLEtBQUssQ0FBQyxxQkFBRCxFQUF3QkksSUFBSSxDQUFDMkQsV0FBN0IsQ0FBTDtBQUVBOUQsRUFBQUEsS0FBSyxHQUFHMkQsS0FBSyxDQUFDRSxJQUFELENBQWI7O0FBQ0E3RCxFQUFBQSxLQUFLLENBQUNXLEtBQU47QUFDRCxDQVZEOztBQVlBUixJQUFJLENBQUNJLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQUosSUFBSSxDQUFDMkQsV0FBTCxHQUFtQixJQUFuQjtBQUVBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUI3RCxJQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5jb25zdCBhc3NlcnQgPSByZXF1aXJlKCdhc3NlcnQnKVxuY29uc3QgcmVjb3JkZXIgPSByZXF1aXJlKCcuL3JlY29yZGVyJylcbmNvbnN0IHtcbiAgYWN0aXZhdGUsXG4gIGRpc2FibGVOZXRDb25uZWN0LFxuICBlbmFibGVOZXRDb25uZWN0LFxuICByZW1vdmVBbGw6IGNsZWFuQWxsLFxufSA9IHJlcXVpcmUoJy4vaW50ZXJjZXB0JylcbmNvbnN0IHsgbG9hZERlZnMsIGRlZmluZSB9ID0gcmVxdWlyZSgnLi9zY29wZScpXG5cbmNvbnN0IHsgZm9ybWF0IH0gPSByZXF1aXJlKCd1dGlsJylcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJylcbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnbm9jay5iYWNrJylcblxubGV0IF9tb2RlID0gbnVsbFxuXG5sZXQgZnNcblxudHJ5IHtcbiAgZnMgPSByZXF1aXJlKCdmcycpXG59IGNhdGNoIChlcnIpIHtcbiAgLy8gZG8gbm90aGluZywgcHJvYmFibHkgaW4gYnJvd3NlclxufVxuXG4vKipcbiAqIG5vY2sgdGhlIGN1cnJlbnQgZnVuY3Rpb24gd2l0aCB0aGUgZml4dHVyZSBnaXZlblxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSAgIGZpeHR1cmVOYW1lICAtIHRoZSBuYW1lIG9mIHRoZSBmaXh0dXJlLCBlLnguICdmb28uanNvbidcbiAqIEBwYXJhbSB7b2JqZWN0fSAgIG9wdGlvbnMgICAgICAtIFtvcHRpb25hbF0gZXh0cmEgb3B0aW9ucyBmb3Igbm9jayB3aXRoLCBlLnguIGB7IGFzc2VydDogdHJ1ZSB9YFxuICogQHBhcmFtIHtmdW5jdGlvbn0gbm9ja2VkRm4gICAgIC0gW29wdGlvbmFsXSBjYWxsYmFjayBmdW5jdGlvbiB0byBiZSBleGVjdXRlZCB3aXRoIHRoZSBnaXZlbiBmaXh0dXJlIGJlaW5nIGxvYWRlZDtcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGRlZmluZWQgdGhlIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIHdpdGggY29udGV4dCBgeyBzY29wZXM6IGxvYWRlZF9ub2NrcyB8fCBbXSB9YFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2V0IGFzIGB0aGlzYCBhbmQgYG5vY2tEb25lYCBjYWxsYmFjayBmdW5jdGlvbiBhcyBmaXJzdCBhbmQgb25seSBwYXJhbWV0ZXI7XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3QgZGVmaW5lZCBhIHByb21pc2UgcmVzb2x2aW5nIHRvIGB7bm9ja0RvbmUsIGNvbnRleHR9YCB3aGVyZSBgY29udGV4dGAgaXNcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFmb3JlbWVudGlvbmVkIGB7IHNjb3BlczogbG9hZGVkX25vY2tzIHx8IFtdIH1gXG4gKlxuICogTGlzdCBvZiBvcHRpb25zOlxuICpcbiAqIEBwYXJhbSB7ZnVuY3Rpb259IGJlZm9yZSAgICAgICAtIGEgcHJlcHJvY2Vzc2luZyBmdW5jdGlvbiwgZ2V0cyBjYWxsZWQgYmVmb3JlIG5vY2suZGVmaW5lXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSBhZnRlciAgICAgICAgLSBhIHBvc3Rwcm9jZXNzaW5nIGZ1bmN0aW9uLCBnZXRzIGNhbGxlZCBhZnRlciBub2NrLmRlZmluZVxuICogQHBhcmFtIHtmdW5jdGlvbn0gYWZ0ZXJSZWNvcmQgIC0gYSBwb3N0cHJvY2Vzc2luZyBmdW5jdGlvbiwgZ2V0cyBjYWxsZWQgYWZ0ZXIgcmVjb3JkaW5nLiBJcyBwYXNzZWQgdGhlIGFycmF5XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvZiBzY29wZXMgcmVjb3JkZWQgYW5kIHNob3VsZCByZXR1cm4gdGhlIGFycmF5IHNjb3BlcyB0byBzYXZlIHRvIHRoZSBmaXh0dXJlXG4gKiBAcGFyYW0ge2Z1bmN0aW9ufSByZWNvcmRlciAgICAgLSBjdXN0b20gb3B0aW9ucyB0byBwYXNzIHRvIHRoZSByZWNvcmRlclxuICpcbiAqL1xuZnVuY3Rpb24gQmFjayhmaXh0dXJlTmFtZSwgb3B0aW9ucywgbm9ja2VkRm4pIHtcbiAgaWYgKCFCYWNrLmZpeHR1cmVzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgJ0JhY2sgcmVxdWlyZXMgbm9jay5iYWNrLmZpeHR1cmVzIHRvIGJlIHNldFxcbicgK1xuICAgICAgICAnRXg6XFxuJyArXG4gICAgICAgIFwiXFx0cmVxdWlyZShub2NrKS5iYWNrLmZpeHR1cmVzID0gJy9wYXRoL3RvL2ZpeHR1cmVzLydcIlxuICAgIClcbiAgfVxuXG4gIGlmICh0eXBlb2YgZml4dHVyZU5hbWUgIT09ICdzdHJpbmcnKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdQYXJhbWV0ZXIgZml4dHVyZU5hbWUgbXVzdCBiZSBhIHN0cmluZycpXG4gIH1cblxuICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMSkge1xuICAgIG9wdGlvbnMgPSB7fVxuICB9IGVsc2UgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDIpIHtcbiAgICAvLyBJZiAybmQgcGFyYW1ldGVyIGlzIGEgZnVuY3Rpb24gdGhlbiBgb3B0aW9uc2AgaGFzIGJlZW4gb21pdHRlZFxuICAgIC8vIG90aGVyd2lzZSBgb3B0aW9uc2AgaGF2ZW4ndCBiZWVuIG9taXR0ZWQgYnV0IGBub2NrZWRGbmAgd2FzLlxuICAgIGlmICh0eXBlb2Ygb3B0aW9ucyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgbm9ja2VkRm4gPSBvcHRpb25zXG4gICAgICBvcHRpb25zID0ge31cbiAgICB9XG4gIH1cblxuICBfbW9kZS5zZXR1cCgpXG5cbiAgY29uc3QgZml4dHVyZSA9IHBhdGguam9pbihCYWNrLmZpeHR1cmVzLCBmaXh0dXJlTmFtZSlcbiAgY29uc3QgY29udGV4dCA9IF9tb2RlLnN0YXJ0KGZpeHR1cmUsIG9wdGlvbnMpXG5cbiAgY29uc3Qgbm9ja0RvbmUgPSBmdW5jdGlvbiAoKSB7XG4gICAgX21vZGUuZmluaXNoKGZpeHR1cmUsIG9wdGlvbnMsIGNvbnRleHQpXG4gIH1cblxuICBkZWJ1ZygnY29udGV4dDonLCBjb250ZXh0KVxuXG4gIC8vIElmIG5vY2tlZEZuIGlzIGEgZnVuY3Rpb24gdGhlbiBpbnZva2UgaXQsIG90aGVyd2lzZSByZXR1cm4gYSBwcm9taXNlIHJlc29sdmluZyB0byBub2NrRG9uZS5cbiAgaWYgKHR5cGVvZiBub2NrZWRGbiA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIG5vY2tlZEZuLmNhbGwoY29udGV4dCwgbm9ja0RvbmUpXG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7IG5vY2tEb25lLCBjb250ZXh0IH0pXG4gIH1cbn1cblxuLyoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKipcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTW9kZXMgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKlxuICoqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovXG5cbmNvbnN0IHdpbGQgPSB7XG4gIHNldHVwOiBmdW5jdGlvbiAoKSB7XG4gICAgY2xlYW5BbGwoKVxuICAgIHJlY29yZGVyLnJlc3RvcmUoKVxuICAgIGFjdGl2YXRlKClcbiAgICBlbmFibGVOZXRDb25uZWN0KClcbiAgfSxcblxuICBzdGFydDogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiBsb2FkKCkgLy8gZG9uJ3QgbG9hZCBhbnl0aGluZyBidXQgZ2V0IGNvcnJlY3QgY29udGV4dFxuICB9LFxuXG4gIGZpbmlzaDogZnVuY3Rpb24gKCkge1xuICAgIC8vIG5vdGhpbmcgdG8gZG9cbiAgfSxcbn1cblxuY29uc3QgZHJ5cnVuID0ge1xuICBzZXR1cDogZnVuY3Rpb24gKCkge1xuICAgIHJlY29yZGVyLnJlc3RvcmUoKVxuICAgIGNsZWFuQWxsKClcbiAgICBhY3RpdmF0ZSgpXG4gICAgLy8gIFdlIGhhdmUgdG8gZXhwbGljaXRseSBlbmFibGUgbmV0IGNvbm5lY3Rpdml0eSBhcyBieSBkZWZhdWx0IGl0J3Mgb2ZmLlxuICAgIGVuYWJsZU5ldENvbm5lY3QoKVxuICB9LFxuXG4gIHN0YXJ0OiBmdW5jdGlvbiAoZml4dHVyZSwgb3B0aW9ucykge1xuICAgIGNvbnN0IGNvbnRleHRzID0gbG9hZChmaXh0dXJlLCBvcHRpb25zKVxuXG4gICAgZW5hYmxlTmV0Q29ubmVjdCgpXG4gICAgcmV0dXJuIGNvbnRleHRzXG4gIH0sXG5cbiAgZmluaXNoOiBmdW5jdGlvbiAoKSB7XG4gICAgLy8gbm90aGluZyB0byBkb1xuICB9LFxufVxuXG5jb25zdCByZWNvcmQgPSB7XG4gIHNldHVwOiBmdW5jdGlvbiAoKSB7XG4gICAgcmVjb3JkZXIucmVzdG9yZSgpXG4gICAgcmVjb3JkZXIuY2xlYXIoKVxuICAgIGNsZWFuQWxsKClcbiAgICBhY3RpdmF0ZSgpXG4gICAgZGlzYWJsZU5ldENvbm5lY3QoKVxuICB9LFxuXG4gIHN0YXJ0OiBmdW5jdGlvbiAoZml4dHVyZSwgb3B0aW9ucykge1xuICAgIGlmICghZnMpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignbm8gZnMnKVxuICAgIH1cbiAgICBjb25zdCBjb250ZXh0ID0gbG9hZChmaXh0dXJlLCBvcHRpb25zKVxuXG4gICAgaWYgKCFjb250ZXh0LmlzTG9hZGVkKSB7XG4gICAgICByZWNvcmRlci5yZWNvcmQoe1xuICAgICAgICBkb250X3ByaW50OiB0cnVlLFxuICAgICAgICBvdXRwdXRfb2JqZWN0czogdHJ1ZSxcbiAgICAgICAgLi4ub3B0aW9ucy5yZWNvcmRlcixcbiAgICAgIH0pXG5cbiAgICAgIGNvbnRleHQuaXNSZWNvcmRpbmcgPSB0cnVlXG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbnRleHRcbiAgfSxcblxuICBmaW5pc2g6IGZ1bmN0aW9uIChmaXh0dXJlLCBvcHRpb25zLCBjb250ZXh0KSB7XG4gICAgaWYgKGNvbnRleHQuaXNSZWNvcmRpbmcpIHtcbiAgICAgIGxldCBvdXRwdXRzID0gcmVjb3JkZXIub3V0cHV0cygpXG5cbiAgICAgIGlmICh0eXBlb2Ygb3B0aW9ucy5hZnRlclJlY29yZCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICBvdXRwdXRzID0gb3B0aW9ucy5hZnRlclJlY29yZChvdXRwdXRzKVxuICAgICAgfVxuXG4gICAgICBvdXRwdXRzID1cbiAgICAgICAgdHlwZW9mIG91dHB1dHMgPT09ICdzdHJpbmcnID8gb3V0cHV0cyA6IEpTT04uc3RyaW5naWZ5KG91dHB1dHMsIG51bGwsIDQpXG4gICAgICBkZWJ1ZygncmVjb3JkZXIgb3V0cHV0czonLCBvdXRwdXRzKVxuXG4gICAgICBmcy5ta2RpclN5bmMocGF0aC5kaXJuYW1lKGZpeHR1cmUpLCB7IHJlY3Vyc2l2ZTogdHJ1ZSB9KVxuICAgICAgZnMud3JpdGVGaWxlU3luYyhmaXh0dXJlLCBvdXRwdXRzKVxuICAgIH1cbiAgfSxcbn1cblxuY29uc3QgbG9ja2Rvd24gPSB7XG4gIHNldHVwOiBmdW5jdGlvbiAoKSB7XG4gICAgcmVjb3JkZXIucmVzdG9yZSgpXG4gICAgcmVjb3JkZXIuY2xlYXIoKVxuICAgIGNsZWFuQWxsKClcbiAgICBhY3RpdmF0ZSgpXG4gICAgZGlzYWJsZU5ldENvbm5lY3QoKVxuICB9LFxuXG4gIHN0YXJ0OiBmdW5jdGlvbiAoZml4dHVyZSwgb3B0aW9ucykge1xuICAgIHJldHVybiBsb2FkKGZpeHR1cmUsIG9wdGlvbnMpXG4gIH0sXG5cbiAgZmluaXNoOiBmdW5jdGlvbiAoKSB7XG4gICAgLy8gbm90aGluZyB0byBkb1xuICB9LFxufVxuXG5mdW5jdGlvbiBsb2FkKGZpeHR1cmUsIG9wdGlvbnMpIHtcbiAgY29uc3QgY29udGV4dCA9IHtcbiAgICBzY29wZXM6IFtdLFxuICAgIGFzc2VydFNjb3Blc0ZpbmlzaGVkOiBmdW5jdGlvbiAoKSB7XG4gICAgICBhc3NlcnRTY29wZXModGhpcy5zY29wZXMsIGZpeHR1cmUpXG4gICAgfSxcbiAgfVxuXG4gIGlmIChmaXh0dXJlICYmIGZpeHR1cmVFeGlzdHMoZml4dHVyZSkpIHtcbiAgICBsZXQgc2NvcGVzID0gbG9hZERlZnMoZml4dHVyZSlcbiAgICBhcHBseUhvb2soc2NvcGVzLCBvcHRpb25zLmJlZm9yZSlcblxuICAgIHNjb3BlcyA9IGRlZmluZShzY29wZXMpXG4gICAgYXBwbHlIb29rKHNjb3Blcywgb3B0aW9ucy5hZnRlcilcblxuICAgIGNvbnRleHQuc2NvcGVzID0gc2NvcGVzXG4gICAgY29udGV4dC5pc0xvYWRlZCA9IHRydWVcbiAgfVxuXG4gIHJldHVybiBjb250ZXh0XG59XG5cbmZ1bmN0aW9uIGFwcGx5SG9vayhzY29wZXMsIGZuKSB7XG4gIGlmICghZm4pIHtcbiAgICByZXR1cm5cbiAgfVxuXG4gIGlmICh0eXBlb2YgZm4gIT09ICdmdW5jdGlvbicpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ3Byb2Nlc3NpbmcgaG9va3MgbXVzdCBiZSBhIGZ1bmN0aW9uJylcbiAgfVxuXG4gIHNjb3Blcy5mb3JFYWNoKGZuKVxufVxuXG5mdW5jdGlvbiBmaXh0dXJlRXhpc3RzKGZpeHR1cmUpIHtcbiAgaWYgKCFmcykge1xuICAgIHRocm93IG5ldyBFcnJvcignbm8gZnMnKVxuICB9XG5cbiAgcmV0dXJuIGZzLmV4aXN0c1N5bmMoZml4dHVyZSlcbn1cblxuZnVuY3Rpb24gYXNzZXJ0U2NvcGVzKHNjb3BlcywgZml4dHVyZSkge1xuICBjb25zdCBwZW5kaW5nID0gc2NvcGVzXG4gICAgLmZpbHRlcihzY29wZSA9PiAhc2NvcGUuaXNEb25lKCkpXG4gICAgLm1hcChzY29wZSA9PiBzY29wZS5wZW5kaW5nTW9ja3MoKSlcblxuICBpZiAocGVuZGluZy5sZW5ndGgpIHtcbiAgICBhc3NlcnQuZmFpbChcbiAgICAgIGZvcm1hdChcbiAgICAgICAgJyVqIHdhcyBub3QgdXNlZCwgY29uc2lkZXIgcmVtb3ZpbmcgJXMgdG8gcmVyZWNvcmQgZml4dHVyZScsXG4gICAgICAgIFtdLmNvbmNhdCguLi5wZW5kaW5nKSxcbiAgICAgICAgZml4dHVyZVxuICAgICAgKVxuICAgIClcbiAgfVxufVxuXG5jb25zdCBNb2RlcyA9IHtcbiAgd2lsZCwgLy8gYWxsIHJlcXVlc3RzIGdvIG91dCB0byB0aGUgaW50ZXJuZXQsIGRvbnQgcmVwbGF5IGFueXRoaW5nLCBkb2VzbnQgcmVjb3JkIGFueXRoaW5nXG5cbiAgZHJ5cnVuLCAvLyB1c2UgcmVjb3JkZWQgbm9ja3MsIGFsbG93IGh0dHAgY2FsbHMsIGRvZXNudCByZWNvcmQgYW55dGhpbmcsIHVzZWZ1bCBmb3Igd3JpdGluZyBuZXcgdGVzdHMgKGRlZmF1bHQpXG5cbiAgcmVjb3JkLCAvLyB1c2UgcmVjb3JkZWQgbm9ja3MsIHJlY29yZCBuZXcgbm9ja3NcblxuICBsb2NrZG93biwgLy8gdXNlIHJlY29yZGVkIG5vY2tzLCBkaXNhYmxlcyBhbGwgaHR0cCBjYWxscyBldmVuIHdoZW4gbm90IG5vY2tlZCwgZG9lc250IHJlY29yZFxufVxuXG5CYWNrLnNldE1vZGUgPSBmdW5jdGlvbiAobW9kZSkge1xuICBpZiAoIShtb2RlIGluIE1vZGVzKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5rbm93biBtb2RlOiAke21vZGV9YClcbiAgfVxuXG4gIEJhY2suY3VycmVudE1vZGUgPSBtb2RlXG4gIGRlYnVnKCdOZXcgbm9jayBiYWNrIG1vZGU6JywgQmFjay5jdXJyZW50TW9kZSlcblxuICBfbW9kZSA9IE1vZGVzW21vZGVdXG4gIF9tb2RlLnNldHVwKClcbn1cblxuQmFjay5maXh0dXJlcyA9IG51bGxcbkJhY2suY3VycmVudE1vZGUgPSBudWxsXG5cbm1vZHVsZS5leHBvcnRzID0gQmFja1xuIl19