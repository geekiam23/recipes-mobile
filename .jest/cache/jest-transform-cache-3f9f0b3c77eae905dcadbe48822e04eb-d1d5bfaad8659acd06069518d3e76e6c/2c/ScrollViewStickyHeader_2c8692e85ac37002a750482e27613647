91ae45467628785a6a642a5587f359fe
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _AnimatedImplementation = _interopRequireDefault(require("../../Animated/AnimatedImplementation"));

var React = _interopRequireWildcard(require("react"));

var _StyleSheet = _interopRequireDefault(require("../../StyleSheet/StyleSheet"));

var _View = _interopRequireDefault(require("../View/View"));

var _Platform = _interopRequireDefault(require("../../Utilities/Platform"));

function _getRequireWildcardCache(nodeInterop) { if (typeof WeakMap !== "function") return null; var cacheBabelInterop = new WeakMap(); var cacheNodeInterop = new WeakMap(); return (_getRequireWildcardCache = function _getRequireWildcardCache(nodeInterop) { return nodeInterop ? cacheNodeInterop : cacheBabelInterop; })(nodeInterop); }

function _interopRequireWildcard(obj, nodeInterop) { if (!nodeInterop && obj && obj.__esModule) { return obj; } if (obj === null || typeof obj !== "object" && typeof obj !== "function") { return { default: obj }; } var cache = _getRequireWildcardCache(nodeInterop); if (cache && cache.has(obj)) { return cache.get(obj); } var newObj = {}; var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor; for (var key in obj) { if (key !== "default" && Object.prototype.hasOwnProperty.call(obj, key)) { var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null; if (desc && (desc.get || desc.set)) { Object.defineProperty(newObj, key, desc); } else { newObj[key] = obj[key]; } } } newObj.default = obj; if (cache) { cache.set(obj, newObj); } return newObj; }

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2.default)(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2.default)(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2.default)(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var AnimatedView = _AnimatedImplementation.default.createAnimatedComponent(_View.default);

var ScrollViewStickyHeader = function (_React$Component) {
  (0, _inherits2.default)(ScrollViewStickyHeader, _React$Component);

  var _super = _createSuper(ScrollViewStickyHeader);

  function ScrollViewStickyHeader() {
    var _this;

    (0, _classCallCheck2.default)(this, ScrollViewStickyHeader);

    for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    _this = _super.call.apply(_super, [this].concat(args));
    _this.state = {
      measured: false,
      layoutY: 0,
      layoutHeight: 0,
      nextHeaderLayoutY: _this.props.nextHeaderLayoutY,
      translateY: null
    };
    _this._translateY = null;
    _this._shouldRecreateTranslateY = true;
    _this._haveReceivedInitialZeroTranslateY = true;
    _this._debounceTimeout = _Platform.default.OS === 'android' ? 15 : 64;

    _this._onLayout = function (event) {
      var layoutY = event.nativeEvent.layout.y;
      var layoutHeight = event.nativeEvent.layout.height;
      var measured = true;

      if (layoutY !== _this.state.layoutY || layoutHeight !== _this.state.layoutHeight || measured !== _this.state.measured) {
        _this._shouldRecreateTranslateY = true;
      }

      _this.setState({
        measured: measured,
        layoutY: layoutY,
        layoutHeight: layoutHeight
      });

      _this.props.onLayout(event);

      var child = React.Children.only(_this.props.children);

      if (child.props.onLayout) {
        child.props.onLayout(event);
      }
    };

    _this._setComponentRef = function (ref) {
      _this._ref = ref;
    };

    return _this;
  }

  (0, _createClass2.default)(ScrollViewStickyHeader, [{
    key: "setNextHeaderY",
    value: function setNextHeaderY(y) {
      this.setState({
        nextHeaderLayoutY: y
      });
    }
  }, {
    key: "UNSAFE_componentWillReceiveProps",
    value: function UNSAFE_componentWillReceiveProps(nextProps) {
      if (nextProps.scrollViewHeight !== this.props.scrollViewHeight || nextProps.scrollAnimatedValue !== this.props.scrollAnimatedValue || nextProps.inverted !== this.props.inverted) {
        this._shouldRecreateTranslateY = true;
      }
    }
  }, {
    key: "updateTranslateListener",
    value: function updateTranslateListener(translateY, isFabric) {
      var _this2 = this;

      if (this._translateY != null && this._animatedValueListenerId != null) {
        this._translateY.removeListener(this._animatedValueListenerId);
      }

      this._translateY = translateY;
      this._shouldRecreateTranslateY = false;

      if (!isFabric) {
        return;
      }

      if (!this._animatedValueListener) {
        this._animatedValueListener = function (_ref) {
          var value = _ref.value;

          if (value === 0 && !_this2._haveReceivedInitialZeroTranslateY) {
            _this2._haveReceivedInitialZeroTranslateY = true;
            return;
          }

          if (_this2._timer) {
            clearTimeout(_this2._timer);
          }

          _this2._timer = setTimeout(function () {
            if (value !== _this2.state.translateY) {
              _this2.setState({
                translateY: value
              });
            }
          }, _this2._debounceTimeout);
        };
      }

      if (this.state.translateY !== 0 && this.state.translateY != null) {
        this._haveReceivedInitialZeroTranslateY = false;
      }

      this._animatedValueListenerId = translateY.addListener(this._animatedValueListener);
    }
  }, {
    key: "render",
    value: function render() {
      var _this$_ref$_internalI, _this$_ref$_internalI2;

      var isFabric = !!(this._ref && (_this$_ref$_internalI = this._ref['_internalInstanceHandle']) != null && (_this$_ref$_internalI2 = _this$_ref$_internalI.stateNode) != null && _this$_ref$_internalI2.canonical);

      if (this._shouldRecreateTranslateY) {
        var _this$props = this.props,
            inverted = _this$props.inverted,
            scrollViewHeight = _this$props.scrollViewHeight;
        var _this$state = this.state,
            measured = _this$state.measured,
            layoutHeight = _this$state.layoutHeight,
            layoutY = _this$state.layoutY,
            nextHeaderLayoutY = _this$state.nextHeaderLayoutY;
        var inputRange = [-1, 0];
        var outputRange = [0, 0];

        if (measured) {
          if (inverted) {
            if (scrollViewHeight != null) {
              var stickStartPoint = layoutY + layoutHeight - scrollViewHeight;

              if (stickStartPoint > 0) {
                inputRange.push(stickStartPoint);
                outputRange.push(0);
                inputRange.push(stickStartPoint + 1);
                outputRange.push(1);
                var collisionPoint = (nextHeaderLayoutY || 0) - layoutHeight - scrollViewHeight;

                if (collisionPoint > stickStartPoint) {
                  inputRange.push(collisionPoint, collisionPoint + 1);
                  outputRange.push(collisionPoint - stickStartPoint, collisionPoint - stickStartPoint);
                }
              }
            }
          } else {
            inputRange.push(layoutY);
            outputRange.push(0);

            var _collisionPoint = (nextHeaderLayoutY || 0) - layoutHeight;

            if (_collisionPoint >= layoutY) {
              inputRange.push(_collisionPoint, _collisionPoint + 1);
              outputRange.push(_collisionPoint - layoutY, _collisionPoint - layoutY);
            } else {
              inputRange.push(layoutY + 1);
              outputRange.push(1);
            }
          }
        }

        this.updateTranslateListener(this.props.scrollAnimatedValue.interpolate({
          inputRange: inputRange,
          outputRange: outputRange
        }), isFabric);
      }

      var child = React.Children.only(this.props.children);
      var passthroughAnimatedPropExplicitValues = isFabric && this.state.translateY != null ? {
        style: {
          transform: [{
            translateY: this.state.translateY
          }]
        }
      } : null;
      return React.createElement(AnimatedView, {
        collapsable: false,
        nativeID: this.props.nativeID,
        onLayout: this._onLayout,
        ref: this._setComponentRef,
        style: [child.props.style, styles.header, {
          transform: [{
            translateY: this._translateY
          }]
        }],
        passthroughAnimatedPropExplicitValues: passthroughAnimatedPropExplicitValues
      }, React.cloneElement(child, {
        style: styles.fill,
        onLayout: undefined
      }));
    }
  }]);
  return ScrollViewStickyHeader;
}(React.Component);

var styles = _StyleSheet.default.create({
  header: {
    zIndex: 10,
    position: 'relative'
  },
  fill: {
    flex: 1
  }
});

module.exports = ScrollViewStickyHeader;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlNjcm9sbFZpZXdTdGlja3lIZWFkZXIuanMiXSwibmFtZXMiOlsiQW5pbWF0ZWRWaWV3IiwiQW5pbWF0ZWRJbXBsZW1lbnRhdGlvbiIsImNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50IiwiVmlldyIsIlNjcm9sbFZpZXdTdGlja3lIZWFkZXIiLCJzdGF0ZSIsIm1lYXN1cmVkIiwibGF5b3V0WSIsImxheW91dEhlaWdodCIsIm5leHRIZWFkZXJMYXlvdXRZIiwicHJvcHMiLCJ0cmFuc2xhdGVZIiwiX3RyYW5zbGF0ZVkiLCJfc2hvdWxkUmVjcmVhdGVUcmFuc2xhdGVZIiwiX2hhdmVSZWNlaXZlZEluaXRpYWxaZXJvVHJhbnNsYXRlWSIsIl9kZWJvdW5jZVRpbWVvdXQiLCJQbGF0Zm9ybSIsIk9TIiwiX29uTGF5b3V0IiwiZXZlbnQiLCJuYXRpdmVFdmVudCIsImxheW91dCIsInkiLCJoZWlnaHQiLCJzZXRTdGF0ZSIsIm9uTGF5b3V0IiwiY2hpbGQiLCJSZWFjdCIsIkNoaWxkcmVuIiwib25seSIsImNoaWxkcmVuIiwiX3NldENvbXBvbmVudFJlZiIsInJlZiIsIl9yZWYiLCJuZXh0UHJvcHMiLCJzY3JvbGxWaWV3SGVpZ2h0Iiwic2Nyb2xsQW5pbWF0ZWRWYWx1ZSIsImludmVydGVkIiwiaXNGYWJyaWMiLCJfYW5pbWF0ZWRWYWx1ZUxpc3RlbmVySWQiLCJyZW1vdmVMaXN0ZW5lciIsIl9hbmltYXRlZFZhbHVlTGlzdGVuZXIiLCJ2YWx1ZSIsIl90aW1lciIsImNsZWFyVGltZW91dCIsInNldFRpbWVvdXQiLCJhZGRMaXN0ZW5lciIsInN0YXRlTm9kZSIsImNhbm9uaWNhbCIsImlucHV0UmFuZ2UiLCJvdXRwdXRSYW5nZSIsInN0aWNrU3RhcnRQb2ludCIsInB1c2giLCJjb2xsaXNpb25Qb2ludCIsInVwZGF0ZVRyYW5zbGF0ZUxpc3RlbmVyIiwiaW50ZXJwb2xhdGUiLCJwYXNzdGhyb3VnaEFuaW1hdGVkUHJvcEV4cGxpY2l0VmFsdWVzIiwic3R5bGUiLCJ0cmFuc2Zvcm0iLCJuYXRpdmVJRCIsInN0eWxlcyIsImhlYWRlciIsImNsb25lRWxlbWVudCIsImZpbGwiLCJ1bmRlZmluZWQiLCJDb21wb25lbnQiLCJTdHlsZVNoZWV0IiwiY3JlYXRlIiwiekluZGV4IiwicG9zaXRpb24iLCJmbGV4IiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBVUE7Ozs7Ozs7Ozs7Ozs7O0FBRUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7Ozs7Ozs7Ozs7QUFJQSxJQUFNQSxZQUFZLEdBQUdDLGdDQUF1QkMsdUJBQXZCLENBQStDQyxhQUEvQyxDQUFyQjs7SUF5Qk1DLHNCOzs7Ozs7Ozs7Ozs7Ozs7VUFDSkMsSyxHQUFlO0FBQ2JDLE1BQUFBLFFBQVEsRUFBRSxLQURHO0FBRWJDLE1BQUFBLE9BQU8sRUFBRSxDQUZJO0FBR2JDLE1BQUFBLFlBQVksRUFBRSxDQUhEO0FBSWJDLE1BQUFBLGlCQUFpQixFQUFFLE1BQUtDLEtBQUwsQ0FBV0QsaUJBSmpCO0FBS2JFLE1BQUFBLFVBQVUsRUFBRTtBQUxDLEs7VUFRZkMsVyxHQUFxRCxJO1VBQ3JEQyx5QixHQUFxQyxJO1VBQ3JDQyxrQyxHQUE4QyxJO1VBTzlDQyxnQixHQUEyQkMsa0JBQVNDLEVBQVQsS0FBZ0IsU0FBaEIsR0FBNEIsRUFBNUIsR0FBaUMsRTs7VUF5RTVEQyxTLEdBQVksVUFBQUMsS0FBSyxFQUFJO0FBQ25CLFVBQU1aLE9BQU8sR0FBR1ksS0FBSyxDQUFDQyxXQUFOLENBQWtCQyxNQUFsQixDQUF5QkMsQ0FBekM7QUFDQSxVQUFNZCxZQUFZLEdBQUdXLEtBQUssQ0FBQ0MsV0FBTixDQUFrQkMsTUFBbEIsQ0FBeUJFLE1BQTlDO0FBQ0EsVUFBTWpCLFFBQVEsR0FBRyxJQUFqQjs7QUFFQSxVQUNFQyxPQUFPLEtBQUssTUFBS0YsS0FBTCxDQUFXRSxPQUF2QixJQUNBQyxZQUFZLEtBQUssTUFBS0gsS0FBTCxDQUFXRyxZQUQ1QixJQUVBRixRQUFRLEtBQUssTUFBS0QsS0FBTCxDQUFXQyxRQUgxQixFQUlFO0FBQ0EsY0FBS08seUJBQUwsR0FBaUMsSUFBakM7QUFDRDs7QUFFRCxZQUFLVyxRQUFMLENBQWM7QUFDWmxCLFFBQUFBLFFBQVEsRUFBUkEsUUFEWTtBQUVaQyxRQUFBQSxPQUFPLEVBQVBBLE9BRlk7QUFHWkMsUUFBQUEsWUFBWSxFQUFaQTtBQUhZLE9BQWQ7O0FBTUEsWUFBS0UsS0FBTCxDQUFXZSxRQUFYLENBQW9CTixLQUFwQjs7QUFDQSxVQUFNTyxLQUFLLEdBQUdDLEtBQUssQ0FBQ0MsUUFBTixDQUFlQyxJQUFmLENBQW9CLE1BQUtuQixLQUFMLENBQVdvQixRQUEvQixDQUFkOztBQUNBLFVBQUlKLEtBQUssQ0FBQ2hCLEtBQU4sQ0FBWWUsUUFBaEIsRUFBMEI7QUFDeEJDLFFBQUFBLEtBQUssQ0FBQ2hCLEtBQU4sQ0FBWWUsUUFBWixDQUFxQk4sS0FBckI7QUFDRDtBQUNGLEs7O1VBRURZLGdCLEdBQW1CLFVBQUFDLEdBQUcsRUFBSTtBQUN4QixZQUFLQyxJQUFMLEdBQVlELEdBQVo7QUFDRCxLOzs7Ozs7O1dBbkdELHdCQUFlVixDQUFmLEVBQTBCO0FBQ3hCLFdBQUtFLFFBQUwsQ0FBYztBQUFDZixRQUFBQSxpQkFBaUIsRUFBRWE7QUFBcEIsT0FBZDtBQUNEOzs7V0FFRCwwQ0FBaUNZLFNBQWpDLEVBQW1EO0FBQ2pELFVBQ0VBLFNBQVMsQ0FBQ0MsZ0JBQVYsS0FBK0IsS0FBS3pCLEtBQUwsQ0FBV3lCLGdCQUExQyxJQUNBRCxTQUFTLENBQUNFLG1CQUFWLEtBQWtDLEtBQUsxQixLQUFMLENBQVcwQixtQkFEN0MsSUFFQUYsU0FBUyxDQUFDRyxRQUFWLEtBQXVCLEtBQUszQixLQUFMLENBQVcyQixRQUhwQyxFQUlFO0FBQ0EsYUFBS3hCLHlCQUFMLEdBQWlDLElBQWpDO0FBQ0Q7QUFDRjs7O1dBRUQsaUNBQ0VGLFVBREYsRUFFRTJCLFFBRkYsRUFHRTtBQUFBOztBQUNBLFVBQUksS0FBSzFCLFdBQUwsSUFBb0IsSUFBcEIsSUFBNEIsS0FBSzJCLHdCQUFMLElBQWlDLElBQWpFLEVBQXVFO0FBQ3JFLGFBQUszQixXQUFMLENBQWlCNEIsY0FBakIsQ0FBZ0MsS0FBS0Qsd0JBQXJDO0FBQ0Q7O0FBRUQsV0FBSzNCLFdBQUwsR0FBbUJELFVBQW5CO0FBQ0EsV0FBS0UseUJBQUwsR0FBaUMsS0FBakM7O0FBRUEsVUFBSSxDQUFDeUIsUUFBTCxFQUFlO0FBQ2I7QUFDRDs7QUFFRCxVQUFJLENBQUMsS0FBS0csc0JBQVYsRUFBa0M7QUFlaEMsYUFBS0Esc0JBQUwsR0FBOEIsZ0JBQWE7QUFBQSxjQUFYQyxLQUFXLFFBQVhBLEtBQVc7O0FBR3pDLGNBQUlBLEtBQUssS0FBSyxDQUFWLElBQWUsQ0FBQyxNQUFJLENBQUM1QixrQ0FBekIsRUFBNkQ7QUFDM0QsWUFBQSxNQUFJLENBQUNBLGtDQUFMLEdBQTBDLElBQTFDO0FBQ0E7QUFDRDs7QUFDRCxjQUFJLE1BQUksQ0FBQzZCLE1BQVQsRUFBaUI7QUFDZkMsWUFBQUEsWUFBWSxDQUFDLE1BQUksQ0FBQ0QsTUFBTixDQUFaO0FBQ0Q7O0FBQ0QsVUFBQSxNQUFJLENBQUNBLE1BQUwsR0FBY0UsVUFBVSxDQUFDLFlBQU07QUFDN0IsZ0JBQUlILEtBQUssS0FBSyxNQUFJLENBQUNyQyxLQUFMLENBQVdNLFVBQXpCLEVBQXFDO0FBQ25DLGNBQUEsTUFBSSxDQUFDYSxRQUFMLENBQWM7QUFDWmIsZ0JBQUFBLFVBQVUsRUFBRStCO0FBREEsZUFBZDtBQUdEO0FBQ0YsV0FOdUIsRUFNckIsTUFBSSxDQUFDM0IsZ0JBTmdCLENBQXhCO0FBT0QsU0FqQkQ7QUFrQkQ7O0FBQ0QsVUFBSSxLQUFLVixLQUFMLENBQVdNLFVBQVgsS0FBMEIsQ0FBMUIsSUFBK0IsS0FBS04sS0FBTCxDQUFXTSxVQUFYLElBQXlCLElBQTVELEVBQWtFO0FBQ2hFLGFBQUtHLGtDQUFMLEdBQTBDLEtBQTFDO0FBQ0Q7O0FBQ0QsV0FBS3lCLHdCQUFMLEdBQWdDNUIsVUFBVSxDQUFDbUMsV0FBWCxDQUM5QixLQUFLTCxzQkFEeUIsQ0FBaEM7QUFHRDs7O1dBZ0NELGtCQUFxQjtBQUFBOztBQUduQixVQUFNSCxRQUFRLEdBQUcsQ0FBQyxFQUNoQixLQUFLTCxJQUFMLDZCQUFhLEtBQUtBLElBQUwsQ0FBVSx5QkFBVixDQUFiLHVDQUFhLHNCQUFzQ2MsU0FBbkQsYUFBYSx1QkFBaURDLFNBRDlDLENBQWxCOztBQU9BLFVBQUksS0FBS25DLHlCQUFULEVBQW9DO0FBQ2xDLDBCQUFxQyxLQUFLSCxLQUExQztBQUFBLFlBQU8yQixRQUFQLGVBQU9BLFFBQVA7QUFBQSxZQUFpQkYsZ0JBQWpCLGVBQWlCQSxnQkFBakI7QUFDQSwwQkFBNkQsS0FBSzlCLEtBQWxFO0FBQUEsWUFBT0MsUUFBUCxlQUFPQSxRQUFQO0FBQUEsWUFBaUJFLFlBQWpCLGVBQWlCQSxZQUFqQjtBQUFBLFlBQStCRCxPQUEvQixlQUErQkEsT0FBL0I7QUFBQSxZQUF3Q0UsaUJBQXhDLGVBQXdDQSxpQkFBeEM7QUFDQSxZQUFNd0MsVUFBeUIsR0FBRyxDQUFDLENBQUMsQ0FBRixFQUFLLENBQUwsQ0FBbEM7QUFDQSxZQUFNQyxXQUEwQixHQUFHLENBQUMsQ0FBRCxFQUFJLENBQUosQ0FBbkM7O0FBRUEsWUFBSTVDLFFBQUosRUFBYztBQUNaLGNBQUkrQixRQUFKLEVBQWM7QUFlWixnQkFBSUYsZ0JBQWdCLElBQUksSUFBeEIsRUFBOEI7QUFDNUIsa0JBQU1nQixlQUFlLEdBQUc1QyxPQUFPLEdBQUdDLFlBQVYsR0FBeUIyQixnQkFBakQ7O0FBQ0Esa0JBQUlnQixlQUFlLEdBQUcsQ0FBdEIsRUFBeUI7QUFDdkJGLGdCQUFBQSxVQUFVLENBQUNHLElBQVgsQ0FBZ0JELGVBQWhCO0FBQ0FELGdCQUFBQSxXQUFXLENBQUNFLElBQVosQ0FBaUIsQ0FBakI7QUFDQUgsZ0JBQUFBLFVBQVUsQ0FBQ0csSUFBWCxDQUFnQkQsZUFBZSxHQUFHLENBQWxDO0FBQ0FELGdCQUFBQSxXQUFXLENBQUNFLElBQVosQ0FBaUIsQ0FBakI7QUFHQSxvQkFBTUMsY0FBYyxHQUNsQixDQUFDNUMsaUJBQWlCLElBQUksQ0FBdEIsSUFBMkJELFlBQTNCLEdBQTBDMkIsZ0JBRDVDOztBQUVBLG9CQUFJa0IsY0FBYyxHQUFHRixlQUFyQixFQUFzQztBQUNwQ0Ysa0JBQUFBLFVBQVUsQ0FBQ0csSUFBWCxDQUFnQkMsY0FBaEIsRUFBZ0NBLGNBQWMsR0FBRyxDQUFqRDtBQUNBSCxrQkFBQUEsV0FBVyxDQUFDRSxJQUFaLENBQ0VDLGNBQWMsR0FBR0YsZUFEbkIsRUFFRUUsY0FBYyxHQUFHRixlQUZuQjtBQUlEO0FBQ0Y7QUFDRjtBQUNGLFdBbkNELE1BbUNPO0FBV0xGLFlBQUFBLFVBQVUsQ0FBQ0csSUFBWCxDQUFnQjdDLE9BQWhCO0FBQ0EyQyxZQUFBQSxXQUFXLENBQUNFLElBQVosQ0FBaUIsQ0FBakI7O0FBR0EsZ0JBQU1DLGVBQWMsR0FBRyxDQUFDNUMsaUJBQWlCLElBQUksQ0FBdEIsSUFBMkJELFlBQWxEOztBQUNBLGdCQUFJNkMsZUFBYyxJQUFJOUMsT0FBdEIsRUFBK0I7QUFDN0IwQyxjQUFBQSxVQUFVLENBQUNHLElBQVgsQ0FBZ0JDLGVBQWhCLEVBQWdDQSxlQUFjLEdBQUcsQ0FBakQ7QUFDQUgsY0FBQUEsV0FBVyxDQUFDRSxJQUFaLENBQ0VDLGVBQWMsR0FBRzlDLE9BRG5CLEVBRUU4QyxlQUFjLEdBQUc5QyxPQUZuQjtBQUlELGFBTkQsTUFNTztBQUNMMEMsY0FBQUEsVUFBVSxDQUFDRyxJQUFYLENBQWdCN0MsT0FBTyxHQUFHLENBQTFCO0FBQ0EyQyxjQUFBQSxXQUFXLENBQUNFLElBQVosQ0FBaUIsQ0FBakI7QUFDRDtBQUNGO0FBQ0Y7O0FBRUQsYUFBS0UsdUJBQUwsQ0FDRSxLQUFLNUMsS0FBTCxDQUFXMEIsbUJBQVgsQ0FBK0JtQixXQUEvQixDQUEyQztBQUN6Q04sVUFBQUEsVUFBVSxFQUFWQSxVQUR5QztBQUV6Q0MsVUFBQUEsV0FBVyxFQUFYQTtBQUZ5QyxTQUEzQyxDQURGLEVBS0VaLFFBTEY7QUFPRDs7QUFFRCxVQUFNWixLQUFLLEdBQUdDLEtBQUssQ0FBQ0MsUUFBTixDQUFlQyxJQUFmLENBQW9CLEtBQUtuQixLQUFMLENBQVdvQixRQUEvQixDQUFkO0FBR0EsVUFBTTBCLHFDQUFxQyxHQUN6Q2xCLFFBQVEsSUFBSSxLQUFLakMsS0FBTCxDQUFXTSxVQUFYLElBQXlCLElBQXJDLEdBQ0k7QUFDRThDLFFBQUFBLEtBQUssRUFBRTtBQUFDQyxVQUFBQSxTQUFTLEVBQUUsQ0FBQztBQUFDL0MsWUFBQUEsVUFBVSxFQUFFLEtBQUtOLEtBQUwsQ0FBV007QUFBeEIsV0FBRDtBQUFaO0FBRFQsT0FESixHQUlJLElBTE47QUFPQSxhQUNFLG9CQUFDLFlBQUQ7QUFDRSxRQUFBLFdBQVcsRUFBRSxLQURmO0FBRUUsUUFBQSxRQUFRLEVBQUUsS0FBS0QsS0FBTCxDQUFXaUQsUUFGdkI7QUFHRSxRQUFBLFFBQVEsRUFBRSxLQUFLekMsU0FIakI7QUFJRSxRQUFBLEdBQUcsRUFBRSxLQUFLYSxnQkFKWjtBQUtFLFFBQUEsS0FBSyxFQUFFLENBQ0xMLEtBQUssQ0FBQ2hCLEtBQU4sQ0FBWStDLEtBRFAsRUFFTEcsTUFBTSxDQUFDQyxNQUZGLEVBR0w7QUFBQ0gsVUFBQUEsU0FBUyxFQUFFLENBQUM7QUFBQy9DLFlBQUFBLFVBQVUsRUFBRSxLQUFLQztBQUFsQixXQUFEO0FBQVosU0FISyxDQUxUO0FBVUUsUUFBQSxxQ0FBcUMsRUFDbkM0QztBQVhKLFNBYUc3QixLQUFLLENBQUNtQyxZQUFOLENBQW1CcEMsS0FBbkIsRUFBMEI7QUFDekIrQixRQUFBQSxLQUFLLEVBQUVHLE1BQU0sQ0FBQ0csSUFEVztBQUV6QnRDLFFBQUFBLFFBQVEsRUFBRXVDO0FBRmUsT0FBMUIsQ0FiSCxDQURGO0FBb0JEOzs7RUFqUGtDckMsS0FBSyxDQUFDc0MsUzs7QUFvUDNDLElBQU1MLE1BQU0sR0FBR00sb0JBQVdDLE1BQVgsQ0FBa0I7QUFDL0JOLEVBQUFBLE1BQU0sRUFBRTtBQUNOTyxJQUFBQSxNQUFNLEVBQUUsRUFERjtBQUVOQyxJQUFBQSxRQUFRLEVBQUU7QUFGSixHQUR1QjtBQUsvQk4sRUFBQUEsSUFBSSxFQUFFO0FBQ0pPLElBQUFBLElBQUksRUFBRTtBQURGO0FBTHlCLENBQWxCLENBQWY7O0FBVUFDLE1BQU0sQ0FBQ0MsT0FBUCxHQUFpQnBFLHNCQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZsb3dcbiAqIEBmb3JtYXRcbiAqL1xuXG4ndXNlIHN0cmljdCc7XG5cbmltcG9ydCBBbmltYXRlZEltcGxlbWVudGF0aW9uIGZyb20gJy4uLy4uL0FuaW1hdGVkL0FuaW1hdGVkSW1wbGVtZW50YXRpb24nO1xuaW1wb3J0ICogYXMgUmVhY3QgZnJvbSAncmVhY3QnO1xuaW1wb3J0IFN0eWxlU2hlZXQgZnJvbSAnLi4vLi4vU3R5bGVTaGVldC9TdHlsZVNoZWV0JztcbmltcG9ydCBWaWV3IGZyb20gJy4uL1ZpZXcvVmlldyc7XG5pbXBvcnQgUGxhdGZvcm0gZnJvbSAnLi4vLi4vVXRpbGl0aWVzL1BsYXRmb3JtJztcblxuaW1wb3J0IHR5cGUge0xheW91dEV2ZW50fSBmcm9tICcuLi8uLi9UeXBlcy9Db3JlRXZlbnRUeXBlcyc7XG5cbmNvbnN0IEFuaW1hdGVkVmlldyA9IEFuaW1hdGVkSW1wbGVtZW50YXRpb24uY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQoVmlldyk7XG5cbmV4cG9ydCB0eXBlIFByb3BzID0ge1xuICBjaGlsZHJlbj86IFJlYWN0LkVsZW1lbnQ8YW55PixcbiAgbmV4dEhlYWRlckxheW91dFk6ID9udW1iZXIsXG4gIG9uTGF5b3V0OiAoZXZlbnQ6IExheW91dEV2ZW50KSA9PiB2b2lkLFxuICBzY3JvbGxBbmltYXRlZFZhbHVlOiBBbmltYXRlZEltcGxlbWVudGF0aW9uLlZhbHVlLFxuICAvLyBXaWxsIGNhdXNlIHN0aWNreSBoZWFkZXJzIHRvIHN0aWNrIGF0IHRoZSBib3R0b20gb2YgdGhlIFNjcm9sbFZpZXcgaW5zdGVhZFxuICAvLyBvZiB0aGUgdG9wLlxuICBpbnZlcnRlZDogP2Jvb2xlYW4sXG4gIC8vIFRoZSBoZWlnaHQgb2YgdGhlIHBhcmVudCBTY3JvbGxWaWV3LiBDdXJyZW50bHkgb25seSBzZXQgd2hlbiBpbnZlcnRlZC5cbiAgc2Nyb2xsVmlld0hlaWdodDogP251bWJlcixcbiAgbmF0aXZlSUQ/OiA/c3RyaW5nLFxuICAuLi5cbn07XG5cbnR5cGUgU3RhdGUgPSB7XG4gIG1lYXN1cmVkOiBib29sZWFuLFxuICBsYXlvdXRZOiBudW1iZXIsXG4gIGxheW91dEhlaWdodDogbnVtYmVyLFxuICBuZXh0SGVhZGVyTGF5b3V0WTogP251bWJlcixcbiAgdHJhbnNsYXRlWTogP251bWJlcixcbiAgLi4uXG59O1xuXG5jbGFzcyBTY3JvbGxWaWV3U3RpY2t5SGVhZGVyIGV4dGVuZHMgUmVhY3QuQ29tcG9uZW50PFByb3BzLCBTdGF0ZT4ge1xuICBzdGF0ZTogU3RhdGUgPSB7XG4gICAgbWVhc3VyZWQ6IGZhbHNlLFxuICAgIGxheW91dFk6IDAsXG4gICAgbGF5b3V0SGVpZ2h0OiAwLFxuICAgIG5leHRIZWFkZXJMYXlvdXRZOiB0aGlzLnByb3BzLm5leHRIZWFkZXJMYXlvdXRZLFxuICAgIHRyYW5zbGF0ZVk6IG51bGwsXG4gIH07XG5cbiAgX3RyYW5zbGF0ZVk6ID9BbmltYXRlZEltcGxlbWVudGF0aW9uLkludGVycG9sYXRpb24gPSBudWxsO1xuICBfc2hvdWxkUmVjcmVhdGVUcmFuc2xhdGVZOiBib29sZWFuID0gdHJ1ZTtcbiAgX2hhdmVSZWNlaXZlZEluaXRpYWxaZXJvVHJhbnNsYXRlWTogYm9vbGVhbiA9IHRydWU7XG4gIF9yZWY6IGFueTsgLy8gVE9ETyBUNTM3MzgxNjE6IGZsb3cgdHlwZSB0aGlzLCBhbmQgdGhlIHdob2xlIGZpbGVcblxuICAvLyBGYWJyaWMtb25seTpcbiAgX3RpbWVyOiA/VGltZW91dElEO1xuICBfYW5pbWF0ZWRWYWx1ZUxpc3RlbmVySWQ6IHN0cmluZztcbiAgX2FuaW1hdGVkVmFsdWVMaXN0ZW5lcjogKHZhbHVlT2JqZWN0OiAkUmVhZE9ubHk8e3x2YWx1ZTogbnVtYmVyfH0+KSA9PiB2b2lkO1xuICBfZGVib3VuY2VUaW1lb3V0OiBudW1iZXIgPSBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnID8gMTUgOiA2NDtcblxuICBzZXROZXh0SGVhZGVyWSh5OiBudW1iZXIpIHtcbiAgICB0aGlzLnNldFN0YXRlKHtuZXh0SGVhZGVyTGF5b3V0WTogeX0pO1xuICB9XG5cbiAgVU5TQUZFX2NvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzOiBQcm9wcykge1xuICAgIGlmIChcbiAgICAgIG5leHRQcm9wcy5zY3JvbGxWaWV3SGVpZ2h0ICE9PSB0aGlzLnByb3BzLnNjcm9sbFZpZXdIZWlnaHQgfHxcbiAgICAgIG5leHRQcm9wcy5zY3JvbGxBbmltYXRlZFZhbHVlICE9PSB0aGlzLnByb3BzLnNjcm9sbEFuaW1hdGVkVmFsdWUgfHxcbiAgICAgIG5leHRQcm9wcy5pbnZlcnRlZCAhPT0gdGhpcy5wcm9wcy5pbnZlcnRlZFxuICAgICkge1xuICAgICAgdGhpcy5fc2hvdWxkUmVjcmVhdGVUcmFuc2xhdGVZID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICB1cGRhdGVUcmFuc2xhdGVMaXN0ZW5lcihcbiAgICB0cmFuc2xhdGVZOiBBbmltYXRlZEltcGxlbWVudGF0aW9uLkludGVycG9sYXRpb24sXG4gICAgaXNGYWJyaWM6IGJvb2xlYW4sXG4gICkge1xuICAgIGlmICh0aGlzLl90cmFuc2xhdGVZICE9IG51bGwgJiYgdGhpcy5fYW5pbWF0ZWRWYWx1ZUxpc3RlbmVySWQgIT0gbnVsbCkge1xuICAgICAgdGhpcy5fdHJhbnNsYXRlWS5yZW1vdmVMaXN0ZW5lcih0aGlzLl9hbmltYXRlZFZhbHVlTGlzdGVuZXJJZCk7XG4gICAgfVxuXG4gICAgdGhpcy5fdHJhbnNsYXRlWSA9IHRyYW5zbGF0ZVk7XG4gICAgdGhpcy5fc2hvdWxkUmVjcmVhdGVUcmFuc2xhdGVZID0gZmFsc2U7XG5cbiAgICBpZiAoIWlzRmFicmljKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLl9hbmltYXRlZFZhbHVlTGlzdGVuZXIpIHtcbiAgICAgIC8vIFRoaXMgaXMgY2FsbGVkIHdoZW5ldmVyIHRoZSAoSW50ZXJwb2xhdGVkKSBBbmltYXRlZCBWYWx1ZVxuICAgICAgLy8gdXBkYXRlcywgd2hpY2ggaXMgc2V2ZXJhbCB0aW1lcyBwZXIgZnJhbWUgZHVyaW5nIHNjcm9sbGluZy5cbiAgICAgIC8vIFRvIGVuc3VyZSB0aGF0IHRoZSBGYWJyaWMgU2hhZG93VHJlZSBoYXMgdGhlIG1vc3QgcmVjZW50XG4gICAgICAvLyB0cmFuc2xhdGUgc3R5bGUgb2YgdGhpcyBub2RlLCB3ZSBkZWJvdW5jZSB0aGUgdmFsdWUgYW5kIHRoZW5cbiAgICAgIC8vIHBhc3MgaXQgdGhyb3VnaCB0byB0aGUgdW5kZXJseWluZyBub2RlIGR1cmluZyByZW5kZXIuXG4gICAgICAvLyBUaGlzIGlzOlxuICAgICAgLy8gMS4gT25seSBhbiBpc3N1ZSBpbiBGYWJyaWMuXG4gICAgICAvLyAyLiBXb3JzZSBpbiBBbmRyb2lkIHRoYW4gaU9TLiBJbiBBbmRyb2lkLCBidXQgbm90IGlPUywgeW91XG4gICAgICAvLyAgICBjYW4gdG91Y2ggYW5kIG1vdmUgeW91ciBmaW5nZXIgc2xpZ2h0bHkgYW5kIHN0aWxsIHRyaWdnZXJcbiAgICAgIC8vICAgIGEgXCJ0YXBcIiBldmVudC4gSW4gaU9TLCBtb3Zpbmcgd2lsbCBjYW5jZWwgdGhlIHRhcCBpblxuICAgICAgLy8gICAgYm90aCBGYWJyaWMgYW5kIG5vbi1GYWJyaWMuIE9uIEFuZHJvaWQgd2hlbiB5b3UgbW92ZVxuICAgICAgLy8gICAgeW91ciBmaW5nZXIsIHRoZSBoaXQtZGV0ZWN0aW9uIG1vdmVzIGZyb20gdGhlIEFuZHJvaWRcbiAgICAgIC8vICAgIHBsYXRmb3JtIHRvIEpTLCBzbyB3ZSBuZWVkIHRoZSBTaGFkb3dUcmVlIHRvIGhhdmUga25vd2xlZGdlXG4gICAgICAvLyAgICBvZiB0aGUgY3VycmVudCBwb3NpdGlvbi5cbiAgICAgIHRoaXMuX2FuaW1hdGVkVmFsdWVMaXN0ZW5lciA9ICh7dmFsdWV9KSA9PiB7XG4gICAgICAgIC8vIFdoZW4gdGhlIEFuaW1hdGVkSW50ZXJwb2xhdGlvbiBpcyByZWNyZWF0ZWQsIGl0IGFsd2F5cyBpbml0aWFsaXplc1xuICAgICAgICAvLyB0byBhIHZhbHVlIG9mIHplcm8gYW5kIGVtaXRzIGEgdmFsdWUgY2hhbmdlIG9mIDAgdG8gaXRzIGxpc3RlbmVycy5cbiAgICAgICAgaWYgKHZhbHVlID09PSAwICYmICF0aGlzLl9oYXZlUmVjZWl2ZWRJbml0aWFsWmVyb1RyYW5zbGF0ZVkpIHtcbiAgICAgICAgICB0aGlzLl9oYXZlUmVjZWl2ZWRJbml0aWFsWmVyb1RyYW5zbGF0ZVkgPSB0cnVlO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAodGhpcy5fdGltZXIpIHtcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5fdGltZXIpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuX3RpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XG4gICAgICAgICAgaWYgKHZhbHVlICE9PSB0aGlzLnN0YXRlLnRyYW5zbGF0ZVkpIHtcbiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgICAgICAgICB0cmFuc2xhdGVZOiB2YWx1ZSxcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgfSwgdGhpcy5fZGVib3VuY2VUaW1lb3V0KTtcbiAgICAgIH07XG4gICAgfVxuICAgIGlmICh0aGlzLnN0YXRlLnRyYW5zbGF0ZVkgIT09IDAgJiYgdGhpcy5zdGF0ZS50cmFuc2xhdGVZICE9IG51bGwpIHtcbiAgICAgIHRoaXMuX2hhdmVSZWNlaXZlZEluaXRpYWxaZXJvVHJhbnNsYXRlWSA9IGZhbHNlO1xuICAgIH1cbiAgICB0aGlzLl9hbmltYXRlZFZhbHVlTGlzdGVuZXJJZCA9IHRyYW5zbGF0ZVkuYWRkTGlzdGVuZXIoXG4gICAgICB0aGlzLl9hbmltYXRlZFZhbHVlTGlzdGVuZXIsXG4gICAgKTtcbiAgfVxuXG4gIF9vbkxheW91dCA9IGV2ZW50ID0+IHtcbiAgICBjb25zdCBsYXlvdXRZID0gZXZlbnQubmF0aXZlRXZlbnQubGF5b3V0Lnk7XG4gICAgY29uc3QgbGF5b3V0SGVpZ2h0ID0gZXZlbnQubmF0aXZlRXZlbnQubGF5b3V0LmhlaWdodDtcbiAgICBjb25zdCBtZWFzdXJlZCA9IHRydWU7XG5cbiAgICBpZiAoXG4gICAgICBsYXlvdXRZICE9PSB0aGlzLnN0YXRlLmxheW91dFkgfHxcbiAgICAgIGxheW91dEhlaWdodCAhPT0gdGhpcy5zdGF0ZS5sYXlvdXRIZWlnaHQgfHxcbiAgICAgIG1lYXN1cmVkICE9PSB0aGlzLnN0YXRlLm1lYXN1cmVkXG4gICAgKSB7XG4gICAgICB0aGlzLl9zaG91bGRSZWNyZWF0ZVRyYW5zbGF0ZVkgPSB0cnVlO1xuICAgIH1cblxuICAgIHRoaXMuc2V0U3RhdGUoe1xuICAgICAgbWVhc3VyZWQsXG4gICAgICBsYXlvdXRZLFxuICAgICAgbGF5b3V0SGVpZ2h0LFxuICAgIH0pO1xuXG4gICAgdGhpcy5wcm9wcy5vbkxheW91dChldmVudCk7XG4gICAgY29uc3QgY2hpbGQgPSBSZWFjdC5DaGlsZHJlbi5vbmx5KHRoaXMucHJvcHMuY2hpbGRyZW4pO1xuICAgIGlmIChjaGlsZC5wcm9wcy5vbkxheW91dCkge1xuICAgICAgY2hpbGQucHJvcHMub25MYXlvdXQoZXZlbnQpO1xuICAgIH1cbiAgfTtcblxuICBfc2V0Q29tcG9uZW50UmVmID0gcmVmID0+IHtcbiAgICB0aGlzLl9yZWYgPSByZWY7XG4gIH07XG5cbiAgcmVuZGVyKCk6IFJlYWN0Lk5vZGUge1xuICAgIC8vIEZhYnJpYyBEZXRlY3Rpb25cbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZG90LW5vdGF0aW9uXG4gICAgY29uc3QgaXNGYWJyaWMgPSAhIShcbiAgICAgIHRoaXMuX3JlZiAmJiB0aGlzLl9yZWZbJ19pbnRlcm5hbEluc3RhbmNlSGFuZGxlJ10/LnN0YXRlTm9kZT8uY2Fub25pY2FsXG4gICAgKTtcblxuICAgIC8vIEluaXRpYWxseSBhbmQgaW4gdGhlIGNhc2Ugb2YgdXBkYXRlZCBwcm9wcyBvciBsYXlvdXQsIHdlXG4gICAgLy8gcmVjcmVhdGUgdGhpcyBpbnRlcnBvbGF0ZWQgdmFsdWUuIE90aGVyd2lzZSwgd2UgZG8gbm90IHJlY3JlYXRlXG4gICAgLy8gd2hlbiB0aGVyZSBhcmUgc3RhdGUgY2hhbmdlcy5cbiAgICBpZiAodGhpcy5fc2hvdWxkUmVjcmVhdGVUcmFuc2xhdGVZKSB7XG4gICAgICBjb25zdCB7aW52ZXJ0ZWQsIHNjcm9sbFZpZXdIZWlnaHR9ID0gdGhpcy5wcm9wcztcbiAgICAgIGNvbnN0IHttZWFzdXJlZCwgbGF5b3V0SGVpZ2h0LCBsYXlvdXRZLCBuZXh0SGVhZGVyTGF5b3V0WX0gPSB0aGlzLnN0YXRlO1xuICAgICAgY29uc3QgaW5wdXRSYW5nZTogQXJyYXk8bnVtYmVyPiA9IFstMSwgMF07XG4gICAgICBjb25zdCBvdXRwdXRSYW5nZTogQXJyYXk8bnVtYmVyPiA9IFswLCAwXTtcblxuICAgICAgaWYgKG1lYXN1cmVkKSB7XG4gICAgICAgIGlmIChpbnZlcnRlZCkge1xuICAgICAgICAgIC8vIFRoZSBpbnRlcnBvbGF0aW9uIGxvb2tzIGxpa2U6XG4gICAgICAgICAgLy8gLSBOZWdhdGl2ZSBzY3JvbGw6IG5vIHRyYW5zbGF0aW9uXG4gICAgICAgICAgLy8gLSBgc3RpY2tTdGFydFBvaW50YCBpcyB0aGUgcG9pbnQgYXQgd2hpY2ggdGhlIGhlYWRlciB3aWxsIHN0YXJ0IHN0aWNraW5nLlxuICAgICAgICAgIC8vICAgSXQgaXMgY2FsY3VsYXRlZCB1c2luZyB0aGUgU2Nyb2xsVmlldyB2aWV3cG9ydCBoZWlnaHQgc28gaXQgaXMgYSB0aGUgYm90dG9tLlxuICAgICAgICAgIC8vIC0gSGVhZGVycyB0aGF0IGFyZSBpbiB0aGUgaW5pdGlhbCB2aWV3cG9ydCB3aWxsIG5ldmVyIHN0aWNrLCBgc3RpY2tTdGFydFBvaW50YFxuICAgICAgICAgIC8vICAgd2lsbCBiZSBuZWdhdGl2ZS5cbiAgICAgICAgICAvLyAtIEZyb20gMCB0byBgc3RpY2tTdGFydFBvaW50YCBubyB0cmFuc2xhdGlvbi4gVGhpcyB3aWxsIGNhdXNlIHRoZSBoZWFkZXJcbiAgICAgICAgICAvLyAgIHRvIHNjcm9sbCBub3JtYWxseSB1bnRpbCBpdCByZWFjaGVzIHRoZSB0b3Agb2YgdGhlIHNjcm9sbCB2aWV3LlxuICAgICAgICAgIC8vIC0gRnJvbSBgc3RpY2tTdGFydFBvaW50YCB0byB3aGVuIHRoZSBuZXh0IGhlYWRlciB5IGhpdHMgdGhlIGJvdHRvbSBlZGdlIG9mIHRoZSBoZWFkZXI6IHRyYW5zbGF0ZVxuICAgICAgICAgIC8vICAgZXF1YWxseSB0byBzY3JvbGwuIFRoaXMgd2lsbCBjYXVzZSB0aGUgaGVhZGVyIHRvIHN0YXkgYXQgdGhlIHRvcCBvZiB0aGUgc2Nyb2xsIHZpZXcuXG4gICAgICAgICAgLy8gLSBQYXN0IHRoZSBjb2xsaXNpb24gd2l0aCB0aGUgbmV4dCBoZWFkZXIgeTogbm8gbW9yZSB0cmFuc2xhdGlvbi4gVGhpcyB3aWxsIGNhdXNlIHRoZVxuICAgICAgICAgIC8vICAgaGVhZGVyIHRvIGNvbnRpbnVlIHNjcm9sbGluZyB1cCBhbmQgbWFrZSByb29tIGZvciB0aGUgbmV4dCBzdGlja3kgaGVhZGVyLlxuICAgICAgICAgIC8vICAgSW4gdGhlIGNhc2UgdGhhdCB0aGVyZSBpcyBubyBuZXh0IGhlYWRlciBqdXN0IHRyYW5zbGF0ZSBlcXVhbGx5IHRvXG4gICAgICAgICAgLy8gICBzY3JvbGwgaW5kZWZpbml0ZWx5LlxuICAgICAgICAgIGlmIChzY3JvbGxWaWV3SGVpZ2h0ICE9IG51bGwpIHtcbiAgICAgICAgICAgIGNvbnN0IHN0aWNrU3RhcnRQb2ludCA9IGxheW91dFkgKyBsYXlvdXRIZWlnaHQgLSBzY3JvbGxWaWV3SGVpZ2h0O1xuICAgICAgICAgICAgaWYgKHN0aWNrU3RhcnRQb2ludCA+IDApIHtcbiAgICAgICAgICAgICAgaW5wdXRSYW5nZS5wdXNoKHN0aWNrU3RhcnRQb2ludCk7XG4gICAgICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goMCk7XG4gICAgICAgICAgICAgIGlucHV0UmFuZ2UucHVzaChzdGlja1N0YXJ0UG9pbnQgKyAxKTtcbiAgICAgICAgICAgICAgb3V0cHV0UmFuZ2UucHVzaCgxKTtcbiAgICAgICAgICAgICAgLy8gSWYgdGhlIG5leHQgc3RpY2t5IGhlYWRlciBoYXMgbm90IGxvYWRlZCB5ZXQgKHByb2JhYmx5IHdpbmRvd2luZykgb3IgaXMgdGhlIGxhc3RcbiAgICAgICAgICAgICAgLy8gd2UgY2FuIGp1c3Qga2VlcCBpdCBzdGlja2VkIGZvcmV2ZXIuXG4gICAgICAgICAgICAgIGNvbnN0IGNvbGxpc2lvblBvaW50ID1cbiAgICAgICAgICAgICAgICAobmV4dEhlYWRlckxheW91dFkgfHwgMCkgLSBsYXlvdXRIZWlnaHQgLSBzY3JvbGxWaWV3SGVpZ2h0O1xuICAgICAgICAgICAgICBpZiAoY29sbGlzaW9uUG9pbnQgPiBzdGlja1N0YXJ0UG9pbnQpIHtcbiAgICAgICAgICAgICAgICBpbnB1dFJhbmdlLnB1c2goY29sbGlzaW9uUG9pbnQsIGNvbGxpc2lvblBvaW50ICsgMSk7XG4gICAgICAgICAgICAgICAgb3V0cHV0UmFuZ2UucHVzaChcbiAgICAgICAgICAgICAgICAgIGNvbGxpc2lvblBvaW50IC0gc3RpY2tTdGFydFBvaW50LFxuICAgICAgICAgICAgICAgICAgY29sbGlzaW9uUG9pbnQgLSBzdGlja1N0YXJ0UG9pbnQsXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAvLyBUaGUgaW50ZXJwb2xhdGlvbiBsb29rcyBsaWtlOlxuICAgICAgICAgIC8vIC0gTmVnYXRpdmUgc2Nyb2xsOiBubyB0cmFuc2xhdGlvblxuICAgICAgICAgIC8vIC0gRnJvbSAwIHRvIHRoZSB5IG9mIHRoZSBoZWFkZXI6IG5vIHRyYW5zbGF0aW9uLiBUaGlzIHdpbGwgY2F1c2UgdGhlIGhlYWRlclxuICAgICAgICAgIC8vICAgdG8gc2Nyb2xsIG5vcm1hbGx5IHVudGlsIGl0IHJlYWNoZXMgdGhlIHRvcCBvZiB0aGUgc2Nyb2xsIHZpZXcuXG4gICAgICAgICAgLy8gLSBGcm9tIGhlYWRlciB5IHRvIHdoZW4gdGhlIG5leHQgaGVhZGVyIHkgaGl0cyB0aGUgYm90dG9tIGVkZ2Ugb2YgdGhlIGhlYWRlcjogdHJhbnNsYXRlXG4gICAgICAgICAgLy8gICBlcXVhbGx5IHRvIHNjcm9sbC4gVGhpcyB3aWxsIGNhdXNlIHRoZSBoZWFkZXIgdG8gc3RheSBhdCB0aGUgdG9wIG9mIHRoZSBzY3JvbGwgdmlldy5cbiAgICAgICAgICAvLyAtIFBhc3QgdGhlIGNvbGxpc2lvbiB3aXRoIHRoZSBuZXh0IGhlYWRlciB5OiBubyBtb3JlIHRyYW5zbGF0aW9uLiBUaGlzIHdpbGwgY2F1c2UgdGhlXG4gICAgICAgICAgLy8gICBoZWFkZXIgdG8gY29udGludWUgc2Nyb2xsaW5nIHVwIGFuZCBtYWtlIHJvb20gZm9yIHRoZSBuZXh0IHN0aWNreSBoZWFkZXIuXG4gICAgICAgICAgLy8gICBJbiB0aGUgY2FzZSB0aGF0IHRoZXJlIGlzIG5vIG5leHQgaGVhZGVyIGp1c3QgdHJhbnNsYXRlIGVxdWFsbHkgdG9cbiAgICAgICAgICAvLyAgIHNjcm9sbCBpbmRlZmluaXRlbHkuXG4gICAgICAgICAgaW5wdXRSYW5nZS5wdXNoKGxheW91dFkpO1xuICAgICAgICAgIG91dHB1dFJhbmdlLnB1c2goMCk7XG4gICAgICAgICAgLy8gSWYgdGhlIG5leHQgc3RpY2t5IGhlYWRlciBoYXMgbm90IGxvYWRlZCB5ZXQgKHByb2JhYmx5IHdpbmRvd2luZykgb3IgaXMgdGhlIGxhc3RcbiAgICAgICAgICAvLyB3ZSBjYW4ganVzdCBrZWVwIGl0IHN0aWNrZWQgZm9yZXZlci5cbiAgICAgICAgICBjb25zdCBjb2xsaXNpb25Qb2ludCA9IChuZXh0SGVhZGVyTGF5b3V0WSB8fCAwKSAtIGxheW91dEhlaWdodDtcbiAgICAgICAgICBpZiAoY29sbGlzaW9uUG9pbnQgPj0gbGF5b3V0WSkge1xuICAgICAgICAgICAgaW5wdXRSYW5nZS5wdXNoKGNvbGxpc2lvblBvaW50LCBjb2xsaXNpb25Qb2ludCArIDEpO1xuICAgICAgICAgICAgb3V0cHV0UmFuZ2UucHVzaChcbiAgICAgICAgICAgICAgY29sbGlzaW9uUG9pbnQgLSBsYXlvdXRZLFxuICAgICAgICAgICAgICBjb2xsaXNpb25Qb2ludCAtIGxheW91dFksXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBpbnB1dFJhbmdlLnB1c2gobGF5b3V0WSArIDEpO1xuICAgICAgICAgICAgb3V0cHV0UmFuZ2UucHVzaCgxKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgdGhpcy51cGRhdGVUcmFuc2xhdGVMaXN0ZW5lcihcbiAgICAgICAgdGhpcy5wcm9wcy5zY3JvbGxBbmltYXRlZFZhbHVlLmludGVycG9sYXRlKHtcbiAgICAgICAgICBpbnB1dFJhbmdlLFxuICAgICAgICAgIG91dHB1dFJhbmdlLFxuICAgICAgICB9KSxcbiAgICAgICAgaXNGYWJyaWMsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IGNoaWxkID0gUmVhY3QuQ2hpbGRyZW4ub25seSh0aGlzLnByb3BzLmNoaWxkcmVuKTtcblxuICAgIC8vIFRPRE8gVDY4MzE5NTM1OiByZW1vdmUgdGhpcyBpZiBOYXRpdmVBbmltYXRlZCBpcyByZXdyaXR0ZW4gZm9yIEZhYnJpY1xuICAgIGNvbnN0IHBhc3N0aHJvdWdoQW5pbWF0ZWRQcm9wRXhwbGljaXRWYWx1ZXMgPVxuICAgICAgaXNGYWJyaWMgJiYgdGhpcy5zdGF0ZS50cmFuc2xhdGVZICE9IG51bGxcbiAgICAgICAgPyB7XG4gICAgICAgICAgICBzdHlsZToge3RyYW5zZm9ybTogW3t0cmFuc2xhdGVZOiB0aGlzLnN0YXRlLnRyYW5zbGF0ZVl9XX0sXG4gICAgICAgICAgfVxuICAgICAgICA6IG51bGw7XG5cbiAgICByZXR1cm4gKFxuICAgICAgPEFuaW1hdGVkVmlld1xuICAgICAgICBjb2xsYXBzYWJsZT17ZmFsc2V9XG4gICAgICAgIG5hdGl2ZUlEPXt0aGlzLnByb3BzLm5hdGl2ZUlEfVxuICAgICAgICBvbkxheW91dD17dGhpcy5fb25MYXlvdXR9XG4gICAgICAgIHJlZj17dGhpcy5fc2V0Q29tcG9uZW50UmVmfVxuICAgICAgICBzdHlsZT17W1xuICAgICAgICAgIGNoaWxkLnByb3BzLnN0eWxlLFxuICAgICAgICAgIHN0eWxlcy5oZWFkZXIsXG4gICAgICAgICAge3RyYW5zZm9ybTogW3t0cmFuc2xhdGVZOiB0aGlzLl90cmFuc2xhdGVZfV19LFxuICAgICAgICBdfVxuICAgICAgICBwYXNzdGhyb3VnaEFuaW1hdGVkUHJvcEV4cGxpY2l0VmFsdWVzPXtcbiAgICAgICAgICBwYXNzdGhyb3VnaEFuaW1hdGVkUHJvcEV4cGxpY2l0VmFsdWVzXG4gICAgICAgIH0+XG4gICAgICAgIHtSZWFjdC5jbG9uZUVsZW1lbnQoY2hpbGQsIHtcbiAgICAgICAgICBzdHlsZTogc3R5bGVzLmZpbGwsIC8vIFdlIHRyYW5zZmVyIHRoZSBjaGlsZCBzdHlsZSB0byB0aGUgd3JhcHBlci5cbiAgICAgICAgICBvbkxheW91dDogdW5kZWZpbmVkLCAvLyB3ZSBjYWxsIHRoaXMgbWFudWFsbHkgdGhyb3VnaCBvdXIgdGhpcy5fb25MYXlvdXRcbiAgICAgICAgfSl9XG4gICAgICA8L0FuaW1hdGVkVmlldz5cbiAgICApO1xuICB9XG59XG5cbmNvbnN0IHN0eWxlcyA9IFN0eWxlU2hlZXQuY3JlYXRlKHtcbiAgaGVhZGVyOiB7XG4gICAgekluZGV4OiAxMCxcbiAgICBwb3NpdGlvbjogJ3JlbGF0aXZlJyxcbiAgfSxcbiAgZmlsbDoge1xuICAgIGZsZXg6IDEsXG4gIH0sXG59KTtcblxubW9kdWxlLmV4cG9ydHMgPSBTY3JvbGxWaWV3U3RpY2t5SGVhZGVyO1xuIl19