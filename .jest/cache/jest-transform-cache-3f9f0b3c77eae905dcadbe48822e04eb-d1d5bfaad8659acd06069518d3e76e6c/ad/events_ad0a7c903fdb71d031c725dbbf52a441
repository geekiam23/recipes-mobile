18b3b99d7cb154ef5f94e3543f520a5b
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _excluded = ["value", "files"],
    _excluded2 = ["bubbles", "cancelable", "detail"];
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.fireEvent = fireEvent;
exports.createEvent = createEvent;

var _config = require("./config");

var _helpers = require("./helpers");

var _eventMap = require("./event-map");

function fireEvent(element, event) {
  return (0, _config.getConfig)().eventWrapper(function () {
    if (!event) {
      throw new Error("Unable to fire an event - please provide an event object.");
    }

    if (!element) {
      throw new Error("Unable to fire a \"" + event.type + "\" event - please provide a DOM element.");
    }

    return element.dispatchEvent(event);
  });
}

function createEvent(eventName, node, init) {
  var _ref = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {},
      _ref$EventType = _ref.EventType,
      EventType = _ref$EventType === void 0 ? 'Event' : _ref$EventType,
      _ref$defaultInit = _ref.defaultInit,
      defaultInit = _ref$defaultInit === void 0 ? {} : _ref$defaultInit;

  if (!node) {
    throw new Error("Unable to fire a \"" + eventName + "\" event - please provide a DOM element.");
  }

  var eventInit = (0, _extends2.default)({}, defaultInit, init);
  var _eventInit$target = eventInit.target;
  _eventInit$target = _eventInit$target === void 0 ? {} : _eventInit$target;
  var value = _eventInit$target.value,
      files = _eventInit$target.files,
      targetProperties = (0, _objectWithoutProperties2.default)(_eventInit$target, _excluded);

  if (value !== undefined) {
    setNativeValue(node, value);
  }

  if (files !== undefined) {
    Object.defineProperty(node, 'files', {
      configurable: true,
      enumerable: true,
      writable: true,
      value: files
    });
  }

  (0, _extends2.default)(node, targetProperties);
  var window = (0, _helpers.getWindowFromNode)(node);
  var EventConstructor = window[EventType] || window.Event;
  var event;

  if (typeof EventConstructor === 'function') {
    event = new EventConstructor(eventName, eventInit);
  } else {
    event = window.document.createEvent(EventType);
    var bubbles = eventInit.bubbles,
        cancelable = eventInit.cancelable,
        detail = eventInit.detail,
        otherInit = (0, _objectWithoutProperties2.default)(eventInit, _excluded2);
    event.initEvent(eventName, bubbles, cancelable, detail);
    Object.keys(otherInit).forEach(function (eventKey) {
      event[eventKey] = otherInit[eventKey];
    });
  }

  var dataTransferProperties = ['dataTransfer', 'clipboardData'];
  dataTransferProperties.forEach(function (dataTransferKey) {
    var dataTransferValue = eventInit[dataTransferKey];

    if (typeof dataTransferValue === 'object') {
      if (typeof window.DataTransfer === 'function') {
        Object.defineProperty(event, dataTransferKey, {
          value: Object.getOwnPropertyNames(dataTransferValue).reduce(function (acc, propName) {
            Object.defineProperty(acc, propName, {
              value: dataTransferValue[propName]
            });
            return acc;
          }, new window.DataTransfer())
        });
      } else {
        Object.defineProperty(event, dataTransferKey, {
          value: dataTransferValue
        });
      }
    }
  });
  return event;
}

Object.keys(_eventMap.eventMap).forEach(function (key) {
  var _eventMap$eventMap$ke = _eventMap.eventMap[key],
      EventType = _eventMap$eventMap$ke.EventType,
      defaultInit = _eventMap$eventMap$ke.defaultInit;
  var eventName = key.toLowerCase();

  createEvent[key] = function (node, init) {
    return createEvent(eventName, node, init, {
      EventType: EventType,
      defaultInit: defaultInit
    });
  };

  fireEvent[key] = function (node, init) {
    return fireEvent(node, createEvent[key](node, init));
  };
});

function setNativeValue(element, value) {
  var _ref2 = Object.getOwnPropertyDescriptor(element, 'value') || {},
      valueSetter = _ref2.set;

  var prototype = Object.getPrototypeOf(element);

  var _ref3 = Object.getOwnPropertyDescriptor(prototype, 'value') || {},
      prototypeValueSetter = _ref3.set;

  if (prototypeValueSetter && valueSetter !== prototypeValueSetter) {
    prototypeValueSetter.call(element, value);
  } else if (valueSetter) {
      valueSetter.call(element, value);
    } else {
      throw new Error('The given element does not have a value setter');
    }
}

Object.keys(_eventMap.eventAliasMap).forEach(function (aliasKey) {
  var key = _eventMap.eventAliasMap[aliasKey];

  fireEvent[aliasKey] = function () {
    return fireEvent[key].apply(fireEvent, arguments);
  };
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImV2ZW50cy5qcyJdLCJuYW1lcyI6WyJPYmplY3QiLCJkZWZpbmVQcm9wZXJ0eSIsImV4cG9ydHMiLCJ2YWx1ZSIsImZpcmVFdmVudCIsImNyZWF0ZUV2ZW50IiwiX2NvbmZpZyIsInJlcXVpcmUiLCJfaGVscGVycyIsIl9ldmVudE1hcCIsImVsZW1lbnQiLCJldmVudCIsImdldENvbmZpZyIsImV2ZW50V3JhcHBlciIsIkVycm9yIiwidHlwZSIsImRpc3BhdGNoRXZlbnQiLCJldmVudE5hbWUiLCJub2RlIiwiaW5pdCIsIkV2ZW50VHlwZSIsImRlZmF1bHRJbml0IiwiZXZlbnRJbml0IiwidGFyZ2V0IiwiZmlsZXMiLCJ0YXJnZXRQcm9wZXJ0aWVzIiwidW5kZWZpbmVkIiwic2V0TmF0aXZlVmFsdWUiLCJjb25maWd1cmFibGUiLCJlbnVtZXJhYmxlIiwid3JpdGFibGUiLCJ3aW5kb3ciLCJnZXRXaW5kb3dGcm9tTm9kZSIsIkV2ZW50Q29uc3RydWN0b3IiLCJFdmVudCIsImRvY3VtZW50IiwiYnViYmxlcyIsImNhbmNlbGFibGUiLCJkZXRhaWwiLCJvdGhlckluaXQiLCJpbml0RXZlbnQiLCJrZXlzIiwiZm9yRWFjaCIsImV2ZW50S2V5IiwiZGF0YVRyYW5zZmVyUHJvcGVydGllcyIsImRhdGFUcmFuc2ZlcktleSIsImRhdGFUcmFuc2ZlclZhbHVlIiwiRGF0YVRyYW5zZmVyIiwiZ2V0T3duUHJvcGVydHlOYW1lcyIsInJlZHVjZSIsImFjYyIsInByb3BOYW1lIiwiZXZlbnRNYXAiLCJrZXkiLCJ0b0xvd2VyQ2FzZSIsImdldE93blByb3BlcnR5RGVzY3JpcHRvciIsInZhbHVlU2V0dGVyIiwic2V0IiwicHJvdG90eXBlIiwiZ2V0UHJvdG90eXBlT2YiLCJwcm90b3R5cGVWYWx1ZVNldHRlciIsImNhbGwiLCJldmVudEFsaWFzTWFwIiwiYWxpYXNLZXkiXSwibWFwcGluZ3MiOiJBQUFBOzs7Ozs7Ozs7O0FBRUFBLE1BQU0sQ0FBQ0MsY0FBUCxDQUFzQkMs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QzJELGNBQVAsQ0FBc0JqRCxPQUF0QixDQUFsQjs7QUFDQSxjQUVJVixNQUFNLENBQUN1RCx3QkFBUCxDQUFnQ0csU0FBaEMsRUFBMkMsT0FBM0MsS0FBdUQsRUFGM0Q7QUFBQSxNQUNPRSxvQkFEUCxTQUNFSCxHQURGOztBQUlBLE1BQUlHLG9CQUFvQixJQUFJSixXQUFXLEtBQUtJLG9CQUE1QyxFQUFrRTtBQUNoRUEsSUFBQUEsb0JBQW9CLENBQUNDLElBQXJCLENBQTBCbkQsT0FBMUIsRUFBbUNQLEtBQW5DO0FBQ0QsR0FGRCxNQUlLLElBQUlxRCxXQUFKLEVBQWlCO0FBQ2xCQSxNQUFBQSxXQUFXLENBQUNLLElBQVosQ0FBaUJuRCxPQUFqQixFQUEwQlAsS0FBMUI7QUFDRCxLQUZFLE1BRUk7QUFDTCxZQUFNLElBQUlXLEtBQUosQ0FBVSxnREFBVixDQUFOO0FBQ0Q7QUFDSjs7QUFFRGQsTUFBTSxDQUFDeUMsSUFBUCxDQUFZaEMsU0FBUyxDQUFDcUQsYUFBdEIsRUFBcUNwQixPQUFyQyxDQUE2QyxVQUFBcUIsUUFBUSxFQUFJO0FBQ3ZELE1BQU1WLEdBQUcsR0FBRzVDLFNBQVMsQ0FBQ3FELGFBQVYsQ0FBd0JDLFFBQXhCLENBQVo7O0FBRUEzRCxFQUFBQSxTQUFTLENBQUMyRCxRQUFELENBQVQsR0FBc0I7QUFBQSxXQUFhM0QsU0FBUyxDQUFDaUQsR0FBRCxDQUFULE9BQUFqRCxTQUFTLFlBQXRCO0FBQUEsR0FBdEI7QUFDRCxDQUpEIiwic291cmNlc0NvbnRlbnQiOlsiXCJ1c2Ugc3RyaWN0XCI7XG5cbk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCBcIl9fZXNNb2R1bGVcIiwge1xuICB2YWx1ZTogdHJ1ZVxufSk7XG5leHBvcnRzLmZpcmVFdmVudCA9IGZpcmVFdmVudDtcbmV4cG9ydHMuY3JlYXRlRXZlbnQgPSBjcmVhdGVFdmVudDtcblxudmFyIF9jb25maWcgPSByZXF1aXJlKFwiLi9jb25maWdcIik7XG5cbnZhciBfaGVscGVycyA9IHJlcXVpcmUoXCIuL2hlbHBlcnNcIik7XG5cbnZhciBfZXZlbnRNYXAgPSByZXF1aXJlKFwiLi9ldmVudC1tYXBcIik7XG5cbmZ1bmN0aW9uIGZpcmVFdmVudChlbGVtZW50LCBldmVudCkge1xuICByZXR1cm4gKDAsIF9jb25maWcuZ2V0Q29uZmlnKSgpLmV2ZW50V3JhcHBlcigoKSA9PiB7XG4gICAgaWYgKCFldmVudCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gZmlyZSBhbiBldmVudCAtIHBsZWFzZSBwcm92aWRlIGFuIGV2ZW50IG9iamVjdC5gKTtcbiAgICB9XG5cbiAgICBpZiAoIWVsZW1lbnQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGZpcmUgYSBcIiR7ZXZlbnQudHlwZX1cIiBldmVudCAtIHBsZWFzZSBwcm92aWRlIGEgRE9NIGVsZW1lbnQuYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGVsZW1lbnQuZGlzcGF0Y2hFdmVudChldmVudCk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVFdmVudChldmVudE5hbWUsIG5vZGUsIGluaXQsIHtcbiAgRXZlbnRUeXBlID0gJ0V2ZW50JyxcbiAgZGVmYXVsdEluaXQgPSB7fVxufSA9IHt9KSB7XG4gIGlmICghbm9kZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGZpcmUgYSBcIiR7ZXZlbnROYW1lfVwiIGV2ZW50IC0gcGxlYXNlIHByb3ZpZGUgYSBET00gZWxlbWVudC5gKTtcbiAgfVxuXG4gIGNvbnN0IGV2ZW50SW5pdCA9IHsgLi4uZGVmYXVsdEluaXQsXG4gICAgLi4uaW5pdFxuICB9O1xuICBjb25zdCB7XG4gICAgdGFyZ2V0OiB7XG4gICAgICB2YWx1ZSxcbiAgICAgIGZpbGVzLFxuICAgICAgLi4udGFyZ2V0UHJvcGVydGllc1xuICAgIH0gPSB7fVxuICB9ID0gZXZlbnRJbml0O1xuXG4gIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgc2V0TmF0aXZlVmFsdWUobm9kZSwgdmFsdWUpO1xuICB9XG5cbiAgaWYgKGZpbGVzICE9PSB1bmRlZmluZWQpIHtcbiAgICAvLyBpbnB1dC5maWxlcyBpcyBhIHJlYWQtb25seSBwcm9wZXJ0eSBzbyB0aGlzIGlzIG5vdCBhbGxvd2VkOlxuICAgIC8vIGlucHV0LmZpbGVzID0gW2ZpbGVdXG4gICAgLy8gc28gd2UgaGF2ZSB0byB1c2UgdGhpcyB3b3JrYXJvdW5kIHRvIHNldCB0aGUgcHJvcGVydHlcbiAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobm9kZSwgJ2ZpbGVzJywge1xuICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgZW51bWVyYWJsZTogdHJ1ZSxcbiAgICAgIHdyaXRhYmxlOiB0cnVlLFxuICAgICAgdmFsdWU6IGZpbGVzXG4gICAgfSk7XG4gIH1cblxuICBPYmplY3QuYXNzaWduKG5vZGUsIHRhcmdldFByb3BlcnRpZXMpO1xuICBjb25zdCB3aW5kb3cgPSAoMCwgX2hlbHBlcnMuZ2V0V2luZG93RnJvbU5vZGUpKG5vZGUpO1xuICBjb25zdCBFdmVudENvbnN0cnVjdG9yID0gd2luZG93W0V2ZW50VHlwZV0gfHwgd2luZG93LkV2ZW50O1xuICBsZXQgZXZlbnQ7XG4gIC8qIGlzdGFuYnVsIGlnbm9yZSBlbHNlICAqL1xuXG4gIGlmICh0eXBlb2YgRXZlbnRDb25zdHJ1Y3RvciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGV2ZW50ID0gbmV3IEV2ZW50Q29uc3RydWN0b3IoZXZlbnROYW1lLCBldmVudEluaXQpO1xuICB9IGVsc2Uge1xuICAgIC8vIElFMTEgcG9seWZpbGwgZnJvbSBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1dlYi9BUEkvQ3VzdG9tRXZlbnQvQ3VzdG9tRXZlbnQjUG9seWZpbGxcbiAgICBldmVudCA9IHdpbmRvdy5kb2N1bWVudC5jcmVhdGVFdmVudChFdmVudFR5cGUpO1xuICAgIGNvbnN0IHtcbiAgICAgIGJ1YmJsZXMsXG4gICAgICBjYW5jZWxhYmxlLFxuICAgICAgZGV0YWlsLFxuICAgICAgLi4ub3RoZXJJbml0XG4gICAgfSA9IGV2ZW50SW5pdDtcbiAgICBldmVudC5pbml0RXZlbnQoZXZlbnROYW1lLCBidWJibGVzLCBjYW5jZWxhYmxlLCBkZXRhaWwpO1xuICAgIE9iamVjdC5rZXlzKG90aGVySW5pdCkuZm9yRWFjaChldmVudEtleSA9PiB7XG4gICAgICBldmVudFtldmVudEtleV0gPSBvdGhlckluaXRbZXZlbnRLZXldO1xuICAgIH0pO1xuICB9IC8vIERhdGFUcmFuc2ZlciBpcyBub3Qgc3VwcG9ydGVkIGluIGpzZG9tOiBodHRwczovL2dpdGh1Yi5jb20vanNkb20vanNkb20vaXNzdWVzLzE1NjhcblxuXG4gIGNvbnN0IGRhdGFUcmFuc2ZlclByb3BlcnRpZXMgPSBbJ2RhdGFUcmFuc2ZlcicsICdjbGlwYm9hcmREYXRhJ107XG4gIGRhdGFUcmFuc2ZlclByb3BlcnRpZXMuZm9yRWFjaChkYXRhVHJhbnNmZXJLZXkgPT4ge1xuICAgIGNvbnN0IGRhdGFUcmFuc2ZlclZhbHVlID0gZXZlbnRJbml0W2RhdGFUcmFuc2ZlcktleV07XG5cbiAgICBpZiAodHlwZW9mIGRhdGFUcmFuc2ZlclZhbHVlID09PSAnb2JqZWN0Jykge1xuICAgICAgLyogaXN0YW5idWwgaWdub3JlIGlmICAqL1xuICAgICAgaWYgKHR5cGVvZiB3aW5kb3cuRGF0YVRyYW5zZmVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShldmVudCwgZGF0YVRyYW5zZmVyS2V5LCB7XG4gICAgICAgICAgdmFsdWU6IE9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKGRhdGFUcmFuc2ZlclZhbHVlKS5yZWR1Y2UoKGFjYywgcHJvcE5hbWUpID0+IHtcbiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShhY2MsIHByb3BOYW1lLCB7XG4gICAgICAgICAgICAgIHZhbHVlOiBkYXRhVHJhbnNmZXJWYWx1ZVtwcm9wTmFtZV1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgICB9LCBuZXcgd2luZG93LkRhdGFUcmFuc2ZlcigpKVxuICAgICAgICB9KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShldmVudCwgZGF0YVRyYW5zZmVyS2V5LCB7XG4gICAgICAgICAgdmFsdWU6IGRhdGFUcmFuc2ZlclZhbHVlXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIHJldHVybiBldmVudDtcbn1cblxuT2JqZWN0LmtleXMoX2V2ZW50TWFwLmV2ZW50TWFwKS5mb3JFYWNoKGtleSA9PiB7XG4gIGNvbnN0IHtcbiAgICBFdmVudFR5cGUsXG4gICAgZGVmYXVsdEluaXRcbiAgfSA9IF9ldmVudE1hcC5ldmVudE1hcFtrZXldO1xuICBjb25zdCBldmVudE5hbWUgPSBrZXkudG9Mb3dlckNhc2UoKTtcblxuICBjcmVhdGVFdmVudFtrZXldID0gKG5vZGUsIGluaXQpID0+IGNyZWF0ZUV2ZW50KGV2ZW50TmFtZSwgbm9kZSwgaW5pdCwge1xuICAgIEV2ZW50VHlwZSxcbiAgICBkZWZhdWx0SW5pdFxuICB9KTtcblxuICBmaXJlRXZlbnRba2V5XSA9IChub2RlLCBpbml0KSA9PiBmaXJlRXZlbnQobm9kZSwgY3JlYXRlRXZlbnRba2V5XShub2RlLCBpbml0KSk7XG59KTsgLy8gZnVuY3Rpb24gd3JpdHRlbiBhZnRlciBzb21lIGludmVzdGlnYXRpb24gaGVyZTpcbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC9pc3N1ZXMvMTAxMzUjaXNzdWVjb21tZW50LTQwMTQ5Njc3NlxuXG5mdW5jdGlvbiBzZXROYXRpdmVWYWx1ZShlbGVtZW50LCB2YWx1ZSkge1xuICBjb25zdCB7XG4gICAgc2V0OiB2YWx1ZVNldHRlclxuICB9ID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihlbGVtZW50LCAndmFsdWUnKSB8fCB7fTtcbiAgY29uc3QgcHJvdG90eXBlID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKGVsZW1lbnQpO1xuICBjb25zdCB7XG4gICAgc2V0OiBwcm90b3R5cGVWYWx1ZVNldHRlclxuICB9ID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihwcm90b3R5cGUsICd2YWx1ZScpIHx8IHt9O1xuXG4gIGlmIChwcm90b3R5cGVWYWx1ZVNldHRlciAmJiB2YWx1ZVNldHRlciAhPT0gcHJvdG90eXBlVmFsdWVTZXR0ZXIpIHtcbiAgICBwcm90b3R5cGVWYWx1ZVNldHRlci5jYWxsKGVsZW1lbnQsIHZhbHVlKTtcbiAgfVxuICAvKiBpc3RhbmJ1bCBpZ25vcmUgbmV4dCAoSSBkb24ndCB3YW50IHRvIGJvdGhlcikgKi9cbiAgZWxzZSBpZiAodmFsdWVTZXR0ZXIpIHtcbiAgICAgIHZhbHVlU2V0dGVyLmNhbGwoZWxlbWVudCwgdmFsdWUpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RoZSBnaXZlbiBlbGVtZW50IGRvZXMgbm90IGhhdmUgYSB2YWx1ZSBzZXR0ZXInKTtcbiAgICB9XG59XG5cbk9iamVjdC5rZXlzKF9ldmVudE1hcC5ldmVudEFsaWFzTWFwKS5mb3JFYWNoKGFsaWFzS2V5ID0+IHtcbiAgY29uc3Qga2V5ID0gX2V2ZW50TWFwLmV2ZW50QWxpYXNNYXBbYWxpYXNLZXldO1xuXG4gIGZpcmVFdmVudFthbGlhc0tleV0gPSAoLi4uYXJncykgPT4gZmlyZUV2ZW50W2tleV0oLi4uYXJncyk7XG59KTtcbi8qIGVzbGludCBjb21wbGV4aXR5OltcImVycm9yXCIsIDldICovIl19