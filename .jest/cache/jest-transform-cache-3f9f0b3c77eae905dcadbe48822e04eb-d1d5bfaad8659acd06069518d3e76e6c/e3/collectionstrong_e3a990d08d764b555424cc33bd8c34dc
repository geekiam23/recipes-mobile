bfc92f75ecfeb448a81a9b079a252b7a
'use strict';

var defineProperty = require("../internals/object-define-property").f;

var create = require("../internals/object-create");

var redefineAll = require("../internals/redefine-all");

var bind = require("../internals/function-bind-context");

var anInstance = require("../internals/an-instance");

var iterate = require("../internals/iterate");

var defineIterator = require("../internals/define-iterator");

var setSpecies = require("../internals/set-species");

var DESCRIPTORS = require("../internals/descriptors");

var fastKey = require("../internals/internal-metadata").fastKey;

var InternalStateModule = require("../internals/internal-state");

var setInternalState = InternalStateModule.set;
var internalStateGetterFor = InternalStateModule.getterFor;
module.exports = {
  getConstructor: function getConstructor(wrapper, CONSTRUCTOR_NAME, IS_MAP, ADDER) {
    var C = wrapper(function (that, iterable) {
      anInstance(that, C, CONSTRUCTOR_NAME);
      setInternalState(that, {
        type: CONSTRUCTOR_NAME,
        index: create(null),
        first: undefined,
        last: undefined,
        size: 0
      });
      if (!DESCRIPTORS) that.size = 0;
      if (iterable != undefined) iterate(iterable, that[ADDER], {
        that: that,
        AS_ENTRIES: IS_MAP
      });
    });
    var getInternalState = internalStateGetterFor(CONSTRUCTOR_NAME);

    var define = function define(that, key, value) {
      var state = getInternalState(that);
      var entry = getEntry(that, key);
      var previous, index;

      if (entry) {
        entry.value = value;
      } else {
        state.last = entry = {
          index: index = fastKey(key, true),
          key: key,
          value: value,
          previous: previous = state.last,
          next: undefined,
          removed: false
        };
        if (!state.first) state.first = entry;
        if (previous) previous.next = entry;
        if (DESCRIPTORS) state.size++;else that.size++;
        if (index !== 'F') state.index[index] = entry;
      }

      return that;
    };

    var getEntry = function getEntry(that, key) {
      var state = getInternalState(that);
      var index = fastKey(key);
      var entry;
      if (index !== 'F') return state.index[index];

      for (entry = state.first; entry; entry = entry.next) {
        if (entry.key == key) return entry;
      }
    };

    redefineAll(C.prototype, {
      clear: function clear() {
        var that = this;
        var state = getInternalState(that);
        var data = state.index;
        var entry = state.first;

        while (entry) {
          entry.removed = true;
          if (entry.previous) entry.previous = entry.previous.next = undefined;
          delete data[entry.index];
          entry = entry.next;
        }

        state.first = state.last = undefined;
        if (DESCRIPTORS) state.size = 0;else that.size = 0;
      },
      'delete': function _delete(key) {
        var that = this;
        var state = getInternalState(that);
        var entry = getEntry(that, key);

        if (entry) {
          var next = entry.next;
          var prev = entry.previous;
          delete state.index[entry.index];
          entry.removed = true;
          if (prev) prev.next = next;
          if (next) next.previous = prev;
          if (state.first == entry) state.first = next;
          if (state.last == entry) state.last = prev;
          if (DESCRIPTORS) state.size--;else that.size--;
        }

        return !!entry;
      },
      forEach: function forEach(callbackfn) {
        var state = getInternalState(this);
        var boundFunction = bind(callbackfn, arguments.length > 1 ? arguments[1] : undefined, 3);
        var entry;

        while (entry = entry ? entry.next : state.first) {
          boundFunction(entry.value, entry.key, this);

          while (entry && entry.removed) {
            entry = entry.previous;
          }
        }
      },
      has: function has(key) {
        return !!getEntry(this, key);
      }
    });
    redefineAll(C.prototype, IS_MAP ? {
      get: function get(key) {
        var entry = getEntry(this, key);
        return entry && entry.value;
      },
      set: function set(key, value) {
        return define(this, key === 0 ? 0 : key, value);
      }
    } : {
      add: function add(value) {
        return define(this, value = value === 0 ? 0 : value, value);
      }
    });
    if (DESCRIPTORS) defineProperty(C.prototype, 'size', {
      get: function get() {
        return getInternalState(this).size;
      }
    });
    return C;
  },
  setStrong: function setStrong(C, CONSTRUCTOR_NAME, IS_MAP) {
    var ITERATOR_NAME = CONSTRUCTOR_NAME + ' Iterator';
    var getInternalCollectionState = internalStateGetterFor(CONSTRUCTOR_NAME);
    var getInternalIteratorState = internalStateGetterFor(ITERATOR_NAME);
    defineIterator(C, CONSTRUCTOR_NAME, function (iterated, kind) {
      setInternalState(this, {
        type: ITERATOR_NAME,
        target: iterated,
        state: getInternalCollectionState(iterated),
        kind: kind,
        last: undefined
      });
    }, function () {
      var state = getInternalIteratorState(this);
      var kind = state.kind;
      var entry = state.last;

      while (entry && entry.removed) {
        entry = entry.previous;
      }

      if (!state.target || !(state.last = entry = entry ? entry.next : state.state.first)) {
        state.target = undefined;
        return {
          value: undefined,
          done: true
        };
      }

      if (kind == 'keys') return {
        value: entry.key,
        done: false
      };
      if (kind == 'values') return {
        value: entry.value,
        done: false
      };
      return {
        value: [entry.key, entry.value],
        done: false
      };
    }, IS_MAP ? 'entries' : 'values', !IS_MAP, true);
    setSpecies(CONSTRUCTOR_NAME);
  }
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvbGxlY3Rpb24tc3Ryb25nLmpzIl0sIm5hbWVzIjpbImRlZmluZVByb3BlcnR5IiwicmVxdWlyZSIsImYiLCJjcmVhdGUiLCJyZWRlZmluZUFsbCIsImJpbmQiLCJhbkluc3RhbmNlIiwiaXRlcmF0ZSIsImRlZmluZUl0ZXJhdG9yIiwic2V0U3BlY2llcyIsIkRFU0NSSVBUT1JTIiwiZmFzdEtleSIsIkludGVybmFsU3RhdGVNb2R1bGUiLCJzZXRJbnRlcm5hbFN0YXRlIiwic2V0IiwiaW50ZXJuYWxTdGF0ZUdldHRlckZvciIsImdldHRlckZvciIsIm1vZHVsZSIsImV4cG9ydHMiLCJnZXRDb25zdHJ1Y3RvciIsIndyYXBwZXIiLCJDT05TVFJVQ1RPUl9OQU1FIiwiSVNfTUFQIiwiQURERVIiLCJDIiwidGhhdCIsIml0ZXJhYmxlIiwidHlwZSIsImluZGV4IiwiZmlyc3QiLCJ1bmRlZmluZWQiLCJsYXN0Iiwic2l6ZSIsIkFTX0VOVFJJRVMiLCJnZXRJbnRlcm5hbFN0YXRlIiwiZGVmaW5lIiwia2V5IiwidmFsdWUiLCJzdGF0ZSIsImVudHJ5IiwiZ2V0RW50cnkiLCJwcmV2aW91cyIsIm5leHQiLCJyZW1vdmVkIiwicHJvdG90eXBlIiwiY2xlYXIiLCJkYXRhIiwicHJldiIsImZvckVhY2giLCJjYWxsYmFja2ZuIiwiYm91bmRGdW5jdGlvbiIsImFyZ3VtZW50cyIsImxlbmd0aCIsImhhcyIsImdldCIsImFkZCIsInNldFN0cm9uZyIsIklURVJBVE9SX05BTUUiLCJnZXRJbnRlcm5hbENvbGxlY3Rpb25TdGF0ZSIsImdldEludGVybmFsSXRlcmF0b3JTdGF0ZSIsIml0ZXJhdGVkIiwia2luZCIsInRhcmdldCIsImRvbmUiXSwibWFwcGluZ3MiOiJBQUFBOztBQUNBLElBQUlBLGNBQWMsR0FBR0MsT0FBTyx1Q0FBUCxDQUErQ0MsQ0FBcEU7O0FBQ0EsSUFBSUMsTUFBTSxHQUFHRixPQUFPLDhCQUFwQjs7QUFDQSxJQUFJRyxXQUFXLEdBQUdILE9BQU8s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QVosRUFBc0IsT0FBTztBQUFFeEIsUUFBQUEsS0FBSyxFQUFFRSxLQUFLLENBQUNGLEtBQWY7QUFBc0IwQixRQUFBQSxJQUFJLEVBQUU7QUFBNUIsT0FBUDtBQUN0QixhQUFPO0FBQUUxQixRQUFBQSxLQUFLLEVBQUUsQ0FBQ0UsS0FBSyxDQUFDSCxHQUFQLEVBQVlHLEtBQUssQ0FBQ0YsS0FBbEIsQ0FBVDtBQUFtQzBCLFFBQUFBLElBQUksRUFBRTtBQUF6QyxPQUFQO0FBQ0QsS0F4QmEsRUF3Qlh6QyxNQUFNLEdBQUcsU0FBSCxHQUFlLFFBeEJWLEVBd0JvQixDQUFDQSxNQXhCckIsRUF3QjZCLElBeEI3QixDQUFkO0FBNkJBYixJQUFBQSxVQUFVLENBQUNZLGdCQUFELENBQVY7QUFDRDtBQXhMYyxDQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcbnZhciBkZWZpbmVQcm9wZXJ0eSA9IHJlcXVpcmUoJy4uL2ludGVybmFscy9vYmplY3QtZGVmaW5lLXByb3BlcnR5JykuZjtcbnZhciBjcmVhdGUgPSByZXF1aXJlKCcuLi9pbnRlcm5hbHMvb2JqZWN0LWNyZWF0ZScpO1xudmFyIHJlZGVmaW5lQWxsID0gcmVxdWlyZSgnLi4vaW50ZXJuYWxzL3JlZGVmaW5lLWFsbCcpO1xudmFyIGJpbmQgPSByZXF1aXJlKCcuLi9pbnRlcm5hbHMvZnVuY3Rpb24tYmluZC1jb250ZXh0Jyk7XG52YXIgYW5JbnN0YW5jZSA9IHJlcXVpcmUoJy4uL2ludGVybmFscy9hbi1pbnN0YW5jZScpO1xudmFyIGl0ZXJhdGUgPSByZXF1aXJlKCcuLi9pbnRlcm5hbHMvaXRlcmF0ZScpO1xudmFyIGRlZmluZUl0ZXJhdG9yID0gcmVxdWlyZSgnLi4vaW50ZXJuYWxzL2RlZmluZS1pdGVyYXRvcicpO1xudmFyIHNldFNwZWNpZXMgPSByZXF1aXJlKCcuLi9pbnRlcm5hbHMvc2V0LXNwZWNpZXMnKTtcbnZhciBERVNDUklQVE9SUyA9IHJlcXVpcmUoJy4uL2ludGVybmFscy9kZXNjcmlwdG9ycycpO1xudmFyIGZhc3RLZXkgPSByZXF1aXJlKCcuLi9pbnRlcm5hbHMvaW50ZXJuYWwtbWV0YWRhdGEnKS5mYXN0S2V5O1xudmFyIEludGVybmFsU3RhdGVNb2R1bGUgPSByZXF1aXJlKCcuLi9pbnRlcm5hbHMvaW50ZXJuYWwtc3RhdGUnKTtcblxudmFyIHNldEludGVybmFsU3RhdGUgPSBJbnRlcm5hbFN0YXRlTW9kdWxlLnNldDtcbnZhciBpbnRlcm5hbFN0YXRlR2V0dGVyRm9yID0gSW50ZXJuYWxTdGF0ZU1vZHVsZS5nZXR0ZXJGb3I7XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBnZXRDb25zdHJ1Y3RvcjogZnVuY3Rpb24gKHdyYXBwZXIsIENPTlNUUlVDVE9SX05BTUUsIElTX01BUCwgQURERVIpIHtcbiAgICB2YXIgQyA9IHdyYXBwZXIoZnVuY3Rpb24gKHRoYXQsIGl0ZXJhYmxlKSB7XG4gICAgICBhbkluc3RhbmNlKHRoYXQsIEMsIENPTlNUUlVDVE9SX05BTUUpO1xuICAgICAgc2V0SW50ZXJuYWxTdGF0ZSh0aGF0LCB7XG4gICAgICAgIHR5cGU6IENPTlNUUlVDVE9SX05BTUUsXG4gICAgICAgIGluZGV4OiBjcmVhdGUobnVsbCksXG4gICAgICAgIGZpcnN0OiB1bmRlZmluZWQsXG4gICAgICAgIGxhc3Q6IHVuZGVmaW5lZCxcbiAgICAgICAgc2l6ZTogMFxuICAgICAgfSk7XG4gICAgICBpZiAoIURFU0NSSVBUT1JTKSB0aGF0LnNpemUgPSAwO1xuICAgICAgaWYgKGl0ZXJhYmxlICE9IHVuZGVmaW5lZCkgaXRlcmF0ZShpdGVyYWJsZSwgdGhhdFtBRERFUl0sIHsgdGhhdDogdGhhdCwgQVNfRU5UUklFUzogSVNfTUFQIH0pO1xuICAgIH0pO1xuXG4gICAgdmFyIGdldEludGVybmFsU3RhdGUgPSBpbnRlcm5hbFN0YXRlR2V0dGVyRm9yKENPTlNUUlVDVE9SX05BTUUpO1xuXG4gICAgdmFyIGRlZmluZSA9IGZ1bmN0aW9uICh0aGF0LCBrZXksIHZhbHVlKSB7XG4gICAgICB2YXIgc3RhdGUgPSBnZXRJbnRlcm5hbFN0YXRlKHRoYXQpO1xuICAgICAgdmFyIGVudHJ5ID0gZ2V0RW50cnkodGhhdCwga2V5KTtcbiAgICAgIHZhciBwcmV2aW91cywgaW5kZXg7XG4gICAgICAvLyBjaGFuZ2UgZXhpc3RpbmcgZW50cnlcbiAgICAgIGlmIChlbnRyeSkge1xuICAgICAgICBlbnRyeS52YWx1ZSA9IHZhbHVlO1xuICAgICAgLy8gY3JlYXRlIG5ldyBlbnRyeVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgc3RhdGUubGFzdCA9IGVudHJ5ID0ge1xuICAgICAgICAgIGluZGV4OiBpbmRleCA9IGZhc3RLZXkoa2V5LCB0cnVlKSxcbiAgICAgICAgICBrZXk6IGtleSxcbiAgICAgICAgICB2YWx1ZTogdmFsdWUsXG4gICAgICAgICAgcHJldmlvdXM6IHByZXZpb3VzID0gc3RhdGUubGFzdCxcbiAgICAgICAgICBuZXh0OiB1bmRlZmluZWQsXG4gICAgICAgICAgcmVtb3ZlZDogZmFsc2VcbiAgICAgICAgfTtcbiAgICAgICAgaWYgKCFzdGF0ZS5maXJzdCkgc3RhdGUuZmlyc3QgPSBlbnRyeTtcbiAgICAgICAgaWYgKHByZXZpb3VzKSBwcmV2aW91cy5uZXh0ID0gZW50cnk7XG4gICAgICAgIGlmIChERVNDUklQVE9SUykgc3RhdGUuc2l6ZSsrO1xuICAgICAgICBlbHNlIHRoYXQuc2l6ZSsrO1xuICAgICAgICAvLyBhZGQgdG8gaW5kZXhcbiAgICAgICAgaWYgKGluZGV4ICE9PSAnRicpIHN0YXRlLmluZGV4W2luZGV4XSA9IGVudHJ5O1xuICAgICAgfSByZXR1cm4gdGhhdDtcbiAgICB9O1xuXG4gICAgdmFyIGdldEVudHJ5ID0gZnVuY3Rpb24gKHRoYXQsIGtleSkge1xuICAgICAgdmFyIHN0YXRlID0gZ2V0SW50ZXJuYWxTdGF0ZSh0aGF0KTtcbiAgICAgIC8vIGZhc3QgY2FzZVxuICAgICAgdmFyIGluZGV4ID0gZmFzdEtleShrZXkpO1xuICAgICAgdmFyIGVudHJ5O1xuICAgICAgaWYgKGluZGV4ICE9PSAnRicpIHJldHVybiBzdGF0ZS5pbmRleFtpbmRleF07XG4gICAgICAvLyBmcm96ZW4gb2JqZWN0IGNhc2VcbiAgICAgIGZvciAoZW50cnkgPSBzdGF0ZS5maXJzdDsgZW50cnk7IGVudHJ5ID0gZW50cnkubmV4dCkge1xuICAgICAgICBpZiAoZW50cnkua2V5ID09IGtleSkgcmV0dXJuIGVudHJ5O1xuICAgICAgfVxuICAgIH07XG5cbiAgICByZWRlZmluZUFsbChDLnByb3RvdHlwZSwge1xuICAgICAgLy8gYHsgTWFwLCBTZXQgfS5wcm90b3R5cGUuY2xlYXIoKWAgbWV0aG9kc1xuICAgICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1tYXAucHJvdG90eXBlLmNsZWFyXG4gICAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLXNldC5wcm90b3R5cGUuY2xlYXJcbiAgICAgIGNsZWFyOiBmdW5jdGlvbiBjbGVhcigpIHtcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICB2YXIgc3RhdGUgPSBnZXRJbnRlcm5hbFN0YXRlKHRoYXQpO1xuICAgICAgICB2YXIgZGF0YSA9IHN0YXRlLmluZGV4O1xuICAgICAgICB2YXIgZW50cnkgPSBzdGF0ZS5maXJzdDtcbiAgICAgICAgd2hpbGUgKGVudHJ5KSB7XG4gICAgICAgICAgZW50cnkucmVtb3ZlZCA9IHRydWU7XG4gICAgICAgICAgaWYgKGVudHJ5LnByZXZpb3VzKSBlbnRyeS5wcmV2aW91cyA9IGVudHJ5LnByZXZpb3VzLm5leHQgPSB1bmRlZmluZWQ7XG4gICAgICAgICAgZGVsZXRlIGRhdGFbZW50cnkuaW5kZXhdO1xuICAgICAgICAgIGVudHJ5ID0gZW50cnkubmV4dDtcbiAgICAgICAgfVxuICAgICAgICBzdGF0ZS5maXJzdCA9IHN0YXRlLmxhc3QgPSB1bmRlZmluZWQ7XG4gICAgICAgIGlmIChERVNDUklQVE9SUykgc3RhdGUuc2l6ZSA9IDA7XG4gICAgICAgIGVsc2UgdGhhdC5zaXplID0gMDtcbiAgICAgIH0sXG4gICAgICAvLyBgeyBNYXAsIFNldCB9LnByb3RvdHlwZS5kZWxldGUoa2V5KWAgbWV0aG9kc1xuICAgICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1tYXAucHJvdG90eXBlLmRlbGV0ZVxuICAgICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1zZXQucHJvdG90eXBlLmRlbGV0ZVxuICAgICAgJ2RlbGV0ZSc6IGZ1bmN0aW9uIChrZXkpIHtcbiAgICAgICAgdmFyIHRoYXQgPSB0aGlzO1xuICAgICAgICB2YXIgc3RhdGUgPSBnZXRJbnRlcm5hbFN0YXRlKHRoYXQpO1xuICAgICAgICB2YXIgZW50cnkgPSBnZXRFbnRyeSh0aGF0LCBrZXkpO1xuICAgICAgICBpZiAoZW50cnkpIHtcbiAgICAgICAgICB2YXIgbmV4dCA9IGVudHJ5Lm5leHQ7XG4gICAgICAgICAgdmFyIHByZXYgPSBlbnRyeS5wcmV2aW91cztcbiAgICAgICAgICBkZWxldGUgc3RhdGUuaW5kZXhbZW50cnkuaW5kZXhdO1xuICAgICAgICAgIGVudHJ5LnJlbW92ZWQgPSB0cnVlO1xuICAgICAgICAgIGlmIChwcmV2KSBwcmV2Lm5leHQgPSBuZXh0O1xuICAgICAgICAgIGlmIChuZXh0KSBuZXh0LnByZXZpb3VzID0gcHJldjtcbiAgICAgICAgICBpZiAoc3RhdGUuZmlyc3QgPT0gZW50cnkpIHN0YXRlLmZpcnN0ID0gbmV4dDtcbiAgICAgICAgICBpZiAoc3RhdGUubGFzdCA9PSBlbnRyeSkgc3RhdGUubGFzdCA9IHByZXY7XG4gICAgICAgICAgaWYgKERFU0NSSVBUT1JTKSBzdGF0ZS5zaXplLS07XG4gICAgICAgICAgZWxzZSB0aGF0LnNpemUtLTtcbiAgICAgICAgfSByZXR1cm4gISFlbnRyeTtcbiAgICAgIH0sXG4gICAgICAvLyBgeyBNYXAsIFNldCB9LnByb3RvdHlwZS5mb3JFYWNoKGNhbGxiYWNrZm4sIHRoaXNBcmcgPSB1bmRlZmluZWQpYCBtZXRob2RzXG4gICAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLW1hcC5wcm90b3R5cGUuZm9yZWFjaFxuICAgICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1zZXQucHJvdG90eXBlLmZvcmVhY2hcbiAgICAgIGZvckVhY2g6IGZ1bmN0aW9uIGZvckVhY2goY2FsbGJhY2tmbiAvKiAsIHRoYXQgPSB1bmRlZmluZWQgKi8pIHtcbiAgICAgICAgdmFyIHN0YXRlID0gZ2V0SW50ZXJuYWxTdGF0ZSh0aGlzKTtcbiAgICAgICAgdmFyIGJvdW5kRnVuY3Rpb24gPSBiaW5kKGNhbGxiYWNrZm4sIGFyZ3VtZW50cy5sZW5ndGggPiAxID8gYXJndW1lbnRzWzFdIDogdW5kZWZpbmVkLCAzKTtcbiAgICAgICAgdmFyIGVudHJ5O1xuICAgICAgICB3aGlsZSAoZW50cnkgPSBlbnRyeSA/IGVudHJ5Lm5leHQgOiBzdGF0ZS5maXJzdCkge1xuICAgICAgICAgIGJvdW5kRnVuY3Rpb24oZW50cnkudmFsdWUsIGVudHJ5LmtleSwgdGhpcyk7XG4gICAgICAgICAgLy8gcmV2ZXJ0IHRvIHRoZSBsYXN0IGV4aXN0aW5nIGVudHJ5XG4gICAgICAgICAgd2hpbGUgKGVudHJ5ICYmIGVudHJ5LnJlbW92ZWQpIGVudHJ5ID0gZW50cnkucHJldmlvdXM7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICAvLyBgeyBNYXAsIFNldH0ucHJvdG90eXBlLmhhcyhrZXkpYCBtZXRob2RzXG4gICAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLW1hcC5wcm90b3R5cGUuaGFzXG4gICAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLXNldC5wcm90b3R5cGUuaGFzXG4gICAgICBoYXM6IGZ1bmN0aW9uIGhhcyhrZXkpIHtcbiAgICAgICAgcmV0dXJuICEhZ2V0RW50cnkodGhpcywga2V5KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHJlZGVmaW5lQWxsKEMucHJvdG90eXBlLCBJU19NQVAgPyB7XG4gICAgICAvLyBgTWFwLnByb3RvdHlwZS5nZXQoa2V5KWAgbWV0aG9kXG4gICAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLW1hcC5wcm90b3R5cGUuZ2V0XG4gICAgICBnZXQ6IGZ1bmN0aW9uIGdldChrZXkpIHtcbiAgICAgICAgdmFyIGVudHJ5ID0gZ2V0RW50cnkodGhpcywga2V5KTtcbiAgICAgICAgcmV0dXJuIGVudHJ5ICYmIGVudHJ5LnZhbHVlO1xuICAgICAgfSxcbiAgICAgIC8vIGBNYXAucHJvdG90eXBlLnNldChrZXksIHZhbHVlKWAgbWV0aG9kXG4gICAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLW1hcC5wcm90b3R5cGUuc2V0XG4gICAgICBzZXQ6IGZ1bmN0aW9uIHNldChrZXksIHZhbHVlKSB7XG4gICAgICAgIHJldHVybiBkZWZpbmUodGhpcywga2V5ID09PSAwID8gMCA6IGtleSwgdmFsdWUpO1xuICAgICAgfVxuICAgIH0gOiB7XG4gICAgICAvLyBgU2V0LnByb3RvdHlwZS5hZGQodmFsdWUpYCBtZXRob2RcbiAgICAgIC8vIGh0dHBzOi8vdGMzOS5lcy9lY21hMjYyLyNzZWMtc2V0LnByb3RvdHlwZS5hZGRcbiAgICAgIGFkZDogZnVuY3Rpb24gYWRkKHZhbHVlKSB7XG4gICAgICAgIHJldHVybiBkZWZpbmUodGhpcywgdmFsdWUgPSB2YWx1ZSA9PT0gMCA/IDAgOiB2YWx1ZSwgdmFsdWUpO1xuICAgICAgfVxuICAgIH0pO1xuICAgIGlmIChERVNDUklQVE9SUykgZGVmaW5lUHJvcGVydHkoQy5wcm90b3R5cGUsICdzaXplJywge1xuICAgICAgZ2V0OiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIHJldHVybiBnZXRJbnRlcm5hbFN0YXRlKHRoaXMpLnNpemU7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcmV0dXJuIEM7XG4gIH0sXG4gIHNldFN0cm9uZzogZnVuY3Rpb24gKEMsIENPTlNUUlVDVE9SX05BTUUsIElTX01BUCkge1xuICAgIHZhciBJVEVSQVRPUl9OQU1FID0gQ09OU1RSVUNUT1JfTkFNRSArICcgSXRlcmF0b3InO1xuICAgIHZhciBnZXRJbnRlcm5hbENvbGxlY3Rpb25TdGF0ZSA9IGludGVybmFsU3RhdGVHZXR0ZXJGb3IoQ09OU1RSVUNUT1JfTkFNRSk7XG4gICAgdmFyIGdldEludGVybmFsSXRlcmF0b3JTdGF0ZSA9IGludGVybmFsU3RhdGVHZXR0ZXJGb3IoSVRFUkFUT1JfTkFNRSk7XG4gICAgLy8gYHsgTWFwLCBTZXQgfS5wcm90b3R5cGUueyBrZXlzLCB2YWx1ZXMsIGVudHJpZXMsIEBAaXRlcmF0b3IgfSgpYCBtZXRob2RzXG4gICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1tYXAucHJvdG90eXBlLmVudHJpZXNcbiAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLW1hcC5wcm90b3R5cGUua2V5c1xuICAgIC8vIGh0dHBzOi8vdGMzOS5lcy9lY21hMjYyLyNzZWMtbWFwLnByb3RvdHlwZS52YWx1ZXNcbiAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLW1hcC5wcm90b3R5cGUtQEBpdGVyYXRvclxuICAgIC8vIGh0dHBzOi8vdGMzOS5lcy9lY21hMjYyLyNzZWMtc2V0LnByb3RvdHlwZS5lbnRyaWVzXG4gICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1zZXQucHJvdG90eXBlLmtleXNcbiAgICAvLyBodHRwczovL3RjMzkuZXMvZWNtYTI2Mi8jc2VjLXNldC5wcm90b3R5cGUudmFsdWVzXG4gICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1zZXQucHJvdG90eXBlLUBAaXRlcmF0b3JcbiAgICBkZWZpbmVJdGVyYXRvcihDLCBDT05TVFJVQ1RPUl9OQU1FLCBmdW5jdGlvbiAoaXRlcmF0ZWQsIGtpbmQpIHtcbiAgICAgIHNldEludGVybmFsU3RhdGUodGhpcywge1xuICAgICAgICB0eXBlOiBJVEVSQVRPUl9OQU1FLFxuICAgICAgICB0YXJnZXQ6IGl0ZXJhdGVkLFxuICAgICAgICBzdGF0ZTogZ2V0SW50ZXJuYWxDb2xsZWN0aW9uU3RhdGUoaXRlcmF0ZWQpLFxuICAgICAgICBraW5kOiBraW5kLFxuICAgICAgICBsYXN0OiB1bmRlZmluZWRcbiAgICAgIH0pO1xuICAgIH0sIGZ1bmN0aW9uICgpIHtcbiAgICAgIHZhciBzdGF0ZSA9IGdldEludGVybmFsSXRlcmF0b3JTdGF0ZSh0aGlzKTtcbiAgICAgIHZhciBraW5kID0gc3RhdGUua2luZDtcbiAgICAgIHZhciBlbnRyeSA9IHN0YXRlLmxhc3Q7XG4gICAgICAvLyByZXZlcnQgdG8gdGhlIGxhc3QgZXhpc3RpbmcgZW50cnlcbiAgICAgIHdoaWxlIChlbnRyeSAmJiBlbnRyeS5yZW1vdmVkKSBlbnRyeSA9IGVudHJ5LnByZXZpb3VzO1xuICAgICAgLy8gZ2V0IG5leHQgZW50cnlcbiAgICAgIGlmICghc3RhdGUudGFyZ2V0IHx8ICEoc3RhdGUubGFzdCA9IGVudHJ5ID0gZW50cnkgPyBlbnRyeS5uZXh0IDogc3RhdGUuc3RhdGUuZmlyc3QpKSB7XG4gICAgICAgIC8vIG9yIGZpbmlzaCB0aGUgaXRlcmF0aW9uXG4gICAgICAgIHN0YXRlLnRhcmdldCA9IHVuZGVmaW5lZDtcbiAgICAgICAgcmV0dXJuIHsgdmFsdWU6IHVuZGVmaW5lZCwgZG9uZTogdHJ1ZSB9O1xuICAgICAgfVxuICAgICAgLy8gcmV0dXJuIHN0ZXAgYnkga2luZFxuICAgICAgaWYgKGtpbmQgPT0gJ2tleXMnKSByZXR1cm4geyB2YWx1ZTogZW50cnkua2V5LCBkb25lOiBmYWxzZSB9O1xuICAgICAgaWYgKGtpbmQgPT0gJ3ZhbHVlcycpIHJldHVybiB7IHZhbHVlOiBlbnRyeS52YWx1ZSwgZG9uZTogZmFsc2UgfTtcbiAgICAgIHJldHVybiB7IHZhbHVlOiBbZW50cnkua2V5LCBlbnRyeS52YWx1ZV0sIGRvbmU6IGZhbHNlIH07XG4gICAgfSwgSVNfTUFQID8gJ2VudHJpZXMnIDogJ3ZhbHVlcycsICFJU19NQVAsIHRydWUpO1xuXG4gICAgLy8gYHsgTWFwLCBTZXQgfS5wcm90b3R5cGVbQEBzcGVjaWVzXWAgYWNjZXNzb3JzXG4gICAgLy8gaHR0cHM6Ly90YzM5LmVzL2VjbWEyNjIvI3NlYy1nZXQtbWFwLUBAc3BlY2llc1xuICAgIC8vIGh0dHBzOi8vdGMzOS5lcy9lY21hMjYyLyNzZWMtZ2V0LXNldC1AQHNwZWNpZXNcbiAgICBzZXRTcGVjaWVzKENPTlNUUlVDVE9SX05BTUUpO1xuICB9XG59O1xuIl19