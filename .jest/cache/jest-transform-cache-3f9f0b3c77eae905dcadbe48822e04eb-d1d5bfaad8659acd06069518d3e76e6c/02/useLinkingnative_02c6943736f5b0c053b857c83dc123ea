2a169284b0820d1864f62eb4be2324f2
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = useLinking;

var React = _interopRequireWildcard(require("react"));

var _reactNative = require("react-native");

var _core = require("@react-navigation/core");

var _extractPathFromURL = _interopRequireDefault(require("./extractPathFromURL"));

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

var isUsingLinking = false;

function useLinking(ref, _ref) {
  var _ref$enabled = _ref.enabled,
      enabled = _ref$enabled === void 0 ? true : _ref$enabled,
      prefixes = _ref.prefixes,
      config = _ref.config,
      _ref$getInitialURL = _ref.getInitialURL,
      getInitialURL = _ref$getInitialURL === void 0 ? function () {
    return Promise.race([_reactNative.Linking.getInitialURL(), new Promise(function (resolve) {
      return setTimeout(resolve, 150);
    })]);
  } : _ref$getInitialURL,
      _ref$subscribe = _ref.subscribe,
      subscribe = _ref$subscribe === void 0 ? function (listener) {
    var callback = function callback(_ref2) {
      var url = _ref2.url;
      return listener(url);
    };

    var subscription = _reactNative.Linking.addEventListener('url', callback);

    return function () {
      if (subscription !== null && subscription !== void 0 && subscription.remove) {
        subscription.remove();
      } else {
        _reactNative.Linking.removeEventListener('url', callback);
      }
    };
  } : _ref$subscribe,
      _ref$getStateFromPath = _ref.getStateFromPath,
      getStateFromPath = _ref$getStateFromPath === void 0 ? _core.getStateFromPath : _ref$getStateFromPath,
      _ref$getActionFromSta = _ref.getActionFromState,
      getActionFromState = _ref$getActionFromSta === void 0 ? _core.getActionFromState : _ref$getActionFromSta;
  React.useEffect(function () {
    if (enabled !== false && isUsingLinking) {
      throw new Error(['Looks like you have configured linking in multiple places. This is likely an error since deep links should only be handled in one place to avoid conflicts. Make sure that:', "- You are not using both 'linking' prop and 'useLinking'", "- You don't have 'useLinking' in multiple components", _reactNative.Platform.OS === 'android' ? "- You have set 'android:launchMode=singleTask' in the '<activity />' section of the 'AndroidManifest.xml' file to avoid launching multiple instances" : ''].join('\n').trim());
    } else {
      isUsingLinking = enabled !== false;
    }

    return function () {
      isUsingLinking = false;
    };
  });
  var enabledRef = React.useRef(enabled);
  var prefixesRef = React.useRef(prefixes);
  var configRef = React.useRef(config);
  var getInitialURLRef = React.useRef(getInitialURL);
  var getStateFromPathRef = React.useRef(getStateFromPath);
  var getActionFromStateRef = React.useRef(getActionFromState);
  React.useEffect(function () {
    enabledRef.current = enabled;
    prefixesRef.current = prefixes;
    configRef.current = config;
    getInitialURLRef.current = getInitialURL;
    getStateFromPathRef.current = getStateFromPath;
    getActionFromStateRef.current = getActionFromState;
  });
  var getInitialState = React.useCallback(function () {
    var state;

    if (enabledRef.current) {
      var url = getInitialURLRef.current();

      if (url != null && typeof url !== 'string') {
        return url.then(function (url) {
          var path = url ? (0, _extractPathFromURL.default)(prefixesRef.current, url) : null;
          return path ? getStateFromPathRef.current(path, configRef.current) : undefined;
        });
      }

      var path = url ? (0, _extractPathFromURL.default)(prefixesRef.current, url) : null;
      state = path ? getStateFromPathRef.current(path, configRef.current) : undefined;
    }

    var thenable = {
      then: function then(onfulfilled) {
        return Promise.resolve(onfulfilled ? onfulfilled(state) : state);
      },
      catch: function _catch() {
        return thenable;
      }
    };
    return thenable;
  }, []);
  React.useEffect(function () {
    var listener = function listener(url) {
      if (!enabled) {
        return;
      }

      var path = (0, _extractPathFromURL.default)(prefixesRef.current, url);
      var navigation = ref.current;

      if (navigation && path) {
        var state = getStateFromPathRef.current(path, configRef.current);

        if (state) {
          var rootState = navigation.getRootState();

          if (state.routes.some(function (r) {
            return !(rootState !== null && rootState !== void 0 && rootState.routeNames.includes(r.name));
          })) {
            console.warn("The navigation state parsed from the URL contains routes not present in the root navigator. This usually means that the linking configuration doesn't match the navigation structure. See https://reactnavigation.org/docs/configuring-links for more details on how to specify a linking configuration.");
            return;
          }

          var action = getActionFromStateRef.current(state, configRef.current);

          if (action !== undefined) {
            try {
              navigation.dispatch(action);
            } catch (e) {
              console.warn("An error occurred when trying to handle the link '".concat(path, "': ").concat(e.message));
            }
          } else {
            navigation.resetRoot(state);
          }
        }
      }
    };

    return subscribe(listener);
  }, [enabled, ref, subscribe]);
  return {
    getInitialState: getInitialState
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVzZUxpbmtpbmcubmF0aXZlLnRzeCJdLCJuYW1lcyI6WyJpc1VzaW5nTGlua2luZyIsImVuYWJsZWQiLCJnZXRJbml0aWFsVVJMIiwiUHJvbWlzZSIsIkxpbmtpbmciLCJyZXNvbHZlIiwic2V0VGltZW91dCIsInN1YnNjcmliZSIsImxpc3RlbmVyIiwiY2FsbGJhY2siLCJ1cmwiLCJzdWJzY3JpcHRpb24iLCJnZXRTdGF0ZUZyb21QYXRoIiwiZ2V0U3RhdGVGcm9tUGF0aERlZmF1bHQiLCJnZXRBY3Rpb25Gcm9tU3RhdGUiLCJnZXRBY3Rpb25Gcm9tU3RhdGVEZWZhdWx0IiwiUmVhY3QiLCJQbGF0Zm9ybSIsImVuYWJsZWRSZWYiLCJwcmVmaXhlc1JlZiIsImNvbmZpZ1JlZiIsImdldEluaXRpYWxVUkxSZWYiLCJnZXRTdGF0ZUZyb21QYXRoUmVmIiwiZ2V0QWN0aW9uRnJvbVN0YXRlUmVmIiwiZ2V0SW5pdGlhbFN0YXRlIiwicGF0aCIsInN0YXRlIiwidGhlbmFibGUiLCJ0aGVuIiwib25mdWxmaWxsZWQiLCJjYXRjaCIsIm5hdmlnYXRpb24iLCJyZWYiLCJyb290U3RhdGUiLCJyIiwiY29uc29sZSIsImFjdGlvbiIsImUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQSxJQUFBLEtBQUEsR0FBQSx1QkFBQSxDQUFBLE9BQUEsQ0FBQSxPQUFBLENBQUEsQ0FBQTs7QUFDQSxJQUFBLFlBQUEsR0FBQSxPQUFBLENBQUEsY0FBQSxDQUFBOztBQUNBLElBQUEsS0FBQSxHQUFBLE9BQUEsQ0FBQSx3QkFBQSxDQUFBOztBQUtBLElBQUEsbUJBQUEsR0FBQSxzQkFBQSxDQUFBLE9BQUEsd0JBQUEsQ0FBQTs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBS0EsSUFBSUEsY0FBYyxHQUFsQixLQUFBOztBQUVlLFNBQUEsVUFBQSxDQUFBLEdBQUEsUUFrQ2I7QUFBQSwwQkEvQkVDLE9BK0JGO0FBQUEsTUEv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SUFBQUEsQ0FBQUEsMFNBQUFBO0FBR0E7QUFDRDs7QUFFRCxjQUFNQyxNQUFNLEdBQUdiLHFCQUFxQixDQUFyQkEsT0FBQUEsQ0FBQUEsS0FBQUEsRUFFYkgsU0FBUyxDQUZYLE9BQWVHLENBQWY7O0FBS0EsY0FBSWEsTUFBTSxLQUFWLFNBQUEsRUFBMEI7QUFDeEIsZ0JBQUk7QUFDRkwsY0FBQUEsVUFBVSxDQUFWQSxRQUFBQSxDQUFBQSxNQUFBQTtBQURGLGFBQUEsQ0FFRSxPQUFBLENBQUEsRUFBVTtBQUdWSSxjQUFBQSxPQUFPLENBQVBBLElBQUFBLENBQUFBLHFEQUFBQSxNQUFBQSxDQUFBQSxJQUFBQSxFQUFBQSxLQUFBQSxFQUFBQSxNQUFBQSxDQUNpRUUsQ0FBQyxDQURsRUYsT0FBQUEsQ0FBQUE7QUFHRDtBQVRILFdBQUEsTUFVTztBQUNMSixZQUFBQSxVQUFVLENBQVZBLFNBQUFBLENBQUFBLEtBQUFBO0FBQ0Q7QUFDRjtBQUNGO0FBNUNILEtBQUE7O0FBK0NBLFdBQU94QixTQUFTLENBQWhCLFFBQWdCLENBQWhCO0FBaERGUyxHQUFBQSxFQWlERyxDQUFBLE9BQUEsRUFBQSxHQUFBLEVBakRIQSxTQWlERyxDQWpESEE7QUFtREEsU0FBTztBQUNMUSxJQUFBQSxlQUFBQSxFQUFBQTtBQURLLEdBQVA7QUFHRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAqIGFzIFJlYWN0IGZyb20gJ3JlYWN0JztcbmltcG9ydCB7IExpbmtpbmcsIFBsYXRmb3JtIH0gZnJvbSAncmVhY3QtbmF0aXZlJztcbmltcG9ydCB7XG4gIGdldEFjdGlvbkZyb21TdGF0ZSBhcyBnZXRBY3Rpb25Gcm9tU3RhdGVEZWZhdWx0LFxuICBnZXRTdGF0ZUZyb21QYXRoIGFzIGdldFN0YXRlRnJvbVBhdGhEZWZhdWx0LFxuICBOYXZpZ2F0aW9uQ29udGFpbmVyUmVmLFxufSBmcm9tICdAcmVhY3QtbmF2aWdhdGlvbi9jb3JlJztcbmltcG9ydCBleHRyYWN0UGF0aEZyb21VUkwgZnJvbSAnLi9leHRyYWN0UGF0aEZyb21VUkwnO1xuaW1wb3J0IHR5cGUgeyBMaW5raW5nT3B0aW9ucyB9IGZyb20gJy4vdHlwZXMnO1xuXG50eXBlIFJlc3VsdFN0YXRlID0gUmV0dXJuVHlwZTx0eXBlb2YgZ2V0U3RhdGVGcm9tUGF0aERlZmF1bHQ+O1xuXG5sZXQgaXNVc2luZ0xpbmtpbmcgPSBmYWxzZTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdXNlTGlua2luZyhcbiAgcmVmOiBSZWFjdC5SZWZPYmplY3Q8TmF2aWdhdGlvbkNvbnRhaW5lclJlZj4sXG4gIHtcbiAgICBlbmFibGVkID0gdHJ1ZSxcbiAgICBwcmVmaXhlcyxcbiAgICBjb25maWcsXG4gICAgZ2V0SW5pdGlhbFVSTCA9ICgpID0+XG4gICAgICBQcm9taXNlLnJhY2UoW1xuICAgICAgICBMaW5raW5nLmdldEluaXRpYWxVUkwoKSxcbiAgICAgICAgbmV3IFByb21pc2U8dW5kZWZpbmVkPigocmVzb2x2ZSkgPT5cbiAgICAgICAgICAvLyBUaW1lb3V0IGluIDE1MG1zIGlmIGBnZXRJbml0aWFsU3RhdGVgIGRvZXNuJ3QgcmVzb2x2ZVxuICAgICAgICAgIC8vIFdvcmthcm91bmQgZm9yIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC1uYXRpdmUvaXNzdWVzLzI1Njc1XG4gICAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCAxNTApXG4gICAgICAgICksXG4gICAgICBdKSxcbiAgICBzdWJzY3JpYmUgPSAobGlzdGVuZXIpID0+IHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gKHsgdXJsIH06IHsgdXJsOiBzdHJpbmcgfSkgPT4gbGlzdGVuZXIodXJsKTtcblxuICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gTGlua2luZy5hZGRFdmVudExpc3RlbmVyKCd1cmwnLCBjYWxsYmFjaykgYXNcbiAgICAgICAgfCB7IHJlbW92ZSgpOiB2b2lkIH1cbiAgICAgICAgfCB1bmRlZmluZWQ7XG5cbiAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9yZWFjdC1uYXRpdmUvY29tbWl0LzZkMWFjYTgwNmNlZTg2YWQ3NmRlNzcxZWQzYTFjYzYyOTgyZWJjZDdcbiAgICAgICAgaWYgKHN1YnNjcmlwdGlvbj8ucmVtb3ZlKSB7XG4gICAgICAgICAgc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIExpbmtpbmcucmVtb3ZlRXZlbnRMaXN0ZW5lcigndXJsJywgY2FsbGJhY2spO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0sXG4gICAgZ2V0U3RhdGVGcm9tUGF0aCA9IGdldFN0YXRlRnJvbVBhdGhEZWZhdWx0LFxuICAgIGdldEFjdGlvbkZyb21TdGF0ZSA9IGdldEFjdGlvbkZyb21TdGF0ZURlZmF1bHQsXG4gIH06IExpbmtpbmdPcHRpb25zXG4pIHtcbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBpZiAoZW5hYmxlZCAhPT0gZmFsc2UgJiYgaXNVc2luZ0xpbmtpbmcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgW1xuICAgICAgICAgICdMb29rcyBsaWtlIHlvdSBoYXZlIGNvbmZpZ3VyZWQgbGlua2luZyBpbiBtdWx0aXBsZSBwbGFjZXMuIFRoaXMgaXMgbGlrZWx5IGFuIGVycm9yIHNpbmNlIGRlZXAgbGlua3Mgc2hvdWxkIG9ubHkgYmUgaGFuZGxlZCBpbiBvbmUgcGxhY2UgdG8gYXZvaWQgY29uZmxpY3RzLiBNYWtlIHN1cmUgdGhhdDonLFxuICAgICAgICAgIFwiLSBZb3UgYXJlIG5vdCB1c2luZyBib3RoICdsaW5raW5nJyBwcm9wIGFuZCAndXNlTGlua2luZydcIixcbiAgICAgICAgICBcIi0gWW91IGRvbid0IGhhdmUgJ3VzZUxpbmtpbmcnIGluIG11bHRpcGxlIGNvbXBvbmVudHNcIixcbiAgICAgICAgICBQbGF0Zm9ybS5PUyA9PT0gJ2FuZHJvaWQnXG4gICAgICAgICAgICA/IFwiLSBZb3UgaGF2ZSBzZXQgJ2FuZHJvaWQ6bGF1bmNoTW9kZT1zaW5nbGVUYXNrJyBpbiB0aGUgJzxhY3Rpdml0eSAvPicgc2VjdGlvbiBvZiB0aGUgJ0FuZHJvaWRNYW5pZmVzdC54bWwnIGZpbGUgdG8gYXZvaWQgbGF1bmNoaW5nIG11bHRpcGxlIGluc3RhbmNlc1wiXG4gICAgICAgICAgICA6ICcnLFxuICAgICAgICBdXG4gICAgICAgICAgLmpvaW4oJ1xcbicpXG4gICAgICAgICAgLnRyaW0oKVxuICAgICAgKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaXNVc2luZ0xpbmtpbmcgPSBlbmFibGVkICE9PSBmYWxzZTtcbiAgICB9XG5cbiAgICByZXR1cm4gKCkgPT4ge1xuICAgICAgaXNVc2luZ0xpbmtpbmcgPSBmYWxzZTtcbiAgICB9O1xuICB9KTtcblxuICAvLyBXZSBzdG9yZSB0aGVzZSBvcHRpb25zIGluIHJlZiB0byBhdm9pZCByZS1jcmVhdGluZyBnZXRJbml0aWFsU3RhdGUgYW5kIHJlLXN1YnNjcmliaW5nIGxpc3RlbmVyc1xuICAvLyBUaGlzIGxldHMgdXNlciBhdm9pZCB3cmFwcGluZyB0aGUgaXRlbXMgaW4gYFJlYWN0LnVzZUNhbGxiYWNrYCBvciBgUmVhY3QudXNlTWVtb2BcbiAgLy8gTm90IHJlLWNyZWF0aW5nIGBnZXRJbml0aWFsU3RhdGVgIGlzIGltcG9ydGFudCBjb3ogaXQgbWFrZXMgaXQgZWFzaWVyIGZvciB0aGUgdXNlciB0byB1c2UgaW4gYW4gZWZmZWN0XG4gIGNvbnN0IGVuYWJsZWRSZWYgPSBSZWFjdC51c2VSZWYoZW5hYmxlZCk7XG4gIGNvbnN0IHByZWZpeGVzUmVmID0gUmVhY3QudXNlUmVmKHByZWZpeGVzKTtcbiAgY29uc3QgY29uZmlnUmVmID0gUmVhY3QudXNlUmVmKGNvbmZpZyk7XG4gIGNvbnN0IGdldEluaXRpYWxVUkxSZWYgPSBSZWFjdC51c2VSZWYoZ2V0SW5pdGlhbFVSTCk7XG4gIGNvbnN0IGdldFN0YXRlRnJvbVBhdGhSZWYgPSBSZWFjdC51c2VSZWYoZ2V0U3RhdGVGcm9tUGF0aCk7XG4gIGNvbnN0IGdldEFjdGlvbkZyb21TdGF0ZVJlZiA9IFJlYWN0LnVzZVJlZihnZXRBY3Rpb25Gcm9tU3RhdGUpO1xuXG4gIFJlYWN0LnVzZUVmZmVjdCgoKSA9PiB7XG4gICAgZW5hYmxlZFJlZi5jdXJyZW50ID0gZW5hYmxlZDtcbiAgICBwcmVmaXhlc1JlZi5jdXJyZW50ID0gcHJlZml4ZXM7XG4gICAgY29uZmlnUmVmLmN1cnJlbnQgPSBjb25maWc7XG4gICAgZ2V0SW5pdGlhbFVSTFJlZi5jdXJyZW50ID0gZ2V0SW5pdGlhbFVSTDtcbiAgICBnZXRTdGF0ZUZyb21QYXRoUmVmLmN1cnJlbnQgPSBnZXRTdGF0ZUZyb21QYXRoO1xuICAgIGdldEFjdGlvbkZyb21TdGF0ZVJlZi5jdXJyZW50ID0gZ2V0QWN0aW9uRnJvbVN0YXRlO1xuICB9KTtcblxuICBjb25zdCBnZXRJbml0aWFsU3RhdGUgPSBSZWFjdC51c2VDYWxsYmFjaygoKSA9PiB7XG4gICAgbGV0IHN0YXRlOiBSZXN1bHRTdGF0ZSB8IHVuZGVmaW5lZDtcblxuICAgIGlmIChlbmFibGVkUmVmLmN1cnJlbnQpIHtcbiAgICAgIGNvbnN0IHVybCA9IGdldEluaXRpYWxVUkxSZWYuY3VycmVudCgpO1xuXG4gICAgICBpZiAodXJsICE9IG51bGwgJiYgdHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHtcbiAgICAgICAgcmV0dXJuIHVybC50aGVuKCh1cmwpID0+IHtcbiAgICAgICAgICBjb25zdCBwYXRoID0gdXJsXG4gICAgICAgICAgICA/IGV4dHJhY3RQYXRoRnJvbVVSTChwcmVmaXhlc1JlZi5jdXJyZW50LCB1cmwpXG4gICAgICAgICAgICA6IG51bGw7XG5cbiAgICAgICAgICByZXR1cm4gcGF0aFxuICAgICAgICAgICAgPyBnZXRTdGF0ZUZyb21QYXRoUmVmLmN1cnJlbnQocGF0aCwgY29uZmlnUmVmLmN1cnJlbnQpXG4gICAgICAgICAgICA6IHVuZGVmaW5lZDtcbiAgICAgICAgfSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHBhdGggPSB1cmwgPyBleHRyYWN0UGF0aEZyb21VUkwocHJlZml4ZXNSZWYuY3VycmVudCwgdXJsKSA6IG51bGw7XG5cbiAgICAgIHN0YXRlID0gcGF0aFxuICAgICAgICA/IGdldFN0YXRlRnJvbVBhdGhSZWYuY3VycmVudChwYXRoLCBjb25maWdSZWYuY3VycmVudClcbiAgICAgICAgOiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgY29uc3QgdGhlbmFibGUgPSB7XG4gICAgICB0aGVuKG9uZnVsZmlsbGVkPzogKHN0YXRlOiBSZXN1bHRTdGF0ZSB8IHVuZGVmaW5lZCkgPT4gdm9pZCkge1xuICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKG9uZnVsZmlsbGVkID8gb25mdWxmaWxsZWQoc3RhdGUpIDogc3RhdGUpO1xuICAgICAgfSxcbiAgICAgIGNhdGNoKCkge1xuICAgICAgICByZXR1cm4gdGhlbmFibGU7XG4gICAgICB9LFxuICAgIH07XG5cbiAgICByZXR1cm4gdGhlbmFibGUgYXMgUHJvbWlzZUxpa2U8UmVzdWx0U3RhdGUgfCB1bmRlZmluZWQ+O1xuICB9LCBbXSk7XG5cbiAgUmVhY3QudXNlRWZmZWN0KCgpID0+IHtcbiAgICBjb25zdCBsaXN0ZW5lciA9ICh1cmw6IHN0cmluZykgPT4ge1xuICAgICAgaWYgKCFlbmFibGVkKSB7XG4gICAgICAgIHJldHVybjtcbiAgICAgIH1cblxuICAgICAgY29uc3QgcGF0aCA9IGV4dHJhY3RQYXRoRnJvbVVSTChwcmVmaXhlc1JlZi5jdXJyZW50LCB1cmwpO1xuICAgICAgY29uc3QgbmF2aWdhdGlvbiA9IHJlZi5jdXJyZW50O1xuXG4gICAgICBpZiAobmF2aWdhdGlvbiAmJiBwYXRoKSB7XG4gICAgICAgIGNvbnN0IHN0YXRlID0gZ2V0U3RhdGVGcm9tUGF0aFJlZi5jdXJyZW50KHBhdGgsIGNvbmZpZ1JlZi5jdXJyZW50KTtcblxuICAgICAgICBpZiAoc3RhdGUpIHtcbiAgICAgICAgICAvLyBNYWtlIHN1cmUgdGhhdCB0aGUgcm91dGVzIGluIHRoZSBzdGF0ZSBleGlzdCBpbiB0aGUgcm9vdCBuYXZpZ2F0b3JcbiAgICAgICAgICAvLyBPdGhlcndpc2UgdGhlcmUncyBhbiBlcnJvciBpbiB0aGUgbGlua2luZyBjb25maWd1cmF0aW9uXG4gICAgICAgICAgY29uc3Qgcm9vdFN0YXRlID0gbmF2aWdhdGlvbi5nZXRSb290U3RhdGUoKTtcblxuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHN0YXRlLnJvdXRlcy5zb21lKChyKSA9PiAhcm9vdFN0YXRlPy5yb3V0ZU5hbWVzLmluY2x1ZGVzKHIubmFtZSkpXG4gICAgICAgICAgKSB7XG4gICAgICAgICAgICBjb25zb2xlLndhcm4oXG4gICAgICAgICAgICAgIFwiVGhlIG5hdmlnYXRpb24gc3RhdGUgcGFyc2VkIGZyb20gdGhlIFVSTCBjb250YWlucyByb3V0ZXMgbm90IHByZXNlbnQgaW4gdGhlIHJvb3QgbmF2aWdhdG9yLiBUaGlzIHVzdWFsbHkgbWVhbnMgdGhhdCB0aGUgbGlua2luZyBjb25maWd1cmF0aW9uIGRvZXNuJ3QgbWF0Y2ggdGhlIG5hdmlnYXRpb24gc3RydWN0dXJlLiBTZWUgaHR0cHM6Ly9yZWFjdG5hdmlnYXRpb24ub3JnL2RvY3MvY29uZmlndXJpbmctbGlua3MgZm9yIG1vcmUgZGV0YWlscyBvbiBob3cgdG8gc3BlY2lmeSBhIGxpbmtpbmcgY29uZmlndXJhdGlvbi5cIlxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICBjb25zdCBhY3Rpb24gPSBnZXRBY3Rpb25Gcm9tU3RhdGVSZWYuY3VycmVudChcbiAgICAgICAgICAgIHN0YXRlLFxuICAgICAgICAgICAgY29uZmlnUmVmLmN1cnJlbnRcbiAgICAgICAgICApO1xuXG4gICAgICAgICAgaWYgKGFjdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgICBuYXZpZ2F0aW9uLmRpc3BhdGNoKGFjdGlvbik7XG4gICAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICAgIC8vIElnbm9yZSBhbnkgZXJyb3JzIGZyb20gZGVlcCBsaW5raW5nLlxuICAgICAgICAgICAgICAvLyBUaGlzIGNvdWxkIGhhcHBlbiBpbiBjYXNlIG9mIG1hbGZvcm1lZCBsaW5rcywgbmF2aWdhdGlvbiBvYmplY3Qgbm90IGJlaW5nIGluaXRpYWxpemVkIGV0Yy5cbiAgICAgICAgICAgICAgY29uc29sZS53YXJuKFxuICAgICAgICAgICAgICAgIGBBbiBlcnJvciBvY2N1cnJlZCB3aGVuIHRyeWluZyB0byBoYW5kbGUgdGhlIGxpbmsgJyR7cGF0aH0nOiAke2UubWVzc2FnZX1gXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIG5hdmlnYXRpb24ucmVzZXRSb290KHN0YXRlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9O1xuXG4gICAgcmV0dXJuIHN1YnNjcmliZShsaXN0ZW5lcik7XG4gIH0sIFtlbmFibGVkLCByZWYsIHN1YnNjcmliZV0pO1xuXG4gIHJldHVybiB7XG4gICAgZ2V0SW5pdGlhbFN0YXRlLFxuICB9O1xufVxuIl19