7c7ada325d6326e4032ea2d82c0b35b6
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _excluded = ["openByDefault"];
Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = DrawerRouter;
exports.DrawerActions = void 0;

var _nonSecure = require("nanoid/non-secure");

var _TabRouter = _interopRequireWildcard(require("./TabRouter"));

function _getRequireWildcardCache() {
  if (typeof WeakMap !== "function") return null;
  var cache = new WeakMap();

  _getRequireWildcardCache = function _getRequireWildcardCache() {
    return cache;
  };

  return cache;
}

function _interopRequireWildcard(obj) {
  if (obj && obj.__esModule) {
    return obj;
  }

  if (obj === null || typeof obj !== "object" && typeof obj !== "function") {
    return {
      default: obj
    };
  }

  var cache = _getRequireWildcardCache();

  if (cache && cache.has(obj)) {
    return cache.get(obj);
  }

  var newObj = {};
  var hasPropertyDescriptor = Object.defineProperty && Object.getOwnPropertyDescriptor;

  for (var key in obj) {
    if (Object.prototype.hasOwnProperty.call(obj, key)) {
      var desc = hasPropertyDescriptor ? Object.getOwnPropertyDescriptor(obj, key) : null;

      if (desc && (desc.get || desc.set)) {
        Object.defineProperty(newObj, key, desc);
      } else {
        newObj[key] = obj[key];
      }
    }
  }

  newObj.default = obj;

  if (cache) {
    cache.set(obj, newObj);
  }

  return newObj;
}

var DrawerActions = (0, _extends2.default)({}, _TabRouter.TabActions, {
  openDrawer: function openDrawer() {
    return {
      type: 'OPEN_DRAWER'
    };
  },
  closeDrawer: function closeDrawer() {
    return {
      type: 'CLOSE_DRAWER'
    };
  },
  toggleDrawer: function toggleDrawer() {
    return {
      type: 'TOGGLE_DRAWER'
    };
  }
});
exports.DrawerActions = DrawerActions;

var isDrawerOpen = function isDrawerOpen(state) {
  var _state$history;

  return Boolean((_state$history = state.history) === null || _state$history === void 0 ? void 0 : _state$history.some(function (it) {
    return it.type === 'drawer';
  }));
};

var openDrawer = function openDrawer(state) {
  if (isDrawerOpen(state)) {
    return state;
  }

  return (0, _extends2.default)({}, state, {
    history: [].concat((0, _toConsumableArray2.default)(state.history), [{
      type: 'drawer'
    }])
  });
};

var closeDrawer = function closeDrawer(state) {
  if (!isDrawerOpen(state)) {
    return state;
  }

  return (0, _extends2.default)({}, state, {
    history: state.history.filter(function (it) {
      return it.type !== 'drawer';
    })
  });
};

function DrawerRouter(_ref) {
  var openByDefault = _ref.openByDefault,
      rest = (0, _objectWithoutProperties2.default)(_ref, _excluded);
  var router = (0, _TabRouter.default)(rest);
  return (0, _extends2.default)({}, router, {
    type: 'drawer',
    getInitialState: function getInitialState(_ref2) {
      var routeNames = _ref2.routeNames,
          routeParamList = _ref2.routeParamList,
          routeGetIdList = _ref2.routeGetIdList;
      var state = router.getInitialState({
        routeNames: routeNames,
        routeParamList: routeParamList,
        routeGetIdList: routeGetIdList
      });

      if (openByDefault) {
        state = openDrawer(state);
      }

      return (0, _extends2.default)({}, state, {
        stale: false,
        type: 'drawer',
        key: "drawer-".concat((0, _nonSecure.nanoid)())
      });
    },
    getRehydratedState: function getRehydratedState(partialState, _ref3) {
      var routeNames = _ref3.routeNames,
          routeParamList = _ref3.routeParamList,
          routeGetIdList = _ref3.routeGetIdList;

      if (partialState.stale === false) {
        return partialState;
      }

      var state = router.getRehydratedState(partialState, {
        routeNames: routeNames,
        routeParamList: routeParamList,
        routeGetIdList: routeGetIdList
      });

      if (partialState.history ? isDrawerOpen(partialState) : openByDefault) {
        state = openDrawer(state);
      }

      return (0, _extends2.default)({}, state, {
        type: 'drawer',
        key: "drawer-".concat((0, _nonSecure.nanoid)())
      });
    },
    getStateForRouteFocus: function getStateForRouteFocus(state, key) {
      var result = router.getStateForRouteFocus(state, key);

      if (openByDefault) {
        return openDrawer(result);
      }

      return closeDrawer(result);
    },
    getStateForAction: function getStateForAction(state, action, options) {
      switch (action.type) {
        case 'OPEN_DRAWER':
          return openDrawer(state);

        case 'CLOSE_DRAWER':
          return closeDrawer(state);

        case 'TOGGLE_DRAWER':
          if (isDrawerOpen(state)) {
            return closeDrawer(state);
          }

          return openDrawer(state);

        case 'GO_BACK':
          if (openByDefault) {
            if (!isDrawerOpen(state)) {
              return openDrawer(state);
            }
          } else {
            if (isDrawerOpen(state)) {
              return closeDrawer(state);
            }
          }

          return router.getStateForAction(state, action, options);

        default:
          return router.getStateForAction(state, action, options);
      }
    },
    actionCreators: DrawerActions
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkRyYXdlclJvdXRlci50c3giXSwibmFtZXMiOlsiRHJhd2VyQWN0aW9ucyIsIlRhYkFjdGlvbnMiLCJvcGVuRHJhd2VyIiwidHlwZSIsImNsb3NlRHJhd2VyIiwidG9nZ2xlRHJhd2VyIiwiaXNEcmF3ZXJPcGVuIiwic3RhdGUiLCJCb29sZWFuIiwiaXQiLCJoaXN0b3J5IiwicmVzdCIsInJvdXRlciIsImdldEluaXRpYWxTdGF0ZSIsInJvdXRlR2V0SWRMaXN0Iiwicm91dGVOYW1lcyIsInJvdXRlUGFyYW1MaXN0Iiwic3RhbGUiLCJrZXkiLCJnZXRSZWh5ZHJhdGVkU3RhdGUiLCJwYXJ0aWFsU3RhdGUiLCJnZXRTdGF0ZUZvclJvdXRlRm9jdXMiLCJyZXN1bHQiLCJnZXRTdGF0ZUZvckFjdGlvbiIsImFjdGlvbiIsImFjdGlvbkNyZWF0b3JzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7OztBQUFBLElBQUEsVUFBQSxHQUFBLE9BQUEsQ0FBQSxtQkFBQSxDQUFBOztBQU9BLElBQUEsVUFBQSxHQUFBLHVCQUFBLENBQUEsT0FBQSxlQUFBLENBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXFETyxJQUFNQSxhQUFhLDhCQUNyQkMsVUFBQUEsQ0FEd0IsVUFBSDtBQUV4QkMsRUFBQUEsVUFGd0Isd0JBRU87QUFDN0IsV0FBTztBQUFFQyxNQUFBQSxJQUFJLEVBQUU7QUFBUixLQUFQO0FBSHlCLEdBQUg7QUFLeEJDLEVBQUFBLFdBTHdCLHlCQUtRO0FBQzlCLFdBQU87QUFBRUQsTUFBQUEsSUFBSSxFQUFFO0FBQVIsS0FBUDtBQU55QixHQUFIO0FBUXhCRSxFQUFBQSxZQVJ3QiwwQkFRUztBQUMvQixXQUFPO0FBQUVGLE1BQUFBLElBQUksRUFBRTtBQUFSLEtBQVA7QUFDRDtBQVZ1QixFQUFuQjs7O0FBYVAsSUFBTUcsWUFBWSxHQUNoQkMsU0FESUQsWUFDSkMsQ0FBQUEsS0FEbUIsRUFBQTtB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QUFBLE1BSU87QUFDTCxnQkFBSUksWUFBWSxDQUFoQixLQUFnQixDQUFoQixFQUF5QjtBQUN2QixxQkFBT0YsV0FBVyxDQUFsQixLQUFrQixDQUFsQjtBQUNEO0FBQ0Y7O0FBRUQsaUJBQU9RLE1BQU0sQ0FBTkEsaUJBQUFBLENBQUFBLEtBQUFBLEVBQUFBLE1BQUFBLEVBQVAsT0FBT0EsQ0FBUDs7QUFFRjtBQUNFLGlCQUFPQSxNQUFNLENBQU5BLGlCQUFBQSxDQUFBQSxLQUFBQSxFQUFBQSxNQUFBQSxFQUFQLE9BQU9BLENBQVA7QUE1Qko7QUE1REcsS0FBUDtBQTRGRWEsSUFBQUEsY0FBYyxFQUFFekI7QUE1RmxCO0FBOEZEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbmFub2lkIH0gZnJvbSAnbmFub2lkL25vbi1zZWN1cmUnO1xuaW1wb3J0IHR5cGUge1xuICBQYXJ0aWFsU3RhdGUsXG4gIENvbW1vbk5hdmlnYXRpb25BY3Rpb24sXG4gIFJvdXRlcixcbiAgUGFyYW1MaXN0QmFzZSxcbn0gZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgVGFiUm91dGVyLCB7XG4gIFRhYkFjdGlvbnMsXG4gIFRhYkFjdGlvblR5cGUsXG4gIFRhYlJvdXRlck9wdGlvbnMsXG4gIFRhYk5hdmlnYXRpb25TdGF0ZSxcbiAgVGFiQWN0aW9uSGVscGVycyxcbn0gZnJvbSAnLi9UYWJSb3V0ZXInO1xuXG5leHBvcnQgdHlwZSBEcmF3ZXJBY3Rpb25UeXBlID1cbiAgfCBUYWJBY3Rpb25UeXBlXG4gIHwge1xuICAgICAgdHlwZTogJ09QRU5fRFJBV0VSJyB8ICdDTE9TRV9EUkFXRVInIHwgJ1RPR0dMRV9EUkFXRVInO1xuICAgICAgc291cmNlPzogc3RyaW5nO1xuICAgICAgdGFyZ2V0Pzogc3RyaW5nO1xuICAgIH07XG5cbmV4cG9ydCB0eXBlIERyYXdlclJvdXRlck9wdGlvbnMgPSBUYWJSb3V0ZXJPcHRpb25zICYge1xuICBvcGVuQnlEZWZhdWx0PzogYm9vbGVhbjtcbn07XG5cbmV4cG9ydCB0eXBlIERyYXdlck5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3QgZXh0ZW5kcyBQYXJhbUxpc3RCYXNlPiA9IE9taXQ8XG4gIFRhYk5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3Q+LFxuICAndHlwZScgfCAnaGlzdG9yeSdcbj4gJiB7XG4gIC8qKlxuICAgKiBUeXBlIG9mIHRoZSByb3V0ZXIsIGluIHRoaXMgY2FzZSwgaXQncyBkcmF3ZXIuXG4gICAqL1xuICB0eXBlOiAnZHJhd2VyJztcbiAgLyoqXG4gICAqIExpc3Qgb2YgcHJldmlvdXNseSB2aXNpdGVkIHJvdXRlIGtleXMgYW5kIGRyYXdlciBvcGVuIHN0YXR1cy5cbiAgICovXG4gIGhpc3Rvcnk6ICh7IHR5cGU6ICdyb3V0ZSc7IGtleTogc3RyaW5nIH0gfCB7IHR5cGU6ICdkcmF3ZXInIH0pW107XG59O1xuXG5leHBvcnQgdHlwZSBEcmF3ZXJBY3Rpb25IZWxwZXJzPFxuICBQYXJhbUxpc3QgZXh0ZW5kcyBQYXJhbUxpc3RCYXNlXG4+ID0gVGFiQWN0aW9uSGVscGVyczxQYXJhbUxpc3Q+ICYge1xuICAvKipcbiAgICogT3BlbiB0aGUgZHJhd2VyIHNpZGViYXIuXG4gICAqL1xuICBvcGVuRHJhd2VyKCk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIENsb3NlIHRoZSBkcmF3ZXIgc2lkZWJhci5cbiAgICovXG4gIGNsb3NlRHJhd2VyKCk6IHZvaWQ7XG5cbiAgLyoqXG4gICAqIE9wZW4gdGhlIGRyYXdlciBzaWRlYmFyIGlmIGNsb3NlZCwgb3IgY2xvc2UgaWYgb3BlbmVkLlxuICAgKi9cbiAgdG9nZ2xlRHJhd2VyKCk6IHZvaWQ7XG59O1xuXG5leHBvcnQgY29uc3QgRHJhd2VyQWN0aW9ucyA9IHtcbiAgLi4uVGFiQWN0aW9ucyxcbiAgb3BlbkRyYXdlcigpOiBEcmF3ZXJBY3Rpb25UeXBlIHtcbiAgICByZXR1cm4geyB0eXBlOiAnT1BFTl9EUkFXRVInIH07XG4gIH0sXG4gIGNsb3NlRHJhd2VyKCk6IERyYXdlckFjdGlvblR5cGUge1xuICAgIHJldHVybiB7IHR5cGU6ICdDTE9TRV9EUkFXRVInIH07XG4gIH0sXG4gIHRvZ2dsZURyYXdlcigpOiBEcmF3ZXJBY3Rpb25UeXBlIHtcbiAgICByZXR1cm4geyB0eXBlOiAnVE9HR0xFX0RSQVdFUicgfTtcbiAgfSxcbn07XG5cbmNvbnN0IGlzRHJhd2VyT3BlbiA9IChcbiAgc3RhdGU6XG4gICAgfCBEcmF3ZXJOYXZpZ2F0aW9uU3RhdGU8UGFyYW1MaXN0QmFzZT5cbiAgICB8IFBhcnRpYWxTdGF0ZTxEcmF3ZXJOYXZpZ2F0aW9uU3RhdGU8UGFyYW1MaXN0QmFzZT4+XG4pID0+IEJvb2xlYW4oc3RhdGUuaGlzdG9yeT8uc29tZSgoaXQpID0+IGl0LnR5cGUgPT09ICdkcmF3ZXInKSk7XG5cbmNvbnN0IG9wZW5EcmF3ZXIgPSAoXG4gIHN0YXRlOiBEcmF3ZXJOYXZpZ2F0aW9uU3RhdGU8UGFyYW1MaXN0QmFzZT5cbik6IERyYXdlck5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3RCYXNlPiA9PiB7XG4gIGlmIChpc0RyYXdlck9wZW4oc3RhdGUpKSB7XG4gICAgcmV0dXJuIHN0YXRlO1xuICB9XG5cbiAgcmV0dXJuIHtcbiAgICAuLi5zdGF0ZSxcbiAgICBoaXN0b3J5OiBbLi4uc3RhdGUuaGlzdG9yeSwgeyB0eXBlOiAnZHJhd2VyJyB9XSxcbiAgfTtcbn07XG5cbmNvbnN0IGNsb3NlRHJhd2VyID0gKFxuICBzdGF0ZTogRHJhd2VyTmF2aWdhdGlvblN0YXRlPFBhcmFtTGlzdEJhc2U+XG4pOiBEcmF3ZXJOYXZpZ2F0aW9uU3RhdGU8UGFyYW1MaXN0QmFzZT4gPT4ge1xuICBpZiAoIWlzRHJhd2VyT3BlbihzdGF0ZSkpIHtcbiAgICByZXR1cm4gc3RhdGU7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIC4uLnN0YXRlLFxuICAgIGhpc3Rvcnk6IHN0YXRlLmhpc3RvcnkuZmlsdGVyKChpdCkgPT4gaXQudHlwZSAhPT0gJ2RyYXdlcicpLFxuICB9O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gRHJhd2VyUm91dGVyKHtcbiAgb3BlbkJ5RGVmYXVsdCxcbiAgLi4ucmVzdFxufTogRHJhd2VyUm91dGVyT3B0aW9ucyk6IFJvdXRlcjxcbiAgRHJhd2VyTmF2aWdhdGlvblN0YXRlPFBhcmFtTGlzdEJhc2U+LFxuICBEcmF3ZXJBY3Rpb25UeXBlIHwgQ29tbW9uTmF2aWdhdGlvbkFjdGlvblxuPiB7XG4gIGNvbnN0IHJvdXRlciA9IChUYWJSb3V0ZXIocmVzdCkgYXMgdW5rbm93bikgYXMgUm91dGVyPFxuICAgIERyYXdlck5hdmlnYXRpb25TdGF0ZTxQYXJhbUxpc3RCYXNlPixcbiAgICBUYWJBY3Rpb25UeXBlIHwgQ29tbW9uTmF2aWdhdGlvbkFjdGlvblxuICA+O1xuXG4gIHJldHVybiB7XG4gICAgLi4ucm91dGVyLFxuXG4gICAgdHlwZTogJ2RyYXdlcicsXG5cbiAgICBnZXRJbml0aWFsU3RhdGUoeyByb3V0ZU5hbWVzLCByb3V0ZVBhcmFtTGlzdCwgcm91dGVHZXRJZExpc3QgfSkge1xuICAgICAgbGV0IHN0YXRlID0gcm91dGVyLmdldEluaXRpYWxTdGF0ZSh7XG4gICAgICAgIHJvdXRlTmFtZXMsXG4gICAgICAgIHJvdXRlUGFyYW1MaXN0LFxuICAgICAgICByb3V0ZUdldElkTGlzdCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAob3BlbkJ5RGVmYXVsdCkge1xuICAgICAgICBzdGF0ZSA9IG9wZW5EcmF3ZXIoc3RhdGUpO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICAuLi5zdGF0ZSxcbiAgICAgICAgc3RhbGU6IGZhbHNlLFxuICAgICAgICB0eXBlOiAnZHJhd2VyJyxcbiAgICAgICAga2V5OiBgZHJhd2VyLSR7bmFub2lkKCl9YCxcbiAgICAgIH07XG4gICAgfSxcblxuICAgIGdldFJlaHlkcmF0ZWRTdGF0ZShcbiAgICAgIHBhcnRpYWxTdGF0ZSxcbiAgICAgIHsgcm91dGVOYW1lcywgcm91dGVQYXJhbUxpc3QsIHJvdXRlR2V0SWRMaXN0IH1cbiAgICApIHtcbiAgICAgIGlmIChwYXJ0aWFsU3RhdGUuc3RhbGUgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBwYXJ0aWFsU3RhdGU7XG4gICAgICB9XG5cbiAgICAgIGxldCBzdGF0ZSA9IHJvdXRlci5nZXRSZWh5ZHJhdGVkU3RhdGUocGFydGlhbFN0YXRlLCB7XG4gICAgICAgIHJvdXRlTmFtZXMsXG4gICAgICAgIHJvdXRlUGFyYW1MaXN0LFxuICAgICAgICByb3V0ZUdldElkTGlzdCxcbiAgICAgIH0pO1xuXG4gICAgICBpZiAocGFydGlhbFN0YXRlLmhpc3RvcnkgPyBpc0RyYXdlck9wZW4ocGFydGlhbFN0YXRlKSA6IG9wZW5CeURlZmF1bHQpIHtcbiAgICAgICAgc3RhdGUgPSBvcGVuRHJhd2VyKHN0YXRlKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgLi4uc3RhdGUsXG4gICAgICAgIHR5cGU6ICdkcmF3ZXInLFxuICAgICAgICBrZXk6IGBkcmF3ZXItJHtuYW5vaWQoKX1gLFxuICAgICAgfTtcbiAgICB9LFxuXG4gICAgZ2V0U3RhdGVGb3JSb3V0ZUZvY3VzKHN0YXRlLCBrZXkpIHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHJvdXRlci5nZXRTdGF0ZUZvclJvdXRlRm9jdXMoc3RhdGUsIGtleSk7XG5cbiAgICAgIGlmIChvcGVuQnlEZWZhdWx0KSB7XG4gICAgICAgIHJldHVybiBvcGVuRHJhd2VyKHJlc3VsdCk7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiBjbG9zZURyYXdlcihyZXN1bHQpO1xuICAgIH0sXG5cbiAgICBnZXRTdGF0ZUZvckFjdGlvbihzdGF0ZSwgYWN0aW9uLCBvcHRpb25zKSB7XG4gICAgICBzd2l0Y2ggKGFjdGlvbi50eXBlKSB7XG4gICAgICAgIGNhc2UgJ09QRU5fRFJBV0VSJzpcbiAgICAgICAgICByZXR1cm4gb3BlbkRyYXdlcihzdGF0ZSk7XG5cbiAgICAgICAgY2FzZSAnQ0xPU0VfRFJBV0VSJzpcbiAgICAgICAgICByZXR1cm4gY2xvc2VEcmF3ZXIoc3RhdGUpO1xuXG4gICAgICAgIGNhc2UgJ1RPR0dMRV9EUkFXRVInOlxuICAgICAgICAgIGlmIChpc0RyYXdlck9wZW4oc3RhdGUpKSB7XG4gICAgICAgICAgICByZXR1cm4gY2xvc2VEcmF3ZXIoc3RhdGUpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHJldHVybiBvcGVuRHJhd2VyKHN0YXRlKTtcblxuICAgICAgICBjYXNlICdHT19CQUNLJzpcbiAgICAgICAgICBpZiAob3BlbkJ5RGVmYXVsdCkge1xuICAgICAgICAgICAgaWYgKCFpc0RyYXdlck9wZW4oc3RhdGUpKSB7XG4gICAgICAgICAgICAgIHJldHVybiBvcGVuRHJhd2VyKHN0YXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgaWYgKGlzRHJhd2VyT3BlbihzdGF0ZSkpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGNsb3NlRHJhd2VyKHN0YXRlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG5cbiAgICAgICAgICByZXR1cm4gcm91dGVyLmdldFN0YXRlRm9yQWN0aW9uKHN0YXRlLCBhY3Rpb24sIG9wdGlvbnMpO1xuXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgcmV0dXJuIHJvdXRlci5nZXRTdGF0ZUZvckFjdGlvbihzdGF0ZSwgYWN0aW9uLCBvcHRpb25zKTtcbiAgICAgIH1cbiAgICB9LFxuXG4gICAgYWN0aW9uQ3JlYXRvcnM6IERyYXdlckFjdGlvbnMsXG4gIH07XG59XG4iXX0=