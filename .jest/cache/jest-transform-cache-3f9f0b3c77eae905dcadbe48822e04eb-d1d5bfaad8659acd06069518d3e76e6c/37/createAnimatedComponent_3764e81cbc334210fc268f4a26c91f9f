fa97616ab6eef41e2cbeb7d08cdf8155
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _objectWithoutProperties2 = _interopRequireDefault(require("@babel/runtime/helpers/objectWithoutProperties"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var _inherits2 = _interopRequireDefault(require("@babel/runtime/helpers/inherits"));

var _possibleConstructorReturn2 = _interopRequireDefault(require("@babel/runtime/helpers/possibleConstructorReturn"));

var _getPrototypeOf2 = _interopRequireDefault(require("@babel/runtime/helpers/getPrototypeOf"));

var _excluded = ["style"],
    _excluded2 = ["style"];

function _createSuper(Derived) { var hasNativeReflectConstruct = _isNativeReflectConstruct(); return function _createSuperInternal() { var Super = (0, _getPrototypeOf2.default)(Derived), result; if (hasNativeReflectConstruct) { var NewTarget = (0, _getPrototypeOf2.default)(this).constructor; result = Reflect.construct(Super, arguments, NewTarget); } else { result = Super.apply(this, arguments); } return (0, _possibleConstructorReturn2.default)(this, result); }; }

function _isNativeReflectConstruct() { if (typeof Reflect === "undefined" || !Reflect.construct) return false; if (Reflect.construct.sham) return false; if (typeof Proxy === "function") return true; try { Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {})); return true; } catch (e) { return false; } }

var View = require("../Components/View/View");

var _require = require("./AnimatedEvent"),
    AnimatedEvent = _require.AnimatedEvent;

var AnimatedProps = require("./nodes/AnimatedProps");

var React = require('react');

var NativeAnimatedHelper = require("./NativeAnimatedHelper");

var invariant = require('invariant');

var setAndForwardRef = require("../Utilities/setAndForwardRef");

var animatedComponentNextId = 1;

function createAnimatedComponent(Component) {
  invariant(typeof Component !== 'function' || Component.prototype && Component.prototype.isReactComponent, '`createAnimatedComponent` does not support stateless functional components; ' + 'use a class component instead.');

  var AnimatedComponent = function (_React$Component) {
    (0, _inherits2.default)(AnimatedComponent, _React$Component);

    var _super = _createSuper(AnimatedComponent);

    function AnimatedComponent() {
      var _this;

      (0, _classCallCheck2.default)(this, AnimatedComponent);

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      _this = _super.call.apply(_super, [this].concat(args));
      _this._invokeAnimatedPropsCallbackOnMount = false;
      _this._eventDetachers = [];
      _this._animatedComponentId = animatedComponentNextId++ + ":animatedComponent";

      _this._isFabric = function () {
        var _this$_component$_int, _this$_component$_int2, _this$_component$getN, _this$_component$getN2, _this$_component$getS, _this$_component$getS2;

        if (_this._component == null) {
          return false;
        }

        return ((_this$_component$_int = _this._component['_internalInstanceHandle']) == null ? void 0 : (_this$_component$_int2 = _this$_component$_int.stateNode) == null ? void 0 : _this$_component$_int2.canonical) != null || _this._component.getNativeScrollRef != null && _this._component.getNativeScrollRef() != null && ((_this$_component$getN = _this._component.getNativeScrollRef()['_internalInstanceHandle']) == null ? void 0 : (_this$_component$getN2 = _this$_component$getN.stateNode) == null ? void 0 : _this$_component$getN2.canonical) != null || _this._component.getScrollResponder != null && _this._component.getScrollResponder() != null && _this._component.getScrollResponder().getNativeScrollRef != null && _this._component.getScrollResponder().getNativeScrollRef() != null && ((_this$_component$getS = _this._component.getScrollResponder().getNativeScrollRef()['_internalInstanceHandle']) == null ? void 0 : (_this$_component$getS2 = _this$_component$getS.stateNode) == null ? void 0 : _this$_component$getS2.canonical) != null;
      };

      _this._waitForUpdate = function () {
        if (_this._isFabric()) {
          NativeAnimatedHelper.API.setWaitingForIdentifier(_this._animatedComponentId);
        }
      };

      _this._markUpdateComplete = function () {
        if (_this._isFabric()) {
          NativeAnimatedHelper.API.unsetWaitingForIdentifier(_this._animatedComponentId);
        }
      };

      _this._animatedPropsCallback = function () {
        if (_this._component == null) {
          _this._invokeAnimatedPropsCallbackOnMount = true;
        } else if (process.env.NODE_ENV === 'test' || typeof _this._component.setNativeProps !== 'function' || _this._isFabric()) {
          _this.forceUpdate();
        } else if (!_this._propsAnimated.__isNative) {
          _this._component.setNativeProps(_this._propsAnimated.__getAnimatedValue());
        } else {
          throw new Error('Attempting to run JS driven animation on animated ' + 'node that has been moved to "native" earlier by starting an ' + 'animation with `useNativeDriver: true`');
        }
      };

      _this._setComponentRef = setAndForwardRef({
        getForwardedRef: function getForwardedRef() {
          return _this.props.forwardedRef;
        },
        setLocalRef: function setLocalRef(ref) {
          _this._prevComponent = _this._component;
          _this._component = ref;

          if (ref != null && ref.getNode == null) {
            ref.getNode = function () {
              var _ref$constructor$name;

              console.warn('%s: Calling `getNode()` on the ref of an Animated component ' + 'is no longer necessary. You can now directly use the ref ' + 'instead. This method will be removed in a future release.', (_ref$constructor$name = ref.constructor.name) != null ? _ref$constructor$name : '<<anonymous>>');
              return ref;
            };
          }
        }
      });
      return _this;
    }

    (0, _createClass2.default)(AnimatedComponent, [{
      key: "_attachNativeEvents",
      value: function _attachNativeEvents() {
        var _this$_component,
            _this2 = this;

        var scrollableNode = (_this$_component = this._component) != null && _this$_component.getScrollableNode ? this._component.getScrollableNode() : this._component;

        var _loop = function _loop(key) {
          var prop = _this2.props[key];

          if (prop instanceof AnimatedEvent && prop.__isNative) {
            prop.__attach(scrollableNode, key);

            _this2._eventDetachers.push(function () {
              return prop.__detach(scrollableNode, key);
            });
          }
        };

        for (var key in this.props) {
          _loop(key);
        }
      }
    }, {
      key: "_detachNativeEvents",
      value: function _detachNativeEvents() {
        this._eventDetachers.forEach(function (remove) {
          return remove();
        });

        this._eventDetachers = [];
      }
    }, {
      key: "_attachProps",
      value: function _attachProps(nextProps) {
        var oldPropsAnimated = this._propsAnimated;

        if (nextProps === oldPropsAnimated) {
          return;
        }

        this._propsAnimated = new AnimatedProps(nextProps, this._animatedPropsCallback);

        if (oldPropsAnimated) {
          oldPropsAnimated.__restoreDefaultValues();

          oldPropsAnimated.__detach();
        }
      }
    }, {
      key: "render",
      value: function render() {
        var _props$nativeID;

        var _ref = this._propsAnimated.__getValue() || {},
            _ref$style = _ref.style,
            style = _ref$style === void 0 ? {} : _ref$style,
            props = (0, _objectWithoutProperties2.default)(_ref, _excluded);

        var _ref2 = this.props.passthroughAnimatedPropExplicitValues || {},
            _ref2$style = _ref2.style,
            passthruStyle = _ref2$style === void 0 ? {} : _ref2$style,
            passthruProps = (0, _objectWithoutProperties2.default)(_ref2, _excluded2);

        var mergedStyle = (0, _extends2.default)({}, style, passthruStyle);
        return React.createElement(Component, (0, _extends2.default)({}, props, passthruProps, {
          style: mergedStyle,
          ref: this._setComponentRef,
          nativeID: (_props$nativeID = props.nativeID) != null ? _props$nativeID : this._isFabric() ? 'animatedComponent' : undefined,
          collapsable: this._propsAnimated.__isNative ? false : props.collapsable
        }));
      }
    }, {
      key: "UNSAFE_componentWillMount",
      value: function UNSAFE_componentWillMount() {
        this._waitForUpdate();

        this._attachProps(this.props);
      }
    }, {
      key: "componentDidMount",
      value: function componentDidMount() {
        if (this._invokeAnimatedPropsCallbackOnMount) {
          this._invokeAnimatedPropsCallbackOnMount = false;

          this._animatedPropsCallback();
        }

        this._propsAnimated.setNativeView(this._component);

        this._attachNativeEvents();

        this._markUpdateComplete();
      }
    }, {
      key: "UNSAFE_componentWillReceiveProps",
      value: function UNSAFE_componentWillReceiveProps(newProps) {
        this._waitForUpdate();

        this._attachProps(newProps);
      }
    }, {
      key: "componentDidUpdate",
      value: function componentDidUpdate(prevProps) {
        if (this._component !== this._prevComponent) {
          this._propsAnimated.setNativeView(this._component);
        }

        if (this._component !== this._prevComponent || prevProps !== this.props) {
          this._detachNativeEvents();

          this._attachNativeEvents();
        }

        this._markUpdateComplete();
      }
    }, {
      key: "componentWillUnmount",
      value: function componentWillUnmount() {
        this._propsAnimated && this._propsAnimated.__detach();

        this._detachNativeEvents();

        this._markUpdateComplete();
      }
    }]);
    return AnimatedComponent;
  }(React.Component);

  return React.forwardRef(function AnimatedComponentWrapper(props, ref) {
    return React.createElement(AnimatedComponent, (0, _extends2.default)({}, props, ref == null ? null : {
      forwardedRef: ref
    }));
  });
}

module.exports = createAnimatedComponent;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50LmpzIl0sIm5hbWVzIjpbIlZpZXciLCJyZXF1aXJlIiwiQW5pbWF0ZWRFdmVudCIsIkFuaW1hdGVkUHJvcHMiLCJSZWFjdCIsIk5hdGl2ZUFuaW1hdGVkSGVscGVyIiwiaW52YXJpYW50Iiwic2V0QW5kRm9yd2FyZFJlZiIsImFuaW1hdGVkQ29tcG9uZW50TmV4dElkIiwiY3JlYXRlQW5pbWF0ZWRDb21wb25lbnQiLCJDb21wb25lbnQiLCJwcm90b3R5cGUiLCJpc1JlYWN0Q29tcG9uZW50IiwiQW5pbWF0ZWRDb21wb25lbnQiLCJfaW52b2tlQW5pbWF0ZWRQcm9wc0NhbGxiYWNrT25Nb3VudCIsIl9ldmVudERldGFjaGVycyIsIl9hbmltYXRlZENvbXBvbmVudElkIiwiX2lzRmFicmljIiwiX2NvbXBvbmVudCIsInN0YXRlTm9kZSIsImNhbm9uaWNhbCIsImdldE5hdGl2ZVNjcm9sbFJlZiIsImdldFNjcm9sbFJlc3BvbmRlciIsIl93YWl0Rm9yVXBkYXRlIiwiQVBJIiwic2V0V2FpdGluZ0ZvcklkZW50aWZpZXIiLCJfbWFya1VwZGF0ZUNvbXBsZXRlIiwidW5zZXRXYWl0aW5nRm9ySWRlbnRpZmllciIsIl9hbmltYXRlZFByb3BzQ2FsbGJhY2siLCJwcm9jZXNzIiwiZW52IiwiTk9ERV9FTlYiLCJzZXROYXRpdmVQcm9wcyIsImZvcmNlVXBkYXRlIiwiX3Byb3BzQW5pbWF0ZWQiLCJfX2lzTmF0aXZlIiwiX19nZXRBbmltYXRlZFZhbHVlIiwiRXJyb3IiLCJfc2V0Q29tcG9uZW50UmVmIiwiZ2V0Rm9yd2FyZGVkUmVmIiwicHJvcHMiLCJmb3J3YXJkZWRSZWYiLCJzZXRMb2NhbFJlZiIsInJlZiIsIl9wcmV2Q29tcG9uZW50IiwiZ2V0Tm9kZSIsImNvbnNvbGUiLCJ3YXJuIiwiY29uc3RydWN0b3IiLCJuYW1lIiwic2Nyb2xsYWJsZU5vZGUiLCJnZXRTY3JvbGxhYmxlTm9kZSIsImtleSIsInByb3AiLCJfX2F0dGFjaCIsInB1c2giLCJfX2RldGFjaCIsImZvckVhY2giLCJyZW1vdmUiLCJuZXh0UHJvcHMiLCJvbGRQcm9wc0FuaW1hdGVkIiwiX19yZXN0b3JlRGVmYXVsdFZhbHVlcyIsIl9fZ2V0VmFsdWUiLCJzdHlsZSIsInBhc3N0aHJvdWdoQW5pbWF0ZWRQcm9wRXhwbGljaXRWYWx1ZXMiLCJwYXNzdGhydVN0eWxlIiwicGFzc3RocnVQcm9wcyIsIm1lcmdlZFN0eWxlIiwibmF0aXZlSUQiLCJ1bmRlZmluZWQiLCJjb2xsYXBzYWJsZSIsIl9hdHRhY2hQcm9wcyIsInNldE5hdGl2ZVZpZXciLCJfYXR0YWNoTmF0aXZlRXZlbnRzIiwibmV3UHJvcHMiLCJwcmV2UHJvcHMiLCJfZGV0YWNoTmF0aXZlRXZlbnRzIiwiZm9yd2FyZFJlZiIsIkFuaW1hdGVkQ29tcG9uZW50V3JhcHBlciIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiJBQVVBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsSUFBSSxHQUFHQyxPQUFPLDJCQUFwQjs7QUFDQSxlQUF3QkEsT0FBTyxtQkFBL0I7QUFBQSxJQUFPQyxhQUFQLFlBQU9BLGFBQVA7O0FBQ0EsSUFBTUMsYUFBYSxHQUFHRixPQUFPLHlCQUE3Qjs7QUFDQSxJQUFNRyxLQUFLLEdBQUdILE9BQU8sQ0FBQyxPQUFELENBQXJCOztBQUNBLElBQU1JLG9CQUFvQixHQUFHSixPQUFPLDBCQUFwQzs7QUFFQSxJQUFNSyxTQUFTLEdBQUdMLE9BQU8sQ0FBQyxXQUFELENBQXpCOztBQUNBLElBQU1NLGdCQUFnQixHQUFHTixPQUFPLGlDQUFoQzs7QUFFQSxJQUFJTyx1QkFBdUIsR0FBRyxDQUE5Qjs7QUFrQkEsU0FBU0MsdUJBQVQsQ0FDRUMsU0FERixFQUUwQztBQUN4Q0osRUFBQUEsU0FBUyxDQUNQLE9BQU9JLFNBQVAsS0FBcUIsVUFBckIsSUFDR0EsU0FBUyxDQUFDQyxTQUFWLElBQXVCRCxTQUFTLENBQUNDLFNBQVYsQ0FBb0JDLGdCQUZ2QyxFQUdQLGlGQUNFLGdDQUpLLENBQVQ7O0FBRHdDLE1BUWxDQyxpQkFSa0M7QUFBQTs7QUFBQTs7QUFBQTtBQUFBOztBQUFBOztBQUFBO0FBQUE7QUFBQTs7QUFBQTtBQUFBLFlBVXRDQyxtQ0FWc0MsR0FVUyxLQVZUO0FBQUEsWUFhdENDLGVBYnNDLEdBYUgsRUFiRztBQUFBLFlBZ0J0Q0Msb0JBaEJzQyxHQWdCSlIsdUJBQXVCLEVBaEJuQjs7QUFBQSxZQXVDdENTLFNBdkNzQyxHQXVDMUIsWUFBZTtBQUFBOztBQUN6QixZQUFJLE1BQUtDLFVBQUwsSUFBbUIsSUFBdkIsRUFBNkI7QUFDM0IsaUJBQU8sS0FBUDtBQUNEOztBQUNELGVBRUUsZ0NBQUtBLFVBQUwsQ0FBZ0IseUJBQWhCLHNFQUE0Q0MsU0FBNUMsNENBQXVEQyxTQUF2RCxLQUNFLElBREYsSUFVQyxNQUFLRixVQUFMLENBQWdCRyxrQkFBaEIsSUFBc0MsSUFBdEMsSUFDQyxNQUFLSCxVQUFMLENBQWdCRyxrQkFBaEIsTUFBd0MsSUFEekMsSUFHQyxnQ0FBS0gsVUFBTCxDQUFnQkcsa0JBQWhCLEdBQXFDLHlCQUFyQyxzRUFDSUYsU0FESiw0Q0FDZUMsU0FEZixLQUM0QixJQWQ5QixJQWVDLE1BQUtGLFVBQUwsQ0FBZ0JJLGtCQUFoQixJQUFzQyxJQUF0QyxJQUNDLE1BQUtKLFVBQUwsQ0FBZ0JJLGtCQUFoQixNQUF3QyxJQUR6QyxJQUVDLE1BQUtKLFVBQUwsQ0FBZ0JJLGtCQUFoQixHQUFxQ0Qsa0JBQXJDLElBQTJELElBRjVELElBR0MsTUFBS0gsVUFBTCxDQUFnQkksa0JBQWhCLEdBQXFDRCxrQkFBckMsTUFBNkQsSUFIOUQsSUFJQyxnQ0FBS0gsVUFBTCxDQUFnQkksa0JBQWhCLEdBQXFDRCxrQkFBckMsR0FFRSx5QkFGRixzRUFHR0YsU0FISCw0Q0FHY0MsU0FIZCxLQUcyQixJQXhCL0I7QUEwQkQsT0FyRXFDOztBQUFBLFlBdUV0Q0csY0F2RXNDLEdBdUVyQixZQUFZO0FBQzNCLFlBQUksTUFBS04sU0FBTCxFQUFKLEVBQXNCO0FBQ3BCWixVQUFBQSxvQkFBb0IsQ0FBQ21CLEdBQXJCLENBQXlCQyx1QkFBekIsQ0FDRSxNQUFLVCxvQkFEUDtBQUdEO0FBQ0YsT0E3RXFDOztBQUFBLFlBK0V0Q1UsbUJBL0VzQyxHQStFaEIsWUFBWTtBQUNoQyxZQUFJLE1BQUtULFNBQUwsRUFBSixFQUFzQjtBQUNwQlosVUFBQUEsb0JBQW9CLENBQUNtQixHQUFyQixDQUF5QkcseUJBQXpCLENBQ0UsTUFBS1gsb0JBRFA7QUFHRDtBQUNGLE9BckZxQzs7QUFBQSxZQTZGdENZLHNCQTdGc0MsR0E2RmIsWUFBTTtBQUM3QixZQUFJLE1BQUtWLFVBQUwsSUFBbUIsSUFBdkIsRUFBNkI7QUFNM0IsZ0JBQUtKLG1DQUFMLEdBQTJDLElBQTNDO0FBQ0QsU0FQRCxNQU9PLElBQ0xlLE9BQU8sQ0FBQ0MsR0FBUixDQUFZQyxRQUFaLEtBQXlCLE1BQXpCLElBRUEsT0FBTyxNQUFLYixVQUFMLENBQWdCYyxjQUF2QixLQUEwQyxVQUYxQyxJQUlBLE1BQUtmLFNBQUwsRUFMSyxFQU1MO0FBQ0EsZ0JBQUtnQixXQUFMO0FBQ0QsU0FSTSxNQVFBLElBQUksQ0FBQyxNQUFLQyxjQUFMLENBQW9CQyxVQUF6QixFQUFxQztBQUMxQyxnQkFBS2pCLFVBQUwsQ0FBZ0JjLGNBQWhCLENBQ0UsTUFBS0UsY0FBTCxDQUFvQkUsa0JBQXBCLEVBREY7QUFHRCxTQUpNLE1BSUE7QUFDTCxnQkFBTSxJQUFJQyxLQUFKLENBQ0osdURBQ0UsOERBREYsR0FFRSx3Q0FIRSxDQUFOO0FBS0Q7QUFDRixPQXhIcUM7O0FBQUEsWUFvSnRDQyxnQkFwSnNDLEdBb0puQi9CLGdCQUFnQixDQUFDO0FBQ2xDZ0MsUUFBQUEsZUFBZSxFQUFFO0FBQUEsaUJBQU0sTUFBS0MsS0FBTCxDQUFXQyxZQUFqQjtBQUFBLFNBRGlCO0FBRWxDQyxRQUFBQSxXQUFXLEVBQUUscUJBQUFDLEdBQUcsRUFBSTtBQUNsQixnQkFBS0MsY0FBTCxHQUFzQixNQUFLMUIsVUFBM0I7QUFDQSxnQkFBS0EsVUFBTCxHQUFrQnlCLEdBQWxCOztBQUdBLGNBQUlBLEdBQUcsSUFBSSxJQUFQLElBQWVBLEdBQUcsQ0FBQ0UsT0FBSixJQUFlLElBQWxDLEVBQXdDO0FBQ3RDRixZQUFBQSxHQUFHLENBQUNFLE9BQUosR0FBYyxZQUFNO0FBQUE7O0FBQ2xCQyxjQUFBQSxPQUFPLENBQUNDLElBQVIsQ0FDRSxpRUFDRSwyREFERixHQUVFLDJEQUhKLDJCQUlFSixHQUFHLENBQUNLLFdBQUosQ0FBZ0JDLElBSmxCLG9DQUkwQixlQUoxQjtBQU1BLHFCQUFPTixHQUFQO0FBQ0QsYUFSRDtBQVNEO0FBQ0Y7QUFsQmlDLE9BQUQsQ0FwSkc7QUFBQTtBQUFBOztBQUFBO0FBQUE7QUFBQSxhQWtCdEMsK0JBQXNCO0FBQUE7QUFBQTs7QUFHcEIsWUFBTU8sY0FBYyxHQUFHLHlCQUFLaEMsVUFBTCw4QkFBaUJpQyxpQkFBakIsR0FDbkIsS0FBS2pDLFVBQUwsQ0FBZ0JpQyxpQkFBaEIsRUFEbUIsR0FFbkIsS0FBS2pDLFVBRlQ7O0FBSG9CLG1DQU9Ua0MsR0FQUztBQVFsQixjQUFNQyxJQUFJLEdBQUcsTUFBSSxDQUFDYixLQUFMLENBQVdZLEdBQVgsQ0FBYjs7QUFDQSxjQUFJQyxJQUFJLFlBQVluRCxhQUFoQixJQUFpQ21ELElBQUksQ0FBQ2xCLFVBQTFDLEVBQXNEO0FBQ3BEa0IsWUFBQUEsSUFBSSxDQUFDQyxRQUFMLENBQWNKLGNBQWQsRUFBOEJFLEdBQTlCOztBQUNBLFlBQUEsTUFBSSxDQUFDckMsZUFBTCxDQUFxQndDLElBQXJCLENBQTBCO0FBQUEscUJBQU1GLElBQUksQ0FBQ0csUUFBTCxDQUFjTixjQUFkLEVBQThCRSxHQUE5QixDQUFOO0FBQUEsYUFBMUI7QUFDRDtBQVppQjs7QUFPcEIsYUFBSyxJQUFNQSxHQUFYLElBQWtCLEtBQUtaLEtBQXZCLEVBQThCO0FBQUEsZ0JBQW5CWSxHQUFtQjtBQU03QjtBQUNGO0FBaENxQztBQUFBO0FBQUEsYUFrQ3RDLCtCQUFzQjtBQUNwQixhQUFLckMsZUFBTCxDQUFxQjBDLE9BQXJCLENBQTZCLFVBQUFDLE1BQU07QUFBQSxpQkFBSUEsTUFBTSxFQUFWO0FBQUEsU0FBbkM7O0FBQ0EsYUFBSzNDLGVBQUwsR0FBdUIsRUFBdkI7QUFDRDtBQXJDcUM7QUFBQTtBQUFBLGFBMEh0QyxzQkFBYTRDLFNBQWIsRUFBd0I7QUFDdEIsWUFBTUMsZ0JBQWdCLEdBQUcsS0FBSzFCLGNBQTlCOztBQUVBLFlBQUl5QixTQUFTLEtBQUtDLGdCQUFsQixFQUFvQztBQUNsQztBQUNEOztBQUVELGFBQUsxQixjQUFMLEdBQXNCLElBQUkvQixhQUFKLENBQ3BCd0QsU0FEb0IsRUFFcEIsS0FBSy9CLHNCQUZlLENBQXRCOztBQWFBLFlBQUlnQyxnQkFBSixFQUFzQjtBQUNwQkEsVUFBQUEsZ0JBQWdCLENBQUNDLHNCQUFqQjs7QUFDQUQsVUFBQUEsZ0JBQWdCLENBQUNKLFFBQWpCO0FBQ0Q7QUFDRjtBQWxKcUM7QUFBQTtBQUFBLGFBeUt0QyxrQkFBUztBQUFBOztBQUNQLG1CQUErQixLQUFLdEIsY0FBTCxDQUFvQjRCLFVBQXBCLE1BQW9DLEVBQW5FO0FBQUEsOEJBQU9DLEtBQVA7QUFBQSxZQUFPQSxLQUFQLDJCQUFlLEVBQWY7QUFBQSxZQUFzQnZCLEtBQXRCOztBQUNBLG9CQUNFLEtBQUtBLEtBQUwsQ0FBV3dCLHFDQUFYLElBQW9ELEVBRHREO0FBQUEsZ0NBQU9ELEtBQVA7QUFBQSxZQUFjRSxhQUFkLDRCQUE4QixFQUE5QjtBQUFBLFlBQXFDQyxhQUFyQzs7QUFFQSxZQUFNQyxXQUFXLDhCQUFPSixLQUFQLEVBQWlCRSxhQUFqQixDQUFqQjtBQUNBLGVBQ0Usb0JBQUMsU0FBRCw2QkFDTXpCLEtBRE4sRUFFTTBCLGFBRk47QUFHRSxVQUFBLEtBQUssRUFBRUMsV0FIVDtBQUlFLFVBQUEsR0FBRyxFQUFFLEtBQUs3QixnQkFKWjtBQUtFLFVBQUEsUUFBUSxxQkFDTkUsS0FBSyxDQUFDNEIsUUFEQSw4QkFFTCxLQUFLbkQsU0FBTCxLQUFtQixtQkFBbkIsR0FBeUNvRCxTQVA5QztBQWFFLFVBQUEsV0FBVyxFQUNULEtBQUtuQyxjQUFMLENBQW9CQyxVQUFwQixHQUFpQyxLQUFqQyxHQUF5Q0ssS0FBSyxDQUFDOEI7QUFkbkQsV0FERjtBQW1CRDtBQWpNcUM7QUFBQTtBQUFBLGFBbU10QyxxQ0FBNEI7QUFDMUIsYUFBSy9DLGNBQUw7O0FBQ0EsYUFBS2dELFlBQUwsQ0FBa0IsS0FBSy9CLEtBQXZCO0FBQ0Q7QUF0TXFDO0FBQUE7QUFBQSxhQXdNdEMsNkJBQW9CO0FBQ2xCLFlBQUksS0FBSzFCLG1DQUFULEVBQThDO0FBQzVDLGVBQUtBLG1DQUFMLEdBQTJDLEtBQTNDOztBQUNBLGVBQUtjLHNCQUFMO0FBQ0Q7O0FBRUQsYUFBS00sY0FBTCxDQUFvQnNDLGFBQXBCLENBQWtDLEtBQUt0RCxVQUF2Qzs7QUFDQSxhQUFLdUQsbUJBQUw7O0FBQ0EsYUFBSy9DLG1CQUFMO0FBQ0Q7QUFqTnFDO0FBQUE7QUFBQSxhQW1OdEMsMENBQWlDZ0QsUUFBakMsRUFBMkM7QUFDekMsYUFBS25ELGNBQUw7O0FBQ0EsYUFBS2dELFlBQUwsQ0FBa0JHLFFBQWxCO0FBQ0Q7QUF0TnFDO0FBQUE7QUFBQSxhQXdOdEMsNEJBQW1CQyxTQUFuQixFQUE4QjtBQUM1QixZQUFJLEtBQUt6RCxVQUFMLEtBQW9CLEtBQUswQixjQUE3QixFQUE2QztBQUMzQyxlQUFLVixjQUFMLENBQW9Cc0MsYUFBcEIsQ0FBa0MsS0FBS3RELFVBQXZDO0FBQ0Q7O0FBQ0QsWUFBSSxLQUFLQSxVQUFMLEtBQW9CLEtBQUswQixjQUF6QixJQUEyQytCLFNBQVMsS0FBSyxLQUFLbkMsS0FBbEUsRUFBeUU7QUFDdkUsZUFBS29DLG1CQUFMOztBQUNBLGVBQUtILG1CQUFMO0FBQ0Q7O0FBQ0QsYUFBSy9DLG1CQUFMO0FBQ0Q7QUFqT3FDO0FBQUE7QUFBQSxhQW1PdEMsZ0NBQXVCO0FBQ3JCLGFBQUtRLGNBQUwsSUFBdUIsS0FBS0EsY0FBTCxDQUFvQnNCLFFBQXBCLEVBQXZCOztBQUNBLGFBQUtvQixtQkFBTDs7QUFDQSxhQUFLbEQsbUJBQUw7QUFDRDtBQXZPcUM7QUFBQTtBQUFBLElBUVJ0QixLQUFLLENBQUNNLFNBUkU7O0FBME94QyxTQUFPTixLQUFLLENBQUN5RSxVQUFOLENBQWlCLFNBQVNDLHdCQUFULENBQWtDdEMsS0FBbEMsRUFBeUNHLEdBQXpDLEVBQThDO0FBQ3BFLFdBQ0Usb0JBQUMsaUJBQUQsNkJBQ01ILEtBRE4sRUFFT0csR0FBRyxJQUFJLElBQVAsR0FBYyxJQUFkLEdBQXFCO0FBQUNGLE1BQUFBLFlBQVksRUFBRUU7QUFBZixLQUY1QixFQURGO0FBTUQsR0FQTSxDQUFQO0FBUUQ7O0FBRURvQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJ2RSx1QkFBakIiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENvcHlyaWdodCAoYykgRmFjZWJvb2ssIEluYy4gYW5kIGl0cyBhZmZpbGlhdGVzLlxuICpcbiAqIFRoaXMgc291cmNlIGNvZGUgaXMgbGljZW5zZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlIGZvdW5kIGluIHRoZVxuICogTElDRU5TRSBmaWxlIGluIHRoZSByb290IGRpcmVjdG9yeSBvZiB0aGlzIHNvdXJjZSB0cmVlLlxuICpcbiAqIEBmbG93XG4gKiBAZm9ybWF0XG4gKi9cblxuJ3VzZSBzdHJpY3QnO1xuXG5jb25zdCBWaWV3ID0gcmVxdWlyZSgnLi4vQ29tcG9uZW50cy9WaWV3L1ZpZXcnKTtcbmNvbnN0IHtBbmltYXRlZEV2ZW50fSA9IHJlcXVpcmUoJy4vQW5pbWF0ZWRFdmVudCcpO1xuY29uc3QgQW5pbWF0ZWRQcm9wcyA9IHJlcXVpcmUoJy4vbm9kZXMvQW5pbWF0ZWRQcm9wcycpO1xuY29uc3QgUmVhY3QgPSByZXF1aXJlKCdyZWFjdCcpO1xuY29uc3QgTmF0aXZlQW5pbWF0ZWRIZWxwZXIgPSByZXF1aXJlKCcuL05hdGl2ZUFuaW1hdGVkSGVscGVyJyk7XG5cbmNvbnN0IGludmFyaWFudCA9IHJlcXVpcmUoJ2ludmFyaWFudCcpO1xuY29uc3Qgc2V0QW5kRm9yd2FyZFJlZiA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9zZXRBbmRGb3J3YXJkUmVmJyk7XG5cbmxldCBhbmltYXRlZENvbXBvbmVudE5leHRJZCA9IDE7XG5cbmV4cG9ydCB0eXBlIEFuaW1hdGVkQ29tcG9uZW50VHlwZTxcbiAgUHJvcHM6IHsrW3N0cmluZ106IG1peGVkLCAuLi59LFxuICBJbnN0YW5jZSxcbj4gPSBSZWFjdC5BYnN0cmFjdENvbXBvbmVudDxcbiAgJE9iak1hcDxcbiAgICBQcm9wcyAmXG4gICAgICAkUmVhZE9ubHk8e1xuICAgICAgICBwYXNzdGhyb3VnaEFuaW1hdGVkUHJvcEV4cGxpY2l0VmFsdWVzPzogUmVhY3QuRWxlbWVudENvbmZpZzxcbiAgICAgICAgICB0eXBlb2YgVmlldyxcbiAgICAgICAgPixcbiAgICAgIH0+LFxuICAgICgpID0+IGFueSxcbiAgPixcbiAgSW5zdGFuY2UsXG4+O1xuXG5mdW5jdGlvbiBjcmVhdGVBbmltYXRlZENvbXBvbmVudDxQcm9wczogeytbc3RyaW5nXTogbWl4ZWQsIC4uLn0sIEluc3RhbmNlPihcbiAgQ29tcG9uZW50OiBSZWFjdC5BYnN0cmFjdENvbXBvbmVudDxQcm9wcywgSW5zdGFuY2U+LFxuKTogQW5pbWF0ZWRDb21wb25lbnRUeXBlPFByb3BzLCBJbnN0YW5jZT4ge1xuICBpbnZhcmlhbnQoXG4gICAgdHlwZW9mIENvbXBvbmVudCAhPT0gJ2Z1bmN0aW9uJyB8fFxuICAgICAgKENvbXBvbmVudC5wcm90b3R5cGUgJiYgQ29tcG9uZW50LnByb3RvdHlwZS5pc1JlYWN0Q29tcG9uZW50KSxcbiAgICAnYGNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50YCBkb2VzIG5vdCBzdXBwb3J0IHN0YXRlbGVzcyBmdW5jdGlvbmFsIGNvbXBvbmVudHM7ICcgK1xuICAgICAgJ3VzZSBhIGNsYXNzIGNvbXBvbmVudCBpbnN0ZWFkLicsXG4gICk7XG5cbiAgY2xhc3MgQW5pbWF0ZWRDb21wb25lbnQgZXh0ZW5kcyBSZWFjdC5Db21wb25lbnQ8T2JqZWN0PiB7XG4gICAgX2NvbXBvbmVudDogYW55OyAvLyBUT0RPIFQ1MzczODE2MTogZmxvdyB0eXBlIHRoaXMsIGFuZCB0aGUgd2hvbGUgZmlsZVxuICAgIF9pbnZva2VBbmltYXRlZFByb3BzQ2FsbGJhY2tPbk1vdW50OiBib29sZWFuID0gZmFsc2U7XG4gICAgX3ByZXZDb21wb25lbnQ6IGFueTtcbiAgICBfcHJvcHNBbmltYXRlZDogQW5pbWF0ZWRQcm9wcztcbiAgICBfZXZlbnREZXRhY2hlcnM6IEFycmF5PEZ1bmN0aW9uPiA9IFtdO1xuXG4gICAgLy8gT25seSB0byBiZSB1c2VkIGluIHRoaXMgZmlsZSwgYW5kIG9ubHkgaW4gRmFicmljLlxuICAgIF9hbmltYXRlZENvbXBvbmVudElkOiBzdHJpbmcgPSBgJHthbmltYXRlZENvbXBvbmVudE5leHRJZCsrfTphbmltYXRlZENvbXBvbmVudGA7XG5cbiAgICBfYXR0YWNoTmF0aXZlRXZlbnRzKCkge1xuICAgICAgLy8gTWFrZSBzdXJlIHRvIGdldCB0aGUgc2Nyb2xsYWJsZSBub2RlIGZvciBjb21wb25lbnRzIHRoYXQgaW1wbGVtZW50XG4gICAgICAvLyBgU2Nyb2xsUmVzcG9uZGVyLk1peGluYC5cbiAgICAgIGNvbnN0IHNjcm9sbGFibGVOb2RlID0gdGhpcy5fY29tcG9uZW50Py5nZXRTY3JvbGxhYmxlTm9kZVxuICAgICAgICA/IHRoaXMuX2NvbXBvbmVudC5nZXRTY3JvbGxhYmxlTm9kZSgpXG4gICAgICAgIDogdGhpcy5fY29tcG9uZW50O1xuXG4gICAgICBmb3IgKGNvbnN0IGtleSBpbiB0aGlzLnByb3BzKSB7XG4gICAgICAgIGNvbnN0IHByb3AgPSB0aGlzLnByb3BzW2tleV07XG4gICAgICAgIGlmIChwcm9wIGluc3RhbmNlb2YgQW5pbWF0ZWRFdmVudCAmJiBwcm9wLl9faXNOYXRpdmUpIHtcbiAgICAgICAgICBwcm9wLl9fYXR0YWNoKHNjcm9sbGFibGVOb2RlLCBrZXkpO1xuICAgICAgICAgIHRoaXMuX2V2ZW50RGV0YWNoZXJzLnB1c2goKCkgPT4gcHJvcC5fX2RldGFjaChzY3JvbGxhYmxlTm9kZSwga2V5KSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICBfZGV0YWNoTmF0aXZlRXZlbnRzKCkge1xuICAgICAgdGhpcy5fZXZlbnREZXRhY2hlcnMuZm9yRWFjaChyZW1vdmUgPT4gcmVtb3ZlKCkpO1xuICAgICAgdGhpcy5fZXZlbnREZXRhY2hlcnMgPSBbXTtcbiAgICB9XG5cbiAgICBfaXNGYWJyaWMgPSAoKTogYm9vbGVhbiA9PiB7XG4gICAgICBpZiAodGhpcy5fY29tcG9uZW50ID09IG51bGwpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgcmV0dXJuIChcbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIGRvdC1ub3RhdGlvblxuICAgICAgICB0aGlzLl9jb21wb25lbnRbJ19pbnRlcm5hbEluc3RhbmNlSGFuZGxlJ10/LnN0YXRlTm9kZT8uY2Fub25pY2FsICE9XG4gICAgICAgICAgbnVsbCB8fFxuICAgICAgICAvLyBTb21lIGNvbXBvbmVudHMgaGF2ZSBhIHNldE5hdGl2ZVByb3BzIGZ1bmN0aW9uIGJ1dCBhcmVuJ3QgYSBob3N0IGNvbXBvbmVudFxuICAgICAgICAvLyBzdWNoIGFzIGxpc3RzIGxpa2UgRmxhdExpc3QgYW5kIFNlY3Rpb25MaXN0LiBUaGVzZSBzaG91bGQgYWxzbyB1c2VcbiAgICAgICAgLy8gZm9yY2VVcGRhdGUgaW4gRmFicmljIHNpbmNlIHNldE5hdGl2ZVByb3BzIGRvZXNuJ3QgZXhpc3Qgb24gdGhlIHVuZGVybHlpbmdcbiAgICAgICAgLy8gaG9zdCBjb21wb25lbnQuIFRoaXMgY3JhenkgaGFjayBpcyBlc3NlbnRpYWxseSBzcGVjaWFsIGNhc2luZyB0aG9zZSBsaXN0cyBhbmRcbiAgICAgICAgLy8gU2Nyb2xsVmlldyBpdHNlbGYgdG8gdXNlIGZvcmNlVXBkYXRlIGluIEZhYnJpYy5cbiAgICAgICAgLy8gSWYgdGhlc2UgY29tcG9uZW50cyBlbmQgdXAgdXNpbmcgZm9yd2FyZFJlZiB0aGVuIHRoZXNlIGhhY2tzIGNhbiBnbyBhd2F5XG4gICAgICAgIC8vIGFzIHRoaXMuX2NvbXBvbmVudCB3b3VsZCBhY3R1YWxseSBiZSB0aGUgdW5kZXJseWluZyBob3N0IGNvbXBvbmVudCBhbmQgdGhlIGFib3ZlIGNoZWNrXG4gICAgICAgIC8vIHdvdWxkIGJlIHN1ZmZpY2llbnQuXG4gICAgICAgICh0aGlzLl9jb21wb25lbnQuZ2V0TmF0aXZlU2Nyb2xsUmVmICE9IG51bGwgJiZcbiAgICAgICAgICB0aGlzLl9jb21wb25lbnQuZ2V0TmF0aXZlU2Nyb2xsUmVmKCkgIT0gbnVsbCAmJlxuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBkb3Qtbm90YXRpb25cbiAgICAgICAgICB0aGlzLl9jb21wb25lbnQuZ2V0TmF0aXZlU2Nyb2xsUmVmKClbJ19pbnRlcm5hbEluc3RhbmNlSGFuZGxlJ11cbiAgICAgICAgICAgID8uc3RhdGVOb2RlPy5jYW5vbmljYWwgIT0gbnVsbCkgfHxcbiAgICAgICAgKHRoaXMuX2NvbXBvbmVudC5nZXRTY3JvbGxSZXNwb25kZXIgIT0gbnVsbCAmJlxuICAgICAgICAgIHRoaXMuX2NvbXBvbmVudC5nZXRTY3JvbGxSZXNwb25kZXIoKSAhPSBudWxsICYmXG4gICAgICAgICAgdGhpcy5fY29tcG9uZW50LmdldFNjcm9sbFJlc3BvbmRlcigpLmdldE5hdGl2ZVNjcm9sbFJlZiAhPSBudWxsICYmXG4gICAgICAgICAgdGhpcy5fY29tcG9uZW50LmdldFNjcm9sbFJlc3BvbmRlcigpLmdldE5hdGl2ZVNjcm9sbFJlZigpICE9IG51bGwgJiZcbiAgICAgICAgICB0aGlzLl9jb21wb25lbnQuZ2V0U2Nyb2xsUmVzcG9uZGVyKCkuZ2V0TmF0aXZlU2Nyb2xsUmVmKClbXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgZG90LW5vdGF0aW9uXG4gICAgICAgICAgICAnX2ludGVybmFsSW5zdGFuY2VIYW5kbGUnXG4gICAgICAgICAgXT8uc3RhdGVOb2RlPy5jYW5vbmljYWwgIT0gbnVsbClcbiAgICAgICk7XG4gICAgfTtcblxuICAgIF93YWl0Rm9yVXBkYXRlID0gKCk6IHZvaWQgPT4ge1xuICAgICAgaWYgKHRoaXMuX2lzRmFicmljKCkpIHtcbiAgICAgICAgTmF0aXZlQW5pbWF0ZWRIZWxwZXIuQVBJLnNldFdhaXRpbmdGb3JJZGVudGlmaWVyKFxuICAgICAgICAgIHRoaXMuX2FuaW1hdGVkQ29tcG9uZW50SWQsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfTtcblxuICAgIF9tYXJrVXBkYXRlQ29tcGxldGUgPSAoKTogdm9pZCA9PiB7XG4gICAgICBpZiAodGhpcy5faXNGYWJyaWMoKSkge1xuICAgICAgICBOYXRpdmVBbmltYXRlZEhlbHBlci5BUEkudW5zZXRXYWl0aW5nRm9ySWRlbnRpZmllcihcbiAgICAgICAgICB0aGlzLl9hbmltYXRlZENvbXBvbmVudElkLFxuICAgICAgICApO1xuICAgICAgfVxuICAgIH07XG5cbiAgICAvLyBUaGUgc3lzdGVtIGlzIGJlc3QgZGVzaWduZWQgd2hlbiBzZXROYXRpdmVQcm9wcyBpcyBpbXBsZW1lbnRlZC4gSXQgaXNcbiAgICAvLyBhYmxlIHRvIGF2b2lkIHJlLXJlbmRlcmluZyBhbmQgZGlyZWN0bHkgc2V0IHRoZSBhdHRyaWJ1dGVzIHRoYXQgY2hhbmdlZC5cbiAgICAvLyBIb3dldmVyLCBzZXROYXRpdmVQcm9wcyBjYW4gb25seSBiZSBpbXBsZW1lbnRlZCBvbiBsZWFmIG5hdGl2ZVxuICAgIC8vIGNvbXBvbmVudHMuIElmIHlvdSB3YW50IHRvIGFuaW1hdGUgYSBjb21wb3NpdGUgY29tcG9uZW50LCB5b3UgbmVlZCB0b1xuICAgIC8vIHJlLXJlbmRlciBpdC4gSW4gdGhpcyBjYXNlLCB3ZSBoYXZlIGEgZmFsbGJhY2sgdGhhdCB1c2VzIGZvcmNlVXBkYXRlLlxuICAgIC8vIFRoaXMgZmFsbGJhY2sgaXMgYWxzbyBjYWxsZWQgaW4gRmFicmljLlxuICAgIF9hbmltYXRlZFByb3BzQ2FsbGJhY2sgPSAoKSA9PiB7XG4gICAgICBpZiAodGhpcy5fY29tcG9uZW50ID09IG51bGwpIHtcbiAgICAgICAgLy8gQW5pbWF0ZWRQcm9wcyBpcyBjcmVhdGVkIGluIHdpbGwtbW91bnQgYmVjYXVzZSBpdCdzIHVzZWQgaW4gcmVuZGVyLlxuICAgICAgICAvLyBCdXQgdGhpcyBjYWxsYmFjayBtYXkgYmUgaW52b2tlZCBiZWZvcmUgbW91bnQgaW4gYXN5bmMgbW9kZSxcbiAgICAgICAgLy8gSW4gd2hpY2ggY2FzZSB3ZSBzaG91bGQgZGVmZXIgdGhlIHNldE5hdGl2ZVByb3BzKCkgY2FsbC5cbiAgICAgICAgLy8gUmVhY3QgbWF5IHRocm93IGF3YXkgdW5jb21taXR0ZWQgd29yayBpbiBhc3luYyBtb2RlLFxuICAgICAgICAvLyBTbyBhIGRlZmVycmVkIGNhbGwgd29uJ3QgYWx3YXlzIGJlIGludm9rZWQuXG4gICAgICAgIHRoaXMuX2ludm9rZUFuaW1hdGVkUHJvcHNDYWxsYmFja09uTW91bnQgPSB0cnVlO1xuICAgICAgfSBlbHNlIGlmIChcbiAgICAgICAgcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICd0ZXN0JyB8fFxuICAgICAgICAvLyBGb3IgYW5pbWF0aW5nIHByb3BlcnRpZXMgb2Ygbm9uLWxlYWYvbm9uLW5hdGl2ZSBjb21wb25lbnRzXG4gICAgICAgIHR5cGVvZiB0aGlzLl9jb21wb25lbnQuc2V0TmF0aXZlUHJvcHMgIT09ICdmdW5jdGlvbicgfHxcbiAgICAgICAgLy8gSW4gRmFicmljLCBmb3JjZSBhbmltYXRpb25zIHRvIGdvIHRocm91Z2ggZm9yY2VVcGRhdGUgYW5kIHNraXAgc2V0TmF0aXZlUHJvcHNcbiAgICAgICAgdGhpcy5faXNGYWJyaWMoKVxuICAgICAgKSB7XG4gICAgICAgIHRoaXMuZm9yY2VVcGRhdGUoKTtcbiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX3Byb3BzQW5pbWF0ZWQuX19pc05hdGl2ZSkge1xuICAgICAgICB0aGlzLl9jb21wb25lbnQuc2V0TmF0aXZlUHJvcHMoXG4gICAgICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5fX2dldEFuaW1hdGVkVmFsdWUoKSxcbiAgICAgICAgKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgICAnQXR0ZW1wdGluZyB0byBydW4gSlMgZHJpdmVuIGFuaW1hdGlvbiBvbiBhbmltYXRlZCAnICtcbiAgICAgICAgICAgICdub2RlIHRoYXQgaGFzIGJlZW4gbW92ZWQgdG8gXCJuYXRpdmVcIiBlYXJsaWVyIGJ5IHN0YXJ0aW5nIGFuICcgK1xuICAgICAgICAgICAgJ2FuaW1hdGlvbiB3aXRoIGB1c2VOYXRpdmVEcml2ZXI6IHRydWVgJyxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgX2F0dGFjaFByb3BzKG5leHRQcm9wcykge1xuICAgICAgY29uc3Qgb2xkUHJvcHNBbmltYXRlZCA9IHRoaXMuX3Byb3BzQW5pbWF0ZWQ7XG5cbiAgICAgIGlmIChuZXh0UHJvcHMgPT09IG9sZFByb3BzQW5pbWF0ZWQpIHtcbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuXG4gICAgICB0aGlzLl9wcm9wc0FuaW1hdGVkID0gbmV3IEFuaW1hdGVkUHJvcHMoXG4gICAgICAgIG5leHRQcm9wcyxcbiAgICAgICAgdGhpcy5fYW5pbWF0ZWRQcm9wc0NhbGxiYWNrLFxuICAgICAgKTtcblxuICAgICAgLy8gV2hlbiB5b3UgY2FsbCBkZXRhY2gsIGl0IHJlbW92ZXMgdGhlIGVsZW1lbnQgZnJvbSB0aGUgcGFyZW50IGxpc3RcbiAgICAgIC8vIG9mIGNoaWxkcmVuLiBJZiBpdCBnb2VzIHRvIDAsIHRoZW4gdGhlIHBhcmVudCBhbHNvIGRldGFjaGVzIGl0c2VsZlxuICAgICAgLy8gYW5kIHNvIG9uLlxuICAgICAgLy8gQW4gb3B0aW1pemF0aW9uIGlzIHRvIGF0dGFjaCB0aGUgbmV3IGVsZW1lbnRzIGFuZCBUSEVOIGRldGFjaCB0aGUgb2xkXG4gICAgICAvLyBvbmVzIGluc3RlYWQgb2YgZGV0YWNoaW5nIGFuZCBUSEVOIGF0dGFjaGluZy5cbiAgICAgIC8vIFRoaXMgd2F5IHRoZSBpbnRlcm1lZGlhdGUgc3RhdGUgaXNuJ3QgdG8gZ28gdG8gMCBhbmQgdHJpZ2dlclxuICAgICAgLy8gdGhpcyBleHBlbnNpdmUgcmVjdXJzaXZlIGRldGFjaGluZyB0byB0aGVuIHJlLWF0dGFjaCBldmVyeXRoaW5nIG9uXG4gICAgICAvLyB0aGUgdmVyeSBuZXh0IG9wZXJhdGlvbi5cbiAgICAgIGlmIChvbGRQcm9wc0FuaW1hdGVkKSB7XG4gICAgICAgIG9sZFByb3BzQW5pbWF0ZWQuX19yZXN0b3JlRGVmYXVsdFZhbHVlcygpO1xuICAgICAgICBvbGRQcm9wc0FuaW1hdGVkLl9fZGV0YWNoKCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgX3NldENvbXBvbmVudFJlZiA9IHNldEFuZEZvcndhcmRSZWYoe1xuICAgICAgZ2V0Rm9yd2FyZGVkUmVmOiAoKSA9PiB0aGlzLnByb3BzLmZvcndhcmRlZFJlZixcbiAgICAgIHNldExvY2FsUmVmOiByZWYgPT4ge1xuICAgICAgICB0aGlzLl9wcmV2Q29tcG9uZW50ID0gdGhpcy5fY29tcG9uZW50O1xuICAgICAgICB0aGlzLl9jb21wb25lbnQgPSByZWY7XG5cbiAgICAgICAgLy8gVE9ETzogRGVsZXRlIHRoaXMgaW4gYSBmdXR1cmUgcmVsZWFzZS5cbiAgICAgICAgaWYgKHJlZiAhPSBudWxsICYmIHJlZi5nZXROb2RlID09IG51bGwpIHtcbiAgICAgICAgICByZWYuZ2V0Tm9kZSA9ICgpID0+IHtcbiAgICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICAgJyVzOiBDYWxsaW5nIGBnZXROb2RlKClgIG9uIHRoZSByZWYgb2YgYW4gQW5pbWF0ZWQgY29tcG9uZW50ICcgK1xuICAgICAgICAgICAgICAgICdpcyBubyBsb25nZXIgbmVjZXNzYXJ5LiBZb3UgY2FuIG5vdyBkaXJlY3RseSB1c2UgdGhlIHJlZiAnICtcbiAgICAgICAgICAgICAgICAnaW5zdGVhZC4gVGhpcyBtZXRob2Qgd2lsbCBiZSByZW1vdmVkIGluIGEgZnV0dXJlIHJlbGVhc2UuJyxcbiAgICAgICAgICAgICAgcmVmLmNvbnN0cnVjdG9yLm5hbWUgPz8gJzw8YW5vbnltb3VzPj4nLFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiByZWY7XG4gICAgICAgICAgfTtcbiAgICAgICAgfVxuICAgICAgfSxcbiAgICB9KTtcblxuICAgIHJlbmRlcigpIHtcbiAgICAgIGNvbnN0IHtzdHlsZSA9IHt9LCAuLi5wcm9wc30gPSB0aGlzLl9wcm9wc0FuaW1hdGVkLl9fZ2V0VmFsdWUoKSB8fCB7fTtcbiAgICAgIGNvbnN0IHtzdHlsZTogcGFzc3RocnVTdHlsZSA9IHt9LCAuLi5wYXNzdGhydVByb3BzfSA9XG4gICAgICAgIHRoaXMucHJvcHMucGFzc3Rocm91Z2hBbmltYXRlZFByb3BFeHBsaWNpdFZhbHVlcyB8fCB7fTtcbiAgICAgIGNvbnN0IG1lcmdlZFN0eWxlID0gey4uLnN0eWxlLCAuLi5wYXNzdGhydVN0eWxlfTtcbiAgICAgIHJldHVybiAoXG4gICAgICAgIDxDb21wb25lbnRcbiAgICAgICAgICB7Li4ucHJvcHN9XG4gICAgICAgICAgey4uLnBhc3N0aHJ1UHJvcHN9XG4gICAgICAgICAgc3R5bGU9e21lcmdlZFN0eWxlfVxuICAgICAgICAgIHJlZj17dGhpcy5fc2V0Q29tcG9uZW50UmVmfVxuICAgICAgICAgIG5hdGl2ZUlEPXtcbiAgICAgICAgICAgIHByb3BzLm5hdGl2ZUlEID8/XG4gICAgICAgICAgICAodGhpcy5faXNGYWJyaWMoKSA/ICdhbmltYXRlZENvbXBvbmVudCcgOiB1bmRlZmluZWQpXG4gICAgICAgICAgfSAvKiBUT0RPOiBUNjgyNTg4NDYuICovXG4gICAgICAgICAgLy8gVGhlIG5hdGl2ZSBkcml2ZXIgdXBkYXRlcyB2aWV3cyBkaXJlY3RseSB0aHJvdWdoIHRoZSBVSSB0aHJlYWQgc28gd2VcbiAgICAgICAgICAvLyBoYXZlIHRvIG1ha2Ugc3VyZSB0aGUgdmlldyBkb2Vzbid0IGdldCBvcHRpbWl6ZWQgYXdheSBiZWNhdXNlIGl0IGNhbm5vdFxuICAgICAgICAgIC8vIGdvIHRocm91Z2ggdGhlIE5hdGl2ZVZpZXdIaWVyYXJjaHlNYW5hZ2VyIHNpbmNlIGl0IG9wZXJhdGVzIG9uIHRoZSBzaGFkb3dcbiAgICAgICAgICAvLyB0aHJlYWQuXG4gICAgICAgICAgY29sbGFwc2FibGU9e1xuICAgICAgICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5fX2lzTmF0aXZlID8gZmFsc2UgOiBwcm9wcy5jb2xsYXBzYWJsZVxuICAgICAgICAgIH1cbiAgICAgICAgLz5cbiAgICAgICk7XG4gICAgfVxuXG4gICAgVU5TQUZFX2NvbXBvbmVudFdpbGxNb3VudCgpIHtcbiAgICAgIHRoaXMuX3dhaXRGb3JVcGRhdGUoKTtcbiAgICAgIHRoaXMuX2F0dGFjaFByb3BzKHRoaXMucHJvcHMpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudERpZE1vdW50KCkge1xuICAgICAgaWYgKHRoaXMuX2ludm9rZUFuaW1hdGVkUHJvcHNDYWxsYmFja09uTW91bnQpIHtcbiAgICAgICAgdGhpcy5faW52b2tlQW5pbWF0ZWRQcm9wc0NhbGxiYWNrT25Nb3VudCA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9hbmltYXRlZFByb3BzQ2FsbGJhY2soKTtcbiAgICAgIH1cblxuICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZC5zZXROYXRpdmVWaWV3KHRoaXMuX2NvbXBvbmVudCk7XG4gICAgICB0aGlzLl9hdHRhY2hOYXRpdmVFdmVudHMoKTtcbiAgICAgIHRoaXMuX21hcmtVcGRhdGVDb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIFVOU0FGRV9jb21wb25lbnRXaWxsUmVjZWl2ZVByb3BzKG5ld1Byb3BzKSB7XG4gICAgICB0aGlzLl93YWl0Rm9yVXBkYXRlKCk7XG4gICAgICB0aGlzLl9hdHRhY2hQcm9wcyhuZXdQcm9wcyk7XG4gICAgfVxuXG4gICAgY29tcG9uZW50RGlkVXBkYXRlKHByZXZQcm9wcykge1xuICAgICAgaWYgKHRoaXMuX2NvbXBvbmVudCAhPT0gdGhpcy5fcHJldkNvbXBvbmVudCkge1xuICAgICAgICB0aGlzLl9wcm9wc0FuaW1hdGVkLnNldE5hdGl2ZVZpZXcodGhpcy5fY29tcG9uZW50KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLl9jb21wb25lbnQgIT09IHRoaXMuX3ByZXZDb21wb25lbnQgfHwgcHJldlByb3BzICE9PSB0aGlzLnByb3BzKSB7XG4gICAgICAgIHRoaXMuX2RldGFjaE5hdGl2ZUV2ZW50cygpO1xuICAgICAgICB0aGlzLl9hdHRhY2hOYXRpdmVFdmVudHMoKTtcbiAgICAgIH1cbiAgICAgIHRoaXMuX21hcmtVcGRhdGVDb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xuICAgICAgdGhpcy5fcHJvcHNBbmltYXRlZCAmJiB0aGlzLl9wcm9wc0FuaW1hdGVkLl9fZGV0YWNoKCk7XG4gICAgICB0aGlzLl9kZXRhY2hOYXRpdmVFdmVudHMoKTtcbiAgICAgIHRoaXMuX21hcmtVcGRhdGVDb21wbGV0ZSgpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBSZWFjdC5mb3J3YXJkUmVmKGZ1bmN0aW9uIEFuaW1hdGVkQ29tcG9uZW50V3JhcHBlcihwcm9wcywgcmVmKSB7XG4gICAgcmV0dXJuIChcbiAgICAgIDxBbmltYXRlZENvbXBvbmVudFxuICAgICAgICB7Li4ucHJvcHN9XG4gICAgICAgIHsuLi4ocmVmID09IG51bGwgPyBudWxsIDoge2ZvcndhcmRlZFJlZjogcmVmfSl9XG4gICAgICAvPlxuICAgICk7XG4gIH0pO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IGNyZWF0ZUFuaW1hdGVkQ29tcG9uZW50O1xuIl19