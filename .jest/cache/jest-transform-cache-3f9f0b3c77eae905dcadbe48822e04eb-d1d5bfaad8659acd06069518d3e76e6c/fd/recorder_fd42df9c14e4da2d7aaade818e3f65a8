cd89acc8bbde8db00e18eb89ee5609fd
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var debug = require('debug')('nock.recorder');

var querystring = require('querystring');

var _require = require('util'),
    inspect = _require.inspect;

var common = require("./common");

var _require2 = require("./intercept"),
    restoreOverriddenClientRequest = _require2.restoreOverriddenClientRequest;

var SEPARATOR = '\n<<<<<<-- cut here -->>>>>>\n';
var recordingInProgress = false;
var _outputs = [];

function getScope(options) {
  var _common$normalizeRequ = common.normalizeRequestOptions(options),
      proto = _common$normalizeRequ.proto,
      host = _common$normalizeRequ.host,
      port = _common$normalizeRequ.port;

  return common.normalizeOrigin(proto, host, port);
}

function getMethod(options) {
  return options.method || 'GET';
}

function getBodyFromChunks(chunks, headers) {
  if (headers && common.isContentEncoded(headers)) {
    return {
      body: chunks.map(function (chunk) {
        return chunk.toString('hex');
      })
    };
  }

  var mergedBuffer = Buffer.concat(chunks);
  var isUtf8Representable = common.isUtf8Representable(mergedBuffer);

  if (isUtf8Representable) {
    var maybeStringifiedJson = mergedBuffer.toString('utf8');

    try {
      return {
        isUtf8Representable: isUtf8Representable,
        body: JSON.parse(maybeStringifiedJson)
      };
    } catch (err) {
      return {
        isUtf8Representable: isUtf8Representable,
        body: maybeStringifiedJson
      };
    }
  } else {
    return {
      isUtf8Representable: isUtf8Representable,
      body: mergedBuffer.toString('hex')
    };
  }
}

function generateRequestAndResponseObject(_ref) {
  var req = _ref.req,
      bodyChunks = _ref.bodyChunks,
      options = _ref.options,
      res = _ref.res,
      dataChunks = _ref.dataChunks,
      reqheaders = _ref.reqheaders;

  var _getBodyFromChunks = getBodyFromChunks(dataChunks, res.headers),
      body = _getBodyFromChunks.body,
      isUtf8Representable = _getBodyFromChunks.isUtf8Representable;

  options.path = req.path;
  return {
    scope: getScope(options),
    method: getMethod(options),
    path: options.path,
    body: getBodyFromChunks(bodyChunks).body,
    status: res.statusCode,
    response: body,
    rawHeaders: res.rawHeaders,
    reqheaders: reqheaders || undefined,
    responseIsBinary: isUtf8Representable === false
  };
}

function generateRequestAndResponse(_ref2) {
  var req = _ref2.req,
      bodyChunks = _ref2.bodyChunks,
      options = _ref2.options,
      res = _ref2.res,
      dataChunks = _ref2.dataChunks,
      reqheaders = _ref2.reqheaders;
  var requestBody = getBodyFromChunks(bodyChunks).body;
  var responseBody = getBodyFromChunks(dataChunks, res.headers).body;
  var path = options.path;
  var queryIndex = req.path.indexOf('?');
  var queryObj = {};

  if (queryIndex !== -1) {
    path = path.substring(0, queryIndex);
    var queryStr = req.path.slice(queryIndex + 1);
    queryObj = querystring.parse(queryStr);
  }

  path = path.replace(/'/g, "\\'");
  var encodedQueryObj = {};

  for (var key in queryObj) {
    var formattedPair = common.formatQueryValue(key, queryObj[key], common.percentEncode);
    encodedQueryObj[formattedPair[0]] = formattedPair[1];
  }

  var lines = [];
  lines.push('');
  var scope = getScope(options);
  lines.push("nock('" + scope + "', {\"encodedQueryParams\":true})");
  var methodName = getMethod(options).toLowerCase();

  if (requestBody) {
    lines.push("  ." + methodName + "('" + path + "', " + JSON.stringify(requestBody) + ")");
  } else {
    lines.push("  ." + methodName + "('" + path + "')");
  }

  Object.entries(reqheaders || {}).forEach(function (_ref3) {
    var _ref4 = (0, _slicedToArray2.default)(_ref3, 2),
        fieldName = _ref4[0],
        fieldValue = _ref4[1];

    var safeName = JSON.stringify(fieldName);
    var safeValue = JSON.stringify(fieldValue);
    lines.push("  .matchHeader(" + safeName + ", " + safeValue + ")");
  });

  if (queryIndex !== -1) {
    lines.push("  .query(" + JSON.stringify(encodedQueryObj) + ")");
  }

  var statusCode = res.statusCode.toString();
  var stringifiedResponseBody = JSON.stringify(responseBody);
  var headers = inspect(res.rawHeaders);
  lines.push("  .reply(" + statusCode + ", " + stringifiedResponseBody + ", " + headers + ");");
  return lines.join('\n');
}

var currentRecordingId = 0;
var defaultRecordOptions = {
  dont_print: false,
  enable_reqheaders_recording: false,
  logging: console.log,
  output_objects: false,
  use_separator: true
};

function record(recOptions) {
  if (recordingInProgress) {
    throw new Error('Nock recording already in progress');
  }

  recordingInProgress = true;
  currentRecordingId = currentRecordingId + 1;
  var thisRecordingId = currentRecordingId;

  if (typeof recOptions === 'boolean') {
    recOptions = {
      dont_print: recOptions
    };
  }

  recOptions = (0, _extends2.default)({}, defaultRecordOptions, recOptions);
  debug('start recording', thisRecordingId, recOptions);
  var _recOptions = recOptions,
      dontPrint = _recOptions.dont_print,
      enableReqHeadersRecording = _recOptions.enable_reqheaders_recording,
      logging = _recOptions.logging,
      outputObjects = _recOptions.output_objects,
      useSeparator = _recOptions.use_separator;
  debug(thisRecordingId, 'restoring overridden requests before new overrides');
  common.restoreOverriddenRequests();
  restoreOverriddenClientRequest();
  common.overrideRequests(function (proto, overriddenRequest, rawArgs) {
    var _common$normalizeClie = common.normalizeClientRequestArgs.apply(common, (0, _toConsumableArray2.default)(rawArgs)),
        options = _common$normalizeClie.options,
        callback = _common$normalizeClie.callback;

    var bodyChunks = [];

    if (options._recording) {
      return overriddenRequest(options, callback);
    }

    options._recording = true;
    var req = overriddenRequest(options, function (res) {
      debug(thisRecordingId, 'intercepting', proto, 'request to record');
      res.once('end', function () {
        debug(thisRecordingId, proto, 'intercepted request ended');
        var reqheaders;

        if (enableReqHeadersRecording) {
          reqheaders = req.getHeaders();
          common.deleteHeadersField(reqheaders, 'user-agent');
        }

        var generateFn = outputObjects ? generateRequestAndResponseObject : generateRequestAndResponse;
        var out = generateFn({
          req: req,
          bodyChunks: bodyChunks,
          options: options,
          res: res,
          dataChunks: dataChunks,
          reqheaders: reqheaders
        });
        debug('out:', out);

        if (thisRecordingId !== currentRecordingId) {
          debug('skipping recording of an out-of-order request', out);
          return;
        }

        _outputs.push(out);

        if (!dontPrint) {
          if (useSeparator) {
            if (typeof out !== 'string') {
              out = JSON.stringify(out, null, 2);
            }

            logging(SEPARATOR + out + SEPARATOR);
          } else {
            logging(out);
          }
        }
      });
      var encoding;
      var setEncoding = res.setEncoding;

      res.setEncoding = function (newEncoding) {
        encoding = newEncoding;
        return setEncoding.apply(this, arguments);
      };

      var dataChunks = [];
      var origResPush = res.push;

      res.push = function (data) {
        if (data) {
          if (encoding) {
            data = Buffer.from(data, encoding);
          }

          dataChunks.push(data);
        }

        return origResPush.call(res, data);
      };

      if (callback) {
        callback(res, options, callback);
      }

      debug('finished setting up intercepting');

      if (proto === 'https') {
        options.proto = 'https';
      }
    });

    var recordChunk = function recordChunk(chunk, encoding) {
      debug(thisRecordingId, 'new', proto, 'body chunk');

      if (!Buffer.isBuffer(chunk)) {
        chunk = Buffer.from(chunk, encoding);
      }

      bodyChunks.push(chunk);
    };

    var oldWrite = req.write;

    req.write = function (chunk, encoding) {
      if (typeof chunk !== 'undefined') {
        recordChunk(chunk, encoding);
        oldWrite.apply(req, arguments);
      } else {
        throw new Error('Data was undefined.');
      }
    };

    var oldEnd = req.end;

    req.end = function (chunk, encoding, callback) {
      debug('req.end');

      if (typeof chunk === 'function') {
        callback = chunk;
        chunk = null;
      } else if (typeof encoding === 'function') {
        callback = encoding;
        encoding = null;
      }

      if (chunk) {
        recordChunk(chunk, encoding);
      }

      oldEnd.call(req, chunk, encoding, callback);
    };

    return req;
  });
}

function restore() {
  debug(currentRecordingId, 'restoring all the overridden http/https properties');
  common.restoreOverriddenRequests();
  restoreOverriddenClientRequest();
  recordingInProgress = false;
}

function clear() {
  _outputs = [];
}

module.exports = {
  record: record,
  outputs: function outputs() {
    return _outputs;
  },
  restore: restore,
  clear: clear
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlY29yZGVyLmpzIl0sIm5hbWVzIjpbImRlYnVnIiwicmVxdWlyZSIsInF1ZXJ5c3RyaW5nIiwiaW5zcGVjdCIsImNvbW1vbiIsInJlc3RvcmVPdmVycmlkZGVuQ2xpZW50UmVxdWVzdCIsIlNFUEFSQVRPUiIsInJlY29yZGluZ0luUHJvZ3Jlc3MiLCJvdXRwdXRzIiwiZ2V0U2NvcGUiLCJvcHRpb25zIiwibm9ybWFsaXplUmVxdWVzdE9wdGlvbnMiLCJwcm90byIsImhvc3QiLCJwb3J0Iiwibm9ybWFsaXplT3JpZ2luIiwiZ2V0TWV0aG9kIiwibWV0aG9kIiwiZ2V0Qm9keUZyb21DaHVua3MiLCJjaHVua3MiLCJoZWFkZXJzIiwiaXNDb250ZW50RW5jb2RlZCIsImJvZHkiLCJtYXAiLCJjaHVuayIsInRvU3RyaW5nIiwibWVyZ2VkQnVmZmVyIiwiQnVmZmVyIiwiY29uY2F0IiwiaXNVdGY4UmVwcmVzZW50YWJsZSIsIm1heWJlU3RyaW5naWZpZWRKc29uIiwiSlNPTiIsInBhcnNlIiwiZXJyIiwiZ2VuZXJhdGVSZXF1ZXN0QW5kUmVzcG9uc2VPYmplY3QiLCJyZXEiLCJib2R5Q2h1bmtzIiwicmVzIiwiZGF0YUNodW5rcyIsInJlcWhlYWRlcnMiLCJwYXRoIiwic2NvcGUiLCJzdGF0dXMiLCJzdGF0dXNDb2RlIiwicmVzcG9uc2UiLCJyYXdIZWFkZXJzIiwidW5kZWZpbmVkIiwicmVzcG9uc2VJc0JpbmFyeSIsImdlbmVyYXRlUmVxdWVzdEFuZFJlc3BvbnNlIiwicmVxdWVzdEJvZHkiLCJyZXNwb25zZUJvZHkiLCJxdWVyeUluZGV4IiwiaW5kZXhPZiIsInF1ZXJ5T2JqIiwic3Vic3RyaW5nIiwicXVlcnlTdHIiLCJzbGljZSIsInJlcGxhY2UiLCJlbmNvZGVkUXVlcnlPYmoiLCJrZXkiLCJmb3JtYXR0ZWRQYWlyIiwiZm9ybWF0UXVlcnlWYWx1ZSIsInBlcmNlbnRFbmNvZGUiLCJsaW5lcyIsInB1c2giLCJtZXRob2ROYW1lIiwidG9Mb3dlckNhc2UiLCJzdHJpbmdpZnkiLCJPYmplY3QiLCJlbnRyaWVzIiwiZm9yRWFjaCIsImZpZWxkTmFtZSIsImZpZWxkVmFsdWUiLCJzYWZlTmFtZSIsInNhZmVWYWx1ZSIsInN0cmluZ2lmaWVkUmVzcG9uc2VCb2R5Iiwiam9pbiIsImN1cnJlbnRSZWNvcmRpbmdJZCIsImRlZmF1bHRSZWNvcmRPcHRpb25zIiwiZG9udF9wcmludCIsImVuYWJsZV9yZXFoZWFkZXJzX3JlY29yZGluZyIsImxvZ2dpbmciLCJjb25zb2xlIiwibG9nIiwib3V0cHV0X29iamVjdHMiLCJ1c2Vfc2VwYXJhdG9yIiwicmVjb3JkIiwicmVjT3B0aW9ucyIsIkVycm9yIiwidGhpc1JlY29yZGluZ0lkIiwiZG9udFByaW50IiwiZW5hYmxlUmVxSGVhZGVyc1JlY29yZGluZyIsIm91dHB1dE9iamVjdHMiLCJ1c2VTZXBhcmF0b3IiLCJyZXN0b3JlT3ZlcnJpZGRlblJlcXVlc3RzIiwib3ZlcnJpZGVSZXF1ZXN0cyIsIm92ZXJyaWRkZW5SZXF1ZXN0IiwicmF3QXJncyIsIm5vcm1hbGl6ZUNsaWVudFJlcXVlc3RBcmdzIiwiY2FsbGJhY2siLCJfcmVjb3JkaW5nIiwib25jZSIsImdldEhlYWRlcnMiLCJkZWxldGVIZWFkZXJzRmllbGQiLCJnZW5lcmF0ZUZuIiwib3V0IiwiZW5jb2RpbmciLCJzZXRFbmNvZGluZyIsIm5ld0VuY29kaW5nIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJvcmlnUmVzUHVzaCIsImRhdGEiLCJmcm9tIiwiY2FsbCIsInJlY29yZENodW5rIiwiaXNCdWZmZXIiLCJvbGRXcml0ZSIsIndyaXRlIiwib2xkRW5kIiwiZW5kIiwicmVzdG9yZSIsImNsZWFyIiwibW9kdWxlIiwiZXhwb3J0cyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7QUFFQSxJQUFNQSxLQUFLLEdBQUdDLE9BQU8sQ0FBQyxPQUFELENBQVAsQ0FBaUIsZUFBakIsQ0FBZDs7QUFDQSxJQUFNQyxXQUFXLEdBQUdELE9BQU8sQ0FBQyxhQUFELENBQTNCOztB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QUFDQyxPQUFQLEdBQWlCO0FBQ2Z0QyxFQUFBQSxNQUFNLEVBQU5BLE1BRGU7QUFFZjlFLEVBQUFBLE9BQU8sRUFBRTtBQUFBLFdBQU1BLFFBQU47QUFBQSxHQUZNO0FBR2ZpSCxFQUFBQSxPQUFPLEVBQVBBLE9BSGU7QUFJZkMsRUFBQUEsS0FBSyxFQUFMQTtBQUplLENBQWpCIiwic291cmNlc0NvbnRlbnQiOlsiJ3VzZSBzdHJpY3QnXG5cbmNvbnN0IGRlYnVnID0gcmVxdWlyZSgnZGVidWcnKSgnbm9jay5yZWNvcmRlcicpXG5jb25zdCBxdWVyeXN0cmluZyA9IHJlcXVpcmUoJ3F1ZXJ5c3RyaW5nJylcbmNvbnN0IHsgaW5zcGVjdCB9ID0gcmVxdWlyZSgndXRpbCcpXG5cbmNvbnN0IGNvbW1vbiA9IHJlcXVpcmUoJy4vY29tbW9uJylcbmNvbnN0IHsgcmVzdG9yZU92ZXJyaWRkZW5DbGllbnRSZXF1ZXN0IH0gPSByZXF1aXJlKCcuL2ludGVyY2VwdCcpXG5cbmNvbnN0IFNFUEFSQVRPUiA9ICdcXG48PDw8PDwtLSBjdXQgaGVyZSAtLT4+Pj4+PlxcbidcbmxldCByZWNvcmRpbmdJblByb2dyZXNzID0gZmFsc2VcbmxldCBvdXRwdXRzID0gW11cblxuZnVuY3Rpb24gZ2V0U2NvcGUob3B0aW9ucykge1xuICBjb25zdCB7IHByb3RvLCBob3N0LCBwb3J0IH0gPSBjb21tb24ubm9ybWFsaXplUmVxdWVzdE9wdGlvbnMob3B0aW9ucylcbiAgcmV0dXJuIGNvbW1vbi5ub3JtYWxpemVPcmlnaW4ocHJvdG8sIGhvc3QsIHBvcnQpXG59XG5cbmZ1bmN0aW9uIGdldE1ldGhvZChvcHRpb25zKSB7XG4gIHJldHVybiBvcHRpb25zLm1ldGhvZCB8fCAnR0VUJ1xufVxuXG5mdW5jdGlvbiBnZXRCb2R5RnJvbUNodW5rcyhjaHVua3MsIGhlYWRlcnMpIHtcbiAgLy8gSWYgd2UgaGF2ZSBoZWFkZXJzIGFuZCB0aGVyZSBpcyBjb250ZW50LWVuY29kaW5nIGl0IG1lYW5zIHRoYXQgdGhlIGJvZHlcbiAgLy8gc2hvdWxkbid0IGJlIG1lcmdlZCBidXQgaW5zdGVhZCBwZXJzaXN0ZWQgYXMgYW4gYXJyYXkgb2YgaGV4IHN0cmluZ3Mgc29cbiAgLy8gdGhhdCB0aGUgcmVzcG9uc2UgY2h1bmtzIGNhbiBiZSBtb2NrZWQgb25lIGJ5IG9uZS5cbiAgaWYgKGhlYWRlcnMgJiYgY29tbW9uLmlzQ29udGVudEVuY29kZWQoaGVhZGVycykpIHtcbiAgICByZXR1cm4ge1xuICAgICAgYm9keTogY2h1bmtzLm1hcChjaHVuayA9PiBjaHVuay50b1N0cmluZygnaGV4JykpLFxuICAgIH1cbiAgfVxuXG4gIGNvbnN0IG1lcmdlZEJ1ZmZlciA9IEJ1ZmZlci5jb25jYXQoY2h1bmtzKVxuXG4gIC8vIFRoZSBtZXJnZWQgYnVmZmVyIGNhbiBiZSBvbmUgb2YgdGhyZWUgdGhpbmdzOlxuICAvLyAxLiBBIFVURi04LXJlcHJlc2VudGFibGUgc3RyaW5nIGJ1ZmZlciB3aGljaCByZXByZXNlbnRzIGEgSlNPTiBvYmplY3QuXG4gIC8vIDIuIEEgVVRGLTgtcmVwcmVzZW50YWJsZSBidWZmZXIgd2hpY2ggZG9lc24ndCByZXByZXNlbnQgYSBKU09OIG9iamVjdC5cbiAgLy8gMy4gQSBub24tVVRGLTgtcmVwcmVzZW50YWJsZSBidWZmZXIgd2hpY2ggdGhlbiBoYXMgdG8gYmUgcmVjb3JkZWQgYXMgYSBoZXggc3RyaW5nLlxuICBjb25zdCBpc1V0ZjhSZXByZXNlbnRhYmxlID0gY29tbW9uLmlzVXRmOFJlcHJlc2VudGFibGUobWVyZ2VkQnVmZmVyKVxuICBpZiAoaXNVdGY4UmVwcmVzZW50YWJsZSkge1xuICAgIGNvbnN0IG1heWJlU3RyaW5naWZpZWRKc29uID0gbWVyZ2VkQnVmZmVyLnRvU3RyaW5nKCd1dGY4JylcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgaXNVdGY4UmVwcmVzZW50YWJsZSxcbiAgICAgICAgYm9keTogSlNPTi5wYXJzZShtYXliZVN0cmluZ2lmaWVkSnNvbiksXG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpc1V0ZjhSZXByZXNlbnRhYmxlLFxuICAgICAgICBib2R5OiBtYXliZVN0cmluZ2lmaWVkSnNvbixcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGlzVXRmOFJlcHJlc2VudGFibGUsXG4gICAgICBib2R5OiBtZXJnZWRCdWZmZXIudG9TdHJpbmcoJ2hleCcpLFxuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBnZW5lcmF0ZVJlcXVlc3RBbmRSZXNwb25zZU9iamVjdCh7XG4gIHJlcSxcbiAgYm9keUNodW5rcyxcbiAgb3B0aW9ucyxcbiAgcmVzLFxuICBkYXRhQ2h1bmtzLFxuICByZXFoZWFkZXJzLFxufSkge1xuICBjb25zdCB7IGJvZHksIGlzVXRmOFJlcHJlc2VudGFibGUgfSA9IGdldEJvZHlGcm9tQ2h1bmtzKFxuICAgIGRhdGFDaHVua3MsXG4gICAgcmVzLmhlYWRlcnNcbiAgKVxuICBvcHRpb25zLnBhdGggPSByZXEucGF0aFxuXG4gIHJldHVybiB7XG4gICAgc2NvcGU6IGdldFNjb3BlKG9wdGlvbnMpLFxuICAgIG1ldGhvZDogZ2V0TWV0aG9kKG9wdGlvbnMpLFxuICAgIHBhdGg6IG9wdGlvbnMucGF0aCxcbiAgICAvLyBJcyBpdCBkZWxpYmVyYXRlIHRoYXQgYGdldEJvZHlGcm9tQ2h1bmtzKClgIGlzIGNhbGxlZCBhIHNlY29uZCB0aW1lP1xuICAgIGJvZHk6IGdldEJvZHlGcm9tQ2h1bmtzKGJvZHlDaHVua3MpLmJvZHksXG4gICAgc3RhdHVzOiByZXMuc3RhdHVzQ29kZSxcbiAgICByZXNwb25zZTogYm9keSxcbiAgICByYXdIZWFkZXJzOiByZXMucmF3SGVhZGVycyxcbiAgICByZXFoZWFkZXJzOiByZXFoZWFkZXJzIHx8IHVuZGVmaW5lZCxcbiAgICAvLyBXaGVuIGNvbnRlbnQtZW5jb2RpbmcgaXMgZW5hYmxlZCwgaXNVdGY4UmVwcmVzZW50YWJsZSBpcyBgdW5kZWZpbmVkYCxcbiAgICAvLyBzbyB3ZSBleHBsaWNpdGx5IGNoZWNrIGZvciBgZmFsc2VgLlxuICAgIHJlc3BvbnNlSXNCaW5hcnk6IGlzVXRmOFJlcHJlc2VudGFibGUgPT09IGZhbHNlLFxuICB9XG59XG5cbmZ1bmN0aW9uIGdlbmVyYXRlUmVxdWVzdEFuZFJlc3BvbnNlKHtcbiAgcmVxLFxuICBib2R5Q2h1bmtzLFxuICBvcHRpb25zLFxuICByZXMsXG4gIGRhdGFDaHVua3MsXG4gIHJlcWhlYWRlcnMsXG59KSB7XG4gIGNvbnN0IHJlcXVlc3RCb2R5ID0gZ2V0Qm9keUZyb21DaHVua3MoYm9keUNodW5rcykuYm9keVxuICBjb25zdCByZXNwb25zZUJvZHkgPSBnZXRCb2R5RnJvbUNodW5rcyhkYXRhQ2h1bmtzLCByZXMuaGVhZGVycykuYm9keVxuXG4gIC8vIFJlbW92ZSBhbnkgcXVlcnkgcGFyYW1zIGZyb20gb3B0aW9ucy5wYXRoIHNvIHRoZXkgY2FuIGJlIGFkZGVkIGluIHRoZSBxdWVyeSgpIGZ1bmN0aW9uXG4gIGxldCB7IHBhdGggfSA9IG9wdGlvbnNcbiAgY29uc3QgcXVlcnlJbmRleCA9IHJlcS5wYXRoLmluZGV4T2YoJz8nKVxuICBsZXQgcXVlcnlPYmogPSB7fVxuICBpZiAocXVlcnlJbmRleCAhPT0gLTEpIHtcbiAgICAvLyBSZW1vdmUgdGhlIHF1ZXJ5IGZyb20gdGhlIHBhdGhcbiAgICBwYXRoID0gcGF0aC5zdWJzdHJpbmcoMCwgcXVlcnlJbmRleClcblxuICAgIGNvbnN0IHF1ZXJ5U3RyID0gcmVxLnBhdGguc2xpY2UocXVlcnlJbmRleCArIDEpXG4gICAgcXVlcnlPYmogPSBxdWVyeXN0cmluZy5wYXJzZShxdWVyeVN0cilcbiAgfVxuXG4gIC8vIEVzY2FwZSBhbnkgc2luZ2xlIHF1b3RlcyBpbiB0aGUgcGF0aCBhcyB0aGUgb3V0cHV0IHVzZXMgdGhlbVxuICBwYXRoID0gcGF0aC5yZXBsYWNlKC8nL2csIGBcXFxcJ2ApXG5cbiAgLy8gQWx3YXlzIGVuY29kZSB0aGUgcXVlcnkgcGFyYW1ldGVycyB3aGVuIHJlY29yZGluZy5cbiAgY29uc3QgZW5jb2RlZFF1ZXJ5T2JqID0ge31cbiAgZm9yIChjb25zdCBrZXkgaW4gcXVlcnlPYmopIHtcbiAgICBjb25zdCBmb3JtYXR0ZWRQYWlyID0gY29tbW9uLmZvcm1hdFF1ZXJ5VmFsdWUoXG4gICAgICBrZXksXG4gICAgICBxdWVyeU9ialtrZXldLFxuICAgICAgY29tbW9uLnBlcmNlbnRFbmNvZGVcbiAgICApXG4gICAgZW5jb2RlZFF1ZXJ5T2JqW2Zvcm1hdHRlZFBhaXJbMF1dID0gZm9ybWF0dGVkUGFpclsxXVxuICB9XG5cbiAgY29uc3QgbGluZXMgPSBbXVxuXG4gIC8vIFdlIHdhbnQgYSBsZWFkaW5nIG5ld2xpbmUuXG4gIGxpbmVzLnB1c2goJycpXG5cbiAgY29uc3Qgc2NvcGUgPSBnZXRTY29wZShvcHRpb25zKVxuICBsaW5lcy5wdXNoKGBub2NrKCcke3Njb3BlfScsIHtcImVuY29kZWRRdWVyeVBhcmFtc1wiOnRydWV9KWApXG5cbiAgY29uc3QgbWV0aG9kTmFtZSA9IGdldE1ldGhvZChvcHRpb25zKS50b0xvd2VyQ2FzZSgpXG4gIGlmIChyZXF1ZXN0Qm9keSkge1xuICAgIGxpbmVzLnB1c2goYCAgLiR7bWV0aG9kTmFtZX0oJyR7cGF0aH0nLCAke0pTT04uc3RyaW5naWZ5KHJlcXVlc3RCb2R5KX0pYClcbiAgfSBlbHNlIHtcbiAgICBsaW5lcy5wdXNoKGAgIC4ke21ldGhvZE5hbWV9KCcke3BhdGh9JylgKVxuICB9XG5cbiAgT2JqZWN0LmVudHJpZXMocmVxaGVhZGVycyB8fCB7fSkuZm9yRWFjaCgoW2ZpZWxkTmFtZSwgZmllbGRWYWx1ZV0pID0+IHtcbiAgICBjb25zdCBzYWZlTmFtZSA9IEpTT04uc3RyaW5naWZ5KGZpZWxkTmFtZSlcbiAgICBjb25zdCBzYWZlVmFsdWUgPSBKU09OLnN0cmluZ2lmeShmaWVsZFZhbHVlKVxuICAgIGxpbmVzLnB1c2goYCAgLm1hdGNoSGVhZGVyKCR7c2FmZU5hbWV9LCAke3NhZmVWYWx1ZX0pYClcbiAgfSlcblxuICBpZiAocXVlcnlJbmRleCAhPT0gLTEpIHtcbiAgICBsaW5lcy5wdXNoKGAgIC5xdWVyeSgke0pTT04uc3RyaW5naWZ5KGVuY29kZWRRdWVyeU9iail9KWApXG4gIH1cblxuICBjb25zdCBzdGF0dXNDb2RlID0gcmVzLnN0YXR1c0NvZGUudG9TdHJpbmcoKVxuICBjb25zdCBzdHJpbmdpZmllZFJlc3BvbnNlQm9keSA9IEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlQm9keSlcbiAgY29uc3QgaGVhZGVycyA9IGluc3BlY3QocmVzLnJhd0hlYWRlcnMpXG4gIGxpbmVzLnB1c2goYCAgLnJlcGx5KCR7c3RhdHVzQ29kZX0sICR7c3RyaW5naWZpZWRSZXNwb25zZUJvZHl9LCAke2hlYWRlcnN9KTtgKVxuXG4gIHJldHVybiBsaW5lcy5qb2luKCdcXG4nKVxufVxuXG4vLyAgVGhpcyBtb2R1bGUgdmFyaWFibGUgaXMgdXNlZCB0byBpZGVudGlmeSBhIHVuaXF1ZSByZWNvcmRpbmcgSUQgaW4gb3JkZXIgdG8gc2tpcFxuLy8gIHNwdXJpb3VzIHJlcXVlc3RzIHRoYXQgc29tZXRpbWVzIGhhcHBlbi4gVGhpcyBwcm9ibGVtIGhhcyBiZWVuLCBzbyBmYXIsXG4vLyAgZXhjbHVzaXZlbHkgZGV0ZWN0ZWQgaW4gbm9jaydzIHVuaXQgdGVzdGluZyB3aGVyZSAnY2hlY2tzIGlmIGNhbGxiYWNrIGlzIHNwZWNpZmllZCdcbi8vICBpbnRlcmZlcmVzIHdpdGggb3RoZXIgdGVzdHMgYXMgaXRzIHQuZW5kKCkgaXMgaW52b2tlZCB3aXRob3V0IHdhaXRpbmcgZm9yIHJlcXVlc3Rcbi8vICB0byBmaW5pc2ggKHdoaWNoIGlzIHRoZSBwb2ludCBvZiB0aGUgdGVzdCkuXG5sZXQgY3VycmVudFJlY29yZGluZ0lkID0gMFxuXG5jb25zdCBkZWZhdWx0UmVjb3JkT3B0aW9ucyA9IHtcbiAgZG9udF9wcmludDogZmFsc2UsXG4gIGVuYWJsZV9yZXFoZWFkZXJzX3JlY29yZGluZzogZmFsc2UsXG4gIGxvZ2dpbmc6IGNvbnNvbGUubG9nLFxuICBvdXRwdXRfb2JqZWN0czogZmFsc2UsXG4gIHVzZV9zZXBhcmF0b3I6IHRydWUsXG59XG5cbmZ1bmN0aW9uIHJlY29yZChyZWNPcHRpb25zKSB7XG4gIC8vICBUcnlpbmcgdG8gc3RhcnQgcmVjb3JkaW5nIHdpdGggcmVjb3JkaW5nIGFscmVhZHkgaW4gcHJvZ3Jlc3MgaW1wbGllcyBhbiBlcnJvclxuICAvLyAgaW4gdGhlIHJlY29yZGluZyBjb25maWd1cmF0aW9uIChkb3VibGUgcmVjb3JkaW5nIG1ha2VzIG5vIHNlbnNlIGFuZCB1c2VkIHRvIGxlYWRcbiAgLy8gIHRvIGR1cGxpY2F0ZXMgaW4gb3V0cHV0KVxuICBpZiAocmVjb3JkaW5nSW5Qcm9ncmVzcykge1xuICAgIHRocm93IG5ldyBFcnJvcignTm9jayByZWNvcmRpbmcgYWxyZWFkeSBpbiBwcm9ncmVzcycpXG4gIH1cblxuICByZWNvcmRpbmdJblByb2dyZXNzID0gdHJ1ZVxuXG4gIC8vIFNldCB0aGUgbmV3IGN1cnJlbnQgcmVjb3JkaW5nIElEIGFuZCBjYXB0dXJlIGl0cyB2YWx1ZSBpbiB0aGlzIGluc3RhbmNlIG9mIHJlY29yZCgpLlxuICBjdXJyZW50UmVjb3JkaW5nSWQgPSBjdXJyZW50UmVjb3JkaW5nSWQgKyAxXG4gIGNvbnN0IHRoaXNSZWNvcmRpbmdJZCA9IGN1cnJlbnRSZWNvcmRpbmdJZFxuXG4gIC8vIE9yaWdpbmFsbHkgdGhlIHBhcmFtZXRlciB3YXMgYSBkb250X3ByaW50IGJvb2xlYW4gZmxhZy5cbiAgLy8gVG8ga2VlcCB0aGUgZXhpc3RpbmcgY29kZSBjb21wYXRpYmxlIHdlIHRha2UgdGhhdCBjYXNlIGludG8gYWNjb3VudC5cbiAgaWYgKHR5cGVvZiByZWNPcHRpb25zID09PSAnYm9vbGVhbicpIHtcbiAgICByZWNPcHRpb25zID0geyBkb250X3ByaW50OiByZWNPcHRpb25zIH1cbiAgfVxuXG4gIHJlY09wdGlvbnMgPSB7IC4uLmRlZmF1bHRSZWNvcmRPcHRpb25zLCAuLi5yZWNPcHRpb25zIH1cblxuICBkZWJ1Zygnc3RhcnQgcmVjb3JkaW5nJywgdGhpc1JlY29yZGluZ0lkLCByZWNPcHRpb25zKVxuXG4gIGNvbnN0IHtcbiAgICBkb250X3ByaW50OiBkb250UHJpbnQsXG4gICAgZW5hYmxlX3JlcWhlYWRlcnNfcmVjb3JkaW5nOiBlbmFibGVSZXFIZWFkZXJzUmVjb3JkaW5nLFxuICAgIGxvZ2dpbmcsXG4gICAgb3V0cHV0X29iamVjdHM6IG91dHB1dE9iamVjdHMsXG4gICAgdXNlX3NlcGFyYXRvcjogdXNlU2VwYXJhdG9yLFxuICB9ID0gcmVjT3B0aW9uc1xuXG4gIGRlYnVnKHRoaXNSZWNvcmRpbmdJZCwgJ3Jlc3RvcmluZyBvdmVycmlkZGVuIHJlcXVlc3RzIGJlZm9yZSBuZXcgb3ZlcnJpZGVzJylcbiAgLy8gIFRvIHByZXNlcnZlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgKHN0YXJ0aW5nIHJlY29yZGluZyB3YXNuJ3QgdGhyb3dpbmcgaWYgbm9jayB3YXMgYWxyZWFkeSBhY3RpdmUpXG4gIC8vICB3ZSByZXN0b3JlIGFueSByZXF1ZXN0cyB0aGF0IG1heSBoYXZlIGJlZW4gb3ZlcnJpZGRlbiBieSBvdGhlciBwYXJ0cyBvZiBub2NrIChlLmcuIGludGVyY2VwdClcbiAgLy8gIE5PVEU6IFRoaXMgaXMgaGFja3kgYXMgaGVsbCBidXQgaXQga2VlcHMgdGhlIGJhY2t3YXJkIGNvbXBhdGliaWxpdHkgKmFuZCogYWxsb3dzIGNvcnJlY3RcbiAgLy8gICAgYmVoYXZpb3IgaW4gdGhlIGZhY2Ugb2Ygb3RoZXIgbW9kdWxlcyBhbHNvIG92ZXJyaWRpbmcgQ2xpZW50UmVxdWVzdC5cbiAgY29tbW9uLnJlc3RvcmVPdmVycmlkZGVuUmVxdWVzdHMoKVxuICAvLyAgV2UgcmVzdG9yZSBDbGllbnRSZXF1ZXN0IGFzIGl0IG1lc3NlcyB3aXRoIHJlY29yZGluZyBvZiBtb2R1bGVzIHRoYXQgYWxzbyBvdmVycmlkZSBDbGllbnRSZXF1ZXN0IChlLmcuIHhocjIpXG4gIHJlc3RvcmVPdmVycmlkZGVuQ2xpZW50UmVxdWVzdCgpXG5cbiAgLy8gIFdlIG92ZXJyaWRlIHRoZSByZXF1ZXN0cyBzbyB0aGF0IHdlIGNhbiBzYXZlIGluZm9ybWF0aW9uIG9uIHRoZW0gYmVmb3JlIGV4ZWN1dGluZy5cbiAgY29tbW9uLm92ZXJyaWRlUmVxdWVzdHMoZnVuY3Rpb24gKHByb3RvLCBvdmVycmlkZGVuUmVxdWVzdCwgcmF3QXJncykge1xuICAgIGNvbnN0IHsgb3B0aW9ucywgY2FsbGJhY2sgfSA9IGNvbW1vbi5ub3JtYWxpemVDbGllbnRSZXF1ZXN0QXJncyguLi5yYXdBcmdzKVxuICAgIGNvbnN0IGJvZHlDaHVua3MgPSBbXVxuXG4gICAgLy8gTm9kZSAwLjExIGh0dHBzLnJlcXVlc3QgY2FsbHMgaHR0cC5yZXF1ZXN0IC0tIGRvbid0IHdhbnQgdG8gcmVjb3JkIHRoaW5nc1xuICAgIC8vIHR3aWNlLlxuICAgIC8qIGlzdGFuYnVsIGlnbm9yZSBpZiAqL1xuICAgIGlmIChvcHRpb25zLl9yZWNvcmRpbmcpIHtcbiAgICAgIHJldHVybiBvdmVycmlkZGVuUmVxdWVzdChvcHRpb25zLCBjYWxsYmFjaylcbiAgICB9XG4gICAgb3B0aW9ucy5fcmVjb3JkaW5nID0gdHJ1ZVxuXG4gICAgY29uc3QgcmVxID0gb3ZlcnJpZGRlblJlcXVlc3Qob3B0aW9ucywgZnVuY3Rpb24gKHJlcykge1xuICAgICAgZGVidWcodGhpc1JlY29yZGluZ0lkLCAnaW50ZXJjZXB0aW5nJywgcHJvdG8sICdyZXF1ZXN0IHRvIHJlY29yZCcpXG5cbiAgICAgIC8vICBXZSBwdXQgb3VyICdlbmQnIGxpc3RlbmVyIHRvIHRoZSBmcm9udCBvZiB0aGUgbGlzdGVuZXIgYXJyYXkuXG4gICAgICByZXMub25jZSgnZW5kJywgZnVuY3Rpb24gKCkge1xuICAgICAgICBkZWJ1Zyh0aGlzUmVjb3JkaW5nSWQsIHByb3RvLCAnaW50ZXJjZXB0ZWQgcmVxdWVzdCBlbmRlZCcpXG5cbiAgICAgICAgbGV0IHJlcWhlYWRlcnNcbiAgICAgICAgLy8gSWdub3JlIHJlcXVlc3QgaGVhZGVycyBjb21wbGV0ZWx5IHVubGVzcyBpdCB3YXMgZXhwbGljaXRseSBlbmFibGVkIGJ5IHRoZSB1c2VyIChzZWUgUkVBRE1FKVxuICAgICAgICBpZiAoZW5hYmxlUmVxSGVhZGVyc1JlY29yZGluZykge1xuICAgICAgICAgIC8vIFdlIG5ldmVyIHJlY29yZCB1c2VyLWFnZW50IGhlYWRlcnMgYXMgdGhleSBhcmUgd29yc2UgdGhhbiB1c2VsZXNzIC1cbiAgICAgICAgICAvLyB0aGV5IGFjdHVhbGx5IG1ha2UgdGVzdGluZyBtb3JlIGRpZmZpY3VsdCB3aXRob3V0IHByb3ZpZGluZyBhbnkgYmVuZWZpdCAoc2VlIFJFQURNRSlcbiAgICAgICAgICByZXFoZWFkZXJzID0gcmVxLmdldEhlYWRlcnMoKVxuICAgICAgICAgIGNvbW1vbi5kZWxldGVIZWFkZXJzRmllbGQocmVxaGVhZGVycywgJ3VzZXItYWdlbnQnKVxuICAgICAgICB9XG5cbiAgICAgICAgY29uc3QgZ2VuZXJhdGVGbiA9IG91dHB1dE9iamVjdHNcbiAgICAgICAgICA/IGdlbmVyYXRlUmVxdWVzdEFuZFJlc3BvbnNlT2JqZWN0XG4gICAgICAgICAgOiBnZW5lcmF0ZVJlcXVlc3RBbmRSZXNwb25zZVxuICAgICAgICBsZXQgb3V0ID0gZ2VuZXJhdGVGbih7XG4gICAgICAgICAgcmVxLFxuICAgICAgICAgIGJvZHlDaHVua3MsXG4gICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICByZXMsXG4gICAgICAgICAgZGF0YUNodW5rcyxcbiAgICAgICAgICByZXFoZWFkZXJzLFxuICAgICAgICB9KVxuXG4gICAgICAgIGRlYnVnKCdvdXQ6Jywgb3V0KVxuXG4gICAgICAgIC8vICBDaGVjayB0aGF0IHRoZSByZXF1ZXN0IHdhcyBtYWRlIGR1cmluZyB0aGUgY3VycmVudCByZWNvcmRpbmcuXG4gICAgICAgIC8vICBJZiBpdCBoYXNuJ3QgdGhlbiBza2lwIGl0LiBUaGVyZSBpcyBubyBvdGhlciBzaW1wbGUgd2F5IHRvIGhhbmRsZVxuICAgICAgICAvLyAgdGhpcyBhcyBpdCBkZXBlbmRzIG9uIHRoZSB0aW1pbmcgb2YgcmVxdWVzdHMgYW5kIHJlc3BvbnNlcy4gVGhyb3dpbmdcbiAgICAgICAgLy8gIHdpbGwgbWFrZSBzb21lIHJlY29yZGluZ3MvdW5pdCB0ZXN0cyBmYWlsIHJhbmRvbWx5IGRlcGVuZGluZyBvbiBob3dcbiAgICAgICAgLy8gIGZhc3Qvc2xvdyB0aGUgcmVzcG9uc2UgYXJyaXZlZC5cbiAgICAgICAgLy8gIElmIHlvdSBhcmUgc2VlaW5nIHRoaXMgZXJyb3IgdGhlbiB5b3UgbmVlZCB0byBtYWtlIHN1cmUgdGhhdCBhbGxcbiAgICAgICAgLy8gIHRoZSByZXF1ZXN0cyBtYWRlIGR1cmluZyBhIHNpbmdsZSByZWNvcmRpbmcgc2Vzc2lvbiBmaW5pc2ggYmVmb3JlXG4gICAgICAgIC8vICBlbmRpbmcgdGhlIHNhbWUgcmVjb3JkaW5nIHNlc3Npb24uXG4gICAgICAgIGlmICh0aGlzUmVjb3JkaW5nSWQgIT09IGN1cnJlbnRSZWNvcmRpbmdJZCkge1xuICAgICAgICAgIGRlYnVnKCdza2lwcGluZyByZWNvcmRpbmcgb2YgYW4gb3V0LW9mLW9yZGVyIHJlcXVlc3QnLCBvdXQpXG4gICAgICAgICAgcmV0dXJuXG4gICAgICAgIH1cblxuICAgICAgICBvdXRwdXRzLnB1c2gob3V0KVxuXG4gICAgICAgIGlmICghZG9udFByaW50KSB7XG4gICAgICAgICAgaWYgKHVzZVNlcGFyYXRvcikge1xuICAgICAgICAgICAgaWYgKHR5cGVvZiBvdXQgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgIG91dCA9IEpTT04uc3RyaW5naWZ5KG91dCwgbnVsbCwgMilcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGxvZ2dpbmcoU0VQQVJBVE9SICsgb3V0ICsgU0VQQVJBVE9SKVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICBsb2dnaW5nKG91dClcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pXG5cbiAgICAgIGxldCBlbmNvZGluZ1xuICAgICAgLy8gV2UgbmVlZCB0byBiZSBhd2FyZSBvZiBjaGFuZ2VzIHRvIHRoZSBzdHJlYW0ncyBlbmNvZGluZyBzbyB0aGF0IHdlXG4gICAgICAvLyBkb24ndCBhY2NpZGVudGFsbHkgbWFuZ2xlIHRoZSBkYXRhLlxuICAgICAgY29uc3QgeyBzZXRFbmNvZGluZyB9ID0gcmVzXG4gICAgICByZXMuc2V0RW5jb2RpbmcgPSBmdW5jdGlvbiAobmV3RW5jb2RpbmcpIHtcbiAgICAgICAgZW5jb2RpbmcgPSBuZXdFbmNvZGluZ1xuICAgICAgICByZXR1cm4gc2V0RW5jb2RpbmcuYXBwbHkodGhpcywgYXJndW1lbnRzKVxuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhQ2h1bmtzID0gW11cbiAgICAgIC8vIFJlcGxhY2UgcmVzLnB1c2ggd2l0aCBvdXIgb3duIGltcGxlbWVudGF0aW9uIHRoYXQgc3RvcmVzIGNodW5rc1xuICAgICAgY29uc3Qgb3JpZ1Jlc1B1c2ggPSByZXMucHVzaFxuICAgICAgcmVzLnB1c2ggPSBmdW5jdGlvbiAoZGF0YSkge1xuICAgICAgICBpZiAoZGF0YSkge1xuICAgICAgICAgIGlmIChlbmNvZGluZykge1xuICAgICAgICAgICAgZGF0YSA9IEJ1ZmZlci5mcm9tKGRhdGEsIGVuY29kaW5nKVxuICAgICAgICAgIH1cbiAgICAgICAgICBkYXRhQ2h1bmtzLnB1c2goZGF0YSlcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBvcmlnUmVzUHVzaC5jYWxsKHJlcywgZGF0YSlcbiAgICAgIH1cblxuICAgICAgaWYgKGNhbGxiYWNrKSB7XG4gICAgICAgIGNhbGxiYWNrKHJlcywgb3B0aW9ucywgY2FsbGJhY2spXG4gICAgICB9XG5cbiAgICAgIGRlYnVnKCdmaW5pc2hlZCBzZXR0aW5nIHVwIGludGVyY2VwdGluZycpXG5cbiAgICAgIC8vIFdlIG92ZXJyaWRlIGJvdGggdGhlIGh0dHAgYW5kIHRoZSBodHRwcyBtb2R1bGVzOyB3aGVuIHdlIGFyZVxuICAgICAgLy8gc2VyaWFsaXppbmcgdGhlIHJlcXVlc3QsIHdlIG5lZWQgdG8ga25vdyB3aGljaCB3YXMgY2FsbGVkLlxuICAgICAgLy8gQnkgc3R1ZmZpbmcgdGhlIHN0YXRlLCB3ZSBjYW4gbWFrZSBzdXJlIHRoYXQgbm9jayByZWNvcmRzXG4gICAgICAvLyB0aGUgaW50ZW5kZWQgcHJvdG9jb2wuXG4gICAgICBpZiAocHJvdG8gPT09ICdodHRwcycpIHtcbiAgICAgICAgb3B0aW9ucy5wcm90byA9ICdodHRwcydcbiAgICAgIH1cbiAgICB9KVxuXG4gICAgY29uc3QgcmVjb3JkQ2h1bmsgPSAoY2h1bmssIGVuY29kaW5nKSA9PiB7XG4gICAgICBkZWJ1Zyh0aGlzUmVjb3JkaW5nSWQsICduZXcnLCBwcm90bywgJ2JvZHkgY2h1bmsnKVxuICAgICAgaWYgKCFCdWZmZXIuaXNCdWZmZXIoY2h1bmspKSB7XG4gICAgICAgIGNodW5rID0gQnVmZmVyLmZyb20oY2h1bmssIGVuY29kaW5nKVxuICAgICAgfVxuICAgICAgYm9keUNodW5rcy5wdXNoKGNodW5rKVxuICAgIH1cblxuICAgIGNvbnN0IG9sZFdyaXRlID0gcmVxLndyaXRlXG4gICAgcmVxLndyaXRlID0gZnVuY3Rpb24gKGNodW5rLCBlbmNvZGluZykge1xuICAgICAgaWYgKHR5cGVvZiBjaHVuayAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgICAgICAgcmVjb3JkQ2h1bmsoY2h1bmssIGVuY29kaW5nKVxuICAgICAgICBvbGRXcml0ZS5hcHBseShyZXEsIGFyZ3VtZW50cylcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YSB3YXMgdW5kZWZpbmVkLicpXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gU3RhcnRpbmcgaW4gTm9kZSA4LCBgT3V0Z29pbmdNZXNzYWdlLmVuZCgpYCBkaXJlY3RseSBjYWxscyBhbiBpbnRlcm5hbFxuICAgIC8vIGB3cml0ZV9gIGZ1bmN0aW9uIGluc3RlYWQgb2YgcHJveHlpbmcgdG8gdGhlIHB1YmxpY1xuICAgIC8vIGBPdXRnb2luZ01lc3NhZ2Uud3JpdGUoKWAgbWV0aG9kLCBzbyB3ZSBoYXZlIHRvIHdyYXAgYGVuZGAgdG9vLlxuICAgIGNvbnN0IG9sZEVuZCA9IHJlcS5lbmRcbiAgICByZXEuZW5kID0gZnVuY3Rpb24gKGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spIHtcbiAgICAgIGRlYnVnKCdyZXEuZW5kJylcbiAgICAgIGlmICh0eXBlb2YgY2h1bmsgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgY2FsbGJhY2sgPSBjaHVua1xuICAgICAgICBjaHVuayA9IG51bGxcbiAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGVuY29kaW5nID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNhbGxiYWNrID0gZW5jb2RpbmdcbiAgICAgICAgZW5jb2RpbmcgPSBudWxsXG4gICAgICB9XG5cbiAgICAgIGlmIChjaHVuaykge1xuICAgICAgICByZWNvcmRDaHVuayhjaHVuaywgZW5jb2RpbmcpXG4gICAgICB9XG4gICAgICBvbGRFbmQuY2FsbChyZXEsIGNodW5rLCBlbmNvZGluZywgY2FsbGJhY2spXG4gICAgfVxuXG4gICAgcmV0dXJuIHJlcVxuICB9KVxufVxuXG4vLyBSZXN0b3JlICphbGwqIHRoZSBvdmVycmlkZGVuIGh0dHAvaHR0cHMgbW9kdWxlcycgcHJvcGVydGllcy5cbmZ1bmN0aW9uIHJlc3RvcmUoKSB7XG4gIGRlYnVnKFxuICAgIGN1cnJlbnRSZWNvcmRpbmdJZCxcbiAgICAncmVzdG9yaW5nIGFsbCB0aGUgb3ZlcnJpZGRlbiBodHRwL2h0dHBzIHByb3BlcnRpZXMnXG4gIClcblxuICBjb21tb24ucmVzdG9yZU92ZXJyaWRkZW5SZXF1ZXN0cygpXG4gIHJlc3RvcmVPdmVycmlkZGVuQ2xpZW50UmVxdWVzdCgpXG4gIHJlY29yZGluZ0luUHJvZ3Jlc3MgPSBmYWxzZVxufVxuXG5mdW5jdGlvbiBjbGVhcigpIHtcbiAgb3V0cHV0cyA9IFtdXG59XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICByZWNvcmQsXG4gIG91dHB1dHM6ICgpID0+IG91dHB1dHMsXG4gIHJlc3RvcmUsXG4gIGNsZWFyLFxufVxuIl19