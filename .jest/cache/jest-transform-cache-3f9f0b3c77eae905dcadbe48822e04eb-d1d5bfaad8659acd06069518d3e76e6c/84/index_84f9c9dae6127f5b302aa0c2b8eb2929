b4ab6ba2ed4356b1dba1b47b59571166
'use strict';

var _prettyFormat = _interopRequireDefault(require('pretty-format'));

var _chalk = _interopRequireDefault(require('chalk'));

var _jestGetType = _interopRequireDefault(require('jest-get-type'));

var _diffLines = _interopRequireDefault(require("./diffLines"));

var _printDiffs = require("./printDiffs");

var _constants = require("./constants");

function _interopRequireDefault(obj) {
  return obj && obj.__esModule ? obj : {
    default: obj
  };
}

var Symbol = global['jest-symbol-do-not-touch'] || global.Symbol;

function _objectSpread(target) {
  for (var i = 1; i < arguments.length; i++) {
    var source = arguments[i] != null ? arguments[i] : {};
    var ownKeys = Object.keys(source);

    if (typeof Object.getOwnPropertySymbols === 'function') {
      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {
        return Object.getOwnPropertyDescriptor(source, sym).enumerable;
      }));
    }

    ownKeys.forEach(function (key) {
      _defineProperty(target, key, source[key]);
    });
  }

  return target;
}

function _defineProperty(obj, key, value) {
  if (key in obj) {
    Object.defineProperty(obj, key, {
      value: value,
      enumerable: true,
      configurable: true,
      writable: true
    });
  } else {
    obj[key] = value;
  }

  return obj;
}

var _prettyFormat$plugins = _prettyFormat.default.plugins,
    AsymmetricMatcher = _prettyFormat$plugins.AsymmetricMatcher,
    DOMCollection = _prettyFormat$plugins.DOMCollection,
    DOMElement = _prettyFormat$plugins.DOMElement,
    Immutable = _prettyFormat$plugins.Immutable,
    ReactElement = _prettyFormat$plugins.ReactElement,
    ReactTestComponent = _prettyFormat$plugins.ReactTestComponent;
var PLUGINS = [ReactTestComponent, ReactElement, DOMElement, DOMCollection, Immutable, AsymmetricMatcher];
var FORMAT_OPTIONS = {
  plugins: PLUGINS
};

var FORMAT_OPTIONS_0 = _objectSpread({}, FORMAT_OPTIONS, {
  indent: 0
});

var FALLBACK_FORMAT_OPTIONS = {
  callToJSON: false,
  maxDepth: 10,
  plugins: PLUGINS
};

var FALLBACK_FORMAT_OPTIONS_0 = _objectSpread({}, FALLBACK_FORMAT_OPTIONS, {
  indent: 0
});

function diff(a, b, options) {
  if (Object.is(a, b)) {
    return _constants.NO_DIFF_MESSAGE;
  }

  var aType = (0, _jestGetType.default)(a);
  var expectedType = aType;
  var omitDifference = false;

  if (aType === 'object' && typeof a.asymmetricMatch === 'function') {
    if (a.$$typeof !== Symbol.for('jest.asymmetricMatcher')) {
      return null;
    }

    if (typeof a.getExpectedType !== 'function') {
      return null;
    }

    expectedType = a.getExpectedType();
    omitDifference = expectedType === 'string';
  }

  if (expectedType !== (0, _jestGetType.default)(b)) {
    return '  Comparing two different types of values.' + (" Expected " + _chalk.default.green(expectedType) + " but ") + ("received " + _chalk.default.red((0, _jestGetType.default)(b)) + ".");
  }

  if (omitDifference) {
    return null;
  }

  switch (aType) {
    case 'string':
      return (0, _diffLines.default)(a, b, options);

    case 'boolean':
    case 'number':
      return comparePrimitive(a, b, options);

    case 'map':
      return compareObjects(sortMap(a), sortMap(b), options);

    case 'set':
      return compareObjects(sortSet(a), sortSet(b), options);

    default:
      return compareObjects(a, b, options);
  }
}

function comparePrimitive(a, b, options) {
  return (0, _diffLines.default)((0, _prettyFormat.default)(a, FORMAT_OPTIONS), (0, _prettyFormat.default)(b, FORMAT_OPTIONS), options);
}

function sortMap(map) {
  return new Map(Array.from(map.entries()).sort());
}

function sortSet(set) {
  return new Set(Array.from(set.values()).sort());
}

function compareObjects(a, b, options) {
  var diffMessage;
  var hasThrown = false;

  try {
    diffMessage = (0, _diffLines.default)((0, _prettyFormat.default)(a, FORMAT_OPTIONS_0), (0, _prettyFormat.default)(b, FORMAT_OPTIONS_0), options, {
      a: (0, _prettyFormat.default)(a, FORMAT_OPTIONS),
      b: (0, _prettyFormat.default)(b, FORMAT_OPTIONS)
    });
  } catch (e) {
    hasThrown = true;
  }

  if (!diffMessage || diffMessage === _constants.NO_DIFF_MESSAGE) {
    diffMessage = (0, _diffLines.default)((0, _prettyFormat.default)(a, FALLBACK_FORMAT_OPTIONS_0), (0, _prettyFormat.default)(b, FALLBACK_FORMAT_OPTIONS_0), options, {
      a: (0, _prettyFormat.default)(a, FALLBACK_FORMAT_OPTIONS),
      b: (0, _prettyFormat.default)(b, FALLBACK_FORMAT_OPTIONS)
    });

    if (diffMessage !== _constants.NO_DIFF_MESSAGE && !hasThrown) {
      diffMessage = _constants.SIMILAR_MESSAGE + '\n\n' + diffMessage;
    }
  }

  return diffMessage;
}

diff.getStringDiff = _printDiffs.getStringDiff;
module.exports = diff;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImluZGV4LmpzIl0sIm5hbWVzIjpbIl9wcmV0dHlGb3JtYXQiLCJfaW50ZXJvcFJlcXVpcmVEZWZhdWx0IiwicmVxdWlyZSIsIl9jaGFsayIsIl9qZXN0R2V0VHlwZSIsIl9kaWZmTGluZXMiLCJfcHJpbnREaWZmcyIsIl9jb25zdGFudHMiLCJvYmoiLCJfX2VzTW9kdWxlIiwiZGVmYXVsdCIsIlN5bWJvbCIsImdsb2JhbCIsIl9vYmplY3RTcHJlYWQiLCJ0YXJnZXQiLCJpIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwic291cmNlIiwib3duS2V5cyIsIk9iamVjdCIsImtleXMiLCJnZXRPd25Qcm9wZXJ0eVN5bWJvbHMiLCJjb25jYXQiLCJmaWx0ZXIiLCJzeW0iLCJnZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3IiLCJlbnVtZXJhYmxlIiwiZm9yRWFjaCIsImtleSIsIl9kZWZpbmVQcm9wZXJ0eSIsInZhbHVlIiwiZGVmaW5lUHJvcGVydHkiLCJjb25maWd1cmFibGUiLCJ3cml0YWJsZSIsIl9wcmV0dHlGb3JtYXQkcGx1Z2lucyIsInBsdWdpbnMiLCJBc3ltbWV0cmljTWF0Y2hlciIsIkRPTUNvbGxlY3Rpb24iLCJET01FbGVtZW50IiwiSW1tdXRhYmxlIiwiUmVhY3RFbGVtZW50IiwiUmVhY3RUZXN0Q29tcG9uZW50IiwiUExVR0lOUyIsIkZPUk1BVF9PUFRJT05TIiwiRk9STUFUX09QVElPTlNfMCIsImluZGVudCIsIkZBTExCQUNLX0ZPUk1BVF9PUFRJT05TIiwiY2FsbFRvSlNPTiIsIm1heERlcHRoIiwiRkFMTEJBQ0tfRk9STUFUX09QVElPTlNfMCIsImRpZmYiLCJhIiwiYiIsIm9wdGlvbnMiLCJpcyIsIk5PX0RJRkZfTUVTU0FHRSIsImFUeXBlIiwiZXhwZWN0ZWRUeXBlIiwib21pdERpZmZlcmVuY2UiLCJhc3ltbWV0cmljTWF0Y2giLCIkJHR5cGVvZiIsImZvciIsImdldEV4cGVjdGVkVHlwZSIsImdyZWVuIiwicmVkIiwiY29tcGFyZVByaW1pdGl2ZSIsImNvbXBhcmVPYmplY3RzIiwic29ydE1hcCIsInNvcnRTZXQiLCJtYXAiLCJNYXAiLCJBcnJheSIsImZyb20iLCJlbnRyaWVzIiwic29ydCIsInNldCIsIlNldCIsInZhbHVlcyIsImRpZmZNZXNzYWdlIiwiaGFzVGhyb3duIiwiZSIsIlNJTUlMQVJfTUVTU0FHRSIsImdldFN0cmluZ0RpZmYiLCJtb2R1bGUiLCJleHBvcnRzIl0sIm1hcHBpbmdzIjoiQUFBQTs7QUFFQSxJQUFJQSxhQUFhLEdBQUdDLHNCQUFzQixDQUFDQyxPQUFPLENBQUMsZUFBRCxDQUFSLENBQTFDOztBQUVBLElBQUlDLE1BQU0sR0FBR0Ysc0JBQXNCLENBQUNDLE9BQU8sQ0FBQyxPQUFELENBQVIsQ0FBbkM7O0FBRUEsSUFBSUUsWUFBWSxHQUFHSCxzQkFBc0IsQ0FBQ0MsT0FBTyxDQUFDLGVBQUQsQ0FBUixDQUF6Qzs7QUFFQSxJQUFJRyxVQUFVLEdBQUdKLHNCQUFzQixDQUFDQyxPQUFPLGVBQVIsQ0FBdkM7O0FBRUEsSUFBSUksV0FBVyxHQUFHSixPQUFPLGdCQUF6Qjs7QUFFQSxJQUFJSyxVQUFVLEdBQUdMLE9BQU8sZUFBeEI7O0FBRUEsU0FBU0Qsc0JBQVQsQ0FBZ0NPLEdBQWhDLEVBQXFDO0FBQ25DLFNBQU9BLEdBQUcsSUFBSUEsR0FBRyxDQUFDQyxVQUFYLEdBQXdCRCxHQUF4QixHQUE4QjtBQUFDRSxJQUFBQSxPQUFPLEVBQUVGO0FBQVYsR0FBckM7QUFDRDs7QUFFRCxJQUFJRyxNQUFNLEdBQUdDLE1BQU0sQ0FBQywwQkFBRCxDQUFOLElBQXNDQSxNQUFNLENBQUNELE1BQTFEOztBQUVBLFNBQVNFLGFBQVQsQ0FBdUJDLE1BQXZCLEVBQStCO0FBQzdCLE9BQUssSUFBSUMsQ0FBQyxHQUFHLENBQWIsRUFBZ0JBLENBQUMsR0FBR0MsU0FBUyxDQUFDQyxNQUE5QixFQUFzQ0YsQ0FBQyxFQUF2QyxFQUEyQztBQUN6QyxRQUFJRyxNQUFNLEdBQUdGLFNBQVMsQ0FBQ0QsQ0FBRCxDQUFULElBQWdCLElBQWhCLEdB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QUFBQSxDQUFDLEVBQUUsQ0FBQyxHQUFHckQsYUFBYSxDQUFDVSxPQUFsQixFQUEyQjJDLENBQTNCLEVBQThCTix1QkFBOUI7QUFGTCxLQUpZLENBQWQ7O0FBVUEsUUFBSWdDLFdBQVcsS0FBS3hFLFVBQVUsQ0FBQ2lELGVBQTNCLElBQThDLENBQUN3QixTQUFuRCxFQUE4RDtBQUM1REQsTUFBQUEsV0FBVyxHQUFHeEUsVUFBVSxDQUFDMkUsZUFBWCxHQUE2QixNQUE3QixHQUFzQ0gsV0FBcEQ7QUFDRDtBQUNGOztBQUVELFNBQU9BLFdBQVA7QUFDRDs7QUFFRDVCLElBQUksQ0FBQ2dDLGFBQUwsR0FBcUI3RSxXQUFXLENBQUM2RSxhQUFqQztBQUNBQyxNQUFNLENBQUNDLE9BQVAsR0FBaUJsQyxJQUFqQiIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxudmFyIF9wcmV0dHlGb3JtYXQgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoJ3ByZXR0eS1mb3JtYXQnKSk7XG5cbnZhciBfY2hhbGsgPSBfaW50ZXJvcFJlcXVpcmVEZWZhdWx0KHJlcXVpcmUoJ2NoYWxrJykpO1xuXG52YXIgX2plc3RHZXRUeXBlID0gX2ludGVyb3BSZXF1aXJlRGVmYXVsdChyZXF1aXJlKCdqZXN0LWdldC10eXBlJykpO1xuXG52YXIgX2RpZmZMaW5lcyA9IF9pbnRlcm9wUmVxdWlyZURlZmF1bHQocmVxdWlyZSgnLi9kaWZmTGluZXMnKSk7XG5cbnZhciBfcHJpbnREaWZmcyA9IHJlcXVpcmUoJy4vcHJpbnREaWZmcycpO1xuXG52YXIgX2NvbnN0YW50cyA9IHJlcXVpcmUoJy4vY29uc3RhbnRzJyk7XG5cbmZ1bmN0aW9uIF9pbnRlcm9wUmVxdWlyZURlZmF1bHQob2JqKSB7XG4gIHJldHVybiBvYmogJiYgb2JqLl9fZXNNb2R1bGUgPyBvYmogOiB7ZGVmYXVsdDogb2JqfTtcbn1cblxudmFyIFN5bWJvbCA9IGdsb2JhbFsnamVzdC1zeW1ib2wtZG8tbm90LXRvdWNoJ10gfHwgZ2xvYmFsLlN5bWJvbDtcblxuZnVuY3Rpb24gX29iamVjdFNwcmVhZCh0YXJnZXQpIHtcbiAgZm9yICh2YXIgaSA9IDE7IGkgPCBhcmd1bWVudHMubGVuZ3RoOyBpKyspIHtcbiAgICB2YXIgc291cmNlID0gYXJndW1lbnRzW2ldICE9IG51bGwgPyBhcmd1bWVudHNbaV0gOiB7fTtcbiAgICB2YXIgb3duS2V5cyA9IE9iamVjdC5rZXlzKHNvdXJjZSk7XG4gICAgaWYgKHR5cGVvZiBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBvd25LZXlzID0gb3duS2V5cy5jb25jYXQoXG4gICAgICAgIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMoc291cmNlKS5maWx0ZXIoZnVuY3Rpb24oc3ltKSB7XG4gICAgICAgICAgcmV0dXJuIE9iamVjdC5nZXRPd25Qcm9wZXJ0eURlc2NyaXB0b3Ioc291cmNlLCBzeW0pLmVudW1lcmFibGU7XG4gICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgICBvd25LZXlzLmZvckVhY2goZnVuY3Rpb24oa2V5KSB7XG4gICAgICBfZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBrZXksIHNvdXJjZVtrZXldKTtcbiAgICB9KTtcbiAgfVxuICByZXR1cm4gdGFyZ2V0O1xufVxuXG5mdW5jdGlvbiBfZGVmaW5lUHJvcGVydHkob2JqLCBrZXksIHZhbHVlKSB7XG4gIGlmIChrZXkgaW4gb2JqKSB7XG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG9iaiwga2V5LCB7XG4gICAgICB2YWx1ZTogdmFsdWUsXG4gICAgICBlbnVtZXJhYmxlOiB0cnVlLFxuICAgICAgY29uZmlndXJhYmxlOiB0cnVlLFxuICAgICAgd3JpdGFibGU6IHRydWVcbiAgICB9KTtcbiAgfSBlbHNlIHtcbiAgICBvYmpba2V5XSA9IHZhbHVlO1xuICB9XG4gIHJldHVybiBvYmo7XG59XG5cbmNvbnN0IF9wcmV0dHlGb3JtYXQkcGx1Z2lucyA9IF9wcmV0dHlGb3JtYXQuZGVmYXVsdC5wbHVnaW5zLFxuICBBc3ltbWV0cmljTWF0Y2hlciA9IF9wcmV0dHlGb3JtYXQkcGx1Z2lucy5Bc3ltbWV0cmljTWF0Y2hlcixcbiAgRE9NQ29sbGVjdGlvbiA9IF9wcmV0dHlGb3JtYXQkcGx1Z2lucy5ET01Db2xsZWN0aW9uLFxuICBET01FbGVtZW50ID0gX3ByZXR0eUZvcm1hdCRwbHVnaW5zLkRPTUVsZW1lbnQsXG4gIEltbXV0YWJsZSA9IF9wcmV0dHlGb3JtYXQkcGx1Z2lucy5JbW11dGFibGUsXG4gIFJlYWN0RWxlbWVudCA9IF9wcmV0dHlGb3JtYXQkcGx1Z2lucy5SZWFjdEVsZW1lbnQsXG4gIFJlYWN0VGVzdENvbXBvbmVudCA9IF9wcmV0dHlGb3JtYXQkcGx1Z2lucy5SZWFjdFRlc3RDb21wb25lbnQ7XG5jb25zdCBQTFVHSU5TID0gW1xuICBSZWFjdFRlc3RDb21wb25lbnQsXG4gIFJlYWN0RWxlbWVudCxcbiAgRE9NRWxlbWVudCxcbiAgRE9NQ29sbGVjdGlvbixcbiAgSW1tdXRhYmxlLFxuICBBc3ltbWV0cmljTWF0Y2hlclxuXTtcbmNvbnN0IEZPUk1BVF9PUFRJT05TID0ge1xuICBwbHVnaW5zOiBQTFVHSU5TXG59O1xuXG5jb25zdCBGT1JNQVRfT1BUSU9OU18wID0gX29iamVjdFNwcmVhZCh7fSwgRk9STUFUX09QVElPTlMsIHtcbiAgaW5kZW50OiAwXG59KTtcblxuY29uc3QgRkFMTEJBQ0tfRk9STUFUX09QVElPTlMgPSB7XG4gIGNhbGxUb0pTT046IGZhbHNlLFxuICBtYXhEZXB0aDogMTAsXG4gIHBsdWdpbnM6IFBMVUdJTlNcbn07XG5cbmNvbnN0IEZBTExCQUNLX0ZPUk1BVF9PUFRJT05TXzAgPSBfb2JqZWN0U3ByZWFkKHt9LCBGQUxMQkFDS19GT1JNQVRfT1BUSU9OUywge1xuICBpbmRlbnQ6IDBcbn0pOyAvLyBHZW5lcmF0ZSBhIHN0cmluZyB0aGF0IHdpbGwgaGlnaGxpZ2h0IHRoZSBkaWZmZXJlbmNlIGJldHdlZW4gdHdvIHZhbHVlc1xuLy8gd2l0aCBncmVlbiBhbmQgcmVkLiAoc2ltaWxhciB0byBob3cgZ2l0aHViIGRvZXMgY29kZSBkaWZmaW5nKVxuXG5mdW5jdGlvbiBkaWZmKGEsIGIsIG9wdGlvbnMpIHtcbiAgaWYgKE9iamVjdC5pcyhhLCBiKSkge1xuICAgIHJldHVybiBfY29uc3RhbnRzLk5PX0RJRkZfTUVTU0FHRTtcbiAgfVxuXG4gIGNvbnN0IGFUeXBlID0gKDAsIF9qZXN0R2V0VHlwZS5kZWZhdWx0KShhKTtcbiAgbGV0IGV4cGVjdGVkVHlwZSA9IGFUeXBlO1xuICBsZXQgb21pdERpZmZlcmVuY2UgPSBmYWxzZTtcblxuICBpZiAoYVR5cGUgPT09ICdvYmplY3QnICYmIHR5cGVvZiBhLmFzeW1tZXRyaWNNYXRjaCA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIGlmIChhLiQkdHlwZW9mICE9PSBTeW1ib2wuZm9yKCdqZXN0LmFzeW1tZXRyaWNNYXRjaGVyJykpIHtcbiAgICAgIC8vIERvIG5vdCBrbm93IGV4cGVjdGVkIHR5cGUgb2YgdXNlci1kZWZpbmVkIGFzeW1tZXRyaWMgbWF0Y2hlci5cbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2YgYS5nZXRFeHBlY3RlZFR5cGUgIT09ICdmdW5jdGlvbicpIHtcbiAgICAgIC8vIEZvciBleGFtcGxlLCBleHBlY3QuYW55dGhpbmcoKSBtYXRjaGVzIGVpdGhlciBudWxsIG9yIHVuZGVmaW5lZFxuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgZXhwZWN0ZWRUeXBlID0gYS5nZXRFeHBlY3RlZFR5cGUoKTsgLy8gUHJpbWl0aXZlIHR5cGVzIGJvb2xlYW4gYW5kIG51bWJlciBvbWl0IGRpZmZlcmVuY2UgYmVsb3cuXG4gICAgLy8gRm9yIGV4YW1wbGUsIG9taXQgZGlmZmVyZW5jZSBmb3IgZXhwZWN0LnN0cmluZ01hdGNoaW5nKHJlZ2V4cClcblxuICAgIG9taXREaWZmZXJlbmNlID0gZXhwZWN0ZWRUeXBlID09PSAnc3RyaW5nJztcbiAgfVxuXG4gIGlmIChleHBlY3RlZFR5cGUgIT09ICgwLCBfamVzdEdldFR5cGUuZGVmYXVsdCkoYikpIHtcbiAgICByZXR1cm4gKFxuICAgICAgJyAgQ29tcGFyaW5nIHR3byBkaWZmZXJlbnQgdHlwZXMgb2YgdmFsdWVzLicgK1xuICAgICAgYCBFeHBlY3RlZCAke19jaGFsay5kZWZhdWx0LmdyZWVuKGV4cGVjdGVkVHlwZSl9IGJ1dCBgICtcbiAgICAgIGByZWNlaXZlZCAke19jaGFsay5kZWZhdWx0LnJlZCgoMCwgX2plc3RHZXRUeXBlLmRlZmF1bHQpKGIpKX0uYFxuICAgICk7XG4gIH1cblxuICBpZiAob21pdERpZmZlcmVuY2UpIHtcbiAgICByZXR1cm4gbnVsbDtcbiAgfVxuXG4gIHN3aXRjaCAoYVR5cGUpIHtcbiAgICBjYXNlICdzdHJpbmcnOlxuICAgICAgcmV0dXJuICgwLCBfZGlmZkxpbmVzLmRlZmF1bHQpKGEsIGIsIG9wdGlvbnMpO1xuXG4gICAgY2FzZSAnYm9vbGVhbic6XG4gICAgY2FzZSAnbnVtYmVyJzpcbiAgICAgIHJldHVybiBjb21wYXJlUHJpbWl0aXZlKGEsIGIsIG9wdGlvbnMpO1xuXG4gICAgY2FzZSAnbWFwJzpcbiAgICAgIHJldHVybiBjb21wYXJlT2JqZWN0cyhzb3J0TWFwKGEpLCBzb3J0TWFwKGIpLCBvcHRpb25zKTtcblxuICAgIGNhc2UgJ3NldCc6XG4gICAgICByZXR1cm4gY29tcGFyZU9iamVjdHMoc29ydFNldChhKSwgc29ydFNldChiKSwgb3B0aW9ucyk7XG5cbiAgICBkZWZhdWx0OlxuICAgICAgcmV0dXJuIGNvbXBhcmVPYmplY3RzKGEsIGIsIG9wdGlvbnMpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVQcmltaXRpdmUoYSwgYiwgb3B0aW9ucykge1xuICByZXR1cm4gKDAsIF9kaWZmTGluZXMuZGVmYXVsdCkoXG4gICAgKDAsIF9wcmV0dHlGb3JtYXQuZGVmYXVsdCkoYSwgRk9STUFUX09QVElPTlMpLFxuICAgICgwLCBfcHJldHR5Rm9ybWF0LmRlZmF1bHQpKGIsIEZPUk1BVF9PUFRJT05TKSxcbiAgICBvcHRpb25zXG4gICk7XG59XG5cbmZ1bmN0aW9uIHNvcnRNYXAobWFwKSB7XG4gIHJldHVybiBuZXcgTWFwKEFycmF5LmZyb20obWFwLmVudHJpZXMoKSkuc29ydCgpKTtcbn1cblxuZnVuY3Rpb24gc29ydFNldChzZXQpIHtcbiAgcmV0dXJuIG5ldyBTZXQoQXJyYXkuZnJvbShzZXQudmFsdWVzKCkpLnNvcnQoKSk7XG59XG5cbmZ1bmN0aW9uIGNvbXBhcmVPYmplY3RzKGEsIGIsIG9wdGlvbnMpIHtcbiAgbGV0IGRpZmZNZXNzYWdlO1xuICBsZXQgaGFzVGhyb3duID0gZmFsc2U7XG5cbiAgdHJ5IHtcbiAgICBkaWZmTWVzc2FnZSA9ICgwLCBfZGlmZkxpbmVzLmRlZmF1bHQpKFxuICAgICAgKDAsIF9wcmV0dHlGb3JtYXQuZGVmYXVsdCkoYSwgRk9STUFUX09QVElPTlNfMCksXG4gICAgICAoMCwgX3ByZXR0eUZvcm1hdC5kZWZhdWx0KShiLCBGT1JNQVRfT1BUSU9OU18wKSxcbiAgICAgIG9wdGlvbnMsXG4gICAgICB7XG4gICAgICAgIGE6ICgwLCBfcHJldHR5Rm9ybWF0LmRlZmF1bHQpKGEsIEZPUk1BVF9PUFRJT05TKSxcbiAgICAgICAgYjogKDAsIF9wcmV0dHlGb3JtYXQuZGVmYXVsdCkoYiwgRk9STUFUX09QVElPTlMpXG4gICAgICB9XG4gICAgKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGhhc1Rocm93biA9IHRydWU7XG4gIH0gLy8gSWYgdGhlIGNvbXBhcmlzb24geWllbGRzIG5vIHJlc3VsdHMsIGNvbXBhcmUgYWdhaW4gYnV0IHRoaXMgdGltZVxuICAvLyB3aXRob3V0IGNhbGxpbmcgYHRvSlNPTmAuIEl0J3MgYWxzbyBwb3NzaWJsZSB0aGF0IHRvSlNPTiBtaWdodCB0aHJvdy5cblxuICBpZiAoIWRpZmZNZXNzYWdlIHx8IGRpZmZNZXNzYWdlID09PSBfY29uc3RhbnRzLk5PX0RJRkZfTUVTU0FHRSkge1xuICAgIGRpZmZNZXNzYWdlID0gKDAsIF9kaWZmTGluZXMuZGVmYXVsdCkoXG4gICAgICAoMCwgX3ByZXR0eUZvcm1hdC5kZWZhdWx0KShhLCBGQUxMQkFDS19GT1JNQVRfT1BUSU9OU18wKSxcbiAgICAgICgwLCBfcHJldHR5Rm9ybWF0LmRlZmF1bHQpKGIsIEZBTExCQUNLX0ZPUk1BVF9PUFRJT05TXzApLFxuICAgICAgb3B0aW9ucyxcbiAgICAgIHtcbiAgICAgICAgYTogKDAsIF9wcmV0dHlGb3JtYXQuZGVmYXVsdCkoYSwgRkFMTEJBQ0tfRk9STUFUX09QVElPTlMpLFxuICAgICAgICBiOiAoMCwgX3ByZXR0eUZvcm1hdC5kZWZhdWx0KShiLCBGQUxMQkFDS19GT1JNQVRfT1BUSU9OUylcbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKGRpZmZNZXNzYWdlICE9PSBfY29uc3RhbnRzLk5PX0RJRkZfTUVTU0FHRSAmJiAhaGFzVGhyb3duKSB7XG4gICAgICBkaWZmTWVzc2FnZSA9IF9jb25zdGFudHMuU0lNSUxBUl9NRVNTQUdFICsgJ1xcblxcbicgKyBkaWZmTWVzc2FnZTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gZGlmZk1lc3NhZ2U7XG59IC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1yZWRlY2xhcmVcblxuZGlmZi5nZXRTdHJpbmdEaWZmID0gX3ByaW50RGlmZnMuZ2V0U3RyaW5nRGlmZjtcbm1vZHVsZS5leHBvcnRzID0gZGlmZjtcbiJdfQ==