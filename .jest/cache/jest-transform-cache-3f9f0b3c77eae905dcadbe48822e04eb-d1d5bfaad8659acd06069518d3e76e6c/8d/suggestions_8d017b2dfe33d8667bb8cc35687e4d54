1d423add2579ca1b33adae75bca7351b
"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.getSuggestedQuery = getSuggestedQuery;

var _domAccessibilityApi = require("dom-accessibility-api");

var _matches = require("./matches");

var _getNodeText = require("./get-node-text");

var _config = require("./config");

var _roleHelpers = require("./role-helpers");

var _labelHelpers = require("./label-helpers");

var _shared = require("./shared");

var normalize = (0, _matches.getDefaultNormalizer)();

function escapeRegExp(string) {
  return string.replace(/[.*+\-?^${}()|[\]\\]/g, '\\$&');
}

function getRegExpMatcher(string) {
  return new RegExp(escapeRegExp(string.toLowerCase()), 'i');
}

function makeSuggestion(queryName, element, content, _ref) {
  var variant = _ref.variant,
      name = _ref.name;
  var warning = '';
  var queryOptions = {};
  var queryArgs = [['Role', 'TestId'].includes(queryName) ? content : getRegExpMatcher(content)];

  if (name) {
    queryOptions.name = getRegExpMatcher(name);
  }

  if (queryName === 'Role' && (0, _roleHelpers.isInaccessible)(element)) {
    queryOptions.hidden = true;
    warning = "Element is inaccessible. This means that the element and all its children are invisible to screen readers.\n    If you are using the aria-hidden prop, make sure this is the right choice for your case.\n    ";
  }

  if (Object.keys(queryOptions).length > 0) {
    queryArgs.push(queryOptions);
  }

  var queryMethod = variant + "By" + queryName;
  return {
    queryName: queryName,
    queryMethod: queryMethod,
    queryArgs: queryArgs,
    variant: variant,
    warning: warning,
    toString: function toString() {
      if (warning) {
        console.warn(warning);
      }

      var text = queryArgs[0],
          options = queryArgs[1];
      text = typeof text === 'string' ? "'" + text + "'" : text;
      options = options ? ", { " + Object.entries(options).map(function (_ref2) {
        var _ref3 = (0, _slicedToArray2.default)(_ref2, 2),
            k = _ref3[0],
            v = _ref3[1];

        return k + ": " + v;
      }).join(', ') + " }" : '';
      return queryMethod + "(" + text + options + ")";
    }
  };
}

function canSuggest(currentMethod, requestedMethod, data) {
  return data && (!requestedMethod || requestedMethod.toLowerCase() === currentMethod.toLowerCase());
}

function getSuggestedQuery(element) {
  var variant = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 'get';
  var method = arguments.length > 2 ? arguments[2] : undefined;

  var _element$getAttribute, _getImplicitAriaRoles;

  if (element.matches(_shared.DEFAULT_IGNORE_TAGS)) {
    return undefined;
  }

  var role = (_element$getAttribute = element.getAttribute('role')) != null ? _element$getAttribute : (_getImplicitAriaRoles = (0, _roleHelpers.getImplicitAriaRoles)(element)) == null ? void 0 : _getImplicitAriaRoles[0];

  if (role !== 'generic' && canSuggest('Role', method, role)) {
    return makeSuggestion('Role', element, role, {
      variant: variant,
      name: (0, _domAccessibilityApi.computeAccessibleName)(element, {
        computedStyleSupportsPseudoElements: (0, _config.getConfig)().computedStyleSupportsPseudoElements
      })
    });
  }

  var labelText = (0, _labelHelpers.getLabels)(document, element).map(function (label) {
    return label.content;
  }).join(' ');

  if (canSuggest('LabelText', method, labelText)) {
    return makeSuggestion('LabelText', element, labelText, {
      variant: variant
    });
  }

  var placeholderText = element.getAttribute('placeholder');

  if (canSuggest('PlaceholderText', method, placeholderText)) {
    return makeSuggestion('PlaceholderText', element, placeholderText, {
      variant: variant
    });
  }

  var textContent = normalize((0, _getNodeText.getNodeText)(element));

  if (canSuggest('Text', method, textContent)) {
    return makeSuggestion('Text', element, textContent, {
      variant: variant
    });
  }

  if (canSuggest('DisplayValue', method, element.value)) {
    return makeSuggestion('DisplayValue', element, normalize(element.value), {
      variant: variant
    });
  }

  var alt = element.getAttribute('alt');

  if (canSuggest('AltText', method, alt)) {
    return makeSuggestion('AltText', element, alt, {
      variant: variant
    });
  }

  var title = element.getAttribute('title');

  if (canSuggest('Title', method, title)) {
    return makeSuggestion('Title', element, title, {
      variant: variant
    });
  }

  var testId = element.getAttribute((0, _config.getConfig)().testIdAttribute);

  if (canSuggest('TestId', method, testId)) {
    return makeSuggestion('TestId', element, testId, {
      variant: variant
    });
  }

  return undefined;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInN1Z2dlc3Rpb25zLmpzIl0sIm5hbWVzIjpbIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZXhwb3J0cyIsInZhbHVlIiwiZ2V0U3VnZ2VzdGVkUXVlcnkiLCJfZG9tQWNjZXNzaWJpbGl0eUFwaSIsInJlcXVpcmUiLCJfbWF0Y2hlcyIsIl9nZXROb2RlVGV4dCIsIl9jb25maWciLCJfcm9sZUhlbHBlcnMiLCJfbGFiZWxIZWxwZXJzIiwiX3NoYXJlZCIsIm5vcm1hbGl6ZSIsImdldERlZmF1bHROb3JtYWxpemVyIiwiZXNjYXBlUmVnRXhwIiwic3RyaW5nIiwicmVwbGFjZSIsImdldFJlZ0V4cE1hdGNoZXIiLCJSZWdFeHAiLCJ0b0xvd2VyQ2FzZSIsIm1ha2VTdWdnZXN0aW9uIiwicXVlcnlOYW1lIiwiZWxlbWVudCIsImNvbnRlbnQiLCJ2YXJpYW50IiwibmFtZSIsIndhcm5pbmciLCJxdWVyeU9wdGlvbnMiLCJxdWVyeUFyZ3MiLCJpbmNsdWRlcyIsImlzSW5hY2Nlc3NpYmxlIiwiaGlkZGVuIiwia2V5cyIsImxlbmd0aCIsInB1c2giLCJxdWVyeU1ldGhvZCIsInRvU3RyaW5nIiwiY29uc29sZSIsIndhcm4iLCJ0ZXh0Iiwib3B0aW9ucyIsImVudHJpZXMiLCJtYXAiLCJrIiwidiIsImpvaW4iLCJjYW5TdWdnZXN0IiwiY3VycmVudE1ldGhvZCIsInJlcXVlc3RlZE1ldGhvZCIsImRhdGEiLCJtZXRob2QiLCJfZWxlbWVudCRnZXRBdHRyaWJ1dGUiLCJfZ2V0SW1wbGljaXRBcmlhUm9sZXMiLCJtYXRjaGVzIiwiREVGQVVMVF9JR05PUkVfVEFHUyIsInVuZGVmaW5lZCIsInJvbGUiLCJnZXRBdHRyaWJ1dGUiLCJnZXRJbXBsaWNpdEFyaWFSb2xlcyIsImNvbXB1dGVBY2Nlc3NpYmxlTmFtZSIsImNvbXB1dGVkU3R5bGVTdXBwb3J0c1BzZXVkb0VsZW1lbnRzIiwiZ2V0Q29uZmlnIiwibGFiZWxUZXh0IiwiZ2V0TGFiZWxzIiwiZG9jdW1lbnQiLCJsYWJlbCIsInBsYWNlaG9sZGVyVGV4dCIsInRleHRDb250ZW50IiwiZ2V0Tm9kZVRleHQiLCJhbHQiLCJ0aXRsZSIsInRlc3RJZCIsInRlc3RJZEF0dHJpYnV0ZSJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztBQUVBQSxNQUFNLENBQUNDLGNBQVAsQ0FBc0JDLE9BQXRCLEVBQStCLFlBQS9CLEVBQTZDO0FBQzNDQyxFQUFBQSxLQUFLLEVBQUU7QUFEb0MsQ0FBN0M7QUFHQUQsT0FBTyxDQUFDRSxpQkFBUixHQUE0QkEsaUJBQTVCOztBQUVBLElBQUlDLG9CQUFvQixHQUFHQyxPQUFPLENBQUMsdUJBQUQsQ0FBbEM7O0FBRUEsSUFBSUMsUUFBUSxHQUFHRCxPQUFPLGFBQXRCOztBQUVBLElBQUlFLFlBQVksR0FBR0YsT0FBTyxtQkFBMUI7O0FBRUEsSUFBSUcsT0FBTyxHQUFHSCxPQUFPLFlBQXJCOztBQUVBLElBQUlJLFlBQVksR0FBR0osT0FBTyxrQkFBMUI7O0FBRUEsSUFBSUssYUFBYSxHQUFHTCxPQUFPLG1CQUEzQjs7QUFFQSxJQUFJTSxPQUFPLEdBQUdOLE9BQU8sWUFBckI7O0FBRUEsSUFBTU8sU0FBUyxHQUFHLENBQUMsR0FBR04sUUFBUSxDQUFDTyxvQkFBYixHQUFsQjs7QUFFQSxTQUFTQyxZQUFULENBQXNCQyxNQUF0QixFQUE4QjtBQUM1QixTQUFPQSxNQUFNLENBQUNDLE9BQVAsQ0FBZSx1QkFBZixFQUF3QyxNQUF4QyxDQUFQO0FBQ0Q7O0FBRUQsU0FBU0MsZ0JBQVQsQ0FBMEJGLE1BQTFCLEVBQWtDO0FBQ2hDLFNBQU8sSUFBSUcsTUFBSixDQUFXSixZQUFZLENBQUNDLE1BQU0sQ0FBQ0ksV0FBUCxFQUFELENBQXZCLEVBQStDLEdBQS9DLENBQVA7QUFDRDs7QUFFRCxTQUFTQyxjQUFULENBQXdCQyxTQUF4QixFQUFtQ0MsT0FBbkMsRUFBNENDLE9BQTVDLFFBR0c7QUFBQSxNQUZEQyxPQUVDLFFBRkRBLE9BRUM7QUFBQSxNQUREQyxJQUNDLFFBRERBLElBQ0M7QUFDRCxNQUFJQyxP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VixFQUFtQmdELEtBQW5CLEVBQTBCO0FBQzdDOUMsTUFBQUEsT0FBTyxFQUFQQTtBQUQ2QyxLQUExQixDQUFyQjtBQUdEOztBQUVELE1BQU0rQyxNQUFNLEdBQUdqRCxPQUFPLENBQUNtQyxZQUFSLENBQXFCLENBQUMsR0FBR2pELE9BQU8sQ0FBQ3FELFNBQVosSUFBeUJXLGVBQTlDLENBQWY7O0FBRUEsTUFBSTFCLFVBQVUsQ0FBQyxRQUFELEVBQVdJLE1BQVgsRUFBbUJxQixNQUFuQixDQUFkLEVBQTBDO0FBQ3hDLFdBQU9uRCxjQUFjLENBQUMsUUFBRCxFQUFXRSxPQUFYLEVBQW9CaUQsTUFBcEIsRUFBNEI7QUFDL0MvQyxNQUFBQSxPQUFPLEVBQVBBO0FBRCtDLEtBQTVCLENBQXJCO0FBR0Q7O0FBRUQsU0FBTytCLFNBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbIlwidXNlIHN0cmljdFwiO1xuXG5PYmplY3QuZGVmaW5lUHJvcGVydHkoZXhwb3J0cywgXCJfX2VzTW9kdWxlXCIsIHtcbiAgdmFsdWU6IHRydWVcbn0pO1xuZXhwb3J0cy5nZXRTdWdnZXN0ZWRRdWVyeSA9IGdldFN1Z2dlc3RlZFF1ZXJ5O1xuXG52YXIgX2RvbUFjY2Vzc2liaWxpdHlBcGkgPSByZXF1aXJlKFwiZG9tLWFjY2Vzc2liaWxpdHktYXBpXCIpO1xuXG52YXIgX21hdGNoZXMgPSByZXF1aXJlKFwiLi9tYXRjaGVzXCIpO1xuXG52YXIgX2dldE5vZGVUZXh0ID0gcmVxdWlyZShcIi4vZ2V0LW5vZGUtdGV4dFwiKTtcblxudmFyIF9jb25maWcgPSByZXF1aXJlKFwiLi9jb25maWdcIik7XG5cbnZhciBfcm9sZUhlbHBlcnMgPSByZXF1aXJlKFwiLi9yb2xlLWhlbHBlcnNcIik7XG5cbnZhciBfbGFiZWxIZWxwZXJzID0gcmVxdWlyZShcIi4vbGFiZWwtaGVscGVyc1wiKTtcblxudmFyIF9zaGFyZWQgPSByZXF1aXJlKFwiLi9zaGFyZWRcIik7XG5cbmNvbnN0IG5vcm1hbGl6ZSA9ICgwLCBfbWF0Y2hlcy5nZXREZWZhdWx0Tm9ybWFsaXplcikoKTtcblxuZnVuY3Rpb24gZXNjYXBlUmVnRXhwKHN0cmluZykge1xuICByZXR1cm4gc3RyaW5nLnJlcGxhY2UoL1suKitcXC0/XiR7fSgpfFtcXF1cXFxcXS9nLCAnXFxcXCQmJyk7IC8vICQmIG1lYW5zIHRoZSB3aG9sZSBtYXRjaGVkIHN0cmluZ1xufVxuXG5mdW5jdGlvbiBnZXRSZWdFeHBNYXRjaGVyKHN0cmluZykge1xuICByZXR1cm4gbmV3IFJlZ0V4cChlc2NhcGVSZWdFeHAoc3RyaW5nLnRvTG93ZXJDYXNlKCkpLCAnaScpO1xufVxuXG5mdW5jdGlvbiBtYWtlU3VnZ2VzdGlvbihxdWVyeU5hbWUsIGVsZW1lbnQsIGNvbnRlbnQsIHtcbiAgdmFyaWFudCxcbiAgbmFtZVxufSkge1xuICBsZXQgd2FybmluZyA9ICcnO1xuICBjb25zdCBxdWVyeU9wdGlvbnMgPSB7fTtcbiAgY29uc3QgcXVlcnlBcmdzID0gW1snUm9sZScsICdUZXN0SWQnXS5pbmNsdWRlcyhxdWVyeU5hbWUpID8gY29udGVudCA6IGdldFJlZ0V4cE1hdGNoZXIoY29udGVudCldO1xuXG4gIGlmIChuYW1lKSB7XG4gICAgcXVlcnlPcHRpb25zLm5hbWUgPSBnZXRSZWdFeHBNYXRjaGVyKG5hbWUpO1xuICB9XG5cbiAgaWYgKHF1ZXJ5TmFtZSA9PT0gJ1JvbGUnICYmICgwLCBfcm9sZUhlbHBlcnMuaXNJbmFjY2Vzc2libGUpKGVsZW1lbnQpKSB7XG4gICAgcXVlcnlPcHRpb25zLmhpZGRlbiA9IHRydWU7XG4gICAgd2FybmluZyA9IGBFbGVtZW50IGlzIGluYWNjZXNzaWJsZS4gVGhpcyBtZWFucyB0aGF0IHRoZSBlbGVtZW50IGFuZCBhbGwgaXRzIGNoaWxkcmVuIGFyZSBpbnZpc2libGUgdG8gc2NyZWVuIHJlYWRlcnMuXG4gICAgSWYgeW91IGFyZSB1c2luZyB0aGUgYXJpYS1oaWRkZW4gcHJvcCwgbWFrZSBzdXJlIHRoaXMgaXMgdGhlIHJpZ2h0IGNob2ljZSBmb3IgeW91ciBjYXNlLlxuICAgIGA7XG4gIH1cblxuICBpZiAoT2JqZWN0LmtleXMocXVlcnlPcHRpb25zKS5sZW5ndGggPiAwKSB7XG4gICAgcXVlcnlBcmdzLnB1c2gocXVlcnlPcHRpb25zKTtcbiAgfVxuXG4gIGNvbnN0IHF1ZXJ5TWV0aG9kID0gYCR7dmFyaWFudH1CeSR7cXVlcnlOYW1lfWA7XG4gIHJldHVybiB7XG4gICAgcXVlcnlOYW1lLFxuICAgIHF1ZXJ5TWV0aG9kLFxuICAgIHF1ZXJ5QXJncyxcbiAgICB2YXJpYW50LFxuICAgIHdhcm5pbmcsXG5cbiAgICB0b1N0cmluZygpIHtcbiAgICAgIGlmICh3YXJuaW5nKSB7XG4gICAgICAgIGNvbnNvbGUud2Fybih3YXJuaW5nKTtcbiAgICAgIH1cblxuICAgICAgbGV0IFt0ZXh0LCBvcHRpb25zXSA9IHF1ZXJ5QXJncztcbiAgICAgIHRleHQgPSB0eXBlb2YgdGV4dCA9PT0gJ3N0cmluZycgPyBgJyR7dGV4dH0nYCA6IHRleHQ7XG4gICAgICBvcHRpb25zID0gb3B0aW9ucyA/IGAsIHsgJHtPYmplY3QuZW50cmllcyhvcHRpb25zKS5tYXAoKFtrLCB2XSkgPT4gYCR7a306ICR7dn1gKS5qb2luKCcsICcpfSB9YCA6ICcnO1xuICAgICAgcmV0dXJuIGAke3F1ZXJ5TWV0aG9kfSgke3RleHR9JHtvcHRpb25zfSlgO1xuICAgIH1cblxuICB9O1xufVxuXG5mdW5jdGlvbiBjYW5TdWdnZXN0KGN1cnJlbnRNZXRob2QsIHJlcXVlc3RlZE1ldGhvZCwgZGF0YSkge1xuICByZXR1cm4gZGF0YSAmJiAoIXJlcXVlc3RlZE1ldGhvZCB8fCByZXF1ZXN0ZWRNZXRob2QudG9Mb3dlckNhc2UoKSA9PT0gY3VycmVudE1ldGhvZC50b0xvd2VyQ2FzZSgpKTtcbn1cblxuZnVuY3Rpb24gZ2V0U3VnZ2VzdGVkUXVlcnkoZWxlbWVudCwgdmFyaWFudCA9ICdnZXQnLCBtZXRob2QpIHtcbiAgdmFyIF9lbGVtZW50JGdldEF0dHJpYnV0ZSwgX2dldEltcGxpY2l0QXJpYVJvbGVzO1xuXG4gIC8vIGRvbid0IGNyZWF0ZSBzdWdnZXN0aW9ucyBmb3Igc2NyaXB0IGFuZCBzdHlsZSBlbGVtZW50c1xuICBpZiAoZWxlbWVudC5tYXRjaGVzKF9zaGFyZWQuREVGQVVMVF9JR05PUkVfVEFHUykpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9IC8vV2UgcHJlZmVyIHRvIHN1Z2dlc3Qgc29tZXRoaW5nIGVsc2UgaWYgdGhlIHJvbGUgaXMgZ2VuZXJpY1xuXG5cbiAgY29uc3Qgcm9sZSA9IChfZWxlbWVudCRnZXRBdHRyaWJ1dGUgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgncm9sZScpKSAhPSBudWxsID8gX2VsZW1lbnQkZ2V0QXR0cmlidXRlIDogKF9nZXRJbXBsaWNpdEFyaWFSb2xlcyA9ICgwLCBfcm9sZUhlbHBlcnMuZ2V0SW1wbGljaXRBcmlhUm9sZXMpKGVsZW1lbnQpKSA9PSBudWxsID8gdm9pZCAwIDogX2dldEltcGxpY2l0QXJpYVJvbGVzWzBdO1xuXG4gIGlmIChyb2xlICE9PSAnZ2VuZXJpYycgJiYgY2FuU3VnZ2VzdCgnUm9sZScsIG1ldGhvZCwgcm9sZSkpIHtcbiAgICByZXR1cm4gbWFrZVN1Z2dlc3Rpb24oJ1JvbGUnLCBlbGVtZW50LCByb2xlLCB7XG4gICAgICB2YXJpYW50LFxuICAgICAgbmFtZTogKDAsIF9kb21BY2Nlc3NpYmlsaXR5QXBpLmNvbXB1dGVBY2Nlc3NpYmxlTmFtZSkoZWxlbWVudCwge1xuICAgICAgICBjb21wdXRlZFN0eWxlU3VwcG9ydHNQc2V1ZG9FbGVtZW50czogKDAsIF9jb25maWcuZ2V0Q29uZmlnKSgpLmNvbXB1dGVkU3R5bGVTdXBwb3J0c1BzZXVkb0VsZW1lbnRzXG4gICAgICB9KVxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgbGFiZWxUZXh0ID0gKDAsIF9sYWJlbEhlbHBlcnMuZ2V0TGFiZWxzKShkb2N1bWVudCwgZWxlbWVudCkubWFwKGxhYmVsID0+IGxhYmVsLmNvbnRlbnQpLmpvaW4oJyAnKTtcblxuICBpZiAoY2FuU3VnZ2VzdCgnTGFiZWxUZXh0JywgbWV0aG9kLCBsYWJlbFRleHQpKSB7XG4gICAgcmV0dXJuIG1ha2VTdWdnZXN0aW9uKCdMYWJlbFRleHQnLCBlbGVtZW50LCBsYWJlbFRleHQsIHtcbiAgICAgIHZhcmlhbnRcbiAgICB9KTtcbiAgfVxuXG4gIGNvbnN0IHBsYWNlaG9sZGVyVGV4dCA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdwbGFjZWhvbGRlcicpO1xuXG4gIGlmIChjYW5TdWdnZXN0KCdQbGFjZWhvbGRlclRleHQnLCBtZXRob2QsIHBsYWNlaG9sZGVyVGV4dCkpIHtcbiAgICByZXR1cm4gbWFrZVN1Z2dlc3Rpb24oJ1BsYWNlaG9sZGVyVGV4dCcsIGVsZW1lbnQsIHBsYWNlaG9sZGVyVGV4dCwge1xuICAgICAgdmFyaWFudFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgdGV4dENvbnRlbnQgPSBub3JtYWxpemUoKDAsIF9nZXROb2RlVGV4dC5nZXROb2RlVGV4dCkoZWxlbWVudCkpO1xuXG4gIGlmIChjYW5TdWdnZXN0KCdUZXh0JywgbWV0aG9kLCB0ZXh0Q29udGVudCkpIHtcbiAgICByZXR1cm4gbWFrZVN1Z2dlc3Rpb24oJ1RleHQnLCBlbGVtZW50LCB0ZXh0Q29udGVudCwge1xuICAgICAgdmFyaWFudFxuICAgIH0pO1xuICB9XG5cbiAgaWYgKGNhblN1Z2dlc3QoJ0Rpc3BsYXlWYWx1ZScsIG1ldGhvZCwgZWxlbWVudC52YWx1ZSkpIHtcbiAgICByZXR1cm4gbWFrZVN1Z2dlc3Rpb24oJ0Rpc3BsYXlWYWx1ZScsIGVsZW1lbnQsIG5vcm1hbGl6ZShlbGVtZW50LnZhbHVlKSwge1xuICAgICAgdmFyaWFudFxuICAgIH0pO1xuICB9XG5cbiAgY29uc3QgYWx0ID0gZWxlbWVudC5nZXRBdHRyaWJ1dGUoJ2FsdCcpO1xuXG4gIGlmIChjYW5TdWdnZXN0KCdBbHRUZXh0JywgbWV0aG9kLCBhbHQpKSB7XG4gICAgcmV0dXJuIG1ha2VTdWdnZXN0aW9uKCdBbHRUZXh0JywgZWxlbWVudCwgYWx0LCB7XG4gICAgICB2YXJpYW50XG4gICAgfSk7XG4gIH1cblxuICBjb25zdCB0aXRsZSA9IGVsZW1lbnQuZ2V0QXR0cmlidXRlKCd0aXRsZScpO1xuXG4gIGlmIChjYW5TdWdnZXN0KCdUaXRsZScsIG1ldGhvZCwgdGl0bGUpKSB7XG4gICAgcmV0dXJuIG1ha2VTdWdnZXN0aW9uKCdUaXRsZScsIGVsZW1lbnQsIHRpdGxlLCB7XG4gICAgICB2YXJpYW50XG4gICAgfSk7XG4gIH1cblxuICBjb25zdCB0ZXN0SWQgPSBlbGVtZW50LmdldEF0dHJpYnV0ZSgoMCwgX2NvbmZpZy5nZXRDb25maWcpKCkudGVzdElkQXR0cmlidXRlKTtcblxuICBpZiAoY2FuU3VnZ2VzdCgnVGVzdElkJywgbWV0aG9kLCB0ZXN0SWQpKSB7XG4gICAgcmV0dXJuIG1ha2VTdWdnZXN0aW9uKCdUZXN0SWQnLCBlbGVtZW50LCB0ZXN0SWQsIHtcbiAgICAgIHZhcmlhbnRcbiAgICB9KTtcbiAgfVxuXG4gIHJldHVybiB1bmRlZmluZWQ7XG59Il19