3659ef338cf412474d7c1cc166c52dc0
'use strict';

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _slicedToArray2 = _interopRequireDefault(require("@babel/runtime/helpers/slicedToArray"));

var _toConsumableArray2 = _interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"));

var _extends2 = _interopRequireDefault(require("@babel/runtime/helpers/extends"));

var _classCallCheck2 = _interopRequireDefault(require("@babel/runtime/helpers/classCallCheck"));

var _createClass2 = _interopRequireDefault(require("@babel/runtime/helpers/createClass"));

var stringify = require('json-stringify-safe');

var querystring = require('querystring');

var _require = require('url'),
    URL = _require.URL,
    URLSearchParams = _require.URLSearchParams;

var common = require("./common");

var _require2 = require("./intercept"),
    remove = _require2.remove;

var matchBody = require("./match_body");

var fs;

try {
  fs = require('fs');
} catch (err) {}

module.exports = function () {
  function Interceptor(scope, uri, method, requestBody, interceptorOptions) {
    (0, _classCallCheck2.default)(this, Interceptor);
    var uriIsStr = typeof uri === 'string';

    if (uriIsStr && !scope.scopeOptions.filteringScope && !scope.basePathname && !uri.startsWith('/') && !uri.startsWith('*')) {
      throw Error("Non-wildcard URL path strings must begin with a slash (otherwise they won't match anything) (got: " + uri + ")");
    }

    if (!method) {
      throw new Error('The "method" parameter is required for an intercept call.');
    }

    this.scope = scope;
    this.interceptorMatchHeaders = [];
    this.method = method.toUpperCase();
    this.uri = uri;
    this._key = this.method + " " + scope.basePath + scope.basePathname + (uriIsStr ? '' : '/') + uri;
    this.basePath = this.scope.basePath;
    this.path = uriIsStr ? scope.basePathname + uri : uri;
    this.queries = null;
    this.options = interceptorOptions || {};
    this.counter = 1;
    this._requestBody = requestBody;
    this.reqheaders = common.headersFieldNamesToLowerCase(scope.scopeOptions.reqheaders || {});
    this.badheaders = common.headersFieldsArrayToLowerCase(scope.scopeOptions.badheaders || []);
    this.delayBodyInMs = 0;
    this.delayConnectionInMs = 0;
    this.optional = false;

    if (uriIsStr && uri.includes('?')) {
      var parsedURL = new URL(this.path, 'http://localhost');
      this.path = parsedURL.pathname;
      this.query(parsedURL.searchParams);
      this._key = this.method + " " + scope.basePath + this.path;
    }
  }

  (0, _createClass2.default)(Interceptor, [{
    key: "optionally",
    value: function optionally() {
      var flag = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : true;

      if (typeof flag !== 'boolean') {
        throw new Error('Invalid arguments: argument should be a boolean');
      }

      this.optional = flag;
      return this;
    }
  }, {
    key: "replyWithError",
    value: function replyWithError(errorMessage) {
      this.errorMessage = errorMessage;
      this.options = (0, _extends2.default)({}, this.scope.scopeOptions, this.options);
      this.scope.add(this._key, this);
      return this.scope;
    }
  }, {
    key: "reply",
    value: function reply(statusCode, body, rawHeaders) {
      if (typeof statusCode === 'function') {
        if (arguments.length > 1) {
          throw Error('Invalid arguments. When providing a function for the first argument, .reply does not accept other arguments.');
        }

        this.statusCode = null;
        this.fullReplyFunction = statusCode;
      } else {
        if (statusCode !== undefined && !Number.isInteger(statusCode)) {
          throw new Error("Invalid " + typeof statusCode + " value for status code");
        }

        this.statusCode = statusCode || 200;

        if (typeof body === 'function') {
          this.replyFunction = body;
          body = null;
        }
      }

      this.options = (0, _extends2.default)({}, this.scope.scopeOptions, this.options);
      this.rawHeaders = common.headersInputToRawArray(rawHeaders);

      if (this.scope.date) {
        this.rawHeaders.push('Date', this.scope.date.toUTCString());
      }

      this.headers = common.headersArrayToObject(this.rawHeaders.concat(this.scope._defaultReplyHeaders));

      if (body && typeof body !== 'string' && !Buffer.isBuffer(body) && !common.isStream(body) && !common.isContentEncoded(this.headers)) {
        try {
          body = stringify(body);
        } catch (err) {
          throw new Error('Error encoding response body into JSON');
        }

        if (!this.headers['content-type']) {
          this.rawHeaders.push('Content-Type', 'application/json');
        }

        if (this.scope.contentLen) {
          this.rawHeaders.push('Content-Length', body.length);
        }
      }

      this.scope.logger('reply.headers:', this.headers);
      this.scope.logger('reply.rawHeaders:', this.rawHeaders);
      this.body = body;
      this.scope.add(this._key, this);
      return this.scope;
    }
  }, {
    key: "replyWithFile",
    value: function replyWithFile(statusCode, filePath, headers) {
      if (!fs) {
        throw new Error('No fs');
      }

      var readStream = fs.createReadStream(filePath);
      readStream.pause();
      this.filePath = filePath;
      return this.reply(statusCode, readStream, headers);
    }
  }, {
    key: "reqheaderMatches",
    value: function reqheaderMatches(options, key) {
      var reqHeader = this.reqheaders[key];
      var header = options.headers[key];

      if (header && typeof header !== 'string' && header.toString) {
        header = header.toString();
      }

      if (key === 'host' && (header === undefined || reqHeader === undefined)) {
        return true;
      }

      if (reqHeader !== undefined && header !== undefined) {
        if (typeof reqHeader === 'function') {
          return reqHeader(header);
        } else if (common.matchStringOrRegexp(header, reqHeader)) {
          return true;
        }
      }

      this.scope.logger("request header field doesn't match:", key, header, reqHeader);
      return false;
    }
  }, {
    key: "match",
    value: function match(req, options, body) {
      var _this = this;

      if (this.scope.logger.enabled) {
        this.scope.logger('attempting match %s, body = %s', stringify(options), stringify(body));
      }

      var method = (options.method || 'GET').toUpperCase();
      var _options$path = options.path,
          path = _options$path === void 0 ? '/' : _options$path;
      var matches;
      var matchKey;
      var proto = options.proto;

      if (this.method !== method) {
        this.scope.logger("Method did not match. Request " + method + " Interceptor " + this.method);
        return false;
      }

      if (this.scope.transformPathFunction) {
        path = this.scope.transformPathFunction(path);
      }

      var requestMatchesFilter = function requestMatchesFilter(_ref) {
        var name = _ref.name,
            predicate = _ref.value;
        var headerValue = req.getHeader(name);

        if (typeof predicate === 'function') {
          return predicate(headerValue);
        } else {
          return common.matchStringOrRegexp(headerValue, predicate);
        }
      };

      if (!this.scope.matchHeaders.every(requestMatchesFilter) || !this.interceptorMatchHeaders.every(requestMatchesFilter)) {
        this.scope.logger("headers don't match");
        return false;
      }

      var reqHeadersMatch = Object.keys(this.reqheaders).every(function (key) {
        return _this.reqheaderMatches(options, key);
      });

      if (!reqHeadersMatch) {
        this.scope.logger("headers don't match");
        return false;
      }

      if (this.scope.scopeOptions.conditionally && !this.scope.scopeOptions.conditionally()) {
        this.scope.logger('matching failed because Scope.conditionally() did not validate');
        return false;
      }

      var badHeaders = this.badheaders.filter(function (header) {
        return header in options.headers;
      });

      if (badHeaders.length) {
        var _this$scope;

        (_this$scope = this.scope).logger.apply(_this$scope, ['request contains bad headers'].concat((0, _toConsumableArray2.default)(badHeaders)));

        return false;
      }

      if (this.queries === null) {
        this.scope.logger('query matching skipped');
      } else {
        var _path$split = path.split('?'),
            _path$split2 = (0, _slicedToArray2.default)(_path$split, 2),
            pathname = _path$split2[0],
            search = _path$split2[1];

        var matchQueries = this.matchQuery({
          search: search
        });
        this.scope.logger(matchQueries ? 'query matching succeeded' : 'query matching failed');

        if (!matchQueries) {
          return false;
        }

        path = pathname;
      }

      if (this.__nock_filteredScope) {
        matchKey = this.__nock_filteredScope;
      } else {
        matchKey = common.normalizeOrigin(proto, options.host, options.port);
      }

      if (typeof this.uri === 'function') {
        matches = common.matchStringOrRegexp(matchKey, this.basePath) && this.uri.call(this, path);
      } else {
        matches = common.matchStringOrRegexp(matchKey, this.basePath) && common.matchStringOrRegexp(path, this.path);
      }

      this.scope.logger("matching " + matchKey + path + " to " + this._key + ": " + matches);

      if (matches && this._requestBody !== undefined) {
        if (this.scope.transformRequestBodyFunction) {
          body = this.scope.transformRequestBodyFunction(body, this._requestBody);
        }

        matches = matchBody(options, this._requestBody, body);

        if (!matches) {
          this.scope.logger("bodies don't match: \n", this._requestBody, '\n', body);
        }
      }

      return matches;
    }
  }, {
    key: "matchOrigin",
    value: function matchOrigin(options) {
      var isPathFn = typeof this.path === 'function';
      var isRegex = this.path instanceof RegExp;
      var isRegexBasePath = this.scope.basePath instanceof RegExp;
      var method = (options.method || 'GET').toUpperCase();
      var path = options.path;
      var proto = options.proto;

      if (!isRegex) {
        path = path ? path.split('?')[0] : '';
      }

      if (this.scope.transformPathFunction) {
        path = this.scope.transformPathFunction(path);
      }

      var comparisonKey = isPathFn || isRegex ? this.__nock_scopeKey : this._key;
      var matchKey = method + " " + proto + "://" + options.host + path;

      if (isPathFn) {
        return !!(matchKey.match(comparisonKey) && this.path(path));
      }

      if (isRegex && !isRegexBasePath) {
        return !!matchKey.match(comparisonKey) && this.path.test(path);
      }

      if (isRegexBasePath) {
        return this.scope.basePath.test(matchKey) && !!path.match(this.path);
      }

      return comparisonKey === matchKey;
    }
  }, {
    key: "matchHostName",
    value: function matchHostName(options) {
      return options.hostname === this.scope.urlParts.hostname;
    }
  }, {
    key: "matchQuery",
    value: function matchQuery(options) {
      if (this.queries === true) {
        return true;
      }

      var reqQueries = querystring.parse(options.search);
      this.scope.logger('Interceptor queries: %j', this.queries);
      this.scope.logger('    Request queries: %j', reqQueries);

      if (typeof this.queries === 'function') {
        return this.queries(reqQueries);
      }

      return common.dataEqual(this.queries, reqQueries);
    }
  }, {
    key: "filteringPath",
    value: function filteringPath() {
      var _this$scope2;

      (_this$scope2 = this.scope).filteringPath.apply(_this$scope2, arguments);

      return this;
    }
  }, {
    key: "markConsumed",
    value: function markConsumed() {
      this.interceptionCounter++;
      remove(this);

      if ((this.scope.shouldPersist() || this.counter > 0) && this.filePath) {
        this.body = fs.createReadStream(this.filePath);
        this.body.pause();
      }

      if (!this.scope.shouldPersist() && this.counter < 1) {
        this.scope.remove(this._key, this);
      }
    }
  }, {
    key: "matchHeader",
    value: function matchHeader(name, value) {
      this.interceptorMatchHeaders.push({
        name: name,
        value: value
      });
      return this;
    }
  }, {
    key: "basicAuth",
    value: function basicAuth(_ref2) {
      var user = _ref2.user,
          _ref2$pass = _ref2.pass,
          pass = _ref2$pass === void 0 ? '' : _ref2$pass;
      var encoded = Buffer.from(user + ":" + pass).toString('base64');
      this.matchHeader('authorization', "Basic " + encoded);
      return this;
    }
  }, {
    key: "query",
    value: function query(queries) {
      if (this.queries !== null) {
        throw Error("Query parameters have already been defined");
      }

      if (queries === true) {
        this.queries = queries;
        return this;
      }

      if (typeof queries === 'function') {
        this.queries = queries;
        return this;
      }

      var strFormattingFn;

      if (this.scope.scopeOptions.encodedQueryParams) {
        strFormattingFn = common.percentDecode;
      }

      if (queries instanceof URLSearchParams) {
        queries = querystring.parse(queries.toString());
      } else if (!common.isPlainObject(queries)) {
        throw Error("Argument Error: " + queries);
      }

      this.queries = {};

      for (var _i = 0, _Object$entries = Object.entries(queries); _i < _Object$entries.length; _i++) {
        var _ref3 = _Object$entries[_i];

        var _ref4 = (0, _slicedToArray2.default)(_ref3, 2);

        var key = _ref4[0];
        var value = _ref4[1];
        var formatted = common.formatQueryValue(key, value, strFormattingFn);

        var _formatted = (0, _slicedToArray2.default)(formatted, 2),
            formattedKey = _formatted[0],
            formattedValue = _formatted[1];

        this.queries[formattedKey] = formattedValue;
      }

      return this;
    }
  }, {
    key: "times",
    value: function times(newCounter) {
      if (newCounter < 1) {
        return this;
      }

      this.counter = newCounter;
      return this;
    }
  }, {
    key: "once",
    value: function once() {
      return this.times(1);
    }
  }, {
    key: "twice",
    value: function twice() {
      return this.times(2);
    }
  }, {
    key: "thrice",
    value: function thrice() {
      return this.times(3);
    }
  }, {
    key: "delay",
    value: function delay(opts) {
      var headDelay;
      var bodyDelay;

      if (typeof opts === 'number') {
        headDelay = opts;
        bodyDelay = 0;
      } else if (typeof opts === 'object') {
        headDelay = opts.head || 0;
        bodyDelay = opts.body || 0;
      } else {
        throw new Error("Unexpected input opts " + opts);
      }

      return this.delayConnection(headDelay).delayBody(bodyDelay);
    }
  }, {
    key: "delayBody",
    value: function delayBody(ms) {
      this.delayBodyInMs = ms;
      return this;
    }
  }, {
    key: "delayConnection",
    value: function delayConnection(ms) {
      this.delayConnectionInMs = ms;
      return this;
    }
  }]);
  return Interceptor;
}();
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImludGVyY2VwdG9yLmpzIl0sIm5hbWVzIjpbInN0cmluZ2lmeSIsInJlcXVpcmUiLCJxdWVyeXN0cmluZyIsIlVSTCIsIlVSTFNlYXJjaFBhcmFtcyIsImNvbW1vbiIsInJlbW92ZSIsIm1hdGNoQm9keSIsImZzIiwiZXJyIiwibW9kdWxlIiwiZXhwb3J0cyIsInNjb3BlIiwidXJpIiwibWV0aG9kIiwicmVxdWVzdEJvZHkiLCJpbnRlcmNlcHRvck9wdGlvbnMiLCJ1cmlJc1N0ciIsInNjb3BlT3B0aW9ucyIsImZpbHRlcmluZ1Njb3BlIiwiYmFzZVBhdGhuYW1lIiwic3RhcnRzV2l0aCIsIkVycm9yIiwiaW50ZXJjZXB0b3JNYXRjaEhlYWRlcnMiLCJ0b1VwcGVyQ2FzZSIsIl9rZXkiLCJiYXNlUGF0aCIsInBhdGgiLCJxdWVyaWVzIiwib3B0aW9ucyIsImNvdW50ZXIiLCJfcmVxdWVzdEJvZHkiLCJyZXFoZWFkZXJzIiwiaGVhZGVyc0ZpZWxkTmFtZXNUb0xvd2VyQ2FzZSIsImJhZGhlYWRlcnMiLCJoZWFkZXJzRmllbGRzQXJyYXlUb0xvd2VyQ2FzZSIsImRlbGF5Qm9keUluTXMiLCJkZWxheUNvbm5lY3Rpb25Jbk1zIiwib3B0aW9uYWwiLCJpbmNsdWRlcyIsInBhcnNlZFVSTCIsInBhdGhuYW1lIiwicXVlcnkiLCJzZWFyY2hQYXJhbXMiLCJmbGFnIiwiZXJyb3JNZXNzYWdlIiwiYWRkIiwic3RhdHVzQ29kZSIsImJvZHkiLCJyYXdIZWFkZXJzIiwiYXJndW1lbnRzIiwibGVuZ3RoIiwiZnVsbFJlcGx5RnVuY3Rpb24iLCJ1bmRlZmluZWQiLCJOdW1iZXIiLCJpc0ludGVnZXIiLCJyZXBseUZ1bmN0aW9uIiwiaGVhZGVyc0lucHV0VG9SYXdBcnJheSIsImRhdGUiLCJwdXNoIiwidG9VVENTdHJpbmciLCJoZWFkZXJzIiwiaGVhZGVyc0FycmF5VG9PYmplY3QiLCJjb25jYXQiLCJfZGVmYXVsdFJlcGx5SGVhZGVycyIsIkJ1ZmZlciIsImlzQnVmZmVyIiwiaXNTdHJlYW0iLCJpc0NvbnRlbnRFbmNvZGVkIiwiY29udGVudExlbiIsImxvZ2dlciIsImZpbGVQYXRoIiwicmVhZFN0cmVhbSIsImNyZWF0ZVJlYWRTdHJlYW0iLCJwYXVzZSIsInJlcGx5Iiwia2V5IiwicmVxSGVhZGVyIiwiaGVhZGVyIiwidG9TdHJpbmciLCJtYXRjaFN0cmluZ09yUmVnZXhwIiwicmVxIiwiZW5hYmxlZCIsIm1hdGNoZXMiLCJtYXRjaEtleSIsInByb3RvIiwidHJhbnNmb3JtUGF0aEZ1bmN0aW9uIiwicmVxdWVzdE1hdGNoZXNGaWx0ZXIiLCJuYW1lIiwicHJlZGljYXRlIiwidmFsdWUiLCJoZWFkZXJWYWx1ZSIsImdldEhlYWRlciIsIm1hdGNoSGVhZGVycyIsImV2ZXJ5IiwicmVxSGVhZGVyc01hdGNoIiwiT2JqZWN0Iiwia2V5cyIsInJlcWhlYWRlck1hdGNoZXMiLCJjb25kaXRpb25hbGx5IiwiYmFkSGVhZGVycyIsImZpbHRlciIsInNwbGl0Iiwic2VhcmNoIiwibWF0Y2hRdWVyaWVzIiwibWF0Y2hRdWVyeSIsIl9fbm9ja19maWx0ZXJlZFNjb3BlIiwibm9ybWFsaXplT3JpZ2luIiwiaG9zdCIsInBvcnQiLCJjYWxsIiwidHJhbnNmb3JtUmVxdWVzdEJvZHlGdW5jdGlvbiIsImlzUGF0aEZuIiwiaXNSZWdleCIsIlJlZ0V4cCIsImlzUmVnZXhCYXNlUGF0aCIsImNvbXBhcmlzb25LZXkiLCJfX25vY2tfc2NvcGVLZXkiLCJtYXRjaCIsInRlc3QiLCJob3N0bmFtZSIsInVybFBhcnRzIiwicmVxUXVlcmllcyIsInBhcnNlIiwiZGF0YUVxdWFsIiwiZmlsdGVyaW5nUGF0aCIsImludGVyY2VwdGlvbkNvdW50ZXIiLCJzaG91bGRQZXJzaXN0IiwidXNlciIsInBhc3MiLCJlbmNvZGVkIiwiZnJvbSIsIm1hdGNoSGVhZGVyIiwic3RyRm9ybWF0dGluZ0ZuIiwiZW5jb2RlZFF1ZXJ5UGFyYW1zIiwicGVyY2VudERlY29kZSIsImlzUGxhaW5PYmplY3QiLCJlbnRyaWVzIiwiZm9ybWF0dGVkIiwiZm9ybWF0UXVlcnlWYWx1ZSIsImZvcm1hdHRlZEtleSIsImZvcm1hdHRlZFZhbHVlIiwibmV3Q291bnRlciIsInRpbWVzIiwib3B0cyIsImhlYWREZWxheSIsImJvZHlEZWxheSIsImhlYWQiLCJkZWxheUNvbm5lY3Rpb24iLCJkZWxheUJvZHkiLCJtcyJdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7O0FBRUEsSUFBTUEsU0FBUyxHQUFHQyxPQUFPLENBQUMscUJBQUQsQ0FBekI7O0FBQ0EsSUFBTUMsV0FBVyxHQUFHRCxPQUFPLENBQUMsYUFBRCxDQUEzQjs7QUFDQSxlQUFpQ0EsT0FBTyxDQUFDLEtBQUQsQ0FBeEM7QUFBQSxJQUFRRSxHQUFSLFlBQVFBLEdBQVI7QUFBQSxJQUFhQyxlQUFiLFlBQWFBLGVBQWI7O0FBRUEsSUFBTUMsTUFBTSxHQUFHSixPQUFPLFlBQXRCOztBQUNBLGdCQUFtQkEsT0FBTyxlQUExQjtBQUFBLElBQVFLLE1BQVIsYUFBUUEsTUFBUjs7QUFDQSxJQUFNQyxTQUFTLEdBQUdOLE9BQU8sZ0JBQXpCOztBQUVBLElBQUlPLEVBQUo7O0FBQ0EsSUFBSTtBQUNGQSxFQUFBQSxFQUFFLEdBQUdQLE9BQU8sQ0FBQyxJQUFELENBQVo7QUFDRCxDQUZELENBRUUsT0FBT1EsR0FBUCxFQUFZLENBRWI7O0FBRURDLE1BQU0sQ0FBQ0MsT0FBUDtBQVdFLHVCQUFZQyxLQUFaLEVBQW1CQyxHQUFuQixFQUF3QkMsTUFBeEIsRUFBZ0NDLFdBQWhDLEVBQTZDQyxrQkFBN0MsRUFBaUU7QUFBQTtBQUMvRCxRQUFNQyxRQUFRLEdBQUcsT0FBT0osR0FBUCxLQUFlLFFBQWhDOztBQUlBLFFBQ0VJLFFBQVEsSUFDUixDQUFDTCxLQUFLLENBQUNNLFlBQU4sQ0FBbUJDLGNBRHBCLElBRUEsQ0FBQ1AsS0FBSyxDQUFDUSxZQUZQLElBR0EsQ0FBQ1AsR0FBRyxDQUFDUSxVQUFKLENBQWUsR0FBZixDQUhELElBSUEsQ0FBQ1IsR0FBRyxDQUFDUSxVQUFKLENBQWUs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QUFBQTtBQUFBLFdBcWlCRSxrQkFBUztBQUNQLGFBQU8sS0FBS0EsS0FBTCxDQUFXLENBQVgsQ0FBUDtBQUNEO0FBdmlCSDtBQUFBO0FBQUEsV0FpakJFLGVBQU1DLElBQU4sRUFBWTtBQUNWLFVBQUlDLFNBQUo7QUFDQSxVQUFJQyxTQUFKOztBQUNBLFVBQUksT0FBT0YsSUFBUCxLQUFnQixRQUFwQixFQUE4QjtBQUM1QkMsUUFBQUEsU0FBUyxHQUFHRCxJQUFaO0FBQ0FFLFFBQUFBLFNBQVMsR0FBRyxDQUFaO0FBQ0QsT0FIRCxNQUdPLElBQUksT0FBT0YsSUFBUCxLQUFnQixRQUFwQixFQUE4QjtBQUNuQ0MsUUFBQUEsU0FBUyxHQUFHRCxJQUFJLENBQUNHLElBQUwsSUFBYSxDQUF6QjtBQUNBRCxRQUFBQSxTQUFTLEdBQUdGLElBQUksQ0FBQ2hHLElBQUwsSUFBYSxDQUF6QjtBQUNELE9BSE0sTUFHQTtBQUNMLGNBQU0sSUFBSTFCLEtBQUosNEJBQW1DMEgsSUFBbkMsQ0FBTjtBQUNEOztBQUVELGFBQU8sS0FBS0ksZUFBTCxDQUFxQkgsU0FBckIsRUFBZ0NJLFNBQWhDLENBQTBDSCxTQUExQyxDQUFQO0FBQ0Q7QUEvakJIO0FBQUE7QUFBQSxXQXVrQkUsbUJBQVVJLEVBQVYsRUFBYztBQUNaLFdBQUtsSCxhQUFMLEdBQXFCa0gsRUFBckI7QUFDQSxhQUFPLElBQVA7QUFDRDtBQTFrQkg7QUFBQTtBQUFBLFdBa2xCRSx5QkFBZ0JBLEVBQWhCLEVBQW9CO0FBQ2xCLFdBQUtqSCxtQkFBTCxHQUEyQmlILEVBQTNCO0FBQ0EsYUFBTyxJQUFQO0FBQ0Q7QUFybEJIO0FBQUE7QUFBQSIsInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0J1xuXG5jb25zdCBzdHJpbmdpZnkgPSByZXF1aXJlKCdqc29uLXN0cmluZ2lmeS1zYWZlJylcbmNvbnN0IHF1ZXJ5c3RyaW5nID0gcmVxdWlyZSgncXVlcnlzdHJpbmcnKVxuY29uc3QgeyBVUkwsIFVSTFNlYXJjaFBhcmFtcyB9ID0gcmVxdWlyZSgndXJsJylcblxuY29uc3QgY29tbW9uID0gcmVxdWlyZSgnLi9jb21tb24nKVxuY29uc3QgeyByZW1vdmUgfSA9IHJlcXVpcmUoJy4vaW50ZXJjZXB0JylcbmNvbnN0IG1hdGNoQm9keSA9IHJlcXVpcmUoJy4vbWF0Y2hfYm9keScpXG5cbmxldCBmc1xudHJ5IHtcbiAgZnMgPSByZXF1aXJlKCdmcycpXG59IGNhdGNoIChlcnIpIHtcbiAgLy8gZG8gbm90aGluZywgd2UncmUgaW4gdGhlIGJyb3dzZXJcbn1cblxubW9kdWxlLmV4cG9ydHMgPSBjbGFzcyBJbnRlcmNlcHRvciB7XG4gIC8qKlxuICAgKlxuICAgKiBWYWxpZCBhcmd1bWVudCB0eXBlcyBmb3IgYHVyaWA6XG4gICAqICAtIEEgc3RyaW5nIHVzZWQgZm9yIHN0cmljdCBjb21wYXJpc29ucyB3aXRoIHBhdGhuYW1lLlxuICAgKiAgICBUaGUgc2VhcmNoIHBvcnRpb24gb2YgdGhlIFVSSSBtYXkgYWxzbyBiZSBwb3N0Zml4ZWQsIGluIHdoaWNoIGNhc2UgdGhlIHNlYXJjaCBwYXJhbXNcbiAgICogICAgYXJlIHN0cmlwZWQgYW5kIGFkZGVkIHZpYSB0aGUgYHF1ZXJ5YCBtZXRob2QuXG4gICAqICAtIEEgUmVnRXhwIGluc3RhbmNlIHRoYXQgdGVzdHMgYWdhaW5zdCBvbmx5IHRoZSBwYXRobmFtZSBvZiByZXF1ZXN0cy5cbiAgICogIC0gQSBzeW5jaHJvbm91cyBmdW5jdGlvbiBib3VuZCB0byB0aGlzIEludGVyY2VwdG9yIGluc3RhbmNlLiBJdCdzIHByb3ZpZGVkIHRoZSBwYXRobmFtZVxuICAgKiAgICBvZiByZXF1ZXN0cyBhbmQgbXVzdCByZXR1cm4gYSBib29sZWFuIGRlbm90aW5nIGlmIHRoZSByZXF1ZXN0IGlzIGNvbnNpZGVyZWQgYSBtYXRjaC5cbiAgICovXG4gIGNvbnN0cnVjdG9yKHNjb3BlLCB1cmksIG1ldGhvZCwgcmVxdWVzdEJvZHksIGludGVyY2VwdG9yT3B0aW9ucykge1xuICAgIGNvbnN0IHVyaUlzU3RyID0gdHlwZW9mIHVyaSA9PT0gJ3N0cmluZydcbiAgICAvLyBDaGVjayBmb3IgbGVhZGluZyBzbGFzaC4gVXJpIGNhbiBiZSBlaXRoZXIgYSBzdHJpbmcgb3IgYSByZWdleHAsIGJ1dFxuICAgIC8vIFdoZW4gZW5hYmxlZCBmaWx0ZXJpbmdTY29wZSBpZ25vcmVzIHRoZSBwYXNzZWQgVVJMIGVudGlyZWx5IHNvIHdlIHNraXAgdmFsaWRhdGlvbi5cblxuICAgIGlmIChcbiAgICAgIHVyaUlzU3RyICYmXG4gICAgICAhc2NvcGUuc2NvcGVPcHRpb25zLmZpbHRlcmluZ1Njb3BlICYmXG4gICAgICAhc2NvcGUuYmFzZVBhdGhuYW1lICYmXG4gICAgICAhdXJpLnN0YXJ0c1dpdGgoJy8nKSAmJlxuICAgICAgIXVyaS5zdGFydHNXaXRoKCcqJylcbiAgICApIHtcbiAgICAgIHRocm93IEVycm9yKFxuICAgICAgICBgTm9uLXdpbGRjYXJkIFVSTCBwYXRoIHN0cmluZ3MgbXVzdCBiZWdpbiB3aXRoIGEgc2xhc2ggKG90aGVyd2lzZSB0aGV5IHdvbid0IG1hdGNoIGFueXRoaW5nKSAoZ290OiAke3VyaX0pYFxuICAgICAgKVxuICAgIH1cblxuICAgIGlmICghbWV0aG9kKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICdUaGUgXCJtZXRob2RcIiBwYXJhbWV0ZXIgaXMgcmVxdWlyZWQgZm9yIGFuIGludGVyY2VwdCBjYWxsLidcbiAgICAgIClcbiAgICB9XG5cbiAgICB0aGlzLnNjb3BlID0gc2NvcGVcbiAgICB0aGlzLmludGVyY2VwdG9yTWF0Y2hIZWFkZXJzID0gW11cbiAgICB0aGlzLm1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpXG4gICAgdGhpcy51cmkgPSB1cmlcbiAgICB0aGlzLl9rZXkgPSBgJHt0aGlzLm1ldGhvZH0gJHtzY29wZS5iYXNlUGF0aH0ke3Njb3BlLmJhc2VQYXRobmFtZX0ke1xuICAgICAgdXJpSXNTdHIgPyAnJyA6ICcvJ1xuICAgIH0ke3VyaX1gXG4gICAgdGhpcy5iYXNlUGF0aCA9IHRoaXMuc2NvcGUuYmFzZVBhdGhcbiAgICB0aGlzLnBhdGggPSB1cmlJc1N0ciA/IHNjb3BlLmJhc2VQYXRobmFtZSArIHVyaSA6IHVyaVxuICAgIHRoaXMucXVlcmllcyA9IG51bGxcblxuICAgIHRoaXMub3B0aW9ucyA9IGludGVyY2VwdG9yT3B0aW9ucyB8fCB7fVxuICAgIHRoaXMuY291bnRlciA9IDFcbiAgICB0aGlzLl9yZXF1ZXN0Qm9keSA9IHJlcXVlc3RCb2R5XG5cbiAgICAvLyAgV2UgdXNlIGxvd2VyLWNhc2UgaGVhZGVyIGZpZWxkIG5hbWVzIHRocm91Z2hvdXQgTm9jay5cbiAgICB0aGlzLnJlcWhlYWRlcnMgPSBjb21tb24uaGVhZGVyc0ZpZWxkTmFtZXNUb0xvd2VyQ2FzZShcbiAgICAgIHNjb3BlLnNjb3BlT3B0aW9ucy5yZXFoZWFkZXJzIHx8IHt9XG4gICAgKVxuICAgIHRoaXMuYmFkaGVhZGVycyA9IGNvbW1vbi5oZWFkZXJzRmllbGRzQXJyYXlUb0xvd2VyQ2FzZShcbiAgICAgIHNjb3BlLnNjb3BlT3B0aW9ucy5iYWRoZWFkZXJzIHx8IFtdXG4gICAgKVxuXG4gICAgdGhpcy5kZWxheUJvZHlJbk1zID0gMFxuICAgIHRoaXMuZGVsYXlDb25uZWN0aW9uSW5NcyA9IDBcblxuICAgIHRoaXMub3B0aW9uYWwgPSBmYWxzZVxuXG4gICAgLy8gc3RyaXAgb2ZmIGxpdGVyYWwgcXVlcnkgcGFyYW1ldGVycyBpZiB0aGV5IHdlcmUgcHJvdmlkZWQgYXMgcGFydCBvZiB0aGUgVVJJXG4gICAgaWYgKHVyaUlzU3RyICYmIHVyaS5pbmNsdWRlcygnPycpKSB7XG4gICAgICAvLyBsb2NhbGhvc3QgaXMgYSBkdW1teSB2YWx1ZSBiZWNhdXNlIHRoZSBVUkwgY29uc3RydWN0b3IgZXJyb3JzIGZvciBvbmx5IHJlbGF0aXZlIGlucHV0c1xuICAgICAgY29uc3QgcGFyc2VkVVJMID0gbmV3IFVSTCh0aGlzLnBhdGgsICdodHRwOi8vbG9jYWxob3N0JylcbiAgICAgIHRoaXMucGF0aCA9IHBhcnNlZFVSTC5wYXRobmFtZVxuICAgICAgdGhpcy5xdWVyeShwYXJzZWRVUkwuc2VhcmNoUGFyYW1zKVxuICAgICAgdGhpcy5fa2V5ID0gYCR7dGhpcy5tZXRob2R9ICR7c2NvcGUuYmFzZVBhdGh9JHt0aGlzLnBhdGh9YFxuICAgIH1cbiAgfVxuXG4gIG9wdGlvbmFsbHkoZmxhZyA9IHRydWUpIHtcbiAgICAvLyBUaGUgZGVmYXVsdCBiZWhhdmlvdXIgb2Ygb3B0aW9uYWxseSgpIHdpdGggbm8gYXJndW1lbnRzIGlzIHRvIG1ha2UgdGhlIG1vY2sgb3B0aW9uYWwuXG4gICAgaWYgKHR5cGVvZiBmbGFnICE9PSAnYm9vbGVhbicpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBhcmd1bWVudHM6IGFyZ3VtZW50IHNob3VsZCBiZSBhIGJvb2xlYW4nKVxuICAgIH1cblxuICAgIHRoaXMub3B0aW9uYWwgPSBmbGFnXG5cbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgcmVwbHlXaXRoRXJyb3IoZXJyb3JNZXNzYWdlKSB7XG4gICAgdGhpcy5lcnJvck1lc3NhZ2UgPSBlcnJvck1lc3NhZ2VcblxuICAgIHRoaXMub3B0aW9ucyA9IHtcbiAgICAgIC4uLnRoaXMuc2NvcGUuc2NvcGVPcHRpb25zLFxuICAgICAgLi4udGhpcy5vcHRpb25zLFxuICAgIH1cblxuICAgIHRoaXMuc2NvcGUuYWRkKHRoaXMuX2tleSwgdGhpcylcbiAgICByZXR1cm4gdGhpcy5zY29wZVxuICB9XG5cbiAgcmVwbHkoc3RhdHVzQ29kZSwgYm9keSwgcmF3SGVhZGVycykge1xuICAgIC8vIHN1cHBvcnQgdGhlIGZvcm1hdCBvZiBvbmx5IHBhc3NpbmcgaW4gYSBjYWxsYmFja1xuICAgIGlmICh0eXBlb2Ygc3RhdHVzQ29kZSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPiAxKSB7XG4gICAgICAgIC8vIEl0J3Mgbm90IHZlcnkgSmF2YXNjcmlwdC15IHRvIHRocm93IGFuIGVycm9yIGZvciBleHRyYSBhcmdzIHRvIGEgZnVuY3Rpb24sIGJ1dCBiZWNhdXNlXG4gICAgICAgIC8vIG9mIGxlZ2FjeSBiZWhhdmlvciwgdGhpcyBlcnJvciB3YXMgYWRkZWQgdG8gcmVkdWNlIGNvbmZ1c2lvbiBmb3IgdGhvc2UgbWlncmF0aW5nLlxuICAgICAgICB0aHJvdyBFcnJvcihcbiAgICAgICAgICAnSW52YWxpZCBhcmd1bWVudHMuIFdoZW4gcHJvdmlkaW5nIGEgZnVuY3Rpb24gZm9yIHRoZSBmaXJzdCBhcmd1bWVudCwgLnJlcGx5IGRvZXMgbm90IGFjY2VwdCBvdGhlciBhcmd1bWVudHMuJ1xuICAgICAgICApXG4gICAgICB9XG4gICAgICB0aGlzLnN0YXR1c0NvZGUgPSBudWxsXG4gICAgICB0aGlzLmZ1bGxSZXBseUZ1bmN0aW9uID0gc3RhdHVzQ29kZVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoc3RhdHVzQ29kZSAhPT0gdW5kZWZpbmVkICYmICFOdW1iZXIuaXNJbnRlZ2VyKHN0YXR1c0NvZGUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCAke3R5cGVvZiBzdGF0dXNDb2RlfSB2YWx1ZSBmb3Igc3RhdHVzIGNvZGVgKVxuICAgICAgfVxuXG4gICAgICB0aGlzLnN0YXR1c0NvZGUgPSBzdGF0dXNDb2RlIHx8IDIwMFxuICAgICAgaWYgKHR5cGVvZiBib2R5ID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIHRoaXMucmVwbHlGdW5jdGlvbiA9IGJvZHlcbiAgICAgICAgYm9keSA9IG51bGxcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLm9wdGlvbnMgPSB7XG4gICAgICAuLi50aGlzLnNjb3BlLnNjb3BlT3B0aW9ucyxcbiAgICAgIC4uLnRoaXMub3B0aW9ucyxcbiAgICB9XG5cbiAgICB0aGlzLnJhd0hlYWRlcnMgPSBjb21tb24uaGVhZGVyc0lucHV0VG9SYXdBcnJheShyYXdIZWFkZXJzKVxuXG4gICAgaWYgKHRoaXMuc2NvcGUuZGF0ZSkge1xuICAgICAgLy8gaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzcyMzEjc2VjdGlvbi03LjEuMS4yXG4gICAgICB0aGlzLnJhd0hlYWRlcnMucHVzaCgnRGF0ZScsIHRoaXMuc2NvcGUuZGF0ZS50b1VUQ1N0cmluZygpKVxuICAgIH1cblxuICAgIC8vIFByZXBhcmUgdGhlIGhlYWRlcnMgdGVtcG9yYXJpbHkgc28gd2UgY2FuIG1ha2UgYmVzdCBndWVzc2VzIGFib3V0IGNvbnRlbnQtZW5jb2RpbmcgYW5kIGNvbnRlbnQtdHlwZVxuICAgIC8vIGJlbG93IGFzIHdlbGwgYXMgd2hpbGUgdGhlIHJlc3BvbnNlIGlzIGJlaW5nIHByb2Nlc3NlZCBpbiBSZXF1ZXN0T3ZlcnJpZGVyLmVuZCgpLlxuICAgIC8vIEluY2x1ZGluZyBhbGwgdGhlIGRlZmF1bHQgaGVhZGVycyBpcyBzYWZlIGZvciBvdXIgcHVycG9zZXMgYmVjYXVzZSBvZiB0aGUgc3BlY2lmaWMgaGVhZGVycyB3ZSBpbnRyb3NwZWN0LlxuICAgIC8vIEEgbW9yZSB0aG91Z2h0ZnVsIHByb2Nlc3MgaXMgdXNlZCB0byBtZXJnZSB0aGUgZGVmYXVsdCBoZWFkZXJzIHdoZW4gdGhlIHJlc3BvbnNlIGhlYWRlcnMgYXJlIGZpbmFsbHkgY29tcHV0ZWQuXG4gICAgdGhpcy5oZWFkZXJzID0gY29tbW9uLmhlYWRlcnNBcnJheVRvT2JqZWN0KFxuICAgICAgdGhpcy5yYXdIZWFkZXJzLmNvbmNhdCh0aGlzLnNjb3BlLl9kZWZhdWx0UmVwbHlIZWFkZXJzKVxuICAgIClcblxuICAgIC8vICBJZiB0aGUgY29udGVudCBpcyBub3QgZW5jb2RlZCB3ZSBtYXkgbmVlZCB0byB0cmFuc2Zvcm0gdGhlIHJlc3BvbnNlIGJvZHkuXG4gICAgLy8gIE90aGVyd2lzZSB3ZSBsZWF2ZSBpdCBhcyBpdCBpcy5cbiAgICBpZiAoXG4gICAgICBib2R5ICYmXG4gICAgICB0eXBlb2YgYm9keSAhPT0gJ3N0cmluZycgJiZcbiAgICAgICFCdWZmZXIuaXNCdWZmZXIoYm9keSkgJiZcbiAgICAgICFjb21tb24uaXNTdHJlYW0oYm9keSkgJiZcbiAgICAgICFjb21tb24uaXNDb250ZW50RW5jb2RlZCh0aGlzLmhlYWRlcnMpXG4gICAgKSB7XG4gICAgICB0cnkge1xuICAgICAgICBib2R5ID0gc3RyaW5naWZ5KGJvZHkpXG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdFcnJvciBlbmNvZGluZyByZXNwb25zZSBib2R5IGludG8gSlNPTicpXG4gICAgICB9XG5cbiAgICAgIGlmICghdGhpcy5oZWFkZXJzWydjb250ZW50LXR5cGUnXSkge1xuICAgICAgICAvLyBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjNzIzMSNzZWN0aW9uLTMuMS4xLjVcbiAgICAgICAgdGhpcy5yYXdIZWFkZXJzLnB1c2goJ0NvbnRlbnQtVHlwZScsICdhcHBsaWNhdGlvbi9qc29uJylcbiAgICAgIH1cblxuICAgICAgaWYgKHRoaXMuc2NvcGUuY29udGVudExlbikge1xuICAgICAgICAvLyBodHRwczovL3Rvb2xzLmlldGYub3JnL2h0bWwvcmZjNzIzMCNzZWN0aW9uLTMuMy4yXG4gICAgICAgIHRoaXMucmF3SGVhZGVycy5wdXNoKCdDb250ZW50LUxlbmd0aCcsIGJvZHkubGVuZ3RoKVxuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuc2NvcGUubG9nZ2VyKCdyZXBseS5oZWFkZXJzOicsIHRoaXMuaGVhZGVycylcbiAgICB0aGlzLnNjb3BlLmxvZ2dlcigncmVwbHkucmF3SGVhZGVyczonLCB0aGlzLnJhd0hlYWRlcnMpXG5cbiAgICB0aGlzLmJvZHkgPSBib2R5XG5cbiAgICB0aGlzLnNjb3BlLmFkZCh0aGlzLl9rZXksIHRoaXMpXG4gICAgcmV0dXJuIHRoaXMuc2NvcGVcbiAgfVxuXG4gIHJlcGx5V2l0aEZpbGUoc3RhdHVzQ29kZSwgZmlsZVBhdGgsIGhlYWRlcnMpIHtcbiAgICBpZiAoIWZzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGZzJylcbiAgICB9XG4gICAgY29uc3QgcmVhZFN0cmVhbSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0oZmlsZVBhdGgpXG4gICAgcmVhZFN0cmVhbS5wYXVzZSgpXG4gICAgdGhpcy5maWxlUGF0aCA9IGZpbGVQYXRoXG4gICAgcmV0dXJuIHRoaXMucmVwbHkoc3RhdHVzQ29kZSwgcmVhZFN0cmVhbSwgaGVhZGVycylcbiAgfVxuXG4gIC8vIEFsc28gbWF0Y2ggcmVxdWVzdCBoZWFkZXJzXG4gIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2NrL25vY2svaXNzdWVzLzE2M1xuICByZXFoZWFkZXJNYXRjaGVzKG9wdGlvbnMsIGtleSkge1xuICAgIGNvbnN0IHJlcUhlYWRlciA9IHRoaXMucmVxaGVhZGVyc1trZXldXG4gICAgbGV0IGhlYWRlciA9IG9wdGlvbnMuaGVhZGVyc1trZXldXG5cbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9jay9ub2NrL2lzc3Vlcy8zOTlcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9jay9ub2NrL2lzc3Vlcy84MjJcbiAgICBpZiAoaGVhZGVyICYmIHR5cGVvZiBoZWFkZXIgIT09ICdzdHJpbmcnICYmIGhlYWRlci50b1N0cmluZykge1xuICAgICAgaGVhZGVyID0gaGVhZGVyLnRvU3RyaW5nKClcbiAgICB9XG5cbiAgICAvLyBXZSBza2lwICdob3N0JyBoZWFkZXIgY29tcGFyaXNvbiB1bmxlc3MgaXQncyBhdmFpbGFibGUgaW4gYm90aCBtb2NrIGFuZFxuICAgIC8vIGFjdHVhbCByZXF1ZXN0LiBUaGlzIGJlY2F1c2UgJ2hvc3QnIG1heSBnZXQgaW5zZXJ0ZWQgYnkgTm9jayBpdHNlbGYgYW5kXG4gICAgLy8gdGhlbiBnZXQgcmVjb3JkZWQuIE5PVEU6IFdlIHVzZSBsb3dlci1jYXNlIGhlYWRlciBmaWVsZCBuYW1lcyB0aHJvdWdob3V0XG4gICAgLy8gTm9jay4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9ub2NrL25vY2svcHVsbC8xOTYuXG4gICAgaWYgKGtleSA9PT0gJ2hvc3QnICYmIChoZWFkZXIgPT09IHVuZGVmaW5lZCB8fCByZXFIZWFkZXIgPT09IHVuZGVmaW5lZCkpIHtcbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuXG4gICAgaWYgKHJlcUhlYWRlciAhPT0gdW5kZWZpbmVkICYmIGhlYWRlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBpZiAodHlwZW9mIHJlcUhlYWRlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICByZXR1cm4gcmVxSGVhZGVyKGhlYWRlcilcbiAgICAgIH0gZWxzZSBpZiAoY29tbW9uLm1hdGNoU3RyaW5nT3JSZWdleHAoaGVhZGVyLCByZXFIZWFkZXIpKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhpcy5zY29wZS5sb2dnZXIoXG4gICAgICBcInJlcXVlc3QgaGVhZGVyIGZpZWxkIGRvZXNuJ3QgbWF0Y2g6XCIsXG4gICAgICBrZXksXG4gICAgICBoZWFkZXIsXG4gICAgICByZXFIZWFkZXJcbiAgICApXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBtYXRjaChyZXEsIG9wdGlvbnMsIGJvZHkpIHtcbiAgICAvLyBjaGVjayBpZiB0aGUgbG9nZ2VyIGlzIGVuYWJsZWQgYmVjYXVzZSB0aGUgc3RyaW5naWZpZXMgY2FuIGJlIGV4cGVuc2l2ZS5cbiAgICBpZiAodGhpcy5zY29wZS5sb2dnZXIuZW5hYmxlZCkge1xuICAgICAgdGhpcy5zY29wZS5sb2dnZXIoXG4gICAgICAgICdhdHRlbXB0aW5nIG1hdGNoICVzLCBib2R5ID0gJXMnLFxuICAgICAgICBzdHJpbmdpZnkob3B0aW9ucyksXG4gICAgICAgIHN0cmluZ2lmeShib2R5KVxuICAgICAgKVxuICAgIH1cblxuICAgIGNvbnN0IG1ldGhvZCA9IChvcHRpb25zLm1ldGhvZCB8fCAnR0VUJykudG9VcHBlckNhc2UoKVxuICAgIGxldCB7IHBhdGggPSAnLycgfSA9IG9wdGlvbnNcbiAgICBsZXQgbWF0Y2hlc1xuICAgIGxldCBtYXRjaEtleVxuICAgIGNvbnN0IHsgcHJvdG8gfSA9IG9wdGlvbnNcblxuICAgIGlmICh0aGlzLm1ldGhvZCAhPT0gbWV0aG9kKSB7XG4gICAgICB0aGlzLnNjb3BlLmxvZ2dlcihcbiAgICAgICAgYE1ldGhvZCBkaWQgbm90IG1hdGNoLiBSZXF1ZXN0ICR7bWV0aG9kfSBJbnRlcmNlcHRvciAke3RoaXMubWV0aG9kfWBcbiAgICAgIClcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cblxuICAgIGlmICh0aGlzLnNjb3BlLnRyYW5zZm9ybVBhdGhGdW5jdGlvbikge1xuICAgICAgcGF0aCA9IHRoaXMuc2NvcGUudHJhbnNmb3JtUGF0aEZ1bmN0aW9uKHBhdGgpXG4gICAgfVxuXG4gICAgY29uc3QgcmVxdWVzdE1hdGNoZXNGaWx0ZXIgPSAoeyBuYW1lLCB2YWx1ZTogcHJlZGljYXRlIH0pID0+IHtcbiAgICAgIGNvbnN0IGhlYWRlclZhbHVlID0gcmVxLmdldEhlYWRlcihuYW1lKVxuICAgICAgaWYgKHR5cGVvZiBwcmVkaWNhdGUgPT09ICdmdW5jdGlvbicpIHtcbiAgICAgICAgcmV0dXJuIHByZWRpY2F0ZShoZWFkZXJWYWx1ZSlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHJldHVybiBjb21tb24ubWF0Y2hTdHJpbmdPclJlZ2V4cChoZWFkZXJWYWx1ZSwgcHJlZGljYXRlKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChcbiAgICAgICF0aGlzLnNjb3BlLm1hdGNoSGVhZGVycy5ldmVyeShyZXF1ZXN0TWF0Y2hlc0ZpbHRlcikgfHxcbiAgICAgICF0aGlzLmludGVyY2VwdG9yTWF0Y2hIZWFkZXJzLmV2ZXJ5KHJlcXVlc3RNYXRjaGVzRmlsdGVyKVxuICAgICkge1xuICAgICAgdGhpcy5zY29wZS5sb2dnZXIoXCJoZWFkZXJzIGRvbid0IG1hdGNoXCIpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICBjb25zdCByZXFIZWFkZXJzTWF0Y2ggPSBPYmplY3Qua2V5cyh0aGlzLnJlcWhlYWRlcnMpLmV2ZXJ5KGtleSA9PlxuICAgICAgdGhpcy5yZXFoZWFkZXJNYXRjaGVzKG9wdGlvbnMsIGtleSlcbiAgICApXG5cbiAgICBpZiAoIXJlcUhlYWRlcnNNYXRjaCkge1xuICAgICAgdGhpcy5zY29wZS5sb2dnZXIoXCJoZWFkZXJzIGRvbid0IG1hdGNoXCIpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICB0aGlzLnNjb3BlLnNjb3BlT3B0aW9ucy5jb25kaXRpb25hbGx5ICYmXG4gICAgICAhdGhpcy5zY29wZS5zY29wZU9wdGlvbnMuY29uZGl0aW9uYWxseSgpXG4gICAgKSB7XG4gICAgICB0aGlzLnNjb3BlLmxvZ2dlcihcbiAgICAgICAgJ21hdGNoaW5nIGZhaWxlZCBiZWNhdXNlIFNjb3BlLmNvbmRpdGlvbmFsbHkoKSBkaWQgbm90IHZhbGlkYXRlJ1xuICAgICAgKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgY29uc3QgYmFkSGVhZGVycyA9IHRoaXMuYmFkaGVhZGVycy5maWx0ZXIoXG4gICAgICBoZWFkZXIgPT4gaGVhZGVyIGluIG9wdGlvbnMuaGVhZGVyc1xuICAgIClcblxuICAgIGlmIChiYWRIZWFkZXJzLmxlbmd0aCkge1xuICAgICAgdGhpcy5zY29wZS5sb2dnZXIoJ3JlcXVlc3QgY29udGFpbnMgYmFkIGhlYWRlcnMnLCAuLi5iYWRIZWFkZXJzKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfVxuXG4gICAgLy8gTWF0Y2ggcXVlcnkgc3RyaW5ncyB3aGVuIHVzaW5nIHF1ZXJ5KClcbiAgICBpZiAodGhpcy5xdWVyaWVzID09PSBudWxsKSB7XG4gICAgICB0aGlzLnNjb3BlLmxvZ2dlcigncXVlcnkgbWF0Y2hpbmcgc2tpcHBlZCcpXG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGNhbid0IHJlbHkgb24gcGF0aG5hbWUgb3Igc2VhcmNoIGJlaW5nIGluIHRoZSBvcHRpb25zLCBidXQgcGF0aCBoYXMgYSBkZWZhdWx0XG4gICAgICBjb25zdCBbcGF0aG5hbWUsIHNlYXJjaF0gPSBwYXRoLnNwbGl0KCc/JylcbiAgICAgIGNvbnN0IG1hdGNoUXVlcmllcyA9IHRoaXMubWF0Y2hRdWVyeSh7IHNlYXJjaCB9KVxuXG4gICAgICB0aGlzLnNjb3BlLmxvZ2dlcihcbiAgICAgICAgbWF0Y2hRdWVyaWVzID8gJ3F1ZXJ5IG1hdGNoaW5nIHN1Y2NlZWRlZCcgOiAncXVlcnkgbWF0Y2hpbmcgZmFpbGVkJ1xuICAgICAgKVxuXG4gICAgICBpZiAoIW1hdGNoUXVlcmllcykge1xuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cblxuICAgICAgLy8gSWYgdGhlIHF1ZXJ5IHN0cmluZyB3YXMgZXhwbGljaXRseSBjaGVja2VkIHRoZW4gc3Vic2VxdWVudCBjaGVja3MgYWdhaW5zdFxuICAgICAgLy8gdGhlIHBhdGggdXNpbmcgYSBjYWxsYmFjayBvciByZWdleHAgb25seSB2YWxpZGF0ZSB0aGUgcGF0aG5hbWUuXG4gICAgICBwYXRoID0gcGF0aG5hbWVcbiAgICB9XG5cbiAgICAvLyBJZiB3ZSBoYXZlIGEgZmlsdGVyZWQgc2NvcGUgdGhlbiB3ZSB1c2UgaXQgaW5zdGVhZCByZWNvbnN0cnVjdGluZyB0aGVcbiAgICAvLyBzY29wZSBmcm9tIHRoZSByZXF1ZXN0IG9wdGlvbnMgKHByb3RvLCBob3N0IGFuZCBwb3J0KSBhcyB0aGVzZSB0d28gd29uJ3RcbiAgICAvLyBuZWNlc3NhcmlseSBtYXRjaCBhbmQgd2UgaGF2ZSB0byByZW1vdmUgdGhlIHNjb3BlIHRoYXQgd2FzIG1hdGNoZWQgKHZzLlxuICAgIC8vIHRoYXQgd2FzIGRlZmluZWQpLlxuICAgIGlmICh0aGlzLl9fbm9ja19maWx0ZXJlZFNjb3BlKSB7XG4gICAgICBtYXRjaEtleSA9IHRoaXMuX19ub2NrX2ZpbHRlcmVkU2NvcGVcbiAgICB9IGVsc2Uge1xuICAgICAgbWF0Y2hLZXkgPSBjb21tb24ubm9ybWFsaXplT3JpZ2luKHByb3RvLCBvcHRpb25zLmhvc3QsIG9wdGlvbnMucG9ydClcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHRoaXMudXJpID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICBtYXRjaGVzID1cbiAgICAgICAgY29tbW9uLm1hdGNoU3RyaW5nT3JSZWdleHAobWF0Y2hLZXksIHRoaXMuYmFzZVBhdGgpICYmXG4gICAgICAgIC8vIFRoaXMgaXMgYSBmYWxzZSBwb3NpdGl2ZSwgYXMgYHVyaWAgaXMgbm90IGJvdW5kIHRvIGB0aGlzYC5cbiAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLXVzZWxlc3MtY2FsbFxuICAgICAgICB0aGlzLnVyaS5jYWxsKHRoaXMsIHBhdGgpXG4gICAgfSBlbHNlIHtcbiAgICAgIG1hdGNoZXMgPVxuICAgICAgICBjb21tb24ubWF0Y2hTdHJpbmdPclJlZ2V4cChtYXRjaEtleSwgdGhpcy5iYXNlUGF0aCkgJiZcbiAgICAgICAgY29tbW9uLm1hdGNoU3RyaW5nT3JSZWdleHAocGF0aCwgdGhpcy5wYXRoKVxuICAgIH1cblxuICAgIHRoaXMuc2NvcGUubG9nZ2VyKGBtYXRjaGluZyAke21hdGNoS2V5fSR7cGF0aH0gdG8gJHt0aGlzLl9rZXl9OiAke21hdGNoZXN9YClcblxuICAgIGlmIChtYXRjaGVzICYmIHRoaXMuX3JlcXVlc3RCb2R5ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGlmICh0aGlzLnNjb3BlLnRyYW5zZm9ybVJlcXVlc3RCb2R5RnVuY3Rpb24pIHtcbiAgICAgICAgYm9keSA9IHRoaXMuc2NvcGUudHJhbnNmb3JtUmVxdWVzdEJvZHlGdW5jdGlvbihib2R5LCB0aGlzLl9yZXF1ZXN0Qm9keSlcbiAgICAgIH1cblxuICAgICAgbWF0Y2hlcyA9IG1hdGNoQm9keShvcHRpb25zLCB0aGlzLl9yZXF1ZXN0Qm9keSwgYm9keSlcbiAgICAgIGlmICghbWF0Y2hlcykge1xuICAgICAgICB0aGlzLnNjb3BlLmxvZ2dlcihcbiAgICAgICAgICBcImJvZGllcyBkb24ndCBtYXRjaDogXFxuXCIsXG4gICAgICAgICAgdGhpcy5fcmVxdWVzdEJvZHksXG4gICAgICAgICAgJ1xcbicsXG4gICAgICAgICAgYm9keVxuICAgICAgICApXG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG1hdGNoZXNcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXR1cm4gdHJ1ZSB3aGVuIHRoZSBpbnRlcmNlcHRvcidzIG1ldGhvZCwgcHJvdG9jb2wsIGhvc3QsIHBvcnQsIGFuZCBwYXRoXG4gICAqIG1hdGNoIHRoZSBwcm92aWRlZCBvcHRpb25zLlxuICAgKi9cbiAgbWF0Y2hPcmlnaW4ob3B0aW9ucykge1xuICAgIGNvbnN0IGlzUGF0aEZuID0gdHlwZW9mIHRoaXMucGF0aCA9PT0gJ2Z1bmN0aW9uJ1xuICAgIGNvbnN0IGlzUmVnZXggPSB0aGlzLnBhdGggaW5zdGFuY2VvZiBSZWdFeHBcbiAgICBjb25zdCBpc1JlZ2V4QmFzZVBhdGggPSB0aGlzLnNjb3BlLmJhc2VQYXRoIGluc3RhbmNlb2YgUmVnRXhwXG5cbiAgICBjb25zdCBtZXRob2QgPSAob3B0aW9ucy5tZXRob2QgfHwgJ0dFVCcpLnRvVXBwZXJDYXNlKClcbiAgICBsZXQgeyBwYXRoIH0gPSBvcHRpb25zXG4gICAgY29uc3QgeyBwcm90byB9ID0gb3B0aW9uc1xuXG4gICAgLy8gTk9URTogRG8gbm90IHNwbGl0IG9mZiB0aGUgcXVlcnkgcGFyYW1zIGFzIHRoZSByZWdleCBjb3VsZCB1c2UgdGhlbVxuICAgIGlmICghaXNSZWdleCkge1xuICAgICAgcGF0aCA9IHBhdGggPyBwYXRoLnNwbGl0KCc/JylbMF0gOiAnJ1xuICAgIH1cblxuICAgIGlmICh0aGlzLnNjb3BlLnRyYW5zZm9ybVBhdGhGdW5jdGlvbikge1xuICAgICAgcGF0aCA9IHRoaXMuc2NvcGUudHJhbnNmb3JtUGF0aEZ1bmN0aW9uKHBhdGgpXG4gICAgfVxuICAgIGNvbnN0IGNvbXBhcmlzb25LZXkgPSBpc1BhdGhGbiB8fCBpc1JlZ2V4ID8gdGhpcy5fX25vY2tfc2NvcGVLZXkgOiB0aGlzLl9rZXlcbiAgICBjb25zdCBtYXRjaEtleSA9IGAke21ldGhvZH0gJHtwcm90b306Ly8ke29wdGlvbnMuaG9zdH0ke3BhdGh9YFxuXG4gICAgaWYgKGlzUGF0aEZuKSB7XG4gICAgICByZXR1cm4gISEobWF0Y2hLZXkubWF0Y2goY29tcGFyaXNvbktleSkgJiYgdGhpcy5wYXRoKHBhdGgpKVxuICAgIH1cblxuICAgIGlmIChpc1JlZ2V4ICYmICFpc1JlZ2V4QmFzZVBhdGgpIHtcbiAgICAgIHJldHVybiAhIW1hdGNoS2V5Lm1hdGNoKGNvbXBhcmlzb25LZXkpICYmIHRoaXMucGF0aC50ZXN0KHBhdGgpXG4gICAgfVxuXG4gICAgaWYgKGlzUmVnZXhCYXNlUGF0aCkge1xuICAgICAgcmV0dXJuIHRoaXMuc2NvcGUuYmFzZVBhdGgudGVzdChtYXRjaEtleSkgJiYgISFwYXRoLm1hdGNoKHRoaXMucGF0aClcbiAgICB9XG5cbiAgICByZXR1cm4gY29tcGFyaXNvbktleSA9PT0gbWF0Y2hLZXlcbiAgfVxuXG4gIG1hdGNoSG9zdE5hbWUob3B0aW9ucykge1xuICAgIHJldHVybiBvcHRpb25zLmhvc3RuYW1lID09PSB0aGlzLnNjb3BlLnVybFBhcnRzLmhvc3RuYW1lXG4gIH1cblxuICBtYXRjaFF1ZXJ5KG9wdGlvbnMpIHtcbiAgICBpZiAodGhpcy5xdWVyaWVzID09PSB0cnVlKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cblxuICAgIGNvbnN0IHJlcVF1ZXJpZXMgPSBxdWVyeXN0cmluZy5wYXJzZShvcHRpb25zLnNlYXJjaClcbiAgICB0aGlzLnNjb3BlLmxvZ2dlcignSW50ZXJjZXB0b3IgcXVlcmllczogJWonLCB0aGlzLnF1ZXJpZXMpXG4gICAgdGhpcy5zY29wZS5sb2dnZXIoJyAgICBSZXF1ZXN0IHF1ZXJpZXM6ICVqJywgcmVxUXVlcmllcylcblxuICAgIGlmICh0eXBlb2YgdGhpcy5xdWVyaWVzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICByZXR1cm4gdGhpcy5xdWVyaWVzKHJlcVF1ZXJpZXMpXG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbW1vbi5kYXRhRXF1YWwodGhpcy5xdWVyaWVzLCByZXFRdWVyaWVzKVxuICB9XG5cbiAgZmlsdGVyaW5nUGF0aCguLi5hcmdzKSB7XG4gICAgdGhpcy5zY29wZS5maWx0ZXJpbmdQYXRoKC4uLmFyZ3MpXG4gICAgcmV0dXJuIHRoaXNcbiAgfVxuXG4gIC8vIFRPRE8gZmlsdGVyaW5nIGJ5IHBhdGggaXMgdmFsaWQgb24gdGhlIGludGVyY2VwdCBsZXZlbCwgYnV0IG5vdCBmaWx0ZXJpbmdcbiAgLy8gYnkgcmVxdWVzdCBib2R5P1xuXG4gIG1hcmtDb25zdW1lZCgpIHtcbiAgICB0aGlzLmludGVyY2VwdGlvbkNvdW50ZXIrK1xuXG4gICAgcmVtb3ZlKHRoaXMpXG5cbiAgICBpZiAoKHRoaXMuc2NvcGUuc2hvdWxkUGVyc2lzdCgpIHx8IHRoaXMuY291bnRlciA+IDApICYmIHRoaXMuZmlsZVBhdGgpIHtcbiAgICAgIHRoaXMuYm9keSA9IGZzLmNyZWF0ZVJlYWRTdHJlYW0odGhpcy5maWxlUGF0aClcbiAgICAgIHRoaXMuYm9keS5wYXVzZSgpXG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnNjb3BlLnNob3VsZFBlcnNpc3QoKSAmJiB0aGlzLmNvdW50ZXIgPCAxKSB7XG4gICAgICB0aGlzLnNjb3BlLnJlbW92ZSh0aGlzLl9rZXksIHRoaXMpXG4gICAgfVxuICB9XG5cbiAgbWF0Y2hIZWFkZXIobmFtZSwgdmFsdWUpIHtcbiAgICB0aGlzLmludGVyY2VwdG9yTWF0Y2hIZWFkZXJzLnB1c2goeyBuYW1lLCB2YWx1ZSB9KVxuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICBiYXNpY0F1dGgoeyB1c2VyLCBwYXNzID0gJycgfSkge1xuICAgIGNvbnN0IGVuY29kZWQgPSBCdWZmZXIuZnJvbShgJHt1c2VyfToke3Bhc3N9YCkudG9TdHJpbmcoJ2Jhc2U2NCcpXG4gICAgdGhpcy5tYXRjaEhlYWRlcignYXV0aG9yaXphdGlvbicsIGBCYXNpYyAke2VuY29kZWR9YClcbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBxdWVyeSBzdHJpbmdzIGZvciB0aGUgaW50ZXJjZXB0b3JcbiAgICogQG5hbWUgcXVlcnlcbiAgICogQHBhcmFtIHF1ZXJpZXMgT2JqZWN0IG9mIHF1ZXJ5IHN0cmluZyBuYW1lLHZhbHVlcyAoYWNjZXB0cyByZWdleHAgdmFsdWVzKVxuICAgKiBAcHVibGljXG4gICAqIEBleGFtcGxlXG4gICAqIC8vIFdpbGwgbWF0Y2ggJ2h0dHA6Ly96b21iby5jb20vP3E9dCdcbiAgICogbm9jaygnaHR0cDovL3pvbWJvLmNvbScpLmdldCgnLycpLnF1ZXJ5KHtxOiAndCd9KTtcbiAgICovXG4gIHF1ZXJ5KHF1ZXJpZXMpIHtcbiAgICBpZiAodGhpcy5xdWVyaWVzICE9PSBudWxsKSB7XG4gICAgICB0aHJvdyBFcnJvcihgUXVlcnkgcGFyYW1ldGVycyBoYXZlIGFscmVhZHkgYmVlbiBkZWZpbmVkYClcbiAgICB9XG5cbiAgICAvLyBBbGxvdyBhbGwgcXVlcnkgc3RyaW5ncyB0byBtYXRjaCB0aGlzIHJvdXRlXG4gICAgaWYgKHF1ZXJpZXMgPT09IHRydWUpIHtcbiAgICAgIHRoaXMucXVlcmllcyA9IHF1ZXJpZXNcbiAgICAgIHJldHVybiB0aGlzXG4gICAgfVxuXG4gICAgaWYgKHR5cGVvZiBxdWVyaWVzID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICB0aGlzLnF1ZXJpZXMgPSBxdWVyaWVzXG4gICAgICByZXR1cm4gdGhpc1xuICAgIH1cblxuICAgIGxldCBzdHJGb3JtYXR0aW5nRm5cbiAgICBpZiAodGhpcy5zY29wZS5zY29wZU9wdGlvbnMuZW5jb2RlZFF1ZXJ5UGFyYW1zKSB7XG4gICAgICBzdHJGb3JtYXR0aW5nRm4gPSBjb21tb24ucGVyY2VudERlY29kZVxuICAgIH1cblxuICAgIGlmIChxdWVyaWVzIGluc3RhbmNlb2YgVVJMU2VhcmNoUGFyYW1zKSB7XG4gICAgICAvLyBOb3JtYWxpemUgdGhlIGRhdGEgaW50byB0aGUgc2hhcGUgdGhhdCBpcyBtYXRjaGVkIGFnYWluc3QuXG4gICAgICAvLyBEdXBsaWNhdGUga2V5cyBhcmUgaGFuZGxlZCBieSBjb21iaW5pbmcgdGhlIHZhbHVlcyBpbnRvIGFuIGFycmF5LlxuICAgICAgcXVlcmllcyA9IHF1ZXJ5c3RyaW5nLnBhcnNlKHF1ZXJpZXMudG9TdHJpbmcoKSlcbiAgICB9IGVsc2UgaWYgKCFjb21tb24uaXNQbGFpbk9iamVjdChxdWVyaWVzKSkge1xuICAgICAgdGhyb3cgRXJyb3IoYEFyZ3VtZW50IEVycm9yOiAke3F1ZXJpZXN9YClcbiAgICB9XG5cbiAgICB0aGlzLnF1ZXJpZXMgPSB7fVxuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKHF1ZXJpZXMpKSB7XG4gICAgICBjb25zdCBmb3JtYXR0ZWQgPSBjb21tb24uZm9ybWF0UXVlcnlWYWx1ZShrZXksIHZhbHVlLCBzdHJGb3JtYXR0aW5nRm4pXG4gICAgICBjb25zdCBbZm9ybWF0dGVkS2V5LCBmb3JtYXR0ZWRWYWx1ZV0gPSBmb3JtYXR0ZWRcbiAgICAgIHRoaXMucXVlcmllc1tmb3JtYXR0ZWRLZXldID0gZm9ybWF0dGVkVmFsdWVcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBudW1iZXIgb2YgdGltZXMgd2lsbCByZXBlYXQgdGhlIGludGVyY2VwdG9yXG4gICAqIEBuYW1lIHRpbWVzXG4gICAqIEBwYXJhbSBuZXdDb3VudGVyIE51bWJlciBvZiB0aW1lcyB0byByZXBlYXQgKHNob3VsZCBiZSA+IDApXG4gICAqIEBwdWJsaWNcbiAgICogQGV4YW1wbGVcbiAgICogLy8gV2lsbCByZXBlYXQgbW9jayA1IHRpbWVzIGZvciBzYW1lIGtpbmcgb2YgcmVxdWVzdFxuICAgKiBub2NrKCdodHRwOi8vem9tYm8uY29tKS5nZXQoJy8nKS50aW1lcyg1KS5yZXBseSgyMDAsICdPaycpO1xuICAgKi9cbiAgdGltZXMobmV3Q291bnRlcikge1xuICAgIGlmIChuZXdDb3VudGVyIDwgMSkge1xuICAgICAgcmV0dXJuIHRoaXNcbiAgICB9XG5cbiAgICB0aGlzLmNvdW50ZXIgPSBuZXdDb3VudGVyXG5cbiAgICByZXR1cm4gdGhpc1xuICB9XG5cbiAgLyoqXG4gICAqIEFuIHN1Z2FyIHN5bnRheCBmb3IgdGltZXMoMSlcbiAgICogQG5hbWUgb25jZVxuICAgKiBAc2VlIHtAbGluayB0aW1lc31cbiAgICogQHB1YmxpY1xuICAgKiBAZXhhbXBsZVxuICAgKiBub2NrKCdodHRwOi8vem9tYm8uY29tKS5nZXQoJy8nKS5vbmNlKCkucmVwbHkoMjAwLCAnT2snKTtcbiAgICovXG4gIG9uY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMudGltZXMoMSlcbiAgfVxuXG4gIC8qKlxuICAgKiBBbiBzdWdhciBzeW50YXggZm9yIHRpbWVzKDIpXG4gICAqIEBuYW1lIHR3aWNlXG4gICAqIEBzZWUge0BsaW5rIHRpbWVzfVxuICAgKiBAcHVibGljXG4gICAqIEBleGFtcGxlXG4gICAqIG5vY2soJ2h0dHA6Ly96b21iby5jb20pLmdldCgnLycpLnR3aWNlKCkucmVwbHkoMjAwLCAnT2snKTtcbiAgICovXG4gIHR3aWNlKCkge1xuICAgIHJldHVybiB0aGlzLnRpbWVzKDIpXG4gIH1cblxuICAvKipcbiAgICogQW4gc3VnYXIgc3ludGF4IGZvciB0aW1lcygzKS5cbiAgICogQG5hbWUgdGhyaWNlXG4gICAqIEBzZWUge0BsaW5rIHRpbWVzfVxuICAgKiBAcHVibGljXG4gICAqIEBleGFtcGxlXG4gICAqIG5vY2soJ2h0dHA6Ly96b21iby5jb20pLmdldCgnLycpLnRocmljZSgpLnJlcGx5KDIwMCwgJ09rJyk7XG4gICAqL1xuICB0aHJpY2UoKSB7XG4gICAgcmV0dXJuIHRoaXMudGltZXMoMylcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxheSB0aGUgcmVzcG9uc2UgYnkgYSBjZXJ0YWluIG51bWJlciBvZiBtcy5cbiAgICpcbiAgICogQHBhcmFtIHsoaW50ZWdlcnxvYmplY3QpfSBvcHRzIC0gTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0LCBvciBhbiBvYmplY3RcbiAgICogQHBhcmFtIHtpbnRlZ2VyfSBbb3B0cy5oZWFkXSAtIE51bWJlciBvZiBtaWxsaXNlY29uZHMgdG8gd2FpdCBiZWZvcmUgcmVzcG9uc2UgaXMgc2VudFxuICAgKiBAcGFyYW0ge2ludGVnZXJ9IFtvcHRzLmJvZHldIC0gTnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IGJlZm9yZSByZXNwb25zZSBib2R5IGlzIHNlbnRcbiAgICogQHJldHVybiB7SW50ZXJjZXB0b3J9IC0gdGhlIGN1cnJlbnQgaW50ZXJjZXB0b3IgZm9yIGNoYWluaW5nXG4gICAqL1xuICBkZWxheShvcHRzKSB7XG4gICAgbGV0IGhlYWREZWxheVxuICAgIGxldCBib2R5RGVsYXlcbiAgICBpZiAodHlwZW9mIG9wdHMgPT09ICdudW1iZXInKSB7XG4gICAgICBoZWFkRGVsYXkgPSBvcHRzXG4gICAgICBib2R5RGVsYXkgPSAwXG4gICAgfSBlbHNlIGlmICh0eXBlb2Ygb3B0cyA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGhlYWREZWxheSA9IG9wdHMuaGVhZCB8fCAwXG4gICAgICBib2R5RGVsYXkgPSBvcHRzLmJvZHkgfHwgMFxuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaW5wdXQgb3B0cyAke29wdHN9YClcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5kZWxheUNvbm5lY3Rpb24oaGVhZERlbGF5KS5kZWxheUJvZHkoYm9keURlbGF5KVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGF5IHRoZSByZXNwb25zZSBib2R5IGJ5IGEgY2VydGFpbiBudW1iZXIgb2YgbXMuXG4gICAqXG4gICAqIEBwYXJhbSB7aW50ZWdlcn0gbXMgLSBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgYmVmb3JlIHJlc3BvbnNlIGlzIHNlbnRcbiAgICogQHJldHVybiB7SW50ZXJjZXB0b3J9IC0gdGhlIGN1cnJlbnQgaW50ZXJjZXB0b3IgZm9yIGNoYWluaW5nXG4gICAqL1xuICBkZWxheUJvZHkobXMpIHtcbiAgICB0aGlzLmRlbGF5Qm9keUluTXMgPSBtc1xuICAgIHJldHVybiB0aGlzXG4gIH1cblxuICAvKipcbiAgICogRGVsYXkgdGhlIGNvbm5lY3Rpb24gYnkgYSBjZXJ0YWluIG51bWJlciBvZiBtcy5cbiAgICpcbiAgICogQHBhcmFtICB7aW50ZWdlcn0gbXMgLSBOdW1iZXIgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXRcbiAgICogQHJldHVybiB7SW50ZXJjZXB0b3J9IC0gdGhlIGN1cnJlbnQgaW50ZXJjZXB0b3IgZm9yIGNoYWluaW5nXG4gICAqL1xuICBkZWxheUNvbm5lY3Rpb24obXMpIHtcbiAgICB0aGlzLmRlbGF5Q29ubmVjdGlvbkluTXMgPSBtc1xuICAgIHJldHVybiB0aGlzXG4gIH1cbn1cbiJdfQ==